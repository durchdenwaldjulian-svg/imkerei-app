<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#F5A623">
<link rel="manifest" href="manifest.json">
<title>üìã Bestandsbuch ‚Äì Imkerei Cloud</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
// Fallback: check if jsPDF loaded
if (!window.jspdf) {
    var s1 = document.createElement('script');
    s1.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js';
    document.head.appendChild(s1);
    var s2 = document.createElement('script');
    s2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
    document.head.appendChild(s2);
}
</script>
<style>
:root {
    --bg: #FAF6F0;
    --card: #FFFFFF;
    --border: #E8DFD4;
    --text: #1C1410;
    --text-sub: #7A6652;
    --honey: #D4930D;
    --honey-light: #FFF8EE;
    --honey-dark: #A67208;
    --green: #2D8A4E;
    --green-light: #E8F5EC;
    --red: #C0392B;
    --red-light: #FDECEA;
    --blue: #2980B9;
    --blue-light: #EBF5FB;
    --shadow: 0 2px 12px rgba(28,20,16,0.06);
    --shadow-hover: 0 6px 24px rgba(28,20,16,0.12);
    --radius: 0.75rem;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; min-height:100vh; padding-left:220px; }

/* Sidebar Nav */
.side-nav{position:fixed;left:0;top:0;bottom:0;width:220px;background:#FFFBF0;border-right:2px solid rgba(245,166,35,0.12);display:flex;flex-direction:column;padding:0;z-index:50;overflow-y:auto}
.side-nav .nav-brand{padding:1.25rem 1rem;border-bottom:2px solid rgba(245,166,35,0.12)}
.side-nav .nav-section{font-size:.65rem;font-weight:700;color:#A69580;text-transform:uppercase;letter-spacing:.08em;padding:.75rem 1rem .25rem}
.side-nav .nav-link{display:block;padding:.625rem 1rem;text-align:left;color:#7A6652;font-size:.85rem;border-left:4px solid transparent;transition:all .15s;width:100%;text-decoration:none}
.side-nav .nav-link:hover{background:rgba(245,166,35,0.06)}
.side-nav .nav-link.active{color:#92400E;font-weight:600;border-left-color:#F5A623;background:#FFF8EE}

/* Loading */
.loading-screen { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:999; }
.loading-screen .spinner { width:48px; height:48px; border:4px solid var(--border); border-top-color:var(--honey); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.loading-screen p { margin-top:1rem; color:var(--text-sub); font-size:.9rem; }

/* Header */
.header { background:linear-gradient(135deg,#1C1410 0%,#3D2E22 100%); color:white; padding:1rem 1.5rem; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; box-shadow:0 4px 20px rgba(0,0,0,0.15); }
.header h1 { font-size:1.25rem; font-weight:700; display:flex; align-items:center; gap:.5rem; }
.header-links { display:flex; align-items:center; gap:.75rem; }
.header-links a { color:rgba(255,255,255,0.7); text-decoration:none; font-size:.85rem; padding:.4rem .75rem; border-radius:.4rem; transition:all .2s; }
.header-links a:hover { color:white; background:rgba(255,255,255,0.1); }

/* Main */
.main { max-width:1100px; margin:0 auto; padding:1.5rem; }

/* Info Banner */
.info-banner { background:linear-gradient(135deg,var(--honey-light) 0%,#FFF3E0 100%); border:2px solid #F0D9A0; border-radius:var(--radius); padding:1.25rem 1.5rem; margin-bottom:1.5rem; display:flex; gap:1rem; align-items:flex-start; }
.info-banner .icon { font-size:1.5rem; flex-shrink:0; }
.info-banner h3 { font-size:.95rem; color:var(--honey-dark); margin-bottom:.25rem; }
.info-banner p { font-size:.85rem; color:var(--text-sub); line-height:1.5; }

/* Profil Card */
.profil-card { background:var(--card); border:2px solid var(--border); border-radius:var(--radius); padding:1.5rem; margin-bottom:1.5rem; box-shadow:var(--shadow); }
.profil-card h2 { font-size:1.1rem; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem; }
.profil-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:.75rem; }
.profil-field label { font-size:.72rem; color:var(--text-sub); font-weight:600; text-transform:uppercase; letter-spacing:.05em; display:block; margin-bottom:.2rem; }
.profil-field input { width:100%; padding:.55rem .7rem; border:2px solid var(--border); border-radius:.4rem; font-size:.88rem; background:var(--bg); color:var(--text); transition:border-color .2s; }
.profil-field input:focus { outline:none; border-color:var(--honey); background:white; }
.profil-actions { margin-top:1rem; display:flex; gap:.5rem; }

/* Actions Bar */
.actions-bar { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.75rem; margin-bottom:1.5rem; padding:1rem 1.25rem; background:var(--card); border:2px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
.actions-bar h2 { font-size:1rem; display:flex; align-items:center; gap:.4rem; }

/* Standort Section */
.standort-section { margin-bottom:2rem; }
.standort-header { background:var(--card); border:2px solid var(--border); border-radius:var(--radius) var(--radius) 0 0; padding:1.1rem 1.25rem; display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid var(--honey); }
.standort-header h2 { font-size:1.1rem; display:flex; align-items:center; gap:.5rem; }
.standort-meta { font-size:.8rem; color:var(--text-sub); display:flex; gap:1rem; }
.standort-meta span { display:flex; align-items:center; gap:.25rem; }

/* Table */
.table-wrapper { background:var(--card); border:2px solid var(--border); border-top:none; border-radius:0 0 var(--radius) var(--radius); overflow-x:auto; box-shadow:var(--shadow); }
table { width:100%; border-collapse:collapse; font-size:.83rem; }
thead { background:#F5EDE3; }
thead th { padding:.7rem .5rem; text-align:left; font-weight:700; font-size:.68rem; text-transform:uppercase; letter-spacing:.06em; color:var(--text-sub); border-bottom:2px solid var(--border); white-space:nowrap; }
tbody td { padding:.65rem .5rem; border-bottom:1px solid #F0EBE5; vertical-align:top; }
tbody tr:hover { background:var(--honey-light); }
tbody tr:last-child td { border-bottom:none; }
.nr-cell { font-weight:700; color:var(--honey-dark); text-align:center; width:35px; }
.datum-cell { white-space:nowrap; font-weight:500; }
.methode-badge { display:inline-flex; align-items:center; gap:.2rem; padding:.15rem .45rem; border-radius:.3rem; font-size:.76rem; font-weight:600; }
.empty-state { text-align:center; padding:2.5rem 1rem; color:var(--text-sub); }
.empty-state .icon { font-size:2.5rem; margin-bottom:.75rem; }
.empty-state h3 { font-size:1rem; margin-bottom:.25rem; }

/* Buttons */
.btn { display:inline-flex; align-items:center; gap:.35rem; padding:.55rem 1.1rem; border:none; border-radius:.45rem; font-size:.83rem; font-weight:600; cursor:pointer; transition:all .2s; }
.btn:active { transform:scale(0.97); }
.btn-primary { background:var(--honey); color:white; }
.btn-primary:hover { background:var(--honey-dark); box-shadow:0 4px 12px rgba(212,147,13,0.3); }
.btn-pdf { background:var(--red); color:white; }
.btn-pdf:hover { background:#A93226; }
.btn-all { background:var(--green); color:white; }
.btn-all:hover { background:#227240; }
.btn-sm { padding:.35rem .7rem; font-size:.76rem; }
.btn-outline { background:transparent; color:var(--text-sub); border:2px solid var(--border); }
.btn-outline:hover { background:var(--bg); border-color:var(--honey); color:var(--honey-dark); }
.btn-group { display:flex; gap:.5rem; flex-wrap:wrap; }

/* Year Filter */
.year-filter { display:flex; align-items:center; gap:.5rem; }
.year-filter select { padding:.4rem .6rem; border:2px solid var(--border); border-radius:.4rem; font-size:.85rem; background:white; color:var(--text); }

/* Toast */
.toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(100px); background:#1C1410; color:white; padding:.75rem 1.5rem; border-radius:.75rem; font-size:.9rem; font-weight:500; box-shadow:0 8px 32px rgba(0,0,0,0.2); z-index:1000; transition:transform .3s ease; pointer-events:none; }
.toast.show { transform:translateX(-50%) translateY(0); }

/* Modal */
.modal-overlay { position:fixed; inset:0; background:rgba(28,20,16,0.5); z-index:200; display:none; align-items:center; justify-content:center; padding:1rem; }
.modal-overlay.active { display:flex; }
.modal-box { background:var(--card); border-radius:var(--radius); max-width:900px; width:100%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.2); }
.modal-head { padding:1rem 1.25rem; border-bottom:2px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.modal-head h3 { font-size:1rem; }
.modal-close { width:32px; height:32px; border:none; background:var(--bg); border-radius:.5rem; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.modal-body-inner { flex:1; overflow:auto; padding:1rem; }
.modal-body-inner iframe { width:100%; height:70vh; border:2px solid var(--border); border-radius:.5rem; }

/* Responsive */
@media (max-width:640px) {
    body { padding-left:0; padding-bottom:90px; }
    .side-nav{left:0;right:0;top:auto;bottom:0;width:100%;height:auto;flex-direction:row;border-right:none;border-top:2px solid rgba(245,166,35,0.12);overflow-x:auto;overflow-y:hidden}
    .side-nav .nav-brand,.side-nav .nav-section{display:none}
    .side-nav .nav-link{flex:0 0 auto;padding:.5rem .6rem;font-size:.6rem;text-align:center;border-left:none;border-bottom:3px solid transparent;white-space:nowrap}
    .side-nav .nav-link.active{border-left:none;border-bottom-color:#F5A623}
    .header { padding:.75rem 1rem; flex-direction:column; gap:.5rem; text-align:center; }
    .main { padding:1rem; }
    .profil-grid { grid-template-columns:1fr; }
    .actions-bar { flex-direction:column; text-align:center; }
    .standort-header { flex-direction:column; gap:.5rem; }
    .standort-meta { justify-content:center; }
    table { font-size:.75rem; }
    thead th, tbody td { padding:.45rem .3rem; }
}

@keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
.animate-in { animation:fadeUp .4s ease forwards; }
</style>
</head>
<body>

<nav class="side-nav">
    <div class="nav-brand">
        <div style="font-size:1.5rem;font-weight:bold;color:#F5A623">üêù</div>
        <div style="font-size:.85rem;font-weight:600;color:#1C1410;margin-top:.25rem">Imkerei</div>
        <div style="font-size:.7rem;color:#7A6652">Cloud v6.0</div>
    </div>
    <div class="nav-section">√úbersicht</div>
    <a href="index.html#heute" class="nav-link">üìÖ Heute</a>
    <a href="index.html#standorte" class="nav-link">üìç Standorte</a>
    <a href="index.html#aufgaben" class="nav-link">üìù Aufgaben</a>
    <div class="nav-section">V√∂lker</div>
    <a href="zuchtplan.html" class="nav-link">üëë K√∂niginnenzucht</a>
    <a href="index.html#behandlung" class="nav-link">üíâ Behandlungen</a>
    <a href="bewertung.html" class="nav-link">‚≠ê V√∂lker-Bewertung</a>
    <a href="assistent.html" class="nav-link">ü§ñ Assistent</a>
    <a href="bestandsbuch.html" class="nav-link active">üìã Bestandsbuch</a>
    <div class="nav-section">Ernte & Planung</div>
    <a href="ernte.html" class="nav-link">üçØ Honigernte</a>
    <a href="index.html#tracht" class="nav-link">üå∏ Tracht</a>
    <a href="index.html#packliste" class="nav-link">üì¶ Packliste</a>
    <div class="nav-section">Community</div>
    <a href="forum.html" class="nav-link">üí¨ Forum</a>
    <div class="nav-section">Verwaltung</div>
    <a href="index.html#kosten" class="nav-link">üí∞ Kosten</a>
    <div style="flex:1"></div>
    <div class="nav-section">Rechtliches</div>
    <a href="impressum.html" class="nav-link" style="font-size:.75rem;padding:.4rem 1rem;color:#A69580">Impressum</a>
    <a href="datenschutz.html" class="nav-link" style="font-size:.75rem;padding:.4rem 1rem;color:#A69580">Datenschutz</a>
    <a href="agb.html" class="nav-link" style="font-size:.75rem;padding:.4rem 1rem;color:#A69580">AGB</a>
    <a href="index.html#einstellungen" class="nav-link">‚öôÔ∏è Einstellungen</a>
</nav>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
    <div class="spinner"></div>
    <p>Behandlungsdaten werden geladen...</p>
</div>

<div id="appContent" style="display:none">

<div class="main">
    <!-- Info Banner -->
    <div class="info-banner animate-in">
        <div class="icon">‚öñÔ∏è</div>
        <div>
            <h3>Amtliche Dokumentationspflicht</h3>
            <p>Gem√§√ü Verordnung (EU) 2019/6 und ¬ß 108 (2) m√ºssen alle Arzneimittel-Anwendungen bei Bienenv√∂lkern dokumentiert werden. Belege sind <strong>5 Jahre aufzubewahren</strong>. F√ºr jeden Bienenstand wird ein separates Blatt gef√ºhrt. Die PDFs k√∂nnen jederzeit ausgedruckt und dem Veterin√§ramt vorgelegt werden.</p>
        </div>
    </div>

    <!-- Imker-Profil -->
    <div class="profil-card animate-in">
        <h2>üë§ Imker-Daten (erscheinen auf dem Bestandsbuch)</h2>
        <div class="profil-grid">
            <div class="profil-field"><label>Bienenhalter/in</label><input type="text" id="imkerName" placeholder="Name"></div>
            <div class="profil-field"><label>Stra√üe & Hausnr.</label><input type="text" id="imkerStrasse" placeholder="Stra√üe Nr."></div>
            <div class="profil-field"><label>PLZ</label><input type="text" id="imkerPLZ" placeholder="PLZ"></div>
            <div class="profil-field"><label>Ort</label><input type="text" id="imkerOrt" placeholder="Ort"></div>
            <div class="profil-field"><label>Telefon</label><input type="text" id="imkerTel" placeholder="Telefon"></div>
            <div class="profil-field"><label>Betriebsnummer</label><input type="text" id="imkerBetrieb" placeholder="08-XXX-XXXX"></div>
        </div>
        <div class="profil-actions">
            <button class="btn btn-primary btn-sm" onclick="saveImkerDaten()">üíæ Daten speichern</button>
            <span id="saveHint" style="font-size:.75rem;color:var(--green);display:none">‚úì Gespeichert</span>
        </div>
    </div>

    <!-- Actions Bar -->
    <div class="actions-bar animate-in">
        <h2>üìÑ Bestandsb√ºcher nach Standort</h2>
        <div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">
            <div class="year-filter">
                <label style="font-size:.8rem;color:var(--text-sub);font-weight:600">Jahr:</label>
                <select id="yearFilter" onchange="localStorage.setItem('bestandsbuch_year',this.value);renderStandorte()"></select>
            </div>
            <div class="btn-group">
                <button class="btn btn-all btn-sm" onclick="alleStandortePDF()">üì• Alle als PDF</button>
            </div>
        </div>
    </div>

    <!-- Standort-Tabellen -->
    <div id="standortContainer"></div>
</div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- PDF Preview Modal -->
<div class="modal-overlay" id="previewModal">
    <div class="modal-box">
        <div class="modal-head">
            <h3 id="previewTitle">PDF Vorschau</h3>
            <button class="modal-close" onclick="closePreview()">‚úï</button>
        </div>
        <div class="modal-body-inner">
            <iframe id="previewFrame"></iframe>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
// ============================================
// BESTANDSBUCH MODULE
// ============================================

let standorte = [];
let voelker = [];
let behandlungen = [];
let profile = null;

const METHODEN_COLORS = {
    'ameisensaeure60':'#ef4444','ameisensaeure85':'#dc2626','oxalsaeure':'#3b82f6',
    'oxalstreifen':'#60a5fa','milchsaeure':'#f59e0b','thymol':'#10b981',
    'brutentnahme':'#8b5cf6','andere':'#7A6652'
};

// ============================================
// AUTH & DATA LOADING
// ============================================
async function init() {
    var { data: { session } } = await sb.auth.getSession();
    if (!session) {
        window.location.href = 'index.html';
        return;
    }
    currentUser = session.user;
    await loadData();
    loadImkerDaten();
    buildYearFilter();
    renderStandorte();
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('appContent').style.display = 'block';
}

async function loadData() {
    var stRes = await sb.from('standorte').select('*').eq('user_id', currentUser.id);
    var vkRes = await sb.from('voelker').select('*').eq('user_id', currentUser.id);
    var bhRes = await sb.from('behandlungen').select('*').eq('user_id', currentUser.id);
    var prRes = { data: null, error: null };
    try {
        var prQuery = await sb.from('profiles').select('*').eq('id', currentUser.id);
        if (prQuery.data && prQuery.data.length > 0) prRes.data = prQuery.data[0];
    } catch(e) { console.warn('[Bestandsbuch] Profile query failed:', e); }
    
    if (stRes.error) console.error('[Bestandsbuch] Standorte Error:', stRes.error);
    if (vkRes.error) console.error('[Bestandsbuch] V√∂lker Error:', vkRes.error);
    if (bhRes.error) console.error('[Bestandsbuch] Behandlungen Error:', bhRes.error);
    if (prRes.error) console.error('[Bestandsbuch] Profile Error:', prRes.error);
    
    console.log('[Bestandsbuch] Raw behandlungen response:', bhRes);
    
    standorte = (stRes.data || []).map(r => ({ id:r.id, name:r.name, notizen:r.notizen, lat:r.lat, lng:r.lng }));
    voelker = (vkRes.data || []).map(r => ({ id:r.id, standortId:r.standort_id, name:r.name, status:r.status }));
    behandlungen = (bhRes.data || []).map(r => ({
        id:r.id, voelkerIds:r.voelker_ids||[], voelkerLabel:r.voelker_label||'',
        methode:r.methode, methodeName:r.methode_name, datum:r.datum,
        intervall:r.intervall, intervallLabel:r.intervall_label, termine:r.termine||[],
        notizen:r.notizen||'', standortId:r.standort_id||null,
        menge:r.menge||'', verabreichung:r.verabreichung||'',
        lieferant:r.lieferant||'', wartezeit:r.wartezeit||'',
        behandler:r.behandler||'', created:r.created_at
    }));
    profile = prRes.data || null;
    console.log('[Bestandsbuch] Geladen:', standorte.length, 'Standorte,', voelker.length, 'V√∂lker,', behandlungen.length, 'Behandlungen');
    if (behandlungen.length > 0) console.log('[Bestandsbuch] Erste Behandlung:', JSON.stringify(behandlungen[0]));
}

// ============================================
// IMKER-DATEN (localStorage f√ºr Bestandsbuch)
// ============================================
function loadImkerDaten() {
    var saved = null;
    try { saved = JSON.parse(localStorage.getItem('bestandsbuch_imker')); } catch(e) {}
    if (saved) {
        document.getElementById('imkerName').value = saved.name || '';
        document.getElementById('imkerStrasse').value = saved.strasse || '';
        document.getElementById('imkerPLZ').value = saved.plz || '';
        document.getElementById('imkerOrt').value = saved.ort || '';
        document.getElementById('imkerTel').value = saved.tel || '';
        document.getElementById('imkerBetrieb').value = saved.betrieb || '';
    } else if (profile) {
        document.getElementById('imkerName').value = profile.name || '';
    }
}

function saveImkerDaten() {
    var data = getImkerData();
    localStorage.setItem('bestandsbuch_imker', JSON.stringify(data));
    var hint = document.getElementById('saveHint');
    hint.style.display = 'inline';
    setTimeout(function() { hint.style.display = 'none'; }, 2000);
    toast('‚úÖ Imker-Daten gespeichert');
}

function getImkerData() {
    return {
        name: document.getElementById('imkerName').value,
        strasse: document.getElementById('imkerStrasse').value,
        plz: document.getElementById('imkerPLZ').value,
        ort: document.getElementById('imkerOrt').value,
        tel: document.getElementById('imkerTel').value,
        betrieb: document.getElementById('imkerBetrieb').value
    };
}

// ============================================
// YEAR FILTER
// ============================================
function buildYearFilter() {
    var years = new Set();
    var currentYear = new Date().getFullYear();
    years.add(currentYear);
    behandlungen.forEach(function(b) {
        b.termine.forEach(function(t) {
            years.add(new Date(t).getFullYear());
        });
    });
    var sel = document.getElementById('yearFilter');
    var sorted = Array.from(years).sort((a,b) => b - a);
    sel.innerHTML = '<option value="alle">Alle Jahre</option>';
    sorted.forEach(function(y) {
        sel.innerHTML += '<option value="'+y+'">'+y+'</option>';
    });
    var saved = localStorage.getItem('bestandsbuch_year');
    if (saved && (saved === 'alle' || sorted.indexOf(parseInt(saved)) !== -1)) {
        sel.value = saved;
    }
}

// ============================================
// STANDORT-ZUORDNUNG
// ============================================
function getStandortForBehandlung(beh) {
    // 1) Direct standort_id
    if (beh.standortId) return [beh.standortId];
    // 2) Derive from voelkerIds - can span multiple standorte
    if (beh.voelkerIds && beh.voelkerIds.length > 0) {
        var standortIds = new Set();
        beh.voelkerIds.forEach(function(vid) {
            var v = voelker.find(function(vk) { return String(vk.id) === String(vid); });
            if (v && v.standortId) standortIds.add(v.standortId);
        });
        if (standortIds.size > 0) return Array.from(standortIds);
    }
    // 3) "Alle V√∂lker" without voelkerIds ‚Üí assign to all standorte
    if (beh.voelkerLabel && beh.voelkerLabel.indexOf('Alle V√∂lker') !== -1) {
        return standorte.map(function(s) { return s.id; });
    }
    return [];
}

function getBehandlungenForStandort(standortId, yearFilter) {
    var sVoelker = voelker.filter(function(v) { return v.standortId === standortId; });
    var sVoelkerIds = sVoelker.map(function(v) { return String(v.id); });
    
    var result = [];
    
    behandlungen.forEach(function(beh) {
        // Check if this behandlung belongs to this standort
        var behStandorte = getStandortForBehandlung(beh);
        var matches = behStandorte.indexOf(standortId) !== -1;
        
        // Also check via voelkerIds overlap
        if (!matches && beh.voelkerIds && beh.voelkerIds.length > 0) {
            matches = beh.voelkerIds.some(function(vid) {
                return sVoelkerIds.indexOf(String(vid)) !== -1;
            });
        }
        
        if (!matches) return;
        
        // Get volk names that belong to THIS standort
        var volkNamen = '';
        if (beh.voelkerIds && beh.voelkerIds.length > 0) {
            volkNamen = beh.voelkerIds.map(function(vid) {
                var v = voelker.find(function(vk) { return String(vk.id) === String(vid); });
                // Only show v√∂lker that belong to this standort
                if (v && v.standortId === standortId) return v.name;
                return '';
            }).filter(Boolean).join(', ');
        }
        if (!volkNamen) volkNamen = beh.voelkerLabel || '‚Äì';
        
        // Create a row for each termin
        (beh.termine || []).forEach(function(termin) {
            var terminDate = new Date(termin);
            // Year filter
            if (yearFilter !== 'alle' && terminDate.getFullYear() !== parseInt(yearFilter)) return;
            
            result.push({
                datum: terminDate.toLocaleDateString('de-DE'),
                datumSort: termin,
                voelker: volkNamen,
                arzneimittel: beh.methodeName || '‚Äì',
                lieferant: beh.lieferant || '‚Äì',
                menge: beh.menge || '‚Äì',
                verabreichung: beh.verabreichung || '‚Äì',
                wartezeit: beh.wartezeit || '‚Äì',
                dauer: beh.intervallLabel || 'Einmalig',
                behandler: beh.behandler || '‚Äì',
                methode: beh.methode
            });
        });
    });
    
    result.sort(function(a, b) { return a.datumSort - b.datumSort; });
    return result;
}

// ============================================
// RENDER
// ============================================
function renderStandorte() {
    var container = document.getElementById('standortContainer');
    var yearFilter = document.getElementById('yearFilter').value;
    var html = '';

    standorte.forEach(function(standort) {
        var sVoelker = voelker.filter(v => v.standortId === standort.id);
        var zeilen = getBehandlungenForStandort(standort.id, yearFilter);

        html += '<div class="standort-section animate-in">';
        html += '<div class="standort-header">';
        html += '<div><h2>üìç ' + standort.name + '</h2></div>';
        html += '<div style="display:flex;align-items:center;gap:.75rem;flex-wrap:wrap">';
        html += '<div class="standort-meta"><span>üêù ' + sVoelker.length + ' V√∂lker</span><span>üíâ ' + zeilen.length + ' Eintr√§ge</span></div>';
        html += '<button class="btn btn-pdf btn-sm" onclick="standortPDF(\'' + standort.id + '\')">üìÑ PDF</button>';
        html += '<button class="btn btn-outline btn-sm" onclick="standortPreview(\'' + standort.id + '\')">üëÅÔ∏è Vorschau</button>';
        html += '</div></div>';

        html += '<div class="table-wrapper">';
        if (zeilen.length === 0) {
            html += '<div class="empty-state"><div class="icon">üìã</div><h3>Keine Behandlungen' + (yearFilter !== 'alle' ? ' in ' + yearFilter : '') + '</h3><p>F√ºr diesen Standort wurden noch keine Behandlungen erfasst.</p></div>';
        } else {
            html += '<table><thead><tr>';
            html += '<th>Nr.</th><th>Datum</th><th>Volkbezeichnung</th>';
            html += '<th>Arzneimittel / Lieferant</th><th>Menge</th>';
            html += '<th>Verabreichung</th><th>Wartezeit</th><th>Behandler</th>';
            html += '</tr></thead><tbody>';

            zeilen.forEach(function(z, idx) {
                var farbe = METHODEN_COLORS[z.methode] || '#7A6652';
                html += '<tr>';
                html += '<td class="nr-cell">' + (idx+1) + '</td>';
                html += '<td class="datum-cell">' + z.datum + '</td>';
                html += '<td style="max-width:160px;font-size:.8rem">' + z.voelker + '</td>';
                html += '<td><span class="methode-badge" style="background:'+farbe+'15;color:'+farbe+'">' + z.arzneimittel + '</span>';
                if (z.lieferant !== '‚Äì') html += '<div style="font-size:.7rem;color:#999;margin-top:.15rem">' + z.lieferant + '</div>';
                html += '</td>';
                html += '<td style="font-size:.8rem">' + z.menge + '</td>';
                html += '<td style="font-size:.8rem">' + z.verabreichung + '</td>';
                html += '<td style="font-size:.8rem">' + z.wartezeit + '</td>';
                html += '<td style="font-size:.8rem">' + z.behandler + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table>';
        }
        html += '</div></div>';
    });

    if (standorte.length === 0) {
        html = '<div class="empty-state" style="padding:3rem"><div class="icon">üìç</div><h3>Keine Standorte vorhanden</h3><p>Lege zuerst Standorte in der <a href="index.html" style="color:var(--honey)">Hauptapp</a> an.</p></div>';
    }

    container.innerHTML = html;
}

// ============================================
// PDF GENERATION
// ============================================
function erzeugeBestandsbuchPDF(standortId, doReturn) {
    if (!window.jspdf) {
        toast('‚è≥ PDF-Bibliothek l√§dt noch... bitte in 2 Sekunden nochmal versuchen.');
        return;
    }
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
    
    var standort = standorte.find(s => s.id === standortId);
    if (!standort) { toast('‚ùå Standort nicht gefunden'); return; }
    
    var sVoelker = voelker.filter(v => v.standortId === standortId);
    var imker = getImkerData();
    var yearFilter = document.getElementById('yearFilter').value;
    var zeilen = getBehandlungenForStandort(standortId, yearFilter);
    var blattNr = standorte.indexOf(standort) + 1;

    var pw = doc.internal.pageSize.getWidth();
    var ph = doc.internal.pageSize.getHeight();

    // === TOP BORDER ===
    doc.setDrawColor(180, 140, 80);
    doc.setLineWidth(0.8);
    doc.line(10, 10, pw - 10, 10);

    // === TITLE ===
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(16);
    doc.setTextColor(28, 20, 16);
    doc.text('Bestandsbuch', 14, 20);

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.setTextColor(100, 80, 60);
    doc.text('√ºber die Anwendung von Arzneimitteln bei Bienenv√∂lkern', 14, 26);

    // Blatt Nr
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.setTextColor(28, 20, 16);
    doc.text('Blatt Nr. ' + blattNr, pw - 14, 20, { align:'right' });

    // === IMKER INFO ===
    doc.setDrawColor(200, 185, 165);
    doc.setLineWidth(0.3);
    doc.roundedRect(14, 30, pw - 28, 22, 2, 2);

    doc.setFontSize(7.5);
    doc.setTextColor(120, 102, 82);
    doc.setFont('helvetica', 'normal');

    var y1 = 36;
    doc.text('Bienenhalter/in:', 18, y1);
    doc.text('Stra√üe:', 90, y1);
    doc.text('PLZ / Ort:', 170, y1);
    doc.text('Tel.:', 230, y1);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.setTextColor(28, 20, 16);
    doc.text(imker.name || '‚Äì', 18, y1 + 6);
    doc.text(imker.strasse || '‚Äì', 90, y1 + 6);
    doc.text((imker.plz || '') + ' ' + (imker.ort || ''), 170, y1 + 6);
    doc.text(imker.tel || '‚Äì', 230, y1 + 6);

    var y2 = y1 + 12;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(7.5);
    doc.setTextColor(120, 102, 82);
    doc.text('Bienenstand:', 18, y2);
    doc.text('Betriebsnummer:', 170, y2);

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9);
    doc.setTextColor(28, 20, 16);
    doc.text(standort.name, 60, y2);
    doc.text(imker.betrieb || '‚Äì', 200, y2);

    doc.setFont('helvetica', 'italic');
    doc.setFontSize(7);
    doc.setTextColor(160, 140, 120);
    doc.text('je Standort ein Blatt', pw - 14, y2, { align:'right' });

    // === TABLE ===
    var tableData = zeilen.map(function(z, idx) {
        return [
            (idx + 1).toString(),
            z.datum,
            z.voelker,
            z.arzneimittel + (z.lieferant !== '‚Äì' ? '\n' + z.lieferant : ''),
            z.menge,
            z.verabreichung,
            z.lieferant !== '‚Äì' ? 'Rechnung\n' + z.lieferant : '‚Äì',
            z.wartezeit,
            z.dauer,
            z.behandler
        ];
    });

    // Fill empty rows
    var minRows = Math.max(15, zeilen.length + 3);
    while (tableData.length < minRows) {
        tableData.push(['', '', '', '', '', '', '', '', '', '']);
    }

    doc.autoTable({
        startY: 56,
        margin: { left:14, right:14 },
        head: [[
            'Nr.', 'Datum', 'Volkbezeichnung',
            'Arzneimittel,\nName/Anschrift Lieferant',
            'Menge', 'Art der\nVerabreichung',
            'Beleg / ggf. Name\nverschr. Tierarzt',
            'Wartezeit', 'Behandlungs-\ndauer',
            'Behandelnde\nPerson'
        ]],
        body: tableData,
        styles: {
            fontSize:7.5, cellPadding:2,
            lineColor:[200,185,165], lineWidth:0.2,
            textColor:[28,20,16], font:'helvetica',
            overflow:'linebreak', valign:'top'
        },
        headStyles: {
            fillColor:[245,237,227], textColor:[100,80,60],
            fontStyle:'bold', fontSize:6.5, cellPadding:3,
            halign:'center', valign:'middle'
        },
        columnStyles: {
            0:{ cellWidth:10, halign:'center', fontStyle:'bold' },
            1:{ cellWidth:20 }, 2:{ cellWidth:35 }, 3:{ cellWidth:45 },
            4:{ cellWidth:22 }, 5:{ cellWidth:30 }, 6:{ cellWidth:35 },
            7:{ cellWidth:28 }, 8:{ cellWidth:22 }, 9:{ cellWidth:22 }
        },
        alternateRowStyles: { fillColor:[252,249,245] },
        didParseCell: function(data) {
            if (data.section === 'body' && data.column.index === 0 && data.cell.text[0]) {
                data.cell.styles.textColor = [180, 140, 80];
            }
        }
    });

    // === FOOTER ===
    doc.setFont('helvetica', 'italic');
    doc.setFontSize(6.5);
    doc.setTextColor(160, 140, 120);
    doc.text(
        'laut Verordnung (EU) 2019/6 des Europ√§ischen Parlaments und des Rates vom 11. Dezember 2018 √ºber Tierarzneimittel | ¬ß 108 (2) Beleg 5 Jahre aufbewahren.',
        pw / 2, ph - 8, { align:'center' }
    );

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(6);
    doc.text('Erstellt am: ' + new Date().toLocaleDateString('de-DE') + ' ¬∑ ImkereiCloud', 14, ph - 8);
    doc.text('Seite 1', pw - 14, ph - 8, { align:'right' });

    doc.setDrawColor(180, 140, 80);
    doc.setLineWidth(0.4);
    doc.line(10, ph - 12, pw - 10, ph - 12);

    if (doReturn) return doc;

    var dateiname = 'Bestandsbuch_' + standort.name.replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü ]/g, '').replace(/ /g, '_') + '_' + (yearFilter !== 'alle' ? yearFilter : new Date().getFullYear()) + '.pdf';
    doc.save(dateiname);
    toast('‚úÖ PDF heruntergeladen: ' + dateiname);
}

function standortPDF(id) {
    erzeugeBestandsbuchPDF(id, false);
}

function standortPreview(id) {
    var doc = erzeugeBestandsbuchPDF(id, true);
    if (!doc) return;
    var blob = doc.output('blob');
    var url = URL.createObjectURL(blob);
    var standort = standorte.find(s => s.id === id);
    document.getElementById('previewTitle').textContent = 'Bestandsbuch ‚Äì ' + (standort ? standort.name : '');
    document.getElementById('previewFrame').src = url;
    document.getElementById('previewModal').classList.add('active');
}

function closePreview() {
    document.getElementById('previewModal').classList.remove('active');
    document.getElementById('previewFrame').src = '';
}

function alleStandortePDF() {
    if (standorte.length === 0) { toast('‚ö†Ô∏è Keine Standorte vorhanden'); return; }
    if (!window.jspdf) { toast('‚è≥ PDF-Bibliothek l√§dt noch...'); return; }
    
    var jsPDF = window.jspdf.jsPDF;
    var combined = null;
    var yearFilter = document.getElementById('yearFilter').value;
    
    standorte.forEach(function(s, idx) {
        var singleDoc = erzeugeBestandsbuchPDF(s.id, true);
        if (!singleDoc) return;
        
        if (idx === 0) {
            combined = singleDoc;
        } else {
            // Seiten aus dem Einzel-PDF in das Gesamt-PDF kopieren
            var pageCount = singleDoc.internal.getNumberOfPages();
            for (var p = 1; p <= pageCount; p++) {
                combined.addPage('a4', 'landscape');
                // Neues PDF f√ºr diesen Standort erzeugen und als Inhalt einf√ºgen
            }
            // Einfacher Ansatz: jedes Standort-PDF separat erzeugen und in combined einf√ºgen
            // Da jsPDF kein page-merging kann, erzeugen wir alles direkt in einem Doc
        }
    });
    
    // Besserer Ansatz: Alles in einem Dokument erzeugen
    combined = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
    var imker = getImkerData();
    
    standorte.forEach(function(s, idx) {
        if (idx > 0) combined.addPage('a4', 'landscape');
        
        var sVoelker = voelker.filter(function(v){ return v.standortId === s.id; });
        var zeilen = getBehandlungenForStandort(s.id, yearFilter);
        var blattNr = idx + 1;
        var pw = combined.internal.pageSize.getWidth();
        var ph = combined.internal.pageSize.getHeight();
        
        // TOP BORDER
        combined.setDrawColor(180, 140, 80);
        combined.setLineWidth(0.8);
        combined.line(10, 10, pw - 10, 10);
        
        // TITLE
        combined.setFont('helvetica', 'bold');
        combined.setFontSize(16);
        combined.setTextColor(28, 20, 16);
        combined.text('Bestandsbuch', 14, 20);
        
        combined.setFont('helvetica', 'normal');
        combined.setFontSize(9);
        combined.setTextColor(100, 80, 60);
        combined.text('√ºber die Anwendung von Arzneimitteln bei Bienenv√∂lkern', 14, 26);
        
        combined.setFont('helvetica', 'bold');
        combined.setFontSize(10);
        combined.setTextColor(28, 20, 16);
        combined.text('Blatt Nr. ' + blattNr, pw - 14, 20, { align:'right' });
        
        // IMKER INFO
        combined.setDrawColor(200, 185, 165);
        combined.setLineWidth(0.3);
        combined.roundedRect(14, 30, pw - 28, 22, 2, 2);
        
        combined.setFontSize(7.5);
        combined.setTextColor(120, 102, 82);
        combined.setFont('helvetica', 'normal');
        
        var y1 = 36;
        combined.text('Bienenhalter/in:', 18, y1);
        combined.text('Stra√üe:', 90, y1);
        combined.text('PLZ / Ort:', 170, y1);
        combined.text('Tel.:', 230, y1);
        
        combined.setFont('helvetica', 'bold');
        combined.setFontSize(9);
        combined.setTextColor(28, 20, 16);
        combined.text(imker.name || '‚Äì', 18, y1 + 6);
        combined.text(imker.strasse || '‚Äì', 90, y1 + 6);
        combined.text((imker.plz || '') + ' ' + (imker.ort || ''), 170, y1 + 6);
        combined.text(imker.tel || '‚Äì', 230, y1 + 6);
        
        var y2 = y1 + 12;
        combined.setFont('helvetica', 'normal');
        combined.setFontSize(7.5);
        combined.setTextColor(120, 102, 82);
        combined.text('Bienenstand:', 18, y2);
        combined.text('Betriebsnummer:', 170, y2);
        
        combined.setFont('helvetica', 'bold');
        combined.setFontSize(9);
        combined.setTextColor(28, 20, 16);
        combined.text(s.name, 60, y2);
        combined.text(imker.betrieb || '‚Äì', 200, y2);
        
        combined.setFont('helvetica', 'italic');
        combined.setFontSize(7);
        combined.setTextColor(160, 140, 120);
        combined.text('je Standort ein Blatt', pw - 14, y2, { align:'right' });
        
        // TABLE
        var tableData = zeilen.map(function(z, i) {
            return [
                (i + 1).toString(), z.datum, z.voelker,
                z.arzneimittel + (z.lieferant !== '‚Äì' ? '\n' + z.lieferant : ''),
                z.menge, z.verabreichung,
                z.lieferant !== '‚Äì' ? 'Rechnung\n' + z.lieferant : '‚Äì',
                z.wartezeit, z.dauer, z.behandler
            ];
        });
        var minRows = Math.max(15, zeilen.length + 3);
        while (tableData.length < minRows) {
            tableData.push(['', '', '', '', '', '', '', '', '', '']);
        }
        
        combined.autoTable({
            startY: 56,
            margin: { left:14, right:14 },
            head: [['Nr.', 'Datum', 'Volkbezeichnung', 'Arzneimittel,\nName/Anschrift Lieferant', 'Menge', 'Art der\nVerabreichung', 'Beleg / ggf. Name\nverschr. Tierarzt', 'Wartezeit', 'Behandlungs-\ndauer', 'Behandelnde\nPerson']],
            body: tableData,
            styles: { fontSize:7.5, cellPadding:2, lineColor:[200,185,165], lineWidth:0.2, textColor:[28,20,16], font:'helvetica', overflow:'linebreak', valign:'top' },
            headStyles: { fillColor:[245,237,227], textColor:[100,80,60], fontStyle:'bold', fontSize:6.5, cellPadding:3, halign:'center', valign:'middle' },
            columnStyles: { 0:{cellWidth:10,halign:'center',fontStyle:'bold'}, 1:{cellWidth:20}, 2:{cellWidth:35}, 3:{cellWidth:45}, 4:{cellWidth:22}, 5:{cellWidth:30}, 6:{cellWidth:35}, 7:{cellWidth:28}, 8:{cellWidth:22}, 9:{cellWidth:22} },
            alternateRowStyles: { fillColor:[252,249,245] },
            didParseCell: function(data) {
                if (data.section === 'body' && data.column.index === 0 && data.cell.text[0]) {
                    data.cell.styles.textColor = [180, 140, 80];
                }
            }
        });
        
        // FOOTER
        combined.setFont('helvetica', 'italic');
        combined.setFontSize(6.5);
        combined.setTextColor(160, 140, 120);
        combined.text('laut Verordnung (EU) 2019/6 des Europ√§ischen Parlaments und des Rates vom 11. Dezember 2018 √ºber Tierarzneimittel | ¬ß 108 (2) Beleg 5 Jahre aufbewahren.', pw / 2, ph - 8, { align:'center' });
        
        combined.setFont('helvetica', 'normal');
        combined.setFontSize(6);
        combined.text('Erstellt am: ' + new Date().toLocaleDateString('de-DE') + ' ¬∑ ImkereiCloud', 14, ph - 8);
        combined.text('Seite ' + (idx + 1) + ' von ' + standorte.length, pw - 14, ph - 8, { align:'right' });
        
        combined.setDrawColor(180, 140, 80);
        combined.setLineWidth(0.4);
        combined.line(10, ph - 12, pw - 10, ph - 12);
    });
    
    var dateiname = 'Bestandsbuch_Alle_Standorte_' + (yearFilter !== 'alle' ? yearFilter : new Date().getFullYear()) + '.pdf';
    combined.save(dateiname);
    toast('‚úÖ PDF mit ' + standorte.length + ' Standorten heruntergeladen');
}

// Toast
function toast(msg) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(function() { el.classList.remove('show'); }, 2500);
}

// Modal close on overlay
document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) closePreview();
});

// ============================================
// INIT
// ============================================
init();
</script>
</body>
</html>
