<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêù Imkermeister</title>
    <meta name="theme-color" content="#1f2937">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f3f4f6; min-height:100vh; }
        
        .login-screen {
            display:flex; align-items:center; justify-content:center; min-height:100vh;
            background:linear-gradient(135deg,#1f2937,#374151);
        }
        .login-box {
            background:#fff; padding:2rem; border-radius:1rem; width:90%; max-width:400px;
            box-shadow:0 4px 20px rgba(0,0,0,.2);
        }
        .login-box h1 { text-align:center; margin-bottom:1.5rem; font-size:1.5rem; }
        .login-box input {
            width:100%; padding:.75rem; border:2px solid #e5e7eb; border-radius:.5rem;
            font-size:1rem; margin-bottom:1rem;
        }
        .login-box button {
            width:100%; padding:.75rem; background:#FFC107; color:#1f2937; border:none;
            border-radius:.5rem; font-size:1rem; font-weight:bold; cursor:pointer;
        }
        .login-box button:hover { background:#f59e0b; }
        .login-error { color:#ef4444; font-size:.85rem; text-align:center; margin-top:.5rem; display:none; }
        
        .admin-container { display:none; }
        .header {
            background:linear-gradient(135deg,#1f2937,#374151); color:#fff;
            padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center;
        }
        .header h1 { font-size:1.25rem; }
        .header a { color:#FFC107; text-decoration:none; font-size:.85rem; }
        
        .container { max-width:900px; margin:0 auto; padding:1.5rem; }
        .card {
            background:#fff; border-radius:.75rem; padding:1.25rem;
            box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:1rem;
        }
        .stats-grid {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
            gap:1rem; margin-bottom:1.5rem;
        }
        .stat-card {
            background:#fff; border-radius:.75rem; padding:1.25rem; text-align:center;
            box-shadow:0 1px 3px rgba(0,0,0,.1);
        }
        .stat-number { font-size:2rem; font-weight:bold; color:#FFC107; }
        .stat-label { font-size:.8rem; color:#6b7280; margin-top:.25rem; }
        
        table { width:100%; border-collapse:collapse; font-size:.9rem; }
        th { text-align:left; padding:.75rem; background:#f9fafb; border-bottom:2px solid #e5e7eb; font-size:.8rem; color:#6b7280; text-transform:uppercase; }
        td { padding:.75rem; border-bottom:1px solid #f3f4f6; }
        tr:hover { background:#f9fafb; }
        
        .btn { padding:.5rem 1rem; border:none; border-radius:.5rem; cursor:pointer; font-size:.8rem; font-weight:600; }
        .btn-danger { background:#fee2e2; color:#ef4444; }
        .btn-danger:hover { background:#fecaca; }
        .btn-blue { background:#dbeafe; color:#3b82f6; }
        .btn-blue:hover { background:#bfdbfe; }
        
        .badge { display:inline-block; padding:.15rem .5rem; border-radius:.25rem; font-size:.7rem; font-weight:600; }
        .badge-green { background:#d1fae5; color:#059669; }
        .badge-gray { background:#f3f4f6; color:#6b7280; }
        
        .tab-bar { display:flex; gap:.5rem; margin-bottom:1.5rem; border-bottom:2px solid #e5e7eb; padding-bottom:.5rem; }
        .tab { padding:.5rem 1rem; border-radius:.5rem .5rem 0 0; cursor:pointer; font-weight:600; color:#6b7280; font-size:.9rem; }
        .tab.active { color:#FFC107; border-bottom:3px solid #FFC107; }
        .tab:hover { color:#1f2937; }
        
        .search-input {
            width:100%; padding:.625rem 1rem; border:2px solid #e5e7eb; border-radius:.5rem;
            font-size:.9rem; margin-bottom:1rem;
        }
        
        @media(max-width:600px) {
            .stats-grid { grid-template-columns:repeat(2,1fr); }
            table { font-size:.8rem; }
            td, th { padding:.5rem; }
        }
    </style>
</head>
<body>

<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h1>üêù Imkermeister</h1>
        <input type="password" id="adminPw" placeholder="Passwort eingeben" onkeydown="if(event.key==='Enter')checkLogin()">
        <button onclick="checkLogin()">Anmelden</button>
        <div class="login-error" id="loginError">Falsches Passwort</div>
    </div>
</div>

<div class="admin-container" id="adminContainer">
    <div class="header">
        <h1>üêù Imkermeister ‚Äì Admin</h1>
        <a href="index.html">‚Üê Zur App</a>
    </div>
    
    <div class="container">
        <div class="stats-grid" id="statsGrid"></div>
        
        <div class="tab-bar">
            <div class="tab active" onclick="showTab('users')">üë• Benutzer</div>
            <div class="tab" onclick="showTab('trachten')">üå∏ Geteilte Trachten</div>
            <div class="tab" onclick="showTab('data')">üìä Daten</div>
        </div>
        
        <div id="tabUsers">
            <input type="text" class="search-input" placeholder="üîç Benutzer suchen..." oninput="filterUsers(this.value)">
            <div class="card" style="overflow-x:auto">
                <table>
                    <thead>
                        <tr><th>E-Mail</th><th>Registriert</th><th>Letzter Login</th><th>Status</th><th>Aktionen</th></tr>
                    </thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>
        
        <div id="tabTrachten" style="display:none">
            <div class="card" style="overflow-x:auto">
                <table>
                    <thead>
                        <tr><th>Typ</th><th>Standort</th><th>Imker</th><th>Position</th><th>Zeitraum</th><th>Aktionen</th></tr>
                    </thead>
                    <tbody id="trachtenTable"></tbody>
                </table>
            </div>
        </div>
        
        <div id="tabData" style="display:none">
            <div class="card" id="dataOverview"></div>
        </div>
    </div>
</div>

<script>
const ADMIN_PW_HASH = '5a9d4c2f8b1e3d7a'; // Simple hash of password
const SUPABASE_URL = "https://reyswuedptkyfdkmdpft.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJleXN3dWVkcHRreWZka21kcGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjM0MDQsImV4cCI6MjA4NzQzOTQwNH0.mrqs7lPs3S7B62sKpTbuzuxAcodil04RQ7HUjuQHuKI";
var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
});

var allUsers = [];
var allTrachten = [];
var allData = {};

function checkLogin() {
    var pw = document.getElementById('adminPw').value;
    if (pw === 'Veronika4701') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminContainer').style.display = 'block';
        loadAdmin();
    } else {
        document.getElementById('loginError').style.display = 'block';
        setTimeout(function(){ document.getElementById('loginError').style.display = 'none'; }, 2000);
    }
}

function showTab(name) {
    document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
    document.getElementById('tabUsers').style.display = name === 'users' ? 'block' : 'none';
    document.getElementById('tabTrachten').style.display = name === 'trachten' ? 'block' : 'none';
    document.getElementById('tabData').style.display = name === 'data' ? 'block' : 'none';
    event.target.classList.add('active');
}

function fd(d) {
    if (!d) return '‚Äì';
    return new Date(d).toLocaleDateString('de-DE', {day:'numeric', month:'short', year:'numeric'});
}

function timeAgo(d) {
    if (!d) return 'Nie';
    var diff = Date.now() - new Date(d).getTime();
    var mins = Math.floor(diff/60000);
    if (mins < 60) return mins + ' Min. her';
    var hours = Math.floor(mins/60);
    if (hours < 24) return hours + ' Std. her';
    var days = Math.floor(hours/24);
    if (days < 30) return days + ' Tage her';
    return fd(d);
}

async function loadAdmin() {
    // Load users from profiles table
    var profilesResult = await sb.from('profiles').select('*');
    var profiles = profilesResult.data || [];
    
    // Load shared trachten
    var trachtenResult = await sb.from('trachten_shared').select('*').order('created_at', {ascending: false});
    allTrachten = trachtenResult.data || [];
    
    // Load data counts per user
    var standorteResult = await sb.from('standorte').select('user_id');
    var voelkerResult = await sb.from('voelker').select('user_id');
    var aufgabenResult = await sb.from('aufgaben').select('user_id');
    var trachtenPrivResult = await sb.from('trachten').select('user_id');
    var behandlungenResult = await sb.from('behandlungen').select('user_id');
    
    var standorte = standorteResult.data || [];
    var voelker = voelkerResult.data || [];
    var aufgaben = aufgabenResult.data || [];
    var trachtenPriv = trachtenPrivResult.data || [];
    var behandlungen = behandlungenResult.data || [];
    
    // Build user list from profiles
    allUsers = profiles.map(function(p) {
        var uid = p.user_id;
        return {
            id: uid,
            email: p.email || '‚Äì',
            name: p.name || '',
            created: p.created_at,
            lastLogin: p.last_login,
            standorte: standorte.filter(function(x){return x.user_id===uid;}).length,
            voelker: voelker.filter(function(x){return x.user_id===uid;}).length,
            aufgaben: aufgaben.filter(function(x){return x.user_id===uid;}).length,
            trachten: trachtenPriv.filter(function(x){return x.user_id===uid;}).length,
            behandlungen: behandlungen.filter(function(x){return x.user_id===uid;}).length
        };
    });
    
    allData = {
        totalStandorte: standorte.length,
        totalVoelker: voelker.length,
        totalAufgaben: aufgaben.length,
        totalTrachten: trachtenPriv.length,
        totalBehandlungen: behandlungen.length,
        totalShared: allTrachten.length
    };
    
    renderStats();
    renderUsers(allUsers);
    renderTrachten();
    renderDataOverview();
}

function renderStats() {
    document.getElementById('statsGrid').innerHTML = 
        '<div class="stat-card"><div class="stat-number">'+allUsers.length+'</div><div class="stat-label">üë• Benutzer</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+allData.totalStandorte+'</div><div class="stat-label">üìç Standorte</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+allData.totalVoelker+'</div><div class="stat-label">üêù V√∂lker</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+allData.totalTrachten+'</div><div class="stat-label">üå∏ Trachten</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+allData.totalBehandlungen+'</div><div class="stat-label">üíâ Behandlungen</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+allData.totalShared+'</div><div class="stat-label">üó∫Ô∏è Geteilte Trachten</div></div>';
}

function renderUsers(users) {
    var html = '';
    users.forEach(function(u) {
        html += '<tr>'+
            '<td><strong>'+u.email+'</strong>'+(u.name ? '<br><span style="font-size:.75rem;color:#6b7280">'+u.name+'</span>' : '')+'</td>'+
            '<td>'+fd(u.created)+'</td>'+
            '<td>'+(u.lastLogin ? timeAgo(u.lastLogin) : 'Nie')+'</td>'+
            '<td><span class="badge badge-green">Aktiv</span></td>'+
            '<td>'+
            '<span style="font-size:.75rem;color:#6b7280">üìç'+u.standorte+' üêù'+u.voelker+' üå∏'+u.trachten+'</span><br>'+
            '<button class="btn btn-danger" style="margin-top:.25rem" onclick="deleteUserData(\''+u.id+'\',\''+u.email+'\')">üóëÔ∏è Daten l√∂schen</button>'+
            '</td>'+
            '</tr>';
    });
    document.getElementById('usersTable').innerHTML = html || '<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:2rem">Keine Benutzer</td></tr>';
}

function filterUsers(query) {
    var q = query.toLowerCase();
    var filtered = allUsers.filter(function(u) {
        return u.email.toLowerCase().indexOf(q) !== -1 || (u.name && u.name.toLowerCase().indexOf(q) !== -1);
    });
    renderUsers(filtered);
}

function renderTrachten() {
    var html = '';
    allTrachten.forEach(function(t) {
        html += '<tr>'+
            '<td><strong>'+t.typ+'</strong></td>'+
            '<td>'+t.standort+'</td>'+
            '<td>'+t.user_name+'</td>'+
            '<td style="font-size:.75rem">'+(t.lat ? t.lat.toFixed(4)+', '+t.lng.toFixed(4) : '‚Äì')+'</td>'+
            '<td style="font-size:.75rem">'+fd(t.beginn)+(t.ende ? ' ‚Üí '+fd(t.ende) : '')+'</td>'+
            '<td><button class="btn btn-danger" onclick="deleteSharedTracht(\''+t.id+'\')">üóëÔ∏è</button></td>'+
            '</tr>';
    });
    document.getElementById('trachtenTable').innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:#6b7280;padding:2rem">Keine geteilten Trachten</td></tr>';
}

function renderDataOverview() {
    var html = '<h3 style="margin-bottom:1rem">üìä Daten pro Benutzer</h3>';
    allUsers.forEach(function(u) {
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid #f3f4f6">'+
            '<div><strong>'+u.email+'</strong></div>'+
            '<div style="display:flex;gap:1rem;font-size:.8rem;color:#6b7280">'+
            '<span>üìç '+u.standorte+'</span>'+
            '<span>üêù '+u.voelker+'</span>'+
            '<span>üå∏ '+u.trachten+'</span>'+
            '<span>üíâ '+u.behandlungen+'</span>'+
            '<span>‚úì '+u.aufgaben+'</span>'+
            '</div></div>';
    });
    document.getElementById('dataOverview').innerHTML = html;
}

async function deleteSharedTracht(id) {
    if (!confirm('Diese geteilte Tracht wirklich l√∂schen?')) return;
    await sb.from('trachten_shared').delete().eq('id', id);
    allTrachten = allTrachten.filter(function(t){return t.id !== id;});
    renderTrachten();
    renderStats();
}

async function deleteUserData(userId, email) {
    if (!confirm('ACHTUNG: Alle Daten von "'+email+'" werden gel√∂scht!\n\n(Standorte, V√∂lker, Aufgaben, Trachten, Behandlungen, Kosten, Packliste)\n\nDer Account selbst bleibt bestehen. Um den Account zu l√∂schen, gehe in Supabase ‚Üí Authentication ‚Üí Users.\n\nFortfahren?')) return;
    
    // Alle Daten des Users l√∂schen
    await sb.from('packliste').delete().eq('user_id', userId);
    await sb.from('behandlungen').delete().eq('user_id', userId);
    await sb.from('trachten').delete().eq('user_id', userId);
    await sb.from('trachten_shared').delete().eq('user_id', userId);
    await sb.from('aufgaben').delete().eq('user_id', userId);
    await sb.from('kosten').delete().eq('user_id', userId);
    await sb.from('voelker').delete().eq('user_id', userId);
    await sb.from('standorte').delete().eq('user_id', userId);
    
    alert('Alle Daten von "'+email+'" wurden gel√∂scht.');
    loadAdmin();
}
</script>
</body>
</html>
