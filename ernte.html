<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üçØ Honigernte ‚Äì Imkerei Tagesplaner</title>
    <meta name="theme-color" content="#F5A623">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* === ERNTE-SPECIFIC STYLES === */
        body{padding-left:220px;padding-bottom:2rem}
        .container{max-width:800px;margin:0 auto;padding:1rem}
        
        .nav{position:fixed;left:0;top:0;bottom:0;width:220px;background:#FFFBF0;border-right:2px solid rgba(245,166,35,0.12);display:flex;flex-direction:column;padding:0;z-index:50;overflow-y:auto}
        .nav-brand{padding:1.25rem 1rem;border-bottom:2px solid rgba(245,166,35,0.12)}
        .nav-section{font-size:.65rem;font-weight:700;color:#A69580;text-transform:uppercase;letter-spacing:.08em;padding:.75rem 1rem .25rem}
        .nav-item{display:block;padding:.625rem 1rem;text-align:left;cursor:pointer;border:none;background:none;color:#7A6652;font-size:.85rem;border-left:4px solid transparent;transition:all .15s;width:100%;text-decoration:none}
        .nav-item:hover{background:rgba(245,166,35,0.06)}
        .nav-item.active{color:#92400E;font-weight:600;border-left-color:#F5A623;background:#FFF8EE}
        
        .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#1C1410;color:#fff;padding:.75rem 1.5rem;border-radius:999px;font-size:.85rem;z-index:9999;display:none;animation:fadeIn .3s}
        
        @media(max-width:768px){
            body{padding-left:0;padding-bottom:90px}
            .nav{left:0;right:0;top:auto;bottom:0;width:100%;height:auto;flex-direction:row;border-right:none;border-top:2px solid rgba(245,166,35,0.12);overflow-x:auto;overflow-y:hidden}
            .nav-brand,.nav-section{display:none}
            .nav-item{flex:0 0 auto;padding:.5rem .6rem;font-size:.6rem;text-align:center;border-left:none;border-bottom:3px solid transparent;white-space:nowrap}
            .nav-item.active{border-left:none;border-bottom-color:#F5A623}
        }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand">
        <div style="font-size:1.5rem;font-weight:bold;color:#F5A623">üêù</div>
        <div style="font-size:.85rem;font-weight:600;color:#1C1410;margin-top:.25rem">Imkerei</div>
        <div style="font-size:.7rem;color:#7A6652">Cloud v6.0</div>
    </div>
    <div class="nav-section">√úbersicht</div>
    <a href="index.html#heute" class="nav-item">üìÖ Heute</a>
    <a href="index.html#standorte" class="nav-item">üìç Standorte</a>
    <a href="index.html#aufgaben" class="nav-item">üìù Aufgaben</a>
    <div class="nav-section">V√∂lker</div>
    <a href="index.html#koeniginnen" class="nav-item">üëë K√∂niginnenzucht</a>
    <a href="index.html#behandlung" class="nav-item">üíâ Behandlungen</a>
    <a href="bewertung.html" class="nav-item">‚≠ê V√∂lker-Bewertung</a>
    <a href="assistent.html" class="nav-item">ü§ñ Assistent</a>
    <a href="bestandsbuch.html" class="nav-item">üìã Bestandsbuch</a>
    <div class="nav-section">Ernte & Planung</div>
    <a href="ernte.html" class="nav-item active">üçØ Honigernte</a>
    <a href="index.html#tracht" class="nav-item">üå∏ Tracht</a>
    <a href="index.html#packliste" class="nav-item">üì¶ Packliste</a>
    <div class="nav-section">Verwaltung</div>
    <a href="index.html#kosten" class="nav-item">üí∞ Kosten</a>
    <div style="flex:1"></div>
    <a href="index.html#einstellungen" class="nav-item">‚öôÔ∏è Einstellungen</a>
</nav>

<div id="loadingOverlay" style="display:flex;justify-content:center;align-items:center;min-height:50vh">
    <div style="text-align:center;color:#7A6652">
        <div style="font-size:3rem;margin-bottom:1rem">üçØ</div>
        <div>Lade Erntedaten...</div>
    </div>
</div>

<div id="app" style="display:none"></div>

<div id="toast" class="toast"></div>

<!-- Ernte erfassen Modal -->
<div id="ernteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="ernteModalTitle">üçØ Ernte erfassen</h2>
            <button class="close-btn" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="date" id="ernteDatum" class="input">
            </div>
            <div class="form-group">
                <label class="form-label">Standort</label>
                <select id="ernteStandort" class="input" onchange="updateVoelkerSelect()">
                    <option value="">-- Alle Standorte --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Volk (optional)</label>
                <select id="ernteVolk" class="input">
                    <option value="">-- Ganzer Standort --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Menge (kg)</label>
                <input type="number" id="ernteMenge" class="input" step="0.1" min="0.1" placeholder="z.B. 12.5">
            </div>
            <div class="form-group">
                <label class="form-label">Honigsorte (optional)</label>
                <div style="display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.5rem">
                    <button type="button" class="btn btn-sm" style="background:#FFF8EE;border:1px solid #E8DFD4" onclick="document.getElementById('ernteSorte').value=this.textContent">Bl√ºte</button>
                    <button type="button" class="btn btn-sm" style="background:#FFF8EE;border:1px solid #E8DFD4" onclick="document.getElementById('ernteSorte').value=this.textContent">Linde</button>
                    <button type="button" class="btn btn-sm" style="background:#FFF8EE;border:1px solid #E8DFD4" onclick="document.getElementById('ernteSorte').value=this.textContent">Wald</button>
                    <button type="button" class="btn btn-sm" style="background:#FFF8EE;border:1px solid #E8DFD4" onclick="document.getElementById('ernteSorte').value=this.textContent">Raps</button>
                    <button type="button" class="btn btn-sm" style="background:#FFF8EE;border:1px solid #E8DFD4" onclick="document.getElementById('ernteSorte').value=this.textContent">Akazie</button>
                    <button type="button" class="btn btn-sm" style="background:#FFF8EE;border:1px solid #E8DFD4" onclick="document.getElementById('ernteSorte').value=this.textContent">Sommer</button>
                </div>
                <input type="text" id="ernteSorte" class="input" placeholder="z.B. Fr√ºhtracht, Sommerhonig...">
            </div>
            <div class="form-group">
                <label class="form-label">Notizen (optional)</label>
                <textarea id="ernteNotizen" class="input" rows="2" placeholder="z.B. Wassergehalt, Besonderheiten..."></textarea>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="saveErnte()">üíæ Ernte speichern</button>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
// ============================================
// ERNTE MODULE
// ============================================
var standorte = [];
var voelker = [];
var ernten = [];
var editId = null;
var activeTab = 'erfassung';
var selectedYear = new Date().getFullYear();

// ============================================
// INIT
// ============================================
async function init() {
    var { data: { session } } = await sb.auth.getSession();
    if (!session) { window.location.href = 'index.html'; return; }
    currentUser = session.user;
    
    var results = await Promise.all([
        sb.from('standorte').select('*').eq('user_id', currentUser.id),
        sb.from('voelker').select('*').eq('user_id', currentUser.id),
        sb.from('ernten').select('*').eq('user_id', currentUser.id).order('datum', {ascending: false})
    ]);
    
    standorte = (results[0].data || []).map(function(r){
        return {id:r.id, name:r.name, lat:r.lat, lng:r.lng};
    });
    voelker = (results[1].data || []).map(function(r){
        return {id:r.id, standortId:r.standort_id, name:r.name};
    });
    ernten = (results[2].data || []).map(function(r){
        return {id:r.id, datum:r.datum, standortId:r.standort_id, standortName:r.standort_name, volkId:r.volk_id, volkName:r.volk_name, menge:parseFloat(r.menge)||0, sorte:r.sorte||'', notizen:r.notizen||'', created:r.created_at};
    });
    
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    render();
}

// ============================================
// RENDER
// ============================================
function render() {
    var html = '<div class="container">';
    
    // Tab-Bar
    html += '<div class="tab-bar">';
    html += '<button class="tab-btn '+(activeTab==='erfassung'?'active':'')+'" onclick="activeTab=\'erfassung\';render()">üçØ Erfassung</button>';
    html += '<button class="tab-btn '+(activeTab==='archiv'?'active':'')+'" onclick="activeTab=\'archiv\';render()">üìä Archiv</button>';
    html += '</div>';
    
    if (activeTab === 'erfassung') {
        html += renderErfassung();
    } else {
        html += renderArchiv();
    }
    
    html += '</div>';
    document.getElementById('app').innerHTML = html;
}

// ============================================
// TAB: ERFASSUNG
// ============================================
function renderErfassung() {
    var jahr = new Date().getFullYear();
    var erntenJahr = ernten.filter(function(e){ return e.datum && e.datum.startsWith(String(jahr)); });
    var gesamt = erntenJahr.reduce(function(s,e){return s+e.menge;}, 0);
    
    var html = '';
    
    // Gesamtertrag
    html += '<div class="card" style="text-align:center">';
    html += '<h3 style="margin-bottom:.75rem">Gesamtertrag '+jahr+'</h3>';
    html += '<div style="font-size:3rem;font-weight:bold;color:#F5A623">'+gesamt.toFixed(1)+' kg</div>';
    html += '<div style="font-size:.85rem;color:#7A6652;margin-top:.5rem">'+erntenJahr.length+' Ernten erfasst</div>';
    html += '<button class="btn btn-primary" style="margin-top:1rem" onclick="openModal()">+ Neue Ernte erfassen</button>';
    html += '</div>';
    
    // Ertrag nach Standort
    if (erntenJahr.length > 0) {
        var nachStandort = {};
        erntenJahr.forEach(function(e){
            var key = e.standortName || 'Unbekannt';
            if (!nachStandort[key]) nachStandort[key] = 0;
            nachStandort[key] += e.menge;
        });
        
        html += '<div class="card">';
        html += '<h3 style="margin-bottom:.75rem">Nach Standort</h3>';
        Object.keys(nachStandort).sort(function(a,b){return nachStandort[b]-nachStandort[a];}).forEach(function(name){
            var kg = nachStandort[name];
            var pct = gesamt > 0 ? (kg/gesamt*100) : 0;
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid #FFFBF0">';
            html += '<div style="flex:1"><div style="font-weight:600">üìç '+name+'</div>';
            html += '<div style="background:#E8DFD4;height:.375rem;border-radius:.25rem;margin-top:.25rem;max-width:200px">';
            html += '<div style="background:#F5A623;height:100%;border-radius:.25rem;width:'+pct+'%"></div></div></div>';
            html += '<div style="font-weight:bold;color:#F5A623">'+kg.toFixed(1)+' kg</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // Letzte Ernten
    html += '<div class="card">';
    html += '<h3 style="margin-bottom:.75rem">Letzte Ernten</h3>';
    
    if (erntenJahr.length === 0) {
        html += '<div style="text-align:center;padding:1.5rem;color:#7A6652">Noch keine Ernten in '+jahr+' erfasst</div>';
    } else {
        erntenJahr.slice(0, 20).forEach(function(e){
            var datum = new Date(e.datum).toLocaleDateString('de-DE',{day:'2-digit',month:'short',year:'numeric'});
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.625rem 0;border-bottom:1px solid #FFFBF0">';
            html += '<div>';
            html += '<div style="font-weight:600">'+e.menge.toFixed(1)+' kg'+(e.sorte?' ¬∑ '+e.sorte:'')+'</div>';
            html += '<div style="font-size:.75rem;color:#7A6652">'+datum+' ¬∑ üìç '+(e.standortName||'?')+(e.volkName?' ¬∑ üêù '+e.volkName:'')+'</div>';
            if (e.notizen) html += '<div style="font-size:.75rem;color:#94a3b8;margin-top:.125rem">'+e.notizen+'</div>';
            html += '</div>';
            html += '<div style="display:flex;gap:.25rem">';
            html += '<button class="btn btn-blue btn-xs" onclick="editErnte(\''+e.id+'\')">‚úèÔ∏è</button>';
            html += '<button class="btn btn-danger btn-xs" onclick="deleteErnte(\''+e.id+'\')">üóëÔ∏è</button>';
            html += '</div></div>';
        });
    }
    html += '</div>';
    
    return html;
}

// ============================================
// TAB: ARCHIV
// ============================================
function renderArchiv() {
    // Alle Jahre ermitteln
    var jahre = {};
    ernten.forEach(function(e){
        if (e.datum) {
            var j = parseInt(e.datum.substring(0,4));
            if (!jahre[j]) jahre[j] = [];
            jahre[j].push(e);
        }
    });
    var jahreList = Object.keys(jahre).sort(function(a,b){return b-a;});
    if (jahreList.length === 0) jahreList = [new Date().getFullYear()];
    
    var html = '';
    
    // Jahres-Auswahl
    html += '<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem">';
    jahreList.forEach(function(j){
        html += '<button class="btn btn-sm '+(selectedYear==j?'btn-primary':'')+'" style="'+(selectedYear!=j?'background:#fff;border:2px solid #E8DFD4;color:#7A6652':'')+'" onclick="selectedYear='+j+';render()">'+j+'</button>';
    });
    html += '</div>';
    
    var erntenJahr = jahre[selectedYear] || [];
    var gesamt = erntenJahr.reduce(function(s,e){return s+e.menge;}, 0);
    
    // Jahres√ºbersicht
    html += '<div class="card" style="text-align:center">';
    html += '<h3 style="margin-bottom:.5rem">üìä Jahres√ºbersicht '+selectedYear+'</h3>';
    html += '<div style="font-size:2.5rem;font-weight:bold;color:#F5A623">'+gesamt.toFixed(1)+' kg</div>';
    html += '<div style="font-size:.85rem;color:#7A6652">'+erntenJahr.length+' Ernten</div>';
    html += '</div>';
    
    // Diagramm: Ertrag pro Monat
    if (erntenJahr.length > 0) {
        var monate = {};
        var monateNamen = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
        for (var m = 0; m < 12; m++) monate[m] = 0;
        erntenJahr.forEach(function(e){
            var monat = parseInt(e.datum.substring(5,7)) - 1;
            monate[monat] += e.menge;
        });
        var maxMonat = Math.max.apply(null, Object.values(monate)) || 1;
        
        html += '<div class="card">';
        html += '<h3 style="margin-bottom:1rem">üìÖ Ertrag pro Monat</h3>';
        html += '<div class="chart-bar">';
        for (var m = 0; m < 12; m++) {
            var h = monate[m] > 0 ? Math.max(8, (monate[m]/maxMonat)*180) : 0;
            html += '<div class="chart-col">';
            if (monate[m] > 0) html += '<div class="value">'+monate[m].toFixed(1)+'</div>';
            html += '<div class="bar" style="height:'+h+'px;'+(monate[m]===0?'background:#E8DFD4;min-height:4px':'')+'"></div>';
            html += '<div class="label">'+monateNamen[m]+'</div>';
            html += '</div>';
        }
        html += '</div></div>';
        
        // Diagramm: Ertrag pro Standort
        var nachStandort = {};
        erntenJahr.forEach(function(e){
            var key = e.standortName || 'Unbekannt';
            if (!nachStandort[key]) nachStandort[key] = 0;
            nachStandort[key] += e.menge;
        });
        var standortKeys = Object.keys(nachStandort).sort(function(a,b){return nachStandort[b]-nachStandort[a];});
        
        html += '<div class="card">';
        html += '<h3 style="margin-bottom:1rem">üìç Ertrag pro Standort</h3>';
        var maxStandort = nachStandort[standortKeys[0]] || 1;
        standortKeys.forEach(function(name){
            var kg = nachStandort[name];
            var pct = (kg/maxStandort*100);
            html += '<div style="margin-bottom:.75rem">';
            html += '<div style="display:flex;justify-content:space-between;margin-bottom:.25rem"><span style="font-weight:600;font-size:.9rem">'+name+'</span><span style="font-weight:bold;color:#F5A623">'+kg.toFixed(1)+' kg</span></div>';
            html += '<div style="background:#E8DFD4;height:.75rem;border-radius:.375rem"><div style="background:linear-gradient(90deg,#F5A623,#f7bc5e);height:100%;border-radius:.375rem;width:'+pct+'%;transition:width .5s"></div></div>';
            html += '</div>';
        });
        html += '</div>';
        
        // Nach Sorte
        var nachSorte = {};
        erntenJahr.forEach(function(e){
            var key = e.sorte || 'Ohne Angabe';
            if (!nachSorte[key]) nachSorte[key] = 0;
            nachSorte[key] += e.menge;
        });
        var sorteKeys = Object.keys(nachSorte).sort(function(a,b){return nachSorte[b]-nachSorte[a];});
        
        html += '<div class="card">';
        html += '<h3 style="margin-bottom:.75rem">üçØ Nach Honigsorte</h3>';
        sorteKeys.forEach(function(name){
            var kg = nachSorte[name];
            var pct = gesamt > 0 ? (kg/gesamt*100) : 0;
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid #FFFBF0">';
            html += '<div style="font-weight:500">'+name+'</div>';
            html += '<div><span style="font-weight:bold;color:#F5A623">'+kg.toFixed(1)+' kg</span> <span style="font-size:.75rem;color:#7A6652">('+pct.toFixed(0)+'%)</span></div>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // Jahresvergleich
    if (jahreList.length > 1) {
        html += '<div class="card">';
        html += '<h3 style="margin-bottom:1rem">üìà Jahresvergleich</h3>';
        var maxJahr = 0;
        jahreList.forEach(function(j){ 
            var s = (jahre[j]||[]).reduce(function(s,e){return s+e.menge;},0);
            if (s > maxJahr) maxJahr = s;
        });
        jahreList.forEach(function(j){
            var kg = (jahre[j]||[]).reduce(function(s,e){return s+e.menge;},0);
            var pct = maxJahr > 0 ? (kg/maxJahr*100) : 0;
            var anzahl = (jahre[j]||[]).length;
            html += '<div style="margin-bottom:.75rem">';
            html += '<div style="display:flex;justify-content:space-between;margin-bottom:.25rem"><span style="font-weight:600">'+j+'</span><span style="font-weight:bold;color:#F5A623">'+kg.toFixed(1)+' kg <span style="font-size:.75rem;font-weight:400;color:#7A6652">('+anzahl+' Ernten)</span></span></div>';
            html += '<div style="background:#E8DFD4;height:.75rem;border-radius:.375rem"><div style="background:linear-gradient(90deg,#F5A623,#f7bc5e);height:100%;border-radius:.375rem;width:'+pct+'%;transition:width .5s"></div></div>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // Alle Ernten des Jahres
    if (erntenJahr.length > 0) {
        html += '<div class="card">';
        html += '<h3 style="margin-bottom:.75rem">üìã Alle Ernten '+selectedYear+'</h3>';
        erntenJahr.sort(function(a,b){return b.datum.localeCompare(a.datum);}).forEach(function(e){
            var datum = new Date(e.datum).toLocaleDateString('de-DE',{day:'2-digit',month:'short'});
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid #FFFBF0">';
            html += '<div><div style="font-weight:500;font-size:.9rem">'+e.menge.toFixed(1)+' kg'+(e.sorte?' ¬∑ '+e.sorte:'')+'</div>';
            html += '<div style="font-size:.75rem;color:#7A6652">'+datum+' ¬∑ '+(e.standortName||'?')+(e.volkName?' ¬∑ '+e.volkName:'')+'</div></div>';
            html += '<div style="display:flex;gap:.25rem">';
            html += '<button class="btn btn-blue btn-xs" onclick="editErnte(\''+e.id+'\')">‚úèÔ∏è</button>';
            html += '<button class="btn btn-danger btn-xs" onclick="deleteErnte(\''+e.id+'\')">üóëÔ∏è</button>';
            html += '</div></div>';
        });
        html += '</div>';
    } else {
        html += '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">';
        html += '<div style="font-size:2rem;margin-bottom:.5rem">üìä</div>';
        html += '<p>Keine Ernten in '+selectedYear+' erfasst.</p></div>';
    }
    
    return html;
}

// ============================================
// MODAL
// ============================================
function openModal(id) {
    editId = id || null;
    document.getElementById('ernteDatum').value = new Date().toISOString().slice(0,10);
    document.getElementById('ernteMenge').value = '';
    document.getElementById('ernteSorte').value = '';
    document.getElementById('ernteNotizen').value = '';
    document.getElementById('ernteModalTitle').textContent = 'üçØ Ernte erfassen';
    
    // Standort-Dropdown f√ºllen
    var sel = document.getElementById('ernteStandort');
    sel.innerHTML = '<option value="">-- Standort w√§hlen --</option>';
    standorte.forEach(function(s){
        sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>';
    });
    
    document.getElementById('ernteVolk').innerHTML = '<option value="">-- Ganzer Standort --</option>';
    
    if (id) {
        var e = ernten.find(function(x){return x.id===id;});
        if (e) {
            document.getElementById('ernteModalTitle').textContent = '‚úèÔ∏è Ernte bearbeiten';
            document.getElementById('ernteDatum').value = e.datum;
            document.getElementById('ernteMenge').value = e.menge;
            document.getElementById('ernteSorte').value = e.sorte;
            document.getElementById('ernteNotizen').value = e.notizen;
            if (e.standortId) {
                sel.value = e.standortId;
                updateVoelkerSelect();
                if (e.volkId) document.getElementById('ernteVolk').value = e.volkId;
            }
        }
    }
    
    document.getElementById('ernteModal').classList.add('active');
}

function closeModal() {
    document.getElementById('ernteModal').classList.remove('active');
    editId = null;
}

function updateVoelkerSelect() {
    var standortId = document.getElementById('ernteStandort').value;
    var sel = document.getElementById('ernteVolk');
    sel.innerHTML = '<option value="">-- Ganzer Standort --</option>';
    if (standortId) {
        voelker.filter(function(v){return v.standortId===standortId;}).forEach(function(v){
            sel.innerHTML += '<option value="'+v.id+'">'+v.name+'</option>';
        });
    }
}

// ============================================
// CRUD
// ============================================
async function saveErnte() {
    var datum = document.getElementById('ernteDatum').value;
    var standortId = document.getElementById('ernteStandort').value;
    var volkId = document.getElementById('ernteVolk').value;
    var menge = parseFloat(document.getElementById('ernteMenge').value);
    var sorte = document.getElementById('ernteSorte').value.trim();
    var notizen = document.getElementById('ernteNotizen').value.trim();
    
    if (!datum || !menge || menge <= 0) {
        alert('Bitte Datum und Menge (> 0 kg) eingeben!');
        return;
    }
    if (!standortId) {
        alert('Bitte einen Standort w√§hlen!');
        return;
    }
    
    var standortName = '';
    var s = standorte.find(function(x){return x.id===standortId;});
    if (s) standortName = s.name;
    
    var volkName = '';
    if (volkId) {
        var v = voelker.find(function(x){return x.id===volkId;});
        if (v) volkName = v.name;
    }
    
    if (editId) {
        // Update
        var res = await sb.from('ernten').update({
            datum: datum,
            standort_id: standortId,
            standort_name: standortName,
            volk_id: volkId || null,
            volk_name: volkName || null,
            menge: menge,
            sorte: sorte,
            notizen: notizen
        }).eq('id', editId);
        
        if (res.error) { alert('Fehler: '+res.error.message); return; }
        
        var idx = ernten.findIndex(function(x){return x.id===editId;});
        if (idx > -1) {
            ernten[idx] = {id:editId, datum:datum, standortId:standortId, standortName:standortName, volkId:volkId, volkName:volkName, menge:menge, sorte:sorte, notizen:notizen, created:ernten[idx].created};
        }
        toast('‚úÖ Ernte aktualisiert');
    } else {
        // Insert
        var id = crypto.randomUUID();
        var res = await sb.from('ernten').insert({
            id: id,
            user_id: currentUser.id,
            datum: datum,
            standort_id: standortId,
            standort_name: standortName,
            volk_id: volkId || null,
            volk_name: volkName || null,
            menge: menge,
            sorte: sorte,
            notizen: notizen
        });
        
        if (res.error) { alert('Fehler: '+res.error.message); return; }
        
        ernten.unshift({id:id, datum:datum, standortId:standortId, standortName:standortName, volkId:volkId, volkName:volkName, menge:menge, sorte:sorte, notizen:notizen, created:new Date().toISOString()});
        toast('‚úÖ Ernte gespeichert');
    }
    
    closeModal();
    render();
}

function editErnte(id) {
    openModal(id);
}

async function deleteErnte(id) {
    if (!confirm('Ernte wirklich l√∂schen?')) return;
    
    await sb.from('ernten').delete().eq('id', id);
    ernten = ernten.filter(function(e){return e.id!==id;});
    toast('üóëÔ∏è Ernte gel√∂scht');
    render();
}

// ============================================
// HELPERS
// ============================================
function toast(msg) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(function(){ el.style.display = 'none'; }, 2500);
}

// Start
init();
</script>
</body>
</html>
