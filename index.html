<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imkerei Tagesplaner</title>
    <meta name="theme-color" content="#F5A623">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>

        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Outfit',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#FFFBF0;min-height:100vh;padding-left:220px;padding-bottom:2rem}
        .container{max-width:800px;margin:0 auto;padding:1rem}
        h1{font-family:'DM Serif Display',serif;font-size:1.75rem;font-weight:bold;color:#1C1410;margin-bottom:1rem}
        h2{font-size:1.25rem;font-weight:bold;color:#1C1410;margin:1.25rem 0 .75rem}
        h3{font-size:1rem;font-weight:600;color:#1C1410;margin-bottom:.5rem}
        .card{background:#fff;border-radius:.75rem;padding:1rem;margin-bottom:.75rem;box-shadow:0 1px 3px rgba(28,20,16,0.06);border:1px solid rgba(245,166,35,0.08)}
        .btn{padding:.875rem 1.5rem;border:none;border-radius:.75rem;font-weight:600;cursor:pointer;font-size:1rem;transition:all .15s}
        .btn:hover{opacity:.85;transform:translateY(-1px)}
        .btn:active{transform:translateY(0)}
        .btn-primary{background:#F5A623;color:#1C1410;box-shadow:0 2px 8px rgba(245,166,35,0.25)}.btn-success{background:#10b981;color:#fff}.btn-danger{background:#ef4444;color:#fff}.btn-blue{background:#3b82f6;color:#fff}
        .btn-sm{padding:.625rem 1rem;font-size:.9rem}
        .btn-xs{padding:.4rem .75rem;font-size:.8rem}
        .btn-block{width:100%;padding:1.1rem;font-size:1.1rem;margin-top:.75rem}
        
        /* Kleinere Option Buttons */
        .option-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:.5rem;margin:.75rem 0}
        .option-btn{padding:.65rem;border:2px solid #E8DFD4;border-radius:.5rem;background:#fff;cursor:pointer;transition:all .2s;text-align:center;font-size:.8rem;font-weight:500}
        .option-btn:hover{border-color:#F5A623;background:#FFF8EE;transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,166,35,.2)}
        .option-btn:active{transform:translateY(0)}
        .option-btn.selected{border-color:#F5A623;background:#F5A623;color:#1C1410;font-weight:600}
        .option-btn .emoji{display:block;font-size:1.5rem;margin-bottom:.3rem}
        
        /* Counter Buttons */
        .counter{display:flex;align-items:center;gap:.75rem;justify-content:center}
        .counter-btn{width:3rem;height:3rem;border:2px solid #E8DFD4;border-radius:.75rem;background:#fff;cursor:pointer;font-size:1.5rem;font-weight:bold;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .counter-btn:hover{border-color:#F5A623;background:#FFF8EE;transform:scale(1.05)}
        .counter-value{font-size:2rem;font-weight:bold;min-width:4rem;text-align:center}
        
        .priority-btns{display:flex;gap:.5rem;margin:.75rem 0}
        .priority-btn{flex:1;padding:.75rem;border:2px solid #E8DFD4;border-radius:.5rem;background:#fff;cursor:pointer;font-weight:600;transition:all .2s;font-size:.9rem}
        .priority-btn:hover{transform:translateY(-1px)}
        .priority-btn:active{transform:translateY(0)}
        .priority-btn.selected.low{border-color:#10b981;background:#10b981;color:#fff}
        .priority-btn.selected.medium{border-color:#f59e0b;background:#f59e0b;color:#fff}
        .priority-btn.selected.high{border-color:#ef4444;background:#ef4444;color:#fff}
        
        .nav{position:fixed;left:0;top:0;bottom:0;width:220px;background:#FFFBF0;border-right:2px solid rgba(245,166,35,0.12);display:flex;flex-direction:column;padding:0;z-index:50;overflow-y:auto}
        .nav-brand{padding:1.25rem 1rem;border-bottom:2px solid rgba(245,166,35,0.12)}
        .nav-section{font-size:.65rem;font-weight:700;color:#A69580;text-transform:uppercase;letter-spacing:.08em;padding:.75rem 1rem .25rem}
        .nav-item{padding:.625rem 1rem;text-align:left;cursor:pointer;border:none;background:none;color:#7A6652;font-size:.85rem;border-left:4px solid transparent;transition:all .15s;width:100%}
        .nav-item:hover{background:rgba(245,166,35,0.06)}
        .nav-item.active{color:#92400E;font-weight:600;border-left-color:#F5A623;background:#FFF8EE}
        .footer{position:fixed;left:220px;bottom:0;right:0;background:#FFFBF0;border-top:1px solid rgba(245,166,35,0.12);padding:.4rem;text-align:center;font-size:.7rem;color:#7A6652;z-index:40}
        .modal{display:none;position:fixed;inset:0;background:rgba(28,20,16,0.45);z-index:100;align-items:center;justify-content:flex-end}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:1rem 0 0 1rem;width:100%;max-width:500px;height:100vh;overflow-y:auto;padding-bottom:2rem;box-shadow:-4px 0 20px rgba(28,20,16,0.15)}
        .modal-center .modal-content{max-width:420px;height:auto;border-radius:1rem;margin:auto}
        .modal-header{padding:1.25rem;border-bottom:2px solid rgba(245,166,35,0.12);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:linear-gradient(to right,#FFF8EE,#fff);z-index:10}
        .modal-header h2{margin:0;font-size:1.25rem}
        .modal-body{padding:1.5rem}
        .form-group{margin-bottom:1.25rem}
        .form-label{display:block;font-size:.95rem;font-weight:600;margin-bottom:.5rem;color:#3D2E1F}
        .input{width:100%;padding:.875rem;border:2px solid #d1d5db;border-radius:.75rem;font-size:1rem;font-family:inherit;outline:none;transition:border-color .15s}
        .input:focus{border-color:#F5A623;box-shadow:0 0 0 3px rgba(245,166,35,.1)}
        textarea.input{min-height:100px;resize:vertical}
        .info-box{background:#dbeafe;border:1px solid #93c5fd;border-radius:.5rem;padding:.625rem;font-size:.75rem;color:#1e40af;margin-top:.5rem}
        .warn-box{background:#FFF3D6;border:1px solid #F5A623;border-radius:.5rem;padding:.625rem;font-size:.75rem;color:#92400e;margin-top:.5rem}
        .badge{display:inline-block;padding:.15rem .5rem;border-radius:.25rem;font-size:.7rem;font-weight:600}
        .badge-green{background:#d1fae5;color:#065f46}.badge-yellow{background:#FFF3D6;color:#92400e}.badge-red{background:#fee2e2;color:#991b1b}.badge-blue{background:#dbeafe;color:#1e40af}
        .toast{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%) translateY(-120%);background:#1C1410;color:#fff;padding:.75rem 1.5rem;border-radius:.75rem;font-size:.875rem;font-weight:600;box-shadow:0 4px 12px rgba(28,20,16,0.18);z-index:9999;transition:transform .3s ease;max-width:90%;text-align:center}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.success{background:#065f46}.toast.error{background:#991b1b}.toast.info{background:#1e40af}
        .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#7A6652;padding:.25rem;line-height:1;transition:color .15s}
        .close-btn:hover{color:#1C1410}
        .dauer-btns{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin:.75rem 0}
        
        /* Timeline f√ºr Zuchtplan */
        .timeline{position:relative;padding-left:2rem}
        .timeline-item{position:relative;padding-bottom:1.5rem;border-left:2px solid #E8DFD4}
        .timeline-item:last-child{border-left:none}
        .timeline-dot{position:absolute;left:-7px;top:0;width:12px;height:12px;border-radius:50%;background:#F5A623;border:2px solid #fff;box-shadow:0 0 0 2px #E8DFD4}
        .timeline-content{margin-left:1rem;background:#FFF8EE;padding:.75rem;border-radius:.5rem}
        
        /* Tracht Items */
        .tracht-item{padding:.75rem;border-radius:.5rem;border-left:4px solid;margin-bottom:.5rem}
        
        /* V√∂lker Grid */
        .volk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.75rem}
        .volk-card{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:.875rem;cursor:pointer;transition:all .2s}
        .volk-card:hover{border-color:#F5A623;transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,166,35,.2)}
        
        @media(max-width:768px){
            body{padding-left:0;padding-bottom:90px}
            .nav{left:0;right:0;top:auto;bottom:0;width:100%;height:auto;flex-direction:row;border-right:none;border-top:2px solid rgba(245,166,35,0.12);overflow-x:auto;overflow-y:hidden}
            .nav-brand,.nav-section{display:none}
            .nav-item{flex:0 0 auto;padding:.5rem .6rem;font-size:.6rem;text-align:center;border-left:none;border-bottom:3px solid transparent;white-space:nowrap}
            .nav-item.active{border-left:none;border-bottom-color:#F5A623}
            .footer{left:0;bottom:60px}
            .modal-content{max-width:100%;border-radius:1rem 1rem 0 0}
            .option-grid{grid-template-columns:repeat(3,1fr)}
            .volk-grid{grid-template-columns:1fr}
        }
        @media print{.nav,.footer,button,.modal,.toast{display:none!important}body{padding:0}}

        /* === PACKLISTE MODULE STYLES === */
        .pack-kategorie{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:1rem;margin-bottom:1rem}
        .pack-item-row{display:flex;justify-content:space-between;align-items:center;padding:.625rem;border-bottom:1px solid #FFFBF0;gap:.75rem}
        .pack-item-row:hover{background:#FFF8EE}
        .pack-item-row:last-child{border-bottom:none}
        .pack-item-main{display:flex;align-items:center;flex:1;min-width:0}
        .pack-item-controls{display:flex;align-items:center;gap:.5rem;flex-shrink:0}
        .pack-checkbox{width:1.25rem;height:1.25rem;margin-right:.875rem;cursor:pointer;accent-color:#F5A623;flex-shrink:0}
        .pack-label{flex:1;font-size:.95rem;color:#1C1410;user-select:none;cursor:pointer;min-width:0;word-break:break-word}
        .pack-label.checked{text-decoration:line-through;color:#A69580}
        .pack-label strong{color:#F5A623;font-weight:700}
        .menge-counter{display:flex;align-items:center;gap:.25rem;background:#FFF8EE;border-radius:.5rem;padding:.25rem}
        .menge-btn{width:1.75rem;height:1.75rem;border:1px solid #d1d5db;border-radius:.375rem;background:#fff;cursor:pointer;font-size:1rem;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:all .15s;color:#7A6652}
        .menge-btn:hover{background:#F5A623;border-color:#F5A623;color:#1C1410;transform:scale(1.1)}
        .menge-btn:active{transform:scale(.95)}
        .menge-value{min-width:1.5rem;text-align:center;font-weight:600;font-size:.9rem;color:#1C1410}
        .btn-del{background:none;border:none;cursor:pointer;font-size:1.25rem;padding:.25rem .5rem;opacity:.4;transition:all .2s}
        .btn-del:hover{opacity:1;transform:scale(1.2)}
        .stats{display:flex;gap:1rem;margin-bottom:1.5rem}
        .stat-card{flex:1;background:#FFF8EE;padding:1rem;border-radius:.5rem;text-align:center}
        .stat-number{font-size:1.75rem;font-weight:bold;color:#F5A623}
        .stat-label{font-size:.75rem;color:#7A6652;margin-top:.25rem;text-transform:uppercase;letter-spacing:.05em}
        .schnell-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:1.5rem}
        .schnell-btn{background:linear-gradient(135deg,#F5A623,#FFBE45);border:none;border-radius:.75rem;padding:1rem;cursor:pointer;transition:all .2s;box-shadow:0 2px 4px rgba(28,20,16,0.08)}
        .schnell-btn:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 6px 12px rgba(245,166,35,.3)}
        .schnell-btn:active{transform:translateY(-1px)}
        .schnell-btn.schnell-equipment{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
        .schnell-btn.schnell-equipment:hover{box-shadow:0 6px 12px rgba(59,130,246,.3)}
        .schnell-icon{font-size:2.5rem;margin-bottom:.5rem}
        .schnell-label{font-weight:600;font-size:.9rem;color:#1C1410}
        .schnell-btn.schnell-equipment .schnell-label{color:#fff}
        
        /* === TRACHTKALENDER MODULE STYLES === */
        .timeline-container{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;overflow:hidden;margin-bottom:2rem}
        .timeline-header-row{display:grid;grid-template-columns:200px 1fr;background:#FFF8EE;border-bottom:2px solid #E8DFD4;font-weight:600;font-size:.9rem}
        .timeline-label-col{padding:1rem;border-right:2px solid #E8DFD4;display:flex;align-items:center;justify-content:center}
        .timeline-months{display:grid;grid-template-columns:repeat(12,1fr);text-align:center}
        .timeline-month{padding:.75rem .25rem;border-right:1px solid #E8DFD4;font-size:.85rem;color:#7A6652}
        .timeline-month:last-child{border-right:none}
        .timeline-row{display:grid;grid-template-columns:200px 1fr;border-bottom:1px solid #FFFBF0;transition:all .2s}
        .timeline-row:hover{background:#FFF8EE;transform:scale(1.01)}
        .timeline-row:last-child{border-bottom:none}
        .timeline-row-label{padding:1rem;border-right:2px solid #E8DFD4;display:flex;align-items:center;gap:.5rem;font-weight:500}
        .timeline-row-bars{display:grid;grid-template-columns:repeat(12,1fr);position:relative;padding:.5rem 0}
        .timeline-bar{height:2.5rem;border-radius:.375rem;margin:0 .15rem;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 2px 4px rgba(28,20,16,0.08);transition:all .2s;position:relative;overflow:hidden}
        .timeline-bar::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(255,255,255,.3) 0%,rgba(255,255,255,0) 100%);pointer-events:none}
        .timeline-bar:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(28,20,16,0.15);z-index:10}
        .ausgeblendet-chip{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .875rem;border-radius:.5rem;border:2px solid;cursor:pointer;transition:all .2s;font-size:.85rem;font-weight:500;opacity:.6;color:#1C1410}
        .ausgeblendet-chip:hover{opacity:1;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .chip-close{font-size:1rem;font-weight:bold;color:#10b981}
        
        /* === ZUCHTPLAN MODULE STYLES === */
        .zucht-card{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:1.25rem;margin-bottom:1rem;transition:all .2s}
        .zucht-card:hover{border-color:#F5A623;transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,166,35,.2)}
        .zucht-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem}
        .zucht-title{font-size:1.25rem;font-weight:bold;color:#1C1410}
        .timeline-dot.completed{background:#10b981;box-shadow:0 0 0 2px #10b981}
        .timeline-dot.active{background:#F5A623;box-shadow:0 0 0 2px #F5A623;animation:pulse 2s infinite}
        .timeline-dot.upcoming{background:#E8DFD4}
        .timeline-title{font-weight:bold;font-size:1rem;color:#1C1410;margin-bottom:.5rem}
        .timeline-date{font-size:.9rem;color:#7A6652;margin-bottom:.25rem}
        .timeline-note{font-size:.85rem;color:#5C4A38;margin-top:.5rem;padding-top:.5rem;border-top:1px solid #E8DFD4}
        .tage-counter{display:flex;align-items:center;gap:.75rem;background:#FFF8EE;padding:.75rem;border-radius:.5rem;margin-top:.5rem}
        .counter-label{font-size:.85rem;color:#7A6652}
        .badge-active{background:#10b981;color:#fff}
        .badge-upcoming{background:#f59e0b;color:#fff}
        .badge-completed{background:#7A6652;color:#fff}
        .badge-repeat{background:#dbeafe;color:#1e40af}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        /* === BEHANDLUNG MODULE STYLES === */
        .behandlung-card{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:1.25rem;margin-bottom:1rem;border-left:4px solid;transition:all .2s}
        .behandlung-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(28,20,16,0.08)}
        .behandlung-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem}
        .behandlung-title{font-size:1.1rem;font-weight:bold;color:#1C1410}
        .behandlung-info{font-size:.85rem;color:#7A6652;line-height:1.6;margin-top:.5rem}
        .termine-liste{margin-top:1rem;padding-top:1rem;border-top:1px solid #E8DFD4}
        .termin-item{padding:.5rem;background:#FFF8EE;border-radius:.5rem;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center;font-size:.85rem}
        .termin-datum{font-weight:600;color:#1C1410}
        .termin-status{color:#7A6652}
        .methoden-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin:.75rem 0}
        .methode-btn{padding:.875rem;border:2px solid #E8DFD4;border-radius:.5rem;background:#fff;cursor:pointer;transition:all .2s;text-align:center;font-size:.85rem;font-weight:500}
        .methode-btn:hover{border-color:#F5A623;background:#FFF8EE;transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,166,35,.2)}
        .methode-btn.selected{border-color:#F5A623;background:#F5A623;color:#1C1410;font-weight:600}
        .methode-btn .emoji{display:block;font-size:1.75rem;margin-bottom:.5rem}
        
        @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}

    
        /* Auth Styles */
        .auth-container{max-width:400px;margin:10vh auto;padding:2rem}
        .auth-card{background:#fff;border-radius:1.25rem;padding:2rem;box-shadow:0 4px 24px rgba(28,20,16,0.1);border:1px solid rgba(245,166,35,0.12)}
        .auth-title{text-align:center;font-size:2.5rem;margin-bottom:.5rem}
        .auth-subtitle{text-align:center;color:#7A6652;margin-bottom:2rem;font-size:.9rem}
        .auth-tabs{display:flex;gap:0;margin-bottom:1.5rem;border:2px solid rgba(245,166,35,0.2);border-radius:.75rem;overflow:hidden}
        .auth-tab{flex:1;padding:.75rem;text-align:center;cursor:pointer;font-weight:600;font-size:.9rem;border:none;background:#FFF8EE;color:#7A6652;transition:all .15s}
        .auth-tab.active{background:#F5A623;color:#1C1410}
        .auth-divider{text-align:center;color:#A69580;font-size:.8rem;margin:1rem 0;position:relative}
        .auth-divider::before,.auth-divider::after{content:'';position:absolute;top:50%;width:35%;height:1px;background:#E8DFD4}
        .auth-divider::before{left:0}
        .auth-divider::after{right:0}
        .loading-overlay{position:fixed;inset:0;background:rgba(255,251,240,.95);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column}
        .spinner{width:50px;height:50px;border:4px solid rgba(245,166,35,0.2);border-top-color:#F5A623;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .save-indicator{position:fixed;top:.75rem;right:.75rem;background:#10b981;color:#fff;padding:.35rem .75rem;border-radius:.5rem;font-size:.75rem;font-weight:600;opacity:0;transition:opacity .3s;z-index:60}
        .save-indicator.show{opacity:1}
    </style>
</head>
<body>
<div id="toast" class="toast"></div>
<div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div><div style="margin-top:1rem;color:#7A6652;font-weight:600">Laden...</div></div>
<div id="saveIndicator" class="save-indicator">üíæ Gespeichert</div>
<div id="app"></div>
<div class="footer">Imkerei Durchdenwald üêù ¬∑ v6.0 Cloud</div>

<!-- Auth Screen (shown when not logged in) -->
<div id="authScreen" style="display:none">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-title">üêù</div>
            <div style="text-align:center;font-size:1.25rem;font-weight:bold;color:#1C1410;margin-bottom:.25rem">Imkerei Tagesplaner</div>
            <div class="auth-subtitle">Melde dich an oder erstelle einen Account</div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Anmelden</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Registrieren</button>
            </div>
            
            <!-- Login -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" id="loginEmail" class="input" placeholder="deine@email.de">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" id="loginPassword" class="input" placeholder="Dein Passwort">
                </div>
                <button class="btn btn-primary btn-block" onclick="doLogin()">Anmelden</button>
                <div style="text-align:center;margin-top:1rem">
                    <a href="#" onclick="showAuthTab('forgot');return false" style="font-size:.85rem;color:#3b82f6">Passwort vergessen?</a>
                </div>
            </div>
            
            <!-- Register -->
            <div id="registerForm" style="display:none">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="regName" class="input" placeholder="Max Mustermann">
                </div>
                <div class="form-group">
                    <label class="form-label">Imkerei (optional)</label>
                    <input type="text" id="regImkerei" class="input" placeholder="Imkerei Durchdenwald">
                </div>
                <div class="form-group">
                    <label class="form-label">E-Mail *</label>
                    <input type="email" id="regEmail" class="input" placeholder="deine@email.de">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort * (min. 6 Zeichen)</label>
                    <input type="password" id="regPassword" class="input" placeholder="Sicheres Passwort">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort wiederholen *</label>
                    <input type="password" id="regPassword2" class="input" placeholder="Passwort best√§tigen">
                </div>
                <button class="btn btn-primary btn-block" onclick="doRegister()">Account erstellen</button>
            </div>
            
            <!-- Passwort vergessen -->
            <div id="forgotForm" style="display:none">
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" id="forgotEmail" class="input" placeholder="deine@email.de">
                </div>
                <button class="btn btn-primary btn-block" onclick="doForgotPassword()">Passwort-Reset senden</button>
                <div style="text-align:center;margin-top:1rem">
                    <a href="#" onclick="showAuthTab('login');return false" style="font-size:.85rem;color:#3b82f6">‚Üê Zur√ºck zum Login</a>
                </div>
            </div>
            
            <!-- Neues Passwort setzen (nach Reset-Link) -->
            <div id="resetForm" style="display:none">
                <div style="text-align:center;margin-bottom:1rem">
                    <div style="font-size:2rem;margin-bottom:.5rem">üîë</div>
                    <h3>Neues Passwort setzen</h3>
                </div>
                <div class="form-group">
                    <label class="form-label">Neues Passwort (min. 6 Zeichen)</label>
                    <input type="password" id="resetNewPassword" class="input" placeholder="Neues Passwort">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort wiederholen</label>
                    <input type="password" id="resetNewPassword2" class="input" placeholder="Passwort best√§tigen">
                </div>
                <button class="btn btn-primary btn-block" onclick="doSetNewPassword()">Passwort speichern</button>
            </div>
            
            <div id="authError" style="display:none;margin-top:1rem;padding:.75rem;background:#fee2e2;border:1px solid #fca5a5;border-radius:.5rem;color:#991b1b;font-size:.85rem;text-align:center"></div>
        </div>
    </div>
</div>

<!-- Standort Modal -->
<div id="standortModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="standortModalTitle">üìç Neuer Standort</h2>
            <button class="close-btn" onclick="app.closeModal('standortModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Name des Standorts *</label>
                <input type="text" id="standortName" class="input" placeholder="z.B. Heimstand Garten">
            </div>
            <div class="form-group">
                <label class="form-label">Anzahl V√∂lker</label>
                <div class="counter">
                    <button class="counter-btn" onclick="app.changeVoelkerCount(-1)">‚àí</button>
                    <div class="counter-value" id="standortVoelkerCount">2</div>
                    <button class="counter-btn" onclick="app.changeVoelkerCount(1)">+</button>
                </div>
                <div class="info-box">Die V√∂lker werden automatisch erstellt</div>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen (optional)</label>
                <textarea id="standortNotizen" class="input" placeholder="z.B. S√ºdseite, gesch√ºtzter Bereich"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">üìç Position auf Karte w√§hlen</label>
                <div id="standortMapPicker" style="height:250px;border-radius:.75rem;border:2px solid #E8DFD4;margin-bottom:.5rem;position:relative;z-index:1"></div>
                <input type="hidden" id="standortLat" value="">
                <input type="hidden" id="standortLng" value="">
                <div id="standortKoordStatus" style="font-size:.8rem;color:#7A6652"></div>
                <div class="info-box">üí° Klicke auf die Karte um den Standort zu setzen. Du kannst zoomen und die Karte verschieben.</div>
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveStandort()">Standort speichern</button>
        </div>
    </div>
</div>

<!-- Volk Modal -->
<div id="volkModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="volkModalTitle">üêù Volk Details</h2>
            <button class="close-btn" onclick="app.closeModal('volkModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Name des Volkes *</label>
                <input type="text" id="volkName" class="input" placeholder="z.B. Volk 1">
            </div>
            <div class="form-group">
                <label class="form-label">Beutensystem</label>
                <select id="volkBeute" class="input">
                    <option value="Dadant">Dadant</option>
                    <option value="Zander">Zander</option>
                    <option value="Deutsch Normal">Deutsch Normal</option>
                    <option value="Langstroth">Langstroth</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <div class="option-grid" style="grid-template-columns:repeat(2,1fr)">
                    <button class="option-btn selected" onclick="app.setVolkStatus('ok')">‚úÖ Gut</button>
                    <button class="option-btn" onclick="app.setVolkStatus('schwach')">‚ö†Ô∏è Schwach</button>
                    <button class="option-btn" onclick="app.setVolkStatus('weisellos')">üëë Weisellos</button>
                    <button class="option-btn" onclick="app.setVolkStatus('problem')">‚ùå Problem</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen</label>
                <textarea id="volkNotizen" class="input" placeholder="Besonderheiten..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Honigernte (kg)</label>
                <input type="number" id="volkHonig" class="input" placeholder="0" step="0.1" min="0">
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveVolk()">Volk speichern</button>
            <button class="btn btn-danger btn-block" style="margin-top:.5rem" onclick="app.deleteVolk()">üóëÔ∏è Volk l√∂schen</button>
        </div>
    </div>
</div>

<!-- Aufgabe Modal -->
<div id="aufgabeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="aufgabeModalTitle">‚úì Neue Aufgabe</h2>
            <button class="close-btn" onclick="app.closeModal('aufgabeModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Aufgaben-Typ w√§hlen</label>
                <div class="option-grid" id="aufgabeTypGrid"></div>
            </div>
            <div class="form-group">
                <label class="form-label">F√§lligkeit</label>
                <input type="date" id="aufgabeDatum" class="input">
            </div>
            <div class="form-group">
                <label class="form-label">Dauer (Minuten)</label>
                <div class="dauer-btns">
                    <button class="option-btn" onclick="app.setDauer(15)">15 Min</button>
                    <button class="option-btn" onclick="app.setDauer(30)">30 Min</button>
                    <button class="option-btn" onclick="app.setDauer(60)">1 Std</button>
                    <button class="option-btn selected" onclick="app.setDauer(120)">2 Std</button>
                </div>
                <input type="number" id="aufgabeDauer" class="input" value="120" min="5" step="5">
            </div>
            <div class="form-group">
                <label class="form-label">Priorit√§t</label>
                <div class="priority-btns">
                    <button class="priority-btn" onclick="app.setPrio('low')">üü¢ Niedrig</button>
                    <button class="priority-btn selected medium" onclick="app.setPrio('medium')">üü° Mittel</button>
                    <button class="priority-btn" onclick="app.setPrio('high')">üî¥ Hoch</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notiz (optional)</label>
                <input type="text" id="aufgabeNotiz" class="input" placeholder="Zus√§tzliche Hinweise...">
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveAufgabe()">Aufgabe speichern</button>
        </div>
    </div>
</div>

<!-- Kosten Modal -->
<div id="kostenModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí∞ Neue Ausgabe</h2>
            <button class="close-btn" onclick="app.closeModal('kostenModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Kategorie w√§hlen</label>
                <div class="option-grid" id="kostenKatGrid"></div>
            </div>
            <div class="form-group">
                <label class="form-label">H√§ufige Ausgaben</label>
                <div class="option-grid" id="kostenVorlagenGrid"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Beschreibung</label>
                <input type="text" id="kostenBeschreibung" class="input" placeholder="z.B. Benzin f√ºr Standortfahrt">
            </div>
            <div class="form-group">
                <label class="form-label">Betrag (‚Ç¨)</label>
                <input type="number" id="kostenBetrag" class="input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="date" id="kostenDatum" class="input">
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveKosten()">Ausgabe speichern</button>
        </div>
    </div>
</div>

<!-- Zuchtplan Modal (enhanced) -->
<div id="zuchtModalEnhanced" class="modal modal-center">
    <div class="modal-content" style="max-width:600px;height:auto;border-radius:1rem;margin:auto">
        <div class="modal-header">
            <h2 id="zuchtModalEnhancedTitle">üëë Neuer Zuchtplan</h2>
            <button class="close-btn" onclick="zuchtplanMod.closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">K√∂nigin Name/Nummer *</label>
                <input type="text" id="zuchtNameE" class="input" placeholder="z.B. K√∂nigin 2025-1">
            </div>
            <div class="form-group">
                <label class="form-label">üì¶ Sammelbrutableger erstellt *</label>
                <input type="date" id="zuchtSammelE" class="input" onchange="zuchtplanMod.berechneAlles()">
                <div class="info-box">üí° Startpunkt</div>
            </div>
            <div class="form-group">
                <label class="form-label">üî¨ Umlarven - Tage nach Sammelbrut</label>
                <div class="tage-counter">
                    <button class="counter-btn" onclick="zuchtplanMod.changeTage('umlarven',-1)">‚àí</button>
                    <div class="counter-value" id="tageUmlarvenE">4</div>
                    <button class="counter-btn" onclick="zuchtplanMod.changeTage('umlarven',1)">+</button>
                    <div class="counter-label">Tage</div>
                </div>
                <input type="date" id="zuchtUmlarvenE" class="input" style="margin-top:.5rem" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">üëë Zusetzen - Tage nach Umlarven</label>
                <div class="tage-counter">
                    <button class="counter-btn" onclick="zuchtplanMod.changeTage('zusetzen',-1)">‚àí</button>
                    <div class="counter-value" id="tageZusetzenE">12</div>
                    <button class="counter-btn" onclick="zuchtplanMod.changeTage('zusetzen',1)">+</button>
                    <div class="counter-label">Tage</div>
                </div>
                <input type="date" id="zuchtZusetzenE" class="input" style="margin-top:.5rem" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen</label>
                <textarea id="zuchtNotizenE" class="input" placeholder="Linie, Herkunft..."></textarea>
            </div>
            <button class="btn btn-primary btn-block" onclick="zuchtplanMod.saveZucht()">Zuchtplan speichern</button>
        </div>
    </div>
</div>

<!-- Tracht Modal -->
<div id="trachtModalEnhanced" class="modal modal-center">
    <div class="modal-content" style="max-width:600px;height:auto;max-height:90vh;border-radius:1rem;margin:auto;overflow-y:auto">
        <div class="modal-header">
            <h2 id="trachtModalTitle">üå∏ Tracht erfassen</h2>
            <button class="close-btn" onclick="trachtkalenderMod.closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Tracht-Typ *</label>
                <select id="trachtTypE" class="input">
                    <option value="">-- Bitte w√§hlen --</option>
                    <optgroup label="Fr√ºhjahr"><option value="Haselnuss">üå∞ Haselnuss</option><option value="Weide">üåø Weide</option><option value="Kirsche">üçí Kirsche</option><option value="L√∂wenzahn">üåº L√∂wenzahn</option><option value="Raps">üåæ Raps</option><option value="Obstbl√ºte">üå∏ Obstbl√ºte</option></optgroup>
                    <optgroup label="Sommer"><option value="Akazie (Robinie)">üå≥ Akazie</option><option value="Linde (Sommer)">üçÉ Linde</option><option value="Phacelia">üíú Phacelia</option><option value="Sonnenblume">üåª Sonnenblume</option></optgroup>
                    <optgroup label="Waldtracht"><option value="Fichte (Honigtau)">üå≤ Fichte</option><option value="Tanne (Honigtau)">üå≤ Tanne</option></optgroup>
                    <optgroup label="Herbst"><option value="Heide">üå∏ Heide</option><option value="Efeu">üåø Efeu</option></optgroup>
                    <option value="Andere">üå∫ Andere</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Standort/Gebiet *</label>
                <select id="trachtStandortSelect" class="input" onchange="trachtkalenderMod.standortChanged()">
                    <option value="">-- Manuell eingeben --</option>
                </select>
                <input type="text" id="trachtStandortE" class="input" placeholder="z.B. Rapsfeld M√ºller" style="margin-top:.5rem">
            </div>
            <div class="form-group">
                <label class="form-label">Bl√ºhbeginn</label>
                <input type="date" id="trachtBeginnE" class="input">
            </div>
            <div class="form-group">
                <label class="form-label">Bl√ºhende</label>
                <input type="date" id="trachtEndeE" class="input">
            </div>
            <div class="form-group">
                <label class="form-label">Ertrag (kg)</label>
                <input type="number" id="trachtErtragE" class="input" placeholder="0" step="0.1" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">üìç Position auf Karte w√§hlen (f√ºr Trachtkarte)</label>
                <div id="trachtMapPicker" style="height:250px;border-radius:.75rem;border:2px solid #E8DFD4;margin-bottom:.5rem;position:relative;z-index:1"></div>
                <input type="hidden" id="trachtLatE" value="">
                <input type="hidden" id="trachtLngE" value="">
                <div id="koordinatenStatus" style="font-size:.8rem;color:#7A6652"></div>
                <div class="info-box">üí° Klicke auf die Karte um die Tracht-Position zu setzen.</div>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen</label>
                <textarea id="trachtNotizenE" class="input" placeholder="Qualit√§t..."></textarea>
            </div>
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:.75rem;border:2px solid #E8DFD4;border-radius:.5rem">
                    <input type="checkbox" id="trachtShareE" style="width:1.25rem;height:1.25rem">
                    <span style="font-weight:500">üó∫Ô∏è Auf der √∂ffentlichen Trachtkarte teilen</span>
                </label>
            </div>
            <button id="trachtSaveBtn" class="btn btn-primary btn-block" onclick="trachtkalenderMod.saveTracht()">Tracht speichern</button>
        </div>
    </div>
</div>

<!-- Behandlung Modal -->
<div id="behandlungModalNew" class="modal modal-center">
    <div class="modal-content" style="max-width:600px;height:auto;max-height:90vh;border-radius:1rem;margin:auto;overflow-y:auto">
        <div class="modal-header">
            <h2>üíâ Neue Behandlung</h2>
            <button class="close-btn" onclick="behandlungMod.closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">V√∂lker</label>
                <div style="display:flex;flex-direction:column;gap:.5rem">
                    <label style="display:flex;align-items:center;gap:.5rem;padding:.75rem;border:2px solid #E8DFD4;border-radius:.5rem;cursor:pointer">
                        <input type="radio" name="volkAuswahlNew" value="alle" onchange="behandlungMod.updateVolkAuswahl('alle')" style="width:1.25rem;height:1.25rem">
                        <span style="font-weight:500">üêù Alle V√∂lker</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:.5rem;padding:.75rem;border:2px solid #E8DFD4;border-radius:.5rem;cursor:pointer">
                        <input type="radio" name="volkAuswahlNew" value="standort" onchange="behandlungMod.updateVolkAuswahl('standort')" style="width:1.25rem;height:1.25rem">
                        <span style="font-weight:500">üìç Ganzer Standort</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:.5rem;padding:.75rem;border:2px solid #E8DFD4;border-radius:.5rem;cursor:pointer">
                        <input type="radio" name="volkAuswahlNew" value="einzeln" onchange="behandlungMod.updateVolkAuswahl('einzeln')" style="width:1.25rem;height:1.25rem" checked>
                        <span style="font-weight:500">üêù Einzelnes Volk</span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="standortGruppeNew" style="display:none">
                <label class="form-label">Standort ausw√§hlen</label>
                <select id="behandlungStandortNew" class="input" onchange="behandlungMod.updateStandortInfo()"><option value="">-- Bitte w√§hlen --</option></select>
                <div id="standortVolkInfo" style="margin-top:.5rem;font-size:.85rem;color:#7A6652"></div>
            </div>
            <div class="form-group" id="einzelVolkGruppeNew">
                <label class="form-label">Volk ausw√§hlen</label>
                <select id="behandlungVolkNew" class="input"><option value="">-- Bitte w√§hlen --</option></select>
            </div>
            <div class="form-group">
                <label class="form-label">Behandlungsmethode *</label>
                <div class="methoden-grid" id="methodenGridNew"></div>
            </div>
            <div class="form-group" id="andereMethodeGruppeNew" style="display:none">
                <label class="form-label">Andere Methode</label>
                <input type="text" id="andereMethodeNew" class="input" placeholder="z.B. Drohnenbrutentnahme">
            </div>
            <div class="form-group">
                <label class="form-label">Behandlungsdatum *</label>
                <input type="date" id="behandlungDatumNew" class="input">
            </div>
            <div class="form-group">
                <label class="form-label">Wiederholung</label>
                <select id="behandlungIntervallNew" class="input" onchange="behandlungMod.updateWiederholung()">
                    <option value="keine">Keine Wiederholung</option>
                    <option value="woechentlich">W√∂chentlich</option>
                    <option value="2wochen">Alle 2 Wochen</option>
                    <option value="3wochen">Alle 3 Wochen</option>
                    <option value="monatlich">Monatlich</option>
                </select>
            </div>
            <div class="form-group" id="anzahlGruppeNew" style="display:none">
                <label class="form-label">Anzahl Wiederholungen</label>
                <div class="counter">
                    <button class="counter-btn" onclick="behandlungMod.changeAnzahl(-1)">‚àí</button>
                    <div class="counter-value" id="anzahlWiederholungenNew">3</div>
                    <button class="counter-btn" onclick="behandlungMod.changeAnzahl(1)">+</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen</label>
                <textarea id="behandlungNotizenNew" class="input" placeholder="Dosierung, Temperatur..."></textarea>
            </div>
            <details id="bestandsbuchDetails" style="margin-bottom:1rem;border:2px solid #E8DFD4;border-radius:.5rem;overflow:hidden">
                <summary style="padding:.75rem 1rem;cursor:pointer;font-weight:600;font-size:.9rem;background:#FFF8EE;color:#7A6652;display:flex;align-items:center;gap:.5rem">üìã Bestandsbuch-Felder (f√ºr Veterin√§ramt)</summary>
                <div style="padding:1rem;display:flex;flex-direction:column;gap:.75rem">
                    <div class="form-group" style="margin:0">
                        <label class="form-label">Verabreichte Menge</label>
                        <input type="text" id="behandlungMengeNew" class="input" placeholder="z.B. 20ml pro Volk">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label class="form-label">Art der Verabreichung</label>
                        <input type="text" id="behandlungVerabreichungNew" class="input" placeholder="z.B. Langzeitverdunstung, Tr√§ufeln...">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label class="form-label">Lieferant (Name/Anschrift)</label>
                        <input type="text" id="behandlungLieferantNew" class="input" placeholder="z.B. Imkereibedarf Wagner, Karlsruhe">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label class="form-label">Wartezeit bis Honigentnahme</label>
                        <input type="text" id="behandlungWartezeitNew" class="input" placeholder="z.B. 4 Wochen nach letzter Behandlung">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label class="form-label">Name der behandelnden Person</label>
                        <input type="text" id="behandlungBehandlerNew" class="input" placeholder="z.B. Julian Mustermann">
                    </div>
                    <div style="font-size:.75rem;color:#7A6652;padding:.5rem;background:#FFF8EE;border-radius:.35rem">‚öñÔ∏è Diese Angaben werden f√ºr das offizielle Bestandsbuch ben√∂tigt (EU VO 2019/6). Du kannst sie auch sp√§ter im Bestandsbuch erg√§nzen.</div>
                </div>
            </details>
            <button class="btn btn-primary btn-block" onclick="behandlungMod.saveBehandlung()">Behandlung speichern</button>
        </div>
    </div>
</div>

<nav class="nav">
    <div class="nav-brand">
        <div style="font-size:1.5rem;font-weight:bold;color:#F5A623">üêù</div>
        <div style="font-size:.85rem;font-weight:600;color:#1C1410;margin-top:.25rem">Imkerei</div>
        <div style="font-size:.7rem;color:#7A6652">Cloud v6.0</div>
    </div>
    <div class="nav-section">√úbersicht</div>
    <button class="nav-item active" data-page="heute">üìÖ Heute</button>
    <button class="nav-item" data-page="standorte">üìç Standorte</button>
    <div class="nav-section">V√∂lker</div>
    <button class="nav-item" data-page="koeniginnen">üëë K√∂niginnenzucht</button>
    <button class="nav-item" data-page="behandlung">üíâ Behandlungen</button>
    <a href="bestandsbuch.html" class="nav-item" style="text-decoration:none;color:inherit;display:flex;align-items:center;gap:.5rem">üìã Bestandsbuch</a>
    <div class="nav-section">Ernte & Planung</div>
    <button class="nav-item" data-page="ernte">üçØ Honigernte</button>
    <button class="nav-item" data-page="tracht">üå∏ Tracht</button>
    <button class="nav-item" data-page="aufgaben">‚úì Aufgaben</button>
    <div class="nav-section">Verwaltung</div>
    <button class="nav-item" data-page="kosten">üí∞ Kosten</button>
    <button class="nav-item" data-page="packliste">üìã Packliste</button>
    <div style="flex:1"></div>
    <button class="nav-item" data-page="einstellungen">‚öôÔ∏è Einstellungen</button>
    <button class="nav-item" style="color:#ef4444" onclick="doLogout()">üö™ Abmelden</button>
</nav>

<script>
// ============================================
// SUPABASE CLIENT
// ============================================
const SUPABASE_URL = "https://reyswuedptkyfdkmdpft.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJleXN3dWVkcHRreWZka21kcGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NjM0MDQsImV4cCI6MjA4NzQzOTQwNH0.mrqs7lPs3S7B62sKpTbuzuxAcodil04RQ7HUjuQHuKI";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// ============================================
// AUTH FUNCTIONS
// ============================================
function showAuthTab(tab) {
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
    document.getElementById('forgotForm').style.display = tab === 'forgot' ? 'block' : 'none';
    document.getElementById('resetForm').style.display = tab === 'reset' ? 'block' : 'none';
    document.getElementById('authError').style.display = 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t,i) {
        t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='register'&&i===1));
    });
}

function showAuthError(msg) {
    var el = document.getElementById('authError');
    el.textContent = msg; el.style.display = 'block';
}

async function doSetNewPassword() {
    var pw1 = document.getElementById('resetNewPassword').value;
    var pw2 = document.getElementById('resetNewPassword2').value;
    if (!pw1 || pw1.length < 6) { showAuthError('Passwort muss mindestens 6 Zeichen haben'); return; }
    if (pw1 !== pw2) { showAuthError('Passw√∂rter stimmen nicht √ºberein'); return; }
    var result = await sb.auth.updateUser({password: pw1});
    if (result.error) { showAuthError(result.error.message); return; }
    showAuthError('');
    document.getElementById('authError').style.display = 'block';
    document.getElementById('authError').style.background = '#d1fae5';
    document.getElementById('authError').style.borderColor = '#6ee7b7';
    document.getElementById('authError').style.color = '#065f46';
    document.getElementById('authError').textContent = '‚úÖ Passwort erfolgreich ge√§ndert! Du wirst eingeloggt...';
    setTimeout(async function(){
        currentUser = result.data.user;
        await startApp();
    }, 1500);
}

async function doLogin() {
    var email = document.getElementById('loginEmail').value.trim();
    var pw = document.getElementById('loginPassword').value;
    if (!email || !pw) { showAuthError('Bitte E-Mail und Passwort eingeben'); return; }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    var result = await sb.auth.signInWithPassword({ email: email, password: pw });
    if (result.error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        showAuthError(result.error.message === 'Invalid login credentials' ? 'Falsche E-Mail oder Passwort' : result.error.message);
        return;
    }
    currentUser = result.data.user;
    // Last login speichern
    sb.from('profiles').update({last_login: new Date().toISOString()}).eq('user_id', currentUser.id);
    // Alte localStorage Trachten aufr√§umen
    localStorage.removeItem('imkerei_trachten');
    await startApp();
}

async function doRegister() {
    var name = document.getElementById('regName').value.trim();
    var imkerei = document.getElementById('regImkerei').value.trim();
    var email = document.getElementById('regEmail').value.trim();
    var pw = document.getElementById('regPassword').value;
    var pw2 = document.getElementById('regPassword2').value;
    
    if (!name) { showAuthError('Bitte Namen eingeben'); return; }
    if (!email) { showAuthError('Bitte E-Mail eingeben'); return; }
    if (pw.length < 6) { showAuthError('Passwort muss min. 6 Zeichen haben'); return; }
    if (pw !== pw2) { showAuthError('Passw√∂rter stimmen nicht √ºberein'); return; }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    var result = await sb.auth.signUp({ email: email, password: pw });
    if (result.error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        showAuthError(result.error.message); return;
    }
    currentUser = result.data.user;
    
    // Profil anlegen
    await sb.from('profiles').insert({ id: currentUser.id, name: name, imkerei: imkerei, email: email });
    
    // Standard-Packliste erstellen
    await packlisteMod.erstelleNeueItems();
    
    await startApp();
}

async function doForgotPassword() {
    var email = document.getElementById('forgotEmail').value.trim();
    if (!email) { showAuthError('Bitte E-Mail eingeben'); return; }
    var result = await sb.auth.resetPasswordForEmail(email);
    if (result.error) { showAuthError(result.error.message); return; }
    showAuthError(''); 
    document.getElementById('authError').style.display = 'block';
    document.getElementById('authError').style.background = '#d1fae5';
    document.getElementById('authError').style.borderColor = '#6ee7b7';
    document.getElementById('authError').style.color = '#065f46';
    document.getElementById('authError').textContent = 'üìß Reset-Link wurde gesendet! Pr√ºfe dein Postfach.';
}

async function doLogout() {
    await sb.auth.signOut();
    currentUser = null;
    document.getElementById('authScreen').style.display = 'block';
    document.querySelector('.nav').style.display = 'none';
    document.getElementById('app').innerHTML = '';
    document.querySelector('.footer').style.display = 'none';
}

// ============================================
// APP START - Load all data from Supabase
// ============================================
async function startApp() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('authScreen').style.display = 'none';
    document.querySelector('.nav').style.display = '';
    document.querySelector('.footer').style.display = '';
    
    // Load profile
    var profileRes = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    app.data.user = profileRes.data || { name: currentUser.email, email: currentUser.email };
    
    // Load all data in parallel
    var results = await Promise.all([
        sb.from('standorte').select('*').eq('user_id', currentUser.id),
        sb.from('voelker').select('*').eq('user_id', currentUser.id),
        sb.from('aufgaben').select('*').eq('user_id', currentUser.id),
        sb.from('kosten').select('*').eq('user_id', currentUser.id),
        sb.from('zuchtplaene').select('*').eq('user_id', currentUser.id),
        sb.from('trachten').select('*').eq('user_id', currentUser.id),
        sb.from('behandlungen').select('*').eq('user_id', currentUser.id),
        sb.from('packliste').select('*').eq('user_id', currentUser.id),
        sb.from('trachten_ausgeblendet').select('*').eq('user_id', currentUser.id)
    ]);
    
    // Map DB rows to app format
    app.data.standorte = (results[0].data || []).map(function(r) {
        return { id: r.id, name: r.name, notizen: r.notizen, mapsLink: r.maps_link, lat: r.lat, lng: r.lng, created: r.created_at };
    });
    app.data.voelker = (results[1].data || []).map(function(r) {
        return { id: r.id, standortId: r.standort_id, name: r.name, beutensystem: r.beutensystem, status: r.status, notizen: r.notizen, honigertrag: parseFloat(r.honigertrag)||0, created: r.created_at };
    });
    app.data.aufgaben = (results[2].data || []).map(function(r) {
        return { id: r.id, typ: r.typ, notiz: r.notiz, faelligkeit: r.faelligkeit, dauer: r.dauer, prio: r.prio, erledigt: r.erledigt, created: r.created_at };
    });
    app.data.kosten = (results[3].data || []).map(function(r) {
        return { id: r.id, beschreibung: r.beschreibung, betrag: parseFloat(r.betrag)||0, kat: r.kat, datum: r.datum };
    });
    zuchtplanMod.plaene = (results[4].data || []).map(function(r) {
        return { id: r.id, name: r.name, sammelbrut: r.sammelbrut, umlarven: r.umlarven, zusetzen: r.zusetzen, notizen: r.notizen, tageUmlarven: r.tage_umlarven, tageZusetzen: r.tage_zusetzen, created: r.created_at };
    });
    trachtkalenderMod.trachten = (results[5].data || []).map(function(r) {
        return { id: r.id, typ: r.typ, standort: r.standort, beginn: r.beginn, ende: r.ende, ertrag: parseFloat(r.ertrag)||0, notizen: r.notizen, lat: r.lat||null, lng: r.lng||null, shared: r.shared||false, created: r.created_at };
    });
    behandlungMod.behandlungen = (results[6].data || []).map(function(r) {
        return { id: r.id, voelkerIds: r.voelker_ids, voelkerLabel: r.voelker_label, methode: r.methode, methodeName: r.methode_name, datum: r.datum, intervall: r.intervall, intervallLabel: r.intervall_label, termine: r.termine, notizen: r.notizen, standortId: r.standort_id||null, menge: r.menge||'', verabreichung: r.verabreichung||'', lieferant: r.lieferant||'', wartezeit: r.wartezeit||'', behandler: r.behandler||'', created: r.created_at };
    });
    packlisteMod.items = (results[7].data || []).map(function(r) {
        return { id: r.id, kategorie: r.kategorie, name: r.name, checked: r.checked, menge: r.menge, istSchnell: r.ist_schnell, schnellTyp: r.schnell_typ };
    });
    trachtkalenderMod.ausgeblendete = (results[8].data || []).map(function(r) { return r.tracht_name; });
    
    // If packliste is empty for new user, create defaults
    if (packlisteMod.items.length === 0) {
        await packlisteMod.erstelleNeueItems();
    }
    
    document.getElementById('loadingOverlay').style.display = 'none';
    app.initUI();
    app.render();
    
    // Wetter im Hintergrund laden
    wetterMod.laden().then(function(){ app.render(); });
}

// Save indicator
function showSaved() {
    var el = document.getElementById('saveIndicator');
    el.classList.add('show');
    setTimeout(function(){ el.classList.remove('show'); }, 1500);
}

// ============================================
// DB HELPER - Supabase CRUD
// ============================================
const db = {
    async upsert(table, data) {
        var result = await sb.from(table).upsert(data);
        if (result.error) console.error('DB upsert error:', table, result.error);
        showSaved();
        return result;
    },
    async insert(table, data) {
        var result = await sb.from(table).insert(data);
        if (result.error) console.error('DB insert error:', table, result.error);
        showSaved();
        return result;
    },
    async update(table, data, id) {
        var result = await sb.from(table).update(data).eq('id', id);
        if (result.error) console.error('DB update error:', table, result.error);
        showSaved();
        return result;
    },
    async del(table, id) {
        var result = await sb.from(table).delete().eq('id', id);
        if (result.error) console.error('DB delete error:', table, result.error);
        showSaved();
        return result;
    },
    async delWhere(table, col, val) {
        var result = await sb.from(table).delete().eq(col, val);
        if (result.error) console.error('DB delWhere error:', table, result.error);
        return result;
    }
};

// ============================================
// CONSTANTS
// ============================================
const TT={
    futter:'üçØ Futter',durchsicht:'üîç Durchsicht',varroabehandlung:'üíâ Varroa',honigraum:'üì¶ Honigraum',absperrgitter:'‚äû Gitter',schwarmkontrolle:'üëÄ Schwarm',ableger:'üêù Ableger',koenigin:'üëë K√∂nigin',mittelwaende:'‚ñ≠ Mittelwand',waben:'‚ó´ Waben',raehmchen:'ü™µ R√§hmchen',standort:'üöó Standort',honigschleudern:'üçØ Schleudern',wachs:'üïØÔ∏è Wachs',equipmentwartung:'üîß Wartung',beuten:'üè† Beuten',varroa:'üî¨ Varroa',gem√ºlldiagnose:'üîç Gem√ºll',winterfutter:'‚ùÑÔ∏è Winter',fluglochkeil:'üö™ Flugloch',maeusegitter:'üê≠ M√§use',custom:'‚úèÔ∏è Eigene'
};
const KK=['Futter','Behandlung','Material','Werkzeug','Fahrtkosten','Verpackung','Energie','Versicherung','Fortbildung','Sonstiges'];
const KOSTEN_VORLAGEN={
    'Benzin':{kat:'Fahrtkosten',betrag:15.00},'Diesel':{kat:'Fahrtkosten',betrag:20.00},'Zucker 25kg':{kat:'Futter',betrag:25.00},'Apifonda':{kat:'Futter',betrag:35.00},'Ameisens√§ure':{kat:'Behandlung',betrag:15.00},'Oxals√§ure':{kat:'Behandlung',betrag:12.00},'Mittelw√§nde':{kat:'Material',betrag:30.00},'Gl√§ser':{kat:'Verpackung',betrag:45.00},'Etiketten':{kat:'Verpackung',betrag:20.00},'Strom':{kat:'Energie',betrag:50.00}
};
const app={
    data:{user:null,standorte:[],voelker:[],aufgaben:[],kosten:[]},
    page:'heute',
    pending:null,
    editStandortId:null,
    editVolkId:null,
    editAufgabeId:null,
    editZuchtId:null,
    selectedStandortId:null,
    selectedVolkStatus:'ok',
    selectedAufgabeTyp:null,
    selectedPrio:'medium',
    selectedDauer:120,
    selectedKostenKat:null,
    voelkerCount:2,
    _toastTimer:null,
    
    init(){
        // Auth check handled externally
    },
    
    initUI(){
        const self=this;
        document.querySelectorAll('.nav-item[data-page]').forEach(function(btn){
            btn.addEventListener('click',function(){
                document.querySelectorAll('.nav-item').forEach(function(b){b.classList.remove('active');});
                btn.classList.add('active');
                self.page=btn.dataset.page;
                self.render();
            });
        });
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('aufgabeDatum').value = today;
        document.getElementById('kostenDatum').value = today;
        
        this.renderAufgabeTypes();
        this.renderKostenKategorien();
        this.renderKostenVorlagen();
    },
    
    toast(msg, type='success', duration=2500){
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.className = 'toast ' + type;
        requestAnimationFrame(function(){
            el.classList.add('show');
        });
        clearTimeout(this._toastTimer);
        const self = this;
        this._toastTimer = setTimeout(function(){
            el.classList.remove('show');
        }, duration);
    },
    
    // === REGISTRATION ===
    startReg(){
        const n = document.getElementById('regName').value.trim();
        const e = document.getElementById('regEmail').value.trim();
        const ok = document.getElementById('regDatenschutz').checked;
        
        if(!n){alert('Bitte Namen eingeben!');return;}
        if(!e || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){alert('Bitte g√ºltige E-Mail eingeben!');return;}
        if(!ok){alert('Bitte Datenschutz akzeptieren!');return;}
        
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        this.pending = {
            name: n,
            imkerei: document.getElementById('regImkerei').value.trim(),
            email: e,
            code: code,
            ts: Date.now()
        };
        
        emailjs.send('service_rowhptg', 'template_oqn3t06', {
            from_name: n,
            imkerei: this.pending.imkerei || '-',
            email: e,
            datum: 'Dein Best√§tigungscode: ' + code
        }).then(() => {
            this.toast('üìß Code gesendet!', 'success');
        }).catch(() => {
            this.toast('E-Mail Fehler', 'error');
        });
        
        // registration handled by auth screen
        document.getElementById('codeEmail').textContent = e;
        document.getElementById('codeModal').classList.add('active');
    },
    
    verifyCode(){
        const c = document.getElementById('codeInput').value.trim();
        if(!this.pending) return;
        
        if(c !== this.pending.code){
            alert('Falscher Code!');
            return;
        }
        
        this.data.user = {
            name: this.pending.name,
            imkerei: this.pending.imkerei,
            email: this.pending.email,
            emailConfirmed: true,
            registeredAt: this.pending.ts
        };
        
        if(!this.data.registrations) this.data.registrations = [];
        this.data.registrations.push({
            id: 'r' + this.uid(),
            name: this.pending.name,
            imkerei: this.pending.imkerei,
            email: this.pending.email,
            emailConfirmed: true,
            registeredAt: this.pending.ts
        });
        
        emailjs.send('service_rowhptg', 'template_oqn3t06', {
            from_name: this.pending.name,
            imkerei: this.pending.imkerei || '-',
            email: this.pending.email,
            datum: 'Neue Registrierung: ' + this.fdt(Date.now())
        }).catch(() => {});
        
        this.save();
        document.getElementById('codeModal').classList.remove('active');
        this.pending = null;
        this.toast('Willkommen! üêù', 'success', 3000);
        this.render();
    },
    
    resendCode(){
        if(!this.pending) return;
        
        emailjs.send('service_rowhptg', 'template_oqn3t06', {
            from_name: this.pending.name,
            imkerei: this.pending.imkerei || '-',
            email: this.pending.email,
            datum: 'Dein Best√§tigungscode: ' + this.pending.code
        }).then(() => {
            this.toast('üìß Erneut gesendet!', 'info');
        }).catch(() => {
            this.toast('Fehler', 'error');
        });
    },
    
    // === GRIDS F√úLLEN ===
    renderAufgabeTypes(){
        const grid = document.getElementById('aufgabeTypGrid');
        grid.innerHTML = Object.entries(TT).map(function(entry){
            const key = entry[0];
            const label = entry[1];
            const parts = label.split(' ');
            const emoji = parts[0];
            const text = parts.slice(1).join(' ');
            return '<button class="option-btn" onclick="app.selectAufgabeTyp(\''+key+'\')"><span class="emoji">'+emoji+'</span>'+text+'</button>';
        }).join('');
    },
    
    renderKostenKategorien(){
        const grid = document.getElementById('kostenKatGrid');
        grid.innerHTML = KK.map(function(kat){
            return '<button class="option-btn" onclick="app.selectKostenKat(\''+kat+'\')">'+kat+'</button>';
        }).join('');
    },
    
    renderKostenVorlagen(){
        const grid = document.getElementById('kostenVorlagenGrid');
        grid.innerHTML = Object.entries(KOSTEN_VORLAGEN).map(function(entry){
            const name = entry[0];
            const data = entry[1];
            return '<button class="option-btn" onclick="app.useKostenVorlage(\''+name+'\')">'+name+'<br><small style="color:#7A6652">'+data.betrag.toFixed(2)+'‚Ç¨</small></button>';
        }).join('');
    },
    
    // === MODAL FUNKTIONEN ===
    openModal(id){
        document.getElementById(id).classList.add('active');
    },
    
    closeModal(id){
        document.getElementById(id).classList.remove('active');
        
        if(id === 'aufgabeModal'){
            this.editAufgabeId = null;
            this.selectedAufgabeTyp = null;
            this.selectedPrio = 'medium';
            document.getElementById('aufgabeNotiz').value = '';
            document.querySelectorAll('#aufgabeTypGrid .option-btn').forEach(function(btn){
                btn.classList.remove('selected');
            });
        }else if(id === 'kostenModal'){
            this.selectedKostenKat = null;
            document.getElementById('kostenBeschreibung').value = '';
            document.getElementById('kostenBetrag').value = '';
            document.querySelectorAll('#kostenKatGrid .option-btn').forEach(function(btn){
                btn.classList.remove('selected');
            });
        }else if(id === 'standortModal'){
            this.editStandortId = null;
            this.voelkerCount = 2;
            document.getElementById('standortName').value = '';
            document.getElementById('standortVoelkerCount').textContent = '2';
            document.getElementById('standortNotizen').value = '';
        }else if(id === 'volkModal'){
            this.editVolkId = null;
            this.selectedVolkStatus = 'ok';
            document.getElementById('volkName').value = '';
            document.getElementById('volkNotizen').value = '';
            document.getElementById('volkHonig').value = '';
        }else if(id === 'zuchtModal'){
            this.editZuchtId = null;
            document.getElementById('zuchtName').value = '';
            document.getElementById('zuchtNotizen').value = '';
        }else if(id === 'trachtModal'){
            document.getElementById('trachtStandort').value = '';
            document.getElementById('trachtErtrag').value = '';
            document.getElementById('trachtNotizen').value = '';
        }
    },
    
    // === COUNTER ===
    changeVoelkerCount(delta){
        this.voelkerCount = Math.max(0, this.voelkerCount + delta);
        document.getElementById('standortVoelkerCount').textContent = this.voelkerCount;
    },
    
    // === STANDORTE ===
    openStandortModal(id){
        if(id){
            const s = this.data.standorte.find(function(x){return x.id === id;});
            if(s){
                this.editStandortId = id;
                document.getElementById('standortModalTitle').textContent = 'üìç Standort bearbeiten';
                document.getElementById('standortName').value = s.name;
                const voelkerAnzahl = this.data.voelker.filter(function(v){return v.standortId === id;}).length;
                this.voelkerCount = voelkerAnzahl;
                document.getElementById('standortVoelkerCount').textContent = voelkerAnzahl;
                document.getElementById('standortNotizen').value = s.notizen || '';
                document.getElementById('standortLat').value = s.lat || '';
                document.getElementById('standortLng').value = s.lng || '';
                this._standortEditLat = s.lat || null;
                this._standortEditLng = s.lng || null;
            }
        }else{
            this.editStandortId = null;
            this.voelkerCount = 2;
            document.getElementById('standortModalTitle').textContent = 'üìç Neuer Standort';
            document.getElementById('standortVoelkerCount').textContent = '2';
            document.getElementById('standortLat').value = '';
            document.getElementById('standortLng').value = '';
            document.getElementById('standortKoordStatus').innerHTML = '';
            this._standortEditLat = null;
            this._standortEditLng = null;
        }
        this.openModal('standortModal');
        // Karte initialisieren nach kurzer Verz√∂gerung (Modal muss sichtbar sein)
        setTimeout(function(){ app.initMapPicker('standort'); }, 300);
    },
    
    initMapPicker(type){
        var containerId = type === 'standort' ? 'standortMapPicker' : 'trachtMapPicker';
        var latId = type === 'standort' ? 'standortLat' : 'trachtLatE';
        var lngId = type === 'standort' ? 'standortLng' : 'trachtLngE';
        var statusId = type === 'standort' ? 'standortKoordStatus' : 'koordinatenStatus';
        
        var container = document.getElementById(containerId);
        if (!container) return;
        
        // Alte Map-Instanz entfernen
        if (container._mapInstance) {
            container._mapInstance.remove();
            container._mapInstance = null;
        }
        container.innerHTML = '';
        
        // Startposition: gespeicherte Koordinaten oder Deutschland-Mitte
        var startLat = parseFloat(document.getElementById(latId).value) || 49.0;
        var startLng = parseFloat(document.getElementById(lngId).value) || 10.0;
        var startZoom = document.getElementById(latId).value ? 14 : 6;
        
        var map = L.map(container, {zoomControl: true}).setView([startLat, startLng], startZoom);
        container._mapInstance = map;
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OSM',
            maxZoom: 19
        }).addTo(map);
        
        var marker = null;
        
        // Wenn schon Koordinaten da sind, Marker setzen
        if (document.getElementById(latId).value) {
            marker = L.marker([startLat, startLng]).addTo(map);
            document.getElementById(statusId).innerHTML = '<span style="color:#10b981">‚úÖ Position gesetzt: '+startLat.toFixed(4)+', '+startLng.toFixed(4)+'</span>';
        }
        
        // Klick auf Karte setzt Marker
        map.on('click', function(e){
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            document.getElementById(latId).value = lat;
            document.getElementById(lngId).value = lng;
            document.getElementById(statusId).innerHTML = '<span style="color:#10b981">‚úÖ Position gesetzt: '+lat.toFixed(4)+', '+lng.toFixed(4)+'</span>';
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map);
        });
        
        // Karte mehrfach invalidieren damit sie korrekt rendert
        setTimeout(function(){ map.invalidateSize(); }, 100);
        setTimeout(function(){ map.invalidateSize(); }, 500);
        setTimeout(function(){ map.invalidateSize(); }, 1000);
    },
    
    parseStandortKoord(){
        // Not needed anymore - map picker handles it
    },
    
    saveStandort(){
        const name = document.getElementById('standortName').value.trim();
        const voelkerAnzahl = this.voelkerCount;
        const notizen = document.getElementById('standortNotizen').value.trim();
        const mapsLink = '';
        const lat = parseFloat(document.getElementById('standortLat').value) || null;
        const lng = parseFloat(document.getElementById('standortLng').value) || null;
        
        if(!name){
            alert('Bitte Namen eingeben!');
            return;
        }
        
        if(this.editStandortId){
            const s = this.data.standorte.find(function(x){return x.id === app.editStandortId;});
            if(s){
                s.name = name;
                s.notizen = notizen;
                s.mapsLink = mapsLink;
                s.lat = lat;
                s.lng = lng;
                
                const aktuelleVoelker = this.data.voelker.filter(function(v){return v.standortId === app.editStandortId;});
                const diff = voelkerAnzahl - aktuelleVoelker.length;
                
                if(diff > 0){
                    for(let i = 0; i < diff; i++){
                        this.data.voelker.push({
                            id: 'v' + this.uid(),
                            standortId: this.editStandortId,
                            name: 'Volk ' + (aktuelleVoelker.length + i + 1),
                            beutensystem: 'Dadant',
                            status: 'ok',
                            notizen: '',
                            honigertrag: 0,
                            created: Date.now()
                        });
                    }
                }else if(diff < 0){
                    const zuLoeschen = aktuelleVoelker.slice(diff);
                    zuLoeschen.forEach(function(v){
                        app.data.voelker = app.data.voelker.filter(function(x){return x.id !== v.id;});
                    });
                }
            }
        }else{
            const standortId = 's' + this.uid();
            this.data.standorte.push({
                id: standortId,
                name: name,
                notizen: notizen,
                mapsLink: mapsLink,
                lat: lat,
                lng: lng,
                created: Date.now()
            });
            
            for(let i = 1; i <= voelkerAnzahl; i++){
                this.data.voelker.push({
                    id: 'v' + this.uid(),
                    standortId: standortId,
                    name: 'Volk ' + i,
                    beutensystem: 'Dadant',
                    status: 'ok',
                    notizen: '',
                    honigertrag: 0,
                    created: Date.now()
                });
            }
        }
        
        this.closeModal('standortModal');
        this.render();
        // Save to Supabase
        if(this.editStandortId){
            var s = this.data.standorte.find(function(x){return x.id === app.editStandortId;});
            if(s) db.update('standorte', {name:s.name, notizen:s.notizen, maps_link:s.mapsLink, lat:s.lat, lng:s.lng}, s.id);
            // Save all voelker for this standort
            this.data.voelker.filter(function(v){return v.standortId===app.editStandortId;}).forEach(function(v){
                db.upsert('voelker', {id:v.id, user_id:currentUser.id, standort_id:v.standortId, name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen, honigertrag:v.honigertrag, created_at:v.created});
            });
        } else {
            var newS = this.data.standorte[this.data.standorte.length-1];
            db.upsert('standorte', {id:newS.id, user_id:currentUser.id, name:newS.name, notizen:newS.notizen, maps_link:newS.mapsLink, lat:newS.lat, lng:newS.lng, created_at:newS.created});
            this.data.voelker.filter(function(v){return v.standortId===newS.id;}).forEach(function(v){
                db.upsert('voelker', {id:v.id, user_id:currentUser.id, standort_id:v.standortId, name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen||'', honigertrag:v.honigertrag||0, created_at:v.created});
            });
        }
    },
    
    delStandort(id){
        if(!confirm('Standort und alle V√∂lker wirklich l√∂schen?')) return;
        
        this.data.standorte = this.data.standorte.filter(function(s){return s.id !== id;});
        this.data.voelker = this.data.voelker.filter(function(v){return v.standortId !== id;});
        db.del('standorte', id);
        db.delWhere('voelker', 'standort_id', id);
        this.render();
    },
    
    // === V√ñLKER ===
    openVolkModal(id){
        const v = this.data.voelker.find(function(x){return x.id === id;});
        if(!v) return;
        
        this.editVolkId = id;
        this.selectedVolkStatus = v.status || 'ok';
        document.getElementById('volkModalTitle').textContent = 'üêù ' + v.name;
        document.getElementById('volkName').value = v.name;
        document.getElementById('volkBeute').value = v.beutensystem || 'Dadant';
        document.getElementById('volkNotizen').value = v.notizen || '';
        document.getElementById('volkHonig').value = v.honigertrag || 0;
        
        // Status buttons markieren
        document.querySelectorAll('#volkModal .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        
        this.openModal('volkModal');
        
        // Status button nach kurzer Verz√∂gerung markieren
        setTimeout(function(){
            const statusMap = {
                'ok': 0,
                'schwach': 1,
                'weisellos': 2,
                'problem': 3
            };
            const btns = document.querySelectorAll('#volkModal .option-btn');
            const idx = statusMap[v.status] || 0;
            if(btns[idx]) btns[idx].classList.add('selected');
        }, 50);
    },
    
    setVolkStatus(status){
        this.selectedVolkStatus = status;
        document.querySelectorAll('#volkModal .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
    },
    
    saveVolk(){
        if(!this.editVolkId) return;
        
        const v = this.data.voelker.find(function(x){return x.id === app.editVolkId;});
        if(!v) return;
        
        v.name = document.getElementById('volkName').value.trim();
        v.beutensystem = document.getElementById('volkBeute').value;
        v.status = this.selectedVolkStatus;
        v.notizen = document.getElementById('volkNotizen').value.trim();
        v.honigertrag = parseFloat(document.getElementById('volkHonig').value) || 0;
        
        db.update('voelker', {name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen, honigertrag:v.honigertrag}, v.id);
        this.closeModal('volkModal');
        this.render();
    },
    
    deleteVolk(){
        if(!this.editVolkId) return;
        if(!confirm('Volk wirklich l√∂schen?')) return;
        
        var delId = app.editVolkId;
        this.data.voelker = this.data.voelker.filter(function(v){return v.id !== delId;});
        db.del('voelker', delId);
        this.closeModal('volkModal');
        this.render();
    },
    
    showStandortDetails(id){
        this.selectedStandortId = id;
        this.render();
    },
    
    // === AUFGABEN ===
    selectAufgabeTyp(typ){
        this.selectedAufgabeTyp = typ;
        document.querySelectorAll('#aufgabeTypGrid .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.closest('.option-btn').classList.add('selected');
        
        if(typ === 'custom'){
            const name = prompt('Name der Aufgabe:');
            if(name) document.getElementById('aufgabeNotiz').value = name;
        }
    },
    
    setPrio(prio){
        this.selectedPrio = prio;
        document.querySelectorAll('.priority-btn').forEach(function(btn){
            btn.classList.remove('selected', 'low', 'medium', 'high');
        });
        event.target.classList.add('selected', prio);
    },
    
    setDauer(minuten){
        this.selectedDauer = minuten;
        document.getElementById('aufgabeDauer').value = minuten;
        document.querySelectorAll('.dauer-btns .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
    },
    
    openAufgabeModal(id){
        if(id){
            const a = this.data.aufgaben.find(function(x){return x.id === id;});
            if(a){
                this.editAufgabeId = id;
                this.selectedAufgabeTyp = a.typ;
                this.selectedPrio = a.prio;
                this.selectedDauer = a.dauer;
                
                document.getElementById('aufgabeModalTitle').textContent = '‚úì Aufgabe bearbeiten';
                document.getElementById('aufgabeDatum').value = new Date(a.faelligkeit).toISOString().split('T')[0];
                document.getElementById('aufgabeDauer').value = a.dauer;
                
                const notizParts = a.notiz.split(' - ');
                document.getElementById('aufgabeNotiz').value = notizParts.length > 1 ? notizParts[1] : '';
                
                // Typ button markieren
                setTimeout(function(){
                    document.querySelectorAll('#aufgabeTypGrid .option-btn').forEach(function(btn, idx){
                        btn.classList.remove('selected');
                        if(Object.keys(TT)[idx] === a.typ){
                            btn.classList.add('selected');
                        }
                    });
                }, 50);
            }
        }else{
            this.editAufgabeId = null;
            document.getElementById('aufgabeModalTitle').textContent = '‚úì Neue Aufgabe';
        }
        this.openModal('aufgabeModal');
    },
    
    saveAufgabe(){
        if(!this.selectedAufgabeTyp){
            alert('Bitte w√§hle einen Aufgaben-Typ!');
            return;
        }
        
        const datum = document.getElementById('aufgabeDatum').value;
        const dauer = parseInt(document.getElementById('aufgabeDauer').value);
        const notiz = document.getElementById('aufgabeNotiz').value;
        
        if(this.editAufgabeId){
            const a = this.data.aufgaben.find(function(x){return x.id === app.editAufgabeId;});
            if(a){
                a.typ = this.selectedAufgabeTyp;
                a.notiz = TT[this.selectedAufgabeTyp] + (notiz ? ' - ' + notiz : '');
                a.faelligkeit = new Date(datum).getTime();
                a.dauer = dauer;
                a.prio = this.selectedPrio;
                db.update('aufgaben', {typ:a.typ, notiz:a.notiz, faelligkeit:a.faelligkeit, dauer:a.dauer, prio:a.prio}, a.id);
            }
        }else{
            const aufgabe = {
                id: 'a' + this.uid(),
                typ: this.selectedAufgabeTyp,
                notiz: TT[this.selectedAufgabeTyp] + (notiz ? ' - ' + notiz : ''),
                faelligkeit: new Date(datum).getTime(),
                dauer: dauer,
                prio: this.selectedPrio,
                erledigt: false,
                created: Date.now()
            };
            this.data.aufgaben.push(aufgabe);
            db.insert('aufgaben', {id:aufgabe.id, user_id:currentUser.id, typ:aufgabe.typ, notiz:aufgabe.notiz, faelligkeit:aufgabe.faelligkeit, dauer:aufgabe.dauer, prio:aufgabe.prio, erledigt:null, created_at:aufgabe.created});
        }
        
        this.closeModal('aufgabeModal');
        this.render();
    },
    
    doneA(id){
        const a = this.data.aufgaben.find(function(x){return x.id === id;});
        if(a){
            a.erledigt = Date.now();
            db.update('aufgaben', {erledigt: a.erledigt}, a.id);
            this.render();
        }
    },
    
    undoneA(id){
        const a = this.data.aufgaben.find(function(x){return x.id === id;});
        if(a){
            a.erledigt = null;
            db.update('aufgaben', {erledigt: null}, a.id);
            this.render();
        }
    },
    
    // === ZUCHTPLAN ===
    openZuchtModal(id){
        if(id){
            const z = this.data.zuchtplaene.find(function(x){return x.id === id;});
            if(z){
                this.editZuchtId = id;
                document.getElementById('zuchtName').value = z.name;
                document.getElementById('zuchtSammelbrut').value = new Date(z.sammelbrut).toISOString().split('T')[0];
                document.getElementById('zuchtUmlarven').value = new Date(z.umlarven).toISOString().split('T')[0];
                document.getElementById('zuchtZusetzen').value = new Date(z.zusetzen).toISOString().split('T')[0];
                document.getElementById('zuchtNotizen').value = z.notizen || '';
            }
        }else{
            this.editZuchtId = null;
        }
        this.openModal('zuchtModal');
    },
    
    saveZucht(){
        const name = document.getElementById('zuchtName').value.trim();
        const sammelbrut = document.getElementById('zuchtSammelbrut').value;
        const umlarven = document.getElementById('zuchtUmlarven').value;
        const zusetzen = document.getElementById('zuchtZusetzen').value;
        const notizen = document.getElementById('zuchtNotizen').value.trim();
        
        if(!name || !sammelbrut){
            alert('Bitte Namen und Sammelbrut-Datum eingeben!');
            return;
        }
        
        if(!this.data.zuchtplaene) this.data.zuchtplaene = [];
        
        if(this.editZuchtId){
            const z = this.data.zuchtplaene.find(function(x){return x.id === app.editZuchtId;});
            if(z){
                z.name = name;
                z.sammelbrut = new Date(sammelbrut).getTime();
                z.umlarven = umlarven ? new Date(umlarven).getTime() : null;
                z.zusetzen = zusetzen ? new Date(zusetzen).getTime() : null;
                z.notizen = notizen;
            }
        }else{
            this.data.zuchtplaene.push({
                id: 'z' + this.uid(),
                name: name,
                sammelbrut: new Date(sammelbrut).getTime(),
                umlarven: umlarven ? new Date(umlarven).getTime() : null,
                zusetzen: zusetzen ? new Date(zusetzen).getTime() : null,
                notizen: notizen,
                status: 'geplant',
                created: Date.now()
            });
        }
        
        this.save();
        this.closeModal('zuchtModal');
        this.render();
    },
    
    // === TRACHT ===
    saveTracht(){
        const typ = document.getElementById('trachtTyp').value;
        const standort = document.getElementById('trachtStandort').value.trim();
        const beginn = document.getElementById('trachtBeginn').value;
        const ende = document.getElementById('trachtEnde').value;
        const ertrag = parseFloat(document.getElementById('trachtErtrag').value) || 0;
        const notizen = document.getElementById('trachtNotizen').value.trim();
        
        if(!typ || !standort || !beginn){
            alert('Bitte Typ, Standort und Bl√ºhbeginn eingeben!');
            return;
        }
        
        if(!this.data.trachten) this.data.trachten = [];
        
        this.data.trachten.push({
            id: 't' + this.uid(),
            typ: typ,
            standort: standort,
            beginn: new Date(beginn).getTime(),
            ende: ende ? new Date(ende).getTime() : null,
            ertrag: ertrag,
            notizen: notizen,
            created: Date.now()
        });
        
        this.save();
        this.closeModal('trachtModal');
        this.render();
    },
    
    // === KOSTEN ===
    selectKostenKat(kat){
        this.selectedKostenKat = kat;
        document.querySelectorAll('#kostenKatGrid .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.closest('.option-btn').classList.add('selected');
    },
    
    useKostenVorlage(name){
        const vorlage = KOSTEN_VORLAGEN[name];
        document.getElementById('kostenBeschreibung').value = name;
        document.getElementById('kostenBetrag').value = vorlage.betrag.toFixed(2);
        this.selectedKostenKat = vorlage.kat;
        
        document.querySelectorAll('#kostenKatGrid .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
            if(btn.textContent === vorlage.kat){
                btn.classList.add('selected');
            }
        });
    },
    
    saveKosten(){
        if(!this.selectedKostenKat){
            alert('Bitte w√§hle eine Kategorie!');
            return;
        }
        
        const beschreibung = document.getElementById('kostenBeschreibung').value;
        const betrag = parseFloat(document.getElementById('kostenBetrag').value);
        const datum = document.getElementById('kostenDatum').value;
        
        if(!beschreibung || isNaN(betrag)){
            alert('Bitte f√ºlle alle Felder aus!');
            return;
        }
        
        const kosten = {
            id: 'k' + this.uid(),
            beschreibung: beschreibung,
            betrag: betrag,
            kat: this.selectedKostenKat,
            datum: new Date(datum).getTime()
        };
        
        this.data.kosten.push(kosten);
        db.insert('kosten', {id:kosten.id, user_id:currentUser.id, beschreibung:kosten.beschreibung, betrag:kosten.betrag, kat:kosten.kat, datum:kosten.datum});
        this.closeModal('kostenModal');
        this.render();
    },
    
    // === HILFSFUNKTIONEN ===
    save(){
        // Data is saved directly to Supabase in each operation
    },
    
    uid(){
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    },
    
    fd(ts){
        if(!ts) return '-';
        const d = new Date(ts);
        return d.toLocaleDateString('de-DE');
    },
    
    fdt(ts){
        if(!ts) return '-';
        const d = new Date(ts);
        return d.toLocaleString('de-DE');
    },
    
    // === RENDER ===
    render(){
        const pages = {
            heute: this.rHeute.bind(this),
            standorte: this.selectedStandortId ? this.rStandortDetails.bind(this) : this.rStandorte.bind(this),
            aufgaben: this.rAufgaben.bind(this),
            kosten: this.rKosten.bind(this),
            koeniginnen: this.rZuchtplanEnhanced.bind(this),
            tracht: this.rTracht.bind(this),
            ernte: this.rErnte.bind(this),
            tagebuch: this.rPlaceholder.bind(this),
            behandlung: this.rBehandlungen.bind(this),
            packliste: this.rPackliste.bind(this),
            datenexport: this.rDatenexport.bind(this),
            einstellungen: this.rEinst.bind(this)
        };
        document.getElementById('app').innerHTML = pages[this.page] ? pages[this.page]() : '<div class="container"><h1>Seite nicht gefunden</h1></div>';
    },
    
    // Fortsetzung folgt in Teil 2...
    
    rHeute(){
        const self = this;
        const heute = new Date();
        const heuteStr = heute.toDateString();
        const heuteTs = heute.getTime();
        const in7Tagen = heuteTs + 7*24*60*60*1000;
        
        const aufgabenHeute = this.data.aufgaben.filter(function(a){
            return !a.erledigt && new Date(a.faelligkeit).toDateString() === heuteStr;
        });
        
        // Upcoming aufgaben (next 7 days, not today)
        const aufgabenBald = this.data.aufgaben.filter(function(a){
            if (a.erledigt) return false;
            var d = new Date(a.faelligkeit);
            return d.toDateString() !== heuteStr && a.faelligkeit <= in7Tagen && a.faelligkeit >= heuteTs;
        }).sort(function(a,b){return a.faelligkeit - b.faelligkeit;});
        
        // √úberf√§llige Aufgaben
        const ueberfaellig = this.data.aufgaben.filter(function(a){
            return !a.erledigt && a.faelligkeit < heuteTs && new Date(a.faelligkeit).toDateString() !== heuteStr;
        }).sort(function(a,b){return a.faelligkeit - b.faelligkeit;});
        
        // Anstehende Behandlungen (heute + n√§chste 14 Tage)
        var behandlungenAnstehend = [];
        var in14Tagen = heuteTs + 14*24*60*60*1000;
        behandlungMod.behandlungen.forEach(function(b){
            (b.termine||[]).forEach(function(termin){
                if (termin >= heuteTs - 86400000 && termin <= in14Tagen) {
                    var tage = Math.ceil((termin - heuteTs)/(1000*60*60*24));
                    var status = 'upcoming';
                    var label = 'In '+tage+' Tagen';
                    if (tage < 0) { status = 'overdue'; label = Math.abs(tage)+' Tag(e) √ºberf√§llig'; }
                    else if (tage === 0) { status = 'today'; label = 'Heute!'; }
                    else if (tage === 1) { label = 'Morgen'; }
                    behandlungenAnstehend.push({behandlung:b, termin:termin, tage:tage, status:status, label:label});
                }
            });
        });
        behandlungenAnstehend.sort(function(a,b){return a.termin - b.termin;});
        
        // Zuchtplan-Termine in den n√§chsten 7 Tagen
        var zuchtTermine = [];
        zuchtplanMod.plaene.forEach(function(p){
            [{name:'Umlarven',ts:p.umlarven,emoji:'üî¨'},{name:'Zusetzen',ts:p.zusetzen,emoji:'üëë'}].forEach(function(step){
                if (step.ts) {
                    var tage = Math.ceil((step.ts - heuteTs)/(1000*60*60*24));
                    if (tage >= -1 && tage <= 7) {
                        var label = tage === 0 ? 'Heute!' : (tage === 1 ? 'Morgen' : (tage < 0 ? 'Gestern!' : 'In '+tage+' Tagen'));
                        zuchtTermine.push({plan:p, step:step.name, emoji:step.emoji, tage:tage, label:label});
                    }
                }
            });
        });
        zuchtTermine.sort(function(a,b){return a.tage - b.tage;});
        
        var behandlungenHeute = behandlungenAnstehend.filter(function(x){return x.status==='today';});
        var behandlungenBald = behandlungenAnstehend.filter(function(x){return x.status!=='today';});
        
        return '<div class="container">'+
        '<h1>üìÖ Heute</h1>'+
        '<div class="card">'+
        '<h3>'+heute.toLocaleDateString('de-DE', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'})+'</h3>'+
        '</div>'+
        
        // Wetter 14 Tage
        wetterMod.render()+
        
        // √úberf√§llige Aufgaben (rot)
        (ueberfaellig.length ?
            '<div class="card" style="background:linear-gradient(135deg,#fef2f2,#fff);border-left:4px solid #ef4444">'+
            '<h2 style="margin:0 0 1rem;color:#ef4444">‚ö†Ô∏è √úberf√§llig ('+ueberfaellig.length+')</h2>'+
            ueberfaellig.map(function(a){
                var tage = Math.ceil((heuteTs - a.faelligkeit)/(1000*60*60*24));
                return '<div style="background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.5rem;border:1px solid #fca5a5">'+
                '<div style="display:flex;justify-content:space-between;align-items:center">'+
                '<div><div style="font-weight:600">'+a.notiz+'</div>'+
                '<div style="font-size:.75rem;color:#ef4444">'+tage+' Tag(e) √ºberf√§llig</div></div>'+
                '<div style="display:flex;gap:.5rem">'+
                '<button class="btn btn-blue btn-xs" onclick="app.openAufgabeModal(\''+a.id+'\')">‚úèÔ∏è</button>'+
                '<button class="btn btn-success btn-xs" onclick="app.doneA(\''+a.id+'\')">‚úì</button>'+
                '</div></div></div>';
            }).join('')+
            '</div>'
            : ''
        )+
        
        // Aufgaben heute
        '<div class="card" style="background:linear-gradient(135deg,#FFF8EE,#fff);border-left:4px solid #F5A623">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h2 style="margin:0">‚úì Aufgaben heute ('+aufgabenHeute.length+')</h2>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openAufgabeModal()">+ Neue</button>'+
        '</div>'+
        (aufgabenHeute.length ? 
            aufgabenHeute.map(function(a){
                const pc = a.prio === 'high' ? 'badge-red' : (a.prio === 'medium' ? 'badge-yellow' : 'badge-green');
                return '<div style="background:#fff;padding:1rem;border-radius:.75rem;margin-bottom:.75rem;border:2px solid #E8DFD4">'+
                '<div style="display:flex;justify-content:space-between;align-items:start">'+
                '<div style="flex:1">'+
                '<div style="font-weight:600;margin-bottom:.25rem">'+a.notiz+'</div>'+
                '<div style="font-size:.8rem;color:#7A6652">‚è±Ô∏è '+a.dauer+' Min ¬∑ <span class="badge '+pc+'">'+a.prio.toUpperCase()+'</span></div>'+
                '</div>'+
                '<div style="display:flex;gap:.5rem">'+
                '<button class="btn btn-blue btn-xs" onclick="app.openAufgabeModal(\''+a.id+'\')">‚úèÔ∏è</button>'+
                '<button class="btn btn-success btn-xs" onclick="app.doneA(\''+a.id+'\')">‚úì</button>'+
                '</div></div></div>';
            }).join('') 
            : '<div style="text-align:center;padding:1.5rem;color:#7A6652">Keine Aufgaben f√ºr heute üéâ</div>'
        )+
        '</div>'+
        
        // Behandlungen heute + anstehend
        (behandlungenAnstehend.length ?
            '<div class="card" style="background:linear-gradient(135deg,#f0fdf4,#fff);border-left:4px solid #10b981">'+
            '<h2 style="margin:0 0 1rem">üíâ Behandlungen</h2>'+
            (behandlungenHeute.length ?
                '<div style="margin-bottom:1rem"><div style="font-weight:600;color:#10b981;margin-bottom:.5rem">Heute f√§llig:</div>'+
                behandlungenHeute.map(function(x){
                    var m = METHODEN[x.behandlung.methode] || {name:x.behandlung.methodeName,emoji:'üíä'};
                    return '<div style="background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.5rem;border:2px solid #10b981">'+
                    '<div style="display:flex;align-items:center;gap:.5rem">'+
                    '<span style="font-size:1.5rem">'+m.emoji+'</span>'+
                    '<div><div style="font-weight:600">'+x.behandlung.methodeName+'</div>'+
                    '<div style="font-size:.75rem;color:#7A6652">'+x.behandlung.voelkerLabel+'</div></div>'+
                    '</div></div>';
                }).join('')+
                '</div>'
                : ''
            )+
            (behandlungenBald.length ?
                '<div><div style="font-weight:600;color:#7A6652;margin-bottom:.5rem">N√§chste 14 Tage:</div>'+
                behandlungenBald.slice(0,5).map(function(x){
                    var m = METHODEN[x.behandlung.methode] || {name:x.behandlung.methodeName,emoji:'üíä'};
                    var farbe = x.status==='overdue' ? '#ef4444' : '#7A6652';
                    return '<div style="background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.5rem;border:1px solid #E8DFD4">'+
                    '<div style="display:flex;justify-content:space-between;align-items:center">'+
                    '<div style="display:flex;align-items:center;gap:.5rem">'+
                    '<span style="font-size:1.25rem">'+m.emoji+'</span>'+
                    '<div><div style="font-weight:500;font-size:.9rem">'+x.behandlung.methodeName+'</div>'+
                    '<div style="font-size:.75rem;color:#7A6652">'+x.behandlung.voelkerLabel+'</div></div></div>'+
                    '<div style="font-size:.8rem;font-weight:600;color:'+farbe+'">'+x.label+'</div>'+
                    '</div></div>';
                }).join('')+
                '</div>'
                : ''
            )+
            '</div>'
            : ''
        )+
        
        // Zuchtplan-Termine
        (zuchtTermine.length ?
            '<div class="card" style="background:linear-gradient(135deg,#fefce8,#fff);border-left:4px solid #eab308">'+
            '<h2 style="margin:0 0 1rem">üëë Zuchtplan-Termine</h2>'+
            zuchtTermine.map(function(z){
                var farbe = z.tage === 0 ? '#eab308' : (z.tage < 0 ? '#ef4444' : '#7A6652');
                return '<div style="background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.5rem;border:1px solid #E8DFD4">'+
                '<div style="display:flex;justify-content:space-between;align-items:center">'+
                '<div style="display:flex;align-items:center;gap:.5rem">'+
                '<span style="font-size:1.25rem">'+z.emoji+'</span>'+
                '<div><div style="font-weight:600;font-size:.9rem">'+z.step+': '+z.plan.name+'</div></div></div>'+
                '<div style="font-size:.8rem;font-weight:600;color:'+farbe+'">'+z.label+'</div>'+
                '</div></div>';
            }).join('')+
            '</div>'
            : ''
        )+
        
        // Aufgaben n√§chste 7 Tage
        (aufgabenBald.length ?
            '<div class="card">'+
            '<h2 style="margin:0 0 1rem">üìã N√§chste 7 Tage ('+aufgabenBald.length+')</h2>'+
            aufgabenBald.map(function(a){
                var d = new Date(a.faelligkeit);
                var tag = d.toLocaleDateString('de-DE', {weekday:'short', day:'numeric', month:'short'});
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.625rem 0;border-bottom:1px solid #FFFBF0">'+
                '<div><div style="font-weight:500;font-size:.9rem">'+a.notiz+'</div></div>'+
                '<div style="font-size:.8rem;color:#7A6652;white-space:nowrap">'+tag+'</div>'+
                '</div>';
            }).join('')+
            '</div>'
            : ''
        )+
        
        // Packliste (nur anzeigen wenn Items vorhanden, auf-/zuklappbar)
        (function(){
            var packItems = packlisteMod.items || [];
            var unchecked = packItems.filter(function(i){return !i.checked;});
            var total = packItems.length;
            if (total === 0) return '';
            var checked = total - unchecked.length;
            var prozent = total > 0 ? Math.round(checked/total*100) : 0;
            
            // Nach Kategorie gruppieren
            var kategorien = {};
            unchecked.forEach(function(item){
                var kat = item.kategorie || 'Sonstiges';
                if (!kategorien[kat]) kategorien[kat] = [];
                kategorien[kat].push(item);
            });
            
            var detailHtml = unchecked.length === 0 ?
                '<div style="text-align:center;padding:.75rem;color:#10b981;font-weight:600">Alles eingepackt! ‚úÖ</div>'
                :
                Object.keys(kategorien).map(function(kat){
                    return '<div style="margin-bottom:.5rem">'+
                    '<div style="font-size:.7rem;font-weight:600;color:#7A6652;text-transform:uppercase;margin-bottom:.25rem">'+kat+'</div>'+
                    kategorien[kat].map(function(item){
                        var menge = item.menge || 1;
                        return '<div style="display:flex;align-items:center;gap:.5rem;padding:.25rem 0;border-bottom:1px solid #FFFBF0">'+
                        '<input type="checkbox" style="width:1rem;height:1rem;cursor:pointer" onchange="packlisteMod.toggle(\''+item.id+'\');app.render()">'+
                        '<span style="font-size:.85rem">'+(menge>1?'<strong>'+menge+'x</strong> ':'')+item.name+'</span>'+
                        '</div>';
                    }).join('')+
                    '</div>';
                }).join('');
            
            return '<div class="card" style="background:linear-gradient(135deg,#f0f9ff,#fff);border-left:4px solid #3b82f6;padding:.75rem 1rem">'+
            '<div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="var el=document.getElementById(\'packlisteDetail\');var arr=document.getElementById(\'packlisteArrow\');if(el.style.display===\'none\'){el.style.display=\'block\';arr.textContent=\'‚ñº\'}else{el.style.display=\'none\';arr.textContent=\'‚ñ∂\'}">'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<span id="packlisteArrow" style="font-size:.7rem;color:#7A6652">‚ñ∂</span>'+
            '<h2 style="margin:0;font-size:1rem">üì¶ Packliste</h2>'+
            '</div>'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<div style="width:60px;background:#E8DFD4;border-radius:999px;height:5px">'+
            '<div style="background:#3b82f6;border-radius:999px;height:100%;width:'+prozent+'%"></div></div>'+
            '<span class="badge '+(unchecked.length===0?'badge-green':'badge-yellow')+'" style="font-size:.7rem">'+checked+'/'+total+'</span>'+
            '</div>'+
            '</div>'+
            '<div id="packlisteDetail" style="display:none;margin-top:.75rem">'+
            detailHtml+
            '<div style="margin-top:.5rem;text-align:center">'+
            '<button class="btn btn-blue btn-sm" style="font-size:.8rem;padding:.375rem .75rem" onclick="app.navigate(\'packliste\')">üìã Volle Packliste</button>'+
            '</div>'+
            '</div>'+
            '</div>';
        })()+
        
        '<div class="card">'+
        '<h3>üìä Schnell√ºbersicht</h3>'+
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-top:.75rem">'+
        [
            ['üìç Standorte', this.data.standorte.length],
            ['üêù V√∂lker', this.data.voelker.length],
            ['‚úì Offene Aufgaben', this.data.aufgaben.filter(function(a){return !a.erledigt;}).length],
            ['üíâ Behandlungen', behandlungMod.behandlungen.length],
            ['üëë Zuchtpl√§ne', zuchtplanMod.plaene.length],
            ['üçØ Honig (Gesamt)', this.data.voelker.reduce(function(s,v){return s+(v.honigertrag||0);}, 0).toFixed(1) + ' kg']
        ].map(function(x){
            return '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem">'+
            '<div style="font-size:1.5rem;font-weight:bold;color:#1C1410">'+x[1]+'</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.25rem">'+x[0]+'</div>'+
            '</div>';
        }).join('')+
        '</div>'+
        '</div>'+
        '</div>';
    },
    
    rStandorte(){
        const self = this;
        this.selectedStandortId = null;
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üìç Standorte</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openStandortModal()">+ Neuer Standort</button>'+
        '</div>'+
        this.data.standorte.map(function(s){
            const voelker = self.data.voelker.filter(function(v){return v.standortId === s.id;});
            return '<div class="card" style="cursor:pointer;transition:all .2s" onclick="app.showStandortDetails(\''+s.id+'\')">'+
            '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.75rem">'+
            '<div style="flex:1">'+
            '<h3>'+s.name+'</h3>'+
            (s.notizen ? '<div style="font-size:.85rem;color:#7A6652;margin-top:.25rem">'+s.notizen+'</div>' : '')+
            (s.mapsLink ? '<a href="'+s.mapsLink+'" target="_blank" onclick="event.stopPropagation()" style="font-size:.75rem;color:#3b82f6;margin-top:.25rem;display:inline-block">üìç In Maps √∂ffnen</a>' : '')+
            '</div>'+
            '<div style="display:flex;gap:.5rem">'+
            '<button class="btn btn-primary btn-xs" onclick="event.stopPropagation();app.openStandortModal(\''+s.id+'\')">‚úèÔ∏è</button>'+
            '<button class="btn btn-danger btn-xs" onclick="event.stopPropagation();app.delStandort(\''+s.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            (s.lat && s.lng ? wetterMod.renderMini(s.id) : '')+
            '<div style="background:#FFF8EE;padding:.75rem;border-radius:.5rem;margin-top:.5rem">'+
            '<div style="font-weight:600;margin-bottom:.5rem">üêù '+voelker.length+' V√∂lker - Klicken f√ºr Details</div>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!this.data.standorte.length ? 
            '<div class="card" style="text-align:center;padding:3rem;color:#7A6652">'+
            '<div style="font-size:3rem;margin-bottom:1rem">üìç</div>'+
            '<h3>Noch keine Standorte</h3>'+
            '<p style="margin:.5rem 0 1.5rem">Erstelle deinen ersten Standort und f√ºge V√∂lker hinzu!</p>'+
            '<button class="btn btn-primary" onclick="app.openStandortModal()">Ersten Standort erstellen</button>'+
            '</div>' 
            : ''
        )+
        '</div>';
    },
    
    rStandortDetails(){
        const self = this;
        const s = this.data.standorte.find(function(x){return x.id === self.selectedStandortId;});
        if(!s){
            this.selectedStandortId = null;
            return this.rStandorte();
        }
        
        const voelker = this.data.voelker.filter(function(v){return v.standortId === s.id;});
        
        const statusColors = {
            'ok': '#10b981',
            'schwach': '#f59e0b',
            'weisellos': '#8b5cf6',
            'problem': '#ef4444'
        };
        
        const statusLabels = {
            'ok': '‚úÖ Gut',
            'schwach': '‚ö†Ô∏è Schwach',
            'weisellos': 'üëë Weisellos',
            'problem': '‚ùå Problem'
        };
        
        return '<div class="container">'+
        '<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">'+
        '<button class="btn btn-sm" onclick="app.selectedStandortId=null;app.render()">‚Üê Zur√ºck</button>'+
        '<h1 style="margin:0">'+s.name+'</h1>'+
        '</div>'+
        
        '<div class="card">'+
        '<div style="display:flex;justify-content:space-between;align-items:start">'+
        '<div>'+
        (s.notizen ? '<p style="color:#7A6652;margin-bottom:.5rem">'+s.notizen+'</p>' : '')+
        (s.mapsLink ? '<a href="'+s.mapsLink+'" target="_blank" style="font-size:.85rem;color:#3b82f6">üìç In Maps √∂ffnen</a>' : '')+
        '</div>'+
        '<div style="display:flex;gap:.5rem">'+
        '<button class="btn btn-primary btn-xs" onclick="app.openStandortModal(\''+s.id+'\')">‚úèÔ∏è Bearbeiten</button>'+
        '</div>'+
        '</div>'+
        '</div>'+
        
        '<div style="display:flex;justify-content:space-between;align-items:center;margin:1.5rem 0 1rem">'+
        '<h2 style="margin:0">üêù V√∂lker ('+voelker.length+')</h2>'+
        '<div style="display:flex;gap:.5rem">'+
        '<button class="btn btn-danger btn-xs" onclick="if(app.voelkerCount>0){app.voelkerCount='+voelker.length+'-1;app.openStandortModal(\''+s.id+'\');app.saveStandort();}">‚àí Volk</button>'+
        '<button class="btn btn-success btn-xs" onclick="app.voelkerCount='+(voelker.length+1)+';app.openStandortModal(\''+s.id+'\');app.saveStandort();">+ Volk</button>'+
        '</div>'+
        '</div>'+
        
        '<div class="volk-grid">'+
        voelker.map(function(v){
            const statusColor = statusColors[v.status] || statusColors.ok;
            const statusLabel = statusLabels[v.status] || statusLabels.ok;
            
            return '<div class="volk-card" onclick="app.openVolkModal(\''+v.id+'\')">'+
            '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem">'+
            '<h3 style="margin:0;font-size:.95rem">'+v.name+'</h3>'+
            '<div style="width:12px;height:12px;border-radius:50%;background:'+statusColor+'"></div>'+
            '</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-bottom:.25rem">'+v.beutensystem+'</div>'+
            '<div style="font-size:.75rem;margin-bottom:.5rem">'+statusLabel+'</div>'+
            '<div style="background:#FFF8EE;padding:.5rem;border-radius:.5rem;font-size:.75rem">'+
            'üçØ '+(v.honigertrag||0).toFixed(1)+' kg'+
            '</div>'+
            '</div>';
        }).join('')+
        '</div>'+
        
        (!voelker.length ? '<div class="card" style="text-align:center;color:#7A6652">Noch keine V√∂lker an diesem Standort</div>' : '')+
        '</div>';
    },
    
    rAufgaben(){
        const self = this;
        const offen = this.data.aufgaben.filter(function(a){return !a.erledigt;}).sort(function(a,b){return a.faelligkeit - b.faelligkeit;});
        const erledigt = this.data.aufgaben.filter(function(a){return a.erledigt;}).sort(function(a,b){return b.erledigt - a.erledigt;}).slice(0, 10);
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>‚úì Aufgaben</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openAufgabeModal()">+ Neue Aufgabe</button>'+
        '</div>'+
        '<h2>Offen ('+offen.length+')</h2>'+
        offen.map(function(a){
            const pc = a.prio === 'high' ? 'badge-red' : (a.prio === 'medium' ? 'badge-yellow' : 'badge-green');
            const ueberfaellig = Date.now() > a.faelligkeit;
            return '<div class="card" '+(ueberfaellig ? 'style="border-left:4px solid #ef4444"' : '')+'>'+
            '<div style="display:flex;justify-content:space-between;align-items:start">'+
            '<div style="flex:1">'+
            '<div style="font-weight:600;margin-bottom:.25rem">'+a.notiz+'</div>'+
            '<div style="font-size:.8rem;color:#7A6652">'+
            'üìÖ '+self.fd(a.faelligkeit)+' ¬∑ ‚è±Ô∏è '+a.dauer+' Min ¬∑ '+
            '<span class="badge '+pc+'">'+a.prio.toUpperCase()+'</span>'+
            (ueberfaellig ? ' ¬∑ <span class="badge badge-red">√úBERF√ÑLLIG</span>' : '')+
            '</div>'+
            '</div>'+
            '<div style="display:flex;gap:.5rem">'+
            '<button class="btn btn-blue btn-xs" onclick="app.openAufgabeModal(\''+a.id+'\')">‚úèÔ∏è</button>'+
            '<button class="btn btn-success btn-xs" onclick="app.doneA(\''+a.id+'\')">‚úì</button>'+
            '<button class="btn btn-danger btn-xs" onclick="app.del(\'aufgaben\',\''+a.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!offen.length ? '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">Keine offenen Aufgaben üéâ</div>' : '')+
        '<h2 style="margin-top:1.5rem">Erledigt</h2>'+
        erledigt.map(function(a){
            return '<div class="card" style="opacity:.6">'+
            '<div style="display:flex;justify-content:space-between;align-items:start">'+
            '<div style="flex:1">'+
            '<div style="text-decoration:line-through">'+a.notiz+'</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.25rem">‚úì '+self.fd(a.erledigt)+'</div>'+
            '</div>'+
            '<div style="display:flex;gap:.5rem">'+
            '<button class="btn btn-blue btn-xs" onclick="app.undoneA(\''+a.id+'\')" title="Wieder √∂ffnen">‚Ü©Ô∏è</button>'+
            '<button class="btn btn-danger btn-xs" onclick="app.del(\'aufgaben\',\''+a.id+'\')" title="L√∂schen">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!erledigt.length ? '<div class="card" style="text-align:center;color:#7A6652">Noch keine erledigten Aufgaben</div>' : '')+
        '</div>';
    },
    
    rZuchtplan(){
        const self = this;
        if(!this.data.zuchtplaene) this.data.zuchtplaene = [];
        const plaene = this.data.zuchtplaene.sort(function(a,b){return b.created - a.created;});
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üëë K√∂niginnenzucht</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openZuchtModal()">+ Neuer Zuchtplan</button>'+
        '</div>'+
        
        plaene.map(function(z){
            const heute = Date.now();
            let phase = 'Vorbereitung';
            let phaseColor = '#7A6652';
            
            if(z.zusetzen && heute >= z.zusetzen){
                phase = 'Zugesetzt';
                phaseColor = '#10b981';
            }else if(z.umlarven && heute >= z.umlarven){
                phase = 'Nach Umlarven';
                phaseColor = '#f59e0b';
            }else if(heute >= z.sammelbrut){
                phase = 'Sammelbrut l√§uft';
                phaseColor = '#3b82f6';
            }
            
            return '<div class="card">'+
            '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem">'+
            '<div>'+
            '<h3>'+z.name+'</h3>'+
            '<div style="display:inline-block;padding:.25rem .75rem;background:'+phaseColor+';color:#fff;border-radius:.5rem;font-size:.75rem;font-weight:600;margin-top:.25rem">'+phase+'</div>'+
            '</div>'+
            '<button class="btn btn-primary btn-xs" onclick="app.openZuchtModal(\''+z.id+'\')">‚úèÔ∏è</button>'+
            '</div>'+
            
            '<div class="timeline">'+
            '<div class="timeline-item">'+
            '<div class="timeline-dot" style="background:'+(heute >= z.sammelbrut ? '#10b981' : '#E8DFD4')+'"></div>'+
            '<div class="timeline-content">'+
            '<div style="font-weight:600;margin-bottom:.25rem">üì¶ Sammelbrutableger</div>'+
            '<div style="font-size:.85rem;color:#7A6652">'+self.fd(z.sammelbrut)+'</div>'+
            '</div>'+
            '</div>'+
            
            (z.umlarven ? 
                '<div class="timeline-item">'+
                '<div class="timeline-dot" style="background:'+(heute >= z.umlarven ? '#10b981' : '#E8DFD4')+'"></div>'+
                '<div class="timeline-content">'+
                '<div style="font-weight:600;margin-bottom:.25rem">üî¨ Umlarven</div>'+
                '<div style="font-size:.85rem;color:#7A6652">'+self.fd(z.umlarven)+'</div>'+
                '</div>'+
                '</div>'
                : ''
            )+
            
            (z.zusetzen ? 
                '<div class="timeline-item">'+
                '<div class="timeline-dot" style="background:'+(heute >= z.zusetzen ? '#10b981' : '#E8DFD4')+'"></div>'+
                '<div class="timeline-content">'+
                '<div style="font-weight:600;margin-bottom:.25rem">üëë Zusetzen</div>'+
                '<div style="font-size:.85rem;color:#7A6652">'+self.fd(z.zusetzen)+'</div>'+
                '</div>'+
                '</div>'
                : ''
            )+
            '</div>'+
            
            (z.notizen ? '<div style="margin-top:.75rem;padding:.75rem;background:#FFF8EE;border-radius:.5rem;font-size:.85rem;color:#7A6652">üí≠ '+z.notizen+'</div>' : '')+
            '</div>';
        }).join('')+
        
        (!plaene.length ? 
            '<div class="card" style="text-align:center;padding:3rem;color:#7A6652">'+
            '<div style="font-size:3rem;margin-bottom:1rem">üëë</div>'+
            '<h3>Noch keine Zuchtpl√§ne</h3>'+
            '<p style="margin:.5rem 0 1.5rem">Erstelle deinen ersten Zuchtplan!</p>'+
            '<button class="btn btn-primary" onclick="app.openZuchtModal()">Ersten Zuchtplan erstellen</button>'+
            '</div>'
            : ''
        )+
        '</div>';
    },
    
    rTracht(){
        const self = this;
        var alleTrachten = trachtkalenderMod.trachten || [];
        const trachten = alleTrachten.sort(function(a,b){return b.created - a.created;});
        
        const trachtColors = {
            'Haselnuss': '#8B7355',
            'Weide': '#98FB98',
            'Kirsche': '#FFB7C5',
            'L√∂wenzahn': '#FFD700',
            'Raps': '#FFFF00',
            'Obstbl√ºte': '#FF69B4',
            'Akazie': '#F5F5DC',
            'Linde': '#90EE90',
            'Kastanie': '#8B4513',
            'Phacelia': '#9370DB',
            'Sonnenblume': '#FFD700',
            'Heide': '#DDA0DD',
            'Efeu': '#228B22',
            'Andere': '#A69580'
        };
        
        const totalErtrag = trachten.reduce(function(s,t){return s + (t.ertrag || 0);}, 0);
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üå∏ Tracht</h1>'+
        '<div style="display:flex;gap:.5rem">'+
        '<a href="trachtkarte.html" target="_blank" class="btn btn-blue btn-sm">üó∫Ô∏è Karte</a>'+
        '<button class="btn btn-primary btn-sm" onclick="trachtkalenderMod.openModal()">+ Tracht</button>'+
        '</div>'+
        '</div>'+
        
        (totalErtrag > 0 ? 
            '<div class="card">'+
            '<div style="text-align:center">'+
            '<div style="font-size:2rem;font-weight:bold">'+totalErtrag.toFixed(1)+' kg</div>'+
            '<div style="font-size:.85rem;color:#7A6652">Gesamtertrag aus Trachten</div>'+
            '</div>'+
            '</div>'
            : ''
        )+
        
        trachten.map(function(t){
            const color = trachtColors[t.typ] || trachtColors['Andere'];
            const aktiv = t.ende ? (Date.now() < t.ende && Date.now() >= t.beginn) : (Date.now() >= t.beginn);
            const isShared = t.shared || false;
            
            return '<div class="tracht-item" style="border-color:'+color+'">'+
            '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem">'+
            '<div>'+
            '<h3 style="margin:0">'+t.typ+' '+(aktiv ? '<span class="badge badge-green">Aktiv</span>' : '')+
            (isShared ? ' <span class="badge badge-blue" style="font-size:.65rem">üó∫Ô∏è Geteilt</span>' : '')+'</h3>'+
            '<div style="font-size:.85rem;color:#7A6652;margin-top:.25rem">üìç '+t.standort+'</div>'+
            '</div>'+
            '<div style="display:flex;gap:.375rem">'+
            '<button class="btn btn-primary btn-xs" onclick="trachtkalenderMod.editTracht(\''+t.id+'\')" title="Bearbeiten">‚úèÔ∏è</button>'+
            (!isShared ? '<button class="btn btn-blue btn-xs" onclick="app.shareTracht(\''+t.id+'\')" title="Auf Karte teilen">üó∫Ô∏è</button>' : 
                         '<button class="btn btn-xs" style="background:#E8DFD4" onclick="app.unshareTracht(\''+t.id+'\')" title="Von Karte entfernen">‚úïüó∫Ô∏è</button>')+
            '<button class="btn btn-danger btn-xs" onclick="trachtkalenderMod.deleteTracht(\''+t.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            '<div style="font-size:.85rem;color:#7A6652;margin-top:.5rem">'+
            'üå∏ '+self.fd(t.beginn)+' '+(t.ende ? '‚Üí '+self.fd(t.ende) : '')+'<br>'+
            (t.ertrag ? 'üçØ Ertrag: '+t.ertrag.toFixed(1)+' kg<br>' : '')+
            (t.notizen ? 'üí≠ '+t.notizen : '')+
            '</div>'+
            '</div>';
        }).join('')+
        
        (!trachten.length ? 
            '<div class="card" style="text-align:center;padding:3rem;color:#7A6652">'+
            '<div style="font-size:3rem;margin-bottom:1rem">üå∏</div>'+
            '<h3>Noch keine Trachten erfasst</h3>'+
            '<p style="margin:.5rem 0 1.5rem">Erfasse deine Trachten mit Standorten und Ertr√§gen!</p>'+
            '<button class="btn btn-primary" onclick="trachtkalenderMod.openModal()">Erste Tracht erfassen</button>'+
            '</div>'
            : ''
        )+
        
        // Trachtkalender einbetten
        this.rTrachtkalender()+
        
        '</div>';
    },
    
    rErnte(){
        const self = this;
        const gesamtErtrag = this.data.voelker.reduce(function(s,v){return s + (v.honigertrag || 0);}, 0);
        const trachtErtrag = this.data.trachten ? this.data.trachten.reduce(function(s,t){return s + (t.ertrag || 0);}, 0) : 0;
        
        // Group voelker by standort
        var standortMap = {};
        this.data.standorte.forEach(function(s){ standortMap[s.id] = {name:s.name, id:s.id, voelker:[], ertrag:0}; });
        this.data.voelker.forEach(function(v){
            var sid = v.standortId;
            if (!standortMap[sid]) standortMap[sid] = {name:'Ohne Standort', id:sid, voelker:[], ertrag:0};
            standortMap[sid].voelker.push(v);
            standortMap[sid].ertrag += (v.honigertrag||0);
        });
        
        if (!this._ernteOpen) this._ernteOpen = {};
        
        return '<div class="container">'+
        '<h1>üçØ Honigernte</h1>'+
        
        '<div class="card">'+
        '<h3 style="text-align:center;margin-bottom:1rem">Gesamtertrag '+new Date().getFullYear()+'</h3>'+
        '<div style="text-align:center">'+
        '<div style="font-size:3rem;font-weight:bold;color:#F5A623">'+gesamtErtrag.toFixed(1)+' kg</div>'+
        '<div style="font-size:.85rem;color:#7A6652;margin-top:.5rem">Aus '+self.data.voelker.length+' V√∂lkern an '+self.data.standorte.length+' Standorten</div>'+
        '</div>'+
        '</div>'+
        
        (trachtErtrag > 0 ? 
            '<div class="card">'+
            '<h3>Nach Trachten</h3>'+
            '<div style="background:#FFF8EE;padding:.75rem;border-radius:.5rem;margin-top:.5rem">'+
            '<div style="font-size:1.25rem;font-weight:bold">'+trachtErtrag.toFixed(1)+' kg</div>'+
            '<div style="font-size:.75rem;color:#7A6652">Erfasst √ºber Trachten</div>'+
            '</div>'+
            '</div>'
            : ''
        )+
        
        Object.entries(standortMap).map(function(entry){
            var sid = entry[0]; var data = entry[1];
            if (data.voelker.length === 0) return '';
            var isOpen = self._ernteOpen[sid] || false;
            var sortiert = data.voelker.sort(function(a,b){return (b.honigertrag||0) - (a.honigertrag||0);});
            return '<div class="card" style="padding:0;overflow:hidden">'+
            
            // Standort Header - klickbar zum Aufklappen
            '<div onclick="app.toggleErnte(\''+sid+'\')" style="display:flex;justify-content:space-between;align-items:center;padding:1.25rem;cursor:pointer;transition:background .15s;user-select:none" onmouseover="this.style.background=\'#FFF8EE\'" onmouseout="this.style.background=\'\'">'+
            '<div style="display:flex;align-items:center;gap:.75rem">'+
            '<span style="font-size:1.25rem;transition:transform .2s;transform:rotate('+(isOpen?'90':'0')+'deg)">‚ñ∂</span>'+
            '<div>'+
            '<h2 style="margin:0">üìç '+data.name+'</h2>'+
            '<div style="font-size:.8rem;color:#7A6652;margin-top:.25rem">'+data.voelker.length+' V√∂lker ¬∑ Klicken f√ºr Details</div>'+
            '</div>'+
            '</div>'+
            '<div style="text-align:right">'+
            '<div style="font-size:1.75rem;font-weight:bold;color:#F5A623">'+data.ertrag.toFixed(1)+' kg</div>'+
            '</div>'+
            '</div>'+
            
            // Aufklappbarer Bereich
            '<div style="display:'+(isOpen?'block':'none')+';border-top:2px solid #FFFBF0">'+
            
            // Standort-Ertrag schnell eingeben
            '<div style="padding:1rem;background:#FFF8EE">'+
            '<div style="font-weight:600;margin-bottom:.75rem">üçØ Ertrag f√ºr ganzen Standort eintragen</div>'+
            '<div style="display:flex;gap:.5rem;align-items:center">'+
            '<input type="number" id="ernteStandort_'+sid+'" class="input" placeholder="kg gesamt" step="0.1" min="0" style="flex:1;margin:0" value="">'+
            '<button class="btn btn-primary btn-sm" onclick="app.verteilErnteStandort(\''+sid+'\')">Gleichm√§√üig verteilen</button>'+
            '</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.5rem">Wird gleichm√§√üig auf alle '+data.voelker.length+' V√∂lker aufgeteilt</div>'+
            '</div>'+
            
            // Einzelne V√∂lker
            '<div style="padding:.5rem 1rem">'+
            sortiert.map(function(v){
                var pct = gesamtErtrag > 0 ? ((v.honigertrag||0)/gesamtErtrag*100) : 0;
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid #FFFBF0">'+
                '<div style="flex:1">'+
                '<div style="font-weight:600">'+v.name+'</div>'+
                '<div style="background:#E8DFD4;height:.375rem;border-radius:.25rem;margin-top:.375rem;max-width:200px">'+
                '<div style="background:#F5A623;height:100%;border-radius:.25rem;width:'+Math.min(100,pct)+'%"></div>'+
                '</div>'+
                '</div>'+
                '<div style="display:flex;align-items:center;gap:.5rem">'+
                '<input type="number" style="width:70px;padding:.375rem;border:1px solid #d1d5db;border-radius:.375rem;text-align:right;font-weight:600" value="'+(v.honigertrag||0).toFixed(1)+'" step="0.1" min="0" onchange="app.updateVolkErtrag(\''+v.id+'\',this.value)">'+
                '<span style="font-size:.85rem;color:#7A6652">kg</span>'+
                '</div>'+
                '</div>';
            }).join('')+
            '</div>'+
            '</div>'+
            
            '</div>';
        }).join('')+
        
        (!this.data.standorte.length ? 
            '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">'+
            '<div style="font-size:3rem;margin-bottom:1rem">üçØ</div>'+
            '<p>Erstelle zuerst Standorte und V√∂lker, um Ertr√§ge zu erfassen.</p>'+
            '</div>'
            : ''
        )+
        
        '<div class="info-box" style="margin-top:1rem">'+
        'üí° Du kannst den Ertrag pro Volk direkt bearbeiten oder f√ºr den ganzen Standort auf einmal eingeben.'+
        '</div>'+
        '</div>';
    },
    
    toggleErnte(sid){
        if (!this._ernteOpen) this._ernteOpen = {};
        this._ernteOpen[sid] = !this._ernteOpen[sid];
        this.render();
    },
    
    updateVolkErtrag(vid, val){
        var v = this.data.voelker.find(function(x){return x.id===vid;});
        if (v) {
            v.honigertrag = parseFloat(val) || 0;
            db.update('voelker', {honigertrag: v.honigertrag}, v.id);
        }
    },
    
    verteilErnteStandort(sid){
        var input = document.getElementById('ernteStandort_'+sid);
        var gesamt = parseFloat(input.value);
        if (!gesamt || gesamt <= 0) { alert('Bitte eine g√ºltige kg-Zahl eingeben'); return; }
        var voelker = this.data.voelker.filter(function(v){return v.standortId===sid;});
        if (voelker.length === 0) return;
        var pro = Math.round((gesamt / voelker.length) * 10) / 10;
        voelker.forEach(function(v){
            v.honigertrag = (v.honigertrag||0) + pro;
            db.update('voelker', {honigertrag: v.honigertrag}, v.id);
        });
        input.value = '';
        this.render();
        app.toast('‚úì '+gesamt+' kg auf '+voelker.length+' V√∂lker verteilt (je +'+pro+' kg)','success');
    },
    
    

    async shareTracht(id){
        var t = trachtkalenderMod.trachten.find(function(x){return x.id===id;});
        if (!t) return;
        
        if (!t.lat || !t.lng) {
            app.toast('‚ö†Ô∏è Keine Koordinaten vorhanden. Bearbeite die Tracht und f√ºge Koordinaten oder einen Google Maps Link hinzu.','warning');
            return;
        }
        
        var profile = app.data.user;
        var userName = profile ? (profile.name || profile.email || 'Anonym') : 'Anonym';
        
        var result = await sb.from('trachten_shared').upsert({
            id: t.id, user_id: currentUser.id, user_name: userName,
            typ: t.typ, standort: t.standort, lat: t.lat, lng: t.lng,
            beginn: t.beginn, ende: t.ende, ertrag: t.ertrag || 0,
            notizen: t.notizen || '', jahr: new Date().getFullYear()
        });
        if (result.error) { app.toast('Fehler: '+result.error.message,'error'); return; }
        
        t.shared = true;
        this.render();
        app.toast('üó∫Ô∏è Tracht auf der Karte geteilt!','success');
    },
    
    async unshareTracht(id){
        if (!confirm('Tracht von der √∂ffentlichen Karte entfernen?')) return;
        var t = trachtkalenderMod.trachten.find(function(x){return x.id===id;});
        if (t) t.shared = false;
        
        await sb.from('trachten_shared').delete().eq('id', id);
        this.render();
        app.toast('‚úì Von Karte entfernt','info');
    },
    
    rKosten(){
        const self = this;
        const k = this.data.kosten.sort(function(a,b){return b.datum - a.datum;});
        const total = k.reduce(function(s,x){return s + x.betrag;}, 0);
        const byKat = {};
        k.forEach(function(x){
            byKat[x.kat] = (byKat[x.kat] || 0) + x.betrag;
        });
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üí∞ Kosten</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openModal(\'kostenModal\')">+ Neue Ausgabe</button>'+
        '</div>'+
        '<div class="card">'+
        '<div style="text-align:center">'+
        '<div style="font-size:2.5rem;font-weight:bold;color:#1C1410">'+total.toFixed(2)+' ‚Ç¨</div>'+
        '<div style="font-size:.85rem;color:#7A6652">Gesamtausgaben</div>'+
        '</div>'+
        '<div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #FFFBF0">'+
        Object.entries(byKat).sort(function(a,b){return b[1] - a[1];}).map(function(x){
            return '<div style="display:flex;justify-content:space-between;padding:.4rem 0;font-size:.9rem">'+
            '<span>'+x[0]+'</span>'+
            '<strong>'+x[1].toFixed(2)+' ‚Ç¨</strong>'+
            '</div>';
        }).join('')+
        '</div>'+
        '</div>'+
        k.map(function(x){
            return '<div class="card">'+
            '<div style="display:flex;justify-content:space-between;align-items:center">'+
            '<div style="flex:1">'+
            '<div style="font-weight:600">'+x.beschreibung+' ‚Äì '+x.betrag.toFixed(2)+' ‚Ç¨</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.25rem">'+x.kat+' ¬∑ '+self.fd(x.datum)+'</div>'+
            '</div>'+
            '<button class="btn btn-danger btn-xs" onclick="app.del(\'kosten\',\''+x.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!k.length ? '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">Noch keine Ausgaben erfasst</div>' : '')+
        '</div>';
    },
    
    rEinst(){
        return '<div class="container">'+
        '<h1>‚öôÔ∏è Einstellungen</h1>'+
        (this.data.user ? 
            '<div class="card">'+
            '<h3>üë§ Profil</h3>'+
            '<div style="font-size:.9rem;color:#7A6652;margin-top:.75rem">'+
            '<div style="margin-bottom:.5rem"><strong>Name:</strong> '+this.data.user.name+'</div>'+
            (this.data.user.imkerei ? '<div style="margin-bottom:.5rem"><strong>Imkerei:</strong> '+this.data.user.imkerei+'</div>' : '')+
            '<div style="margin-bottom:.5rem"><strong>E-Mail:</strong> '+this.data.user.email+' '+
            (this.data.user.emailConfirmed ? '<span class="badge badge-green">‚úì Best√§tigt</span>' : '<span class="badge badge-yellow">Nicht best√§tigt</span>')+
            '</div>'+
            '<div><strong>Registriert:</strong> '+this.fd(this.data.user.registeredAt)+'</div>'+
            '</div>'+
            '</div>' 
            : ''
        )+
        '<div class="card">'+
        '<h3>üìä Statistik</h3>'+
        '<div style="font-size:.9rem;color:#7A6652;margin-top:.75rem">'+
        '<div style="margin-bottom:.4rem">Standorte: <strong>'+this.data.standorte.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">V√∂lker: <strong>'+this.data.voelker.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Aufgaben: <strong>'+this.data.aufgaben.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Zuchtpl√§ne: <strong>'+zuchtplanMod.plaene.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Trachten: <strong>'+trachtkalenderMod.trachten.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Kosten: <strong>'+this.data.kosten.length+'</strong></div>'+
        '</div>'+
        '</div>'+
        '<div class="card">'+
        '<h3>‚ÑπÔ∏è App-Version</h3>'+
        '<p style="font-size:.9rem;color:#7A6652;margin-top:.5rem">Imkerei Tagesplaner v5.0</p>'+
        '<p style="font-size:.85rem;color:#F5A623;font-weight:600;margin-top:.25rem">Imkerei Durchdenwald üêù</p>'+
        '<p style="font-size:.8rem;color:#10b981;margin-top:.5rem">‚òÅÔ∏è Cloud-Version ‚Äì Daten sicher gespeichert</p>'+
        '</div>'+
        '<div class="card">'+
        '<button class="btn btn-danger btn-block" onclick="doLogout()">üö™ Abmelden</button>'+
        '</div>'+
        '</div>';
    },
    

    rPackliste(){
        var stats = packlisteMod.getStatistik();
        var grouped = {};
        packlisteMod.items.forEach(function(item) {
            if (!grouped[item.kategorie]) grouped[item.kategorie] = [];
            grouped[item.kategorie].push(item);
        });
        
        var kategorieHtml = '';
        Object.entries(grouped).forEach(function(entry) {
            var kategorie = entry[0]; var items = entry[1];
            var abgehakt = items.filter(function(i){return i.checked;}).length;
            kategorieHtml += '<div class="pack-kategorie"><h3>'+kategorie+' <small style="color:#7A6652;font-weight:normal">('+abgehakt+'/'+items.length+')</small></h3>';
            items.forEach(function(item) {
                var menge = item.menge || 1;
                kategorieHtml += '<div class="pack-item-row"><div class="pack-item-main">'+
                    '<input type="checkbox" class="pack-checkbox" '+(item.checked?'checked':'')+' onchange="packlisteMod.toggle(\''+item.id+'\')">'+
                    '<span class="pack-label '+(item.checked?'checked':'')+'" onclick="packlisteMod.toggle(\''+item.id+'\')">'+(menge>1?'<strong>'+menge+'x</strong> ':'')+item.name+'</span>'+
                    '</div><div class="pack-item-controls">'+
                    '<div class="menge-counter"><button class="menge-btn" onclick="packlisteMod.changeMenge(\''+item.id+'\',-1)">‚àí</button><span class="menge-value">'+menge+'</span><button class="menge-btn" onclick="packlisteMod.changeMenge(\''+item.id+'\',1)">+</button></div>'+
                    '<button class="btn-del" onclick="packlisteMod.loescheItem(\''+item.id+'\')">üóëÔ∏è</button>'+
                    '</div></div>';
            });
            kategorieHtml += '</div>';
        });
        
        return '<div class="container">'+
        '<h1>üìã Imkerei Packliste</h1>'+
        '<div class="info-box">‚ú® <strong>Vollst√§ndige Packliste</strong> - einfach abhaken! Schnell-Buttons f√ºgen ganze Sets hinzu.</div>'+
        '<h2 style="margin-top:0">‚ö° Schnell hinzuf√ºgen</h2>'+
        '<h3 style="font-size:.9rem;color:#7A6652;margin-bottom:.75rem">üè† Beuten & Material</h3>'+
        '<div class="schnell-grid">'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'ableger\')"><div class="schnell-icon">üì¶</div><div class="schnell-label">Ablegerkasten</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'dadant\')"><div class="schnell-icon">üè†</div><div class="schnell-label">Dadant Beute</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'raehmchen\')"><div class="schnell-icon">ü™µ</div><div class="schnell-label">10 R√§hmchen</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'mittelwaende\')"><div class="schnell-icon">‚ñ≠</div><div class="schnell-label">10 Mittelw√§nde</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'boden\')"><div class="schnell-icon">‚¨ú</div><div class="schnell-label">Boden</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'zarge\')"><div class="schnell-icon">üì¶</div><div class="schnell-label">Zarge</div></button>'+
        '</div>'+
        '<h3 style="font-size:.9rem;color:#7A6652;margin:.75rem 0">üîß Arbeits-Equipment</h3>'+
        '<div class="schnell-grid">'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'schutz\')"><div class="schnell-icon">üß•</div><div class="schnell-label">Schutzausr√ºstung</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'werkzeug\')"><div class="schnell-icon">üîß</div><div class="schnell-label">Werkzeug-Set</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'smoker\')"><div class="schnell-icon">üí®</div><div class="schnell-label">Smoker-Paket</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'ernte\')"><div class="schnell-icon">üçØ</div><div class="schnell-label">Ernte-Set</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'behandlung_set\')"><div class="schnell-icon">üíâ</div><div class="schnell-label">Behandlungs-Set</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'futter\')"><div class="schnell-icon">üçØ</div><div class="schnell-label">Futter-Set</div></button>'+
        '</div>'+
        '<div style="display:flex;gap:.75rem;margin-bottom:1.5rem">'+
        '<button class="btn btn-success" style="flex:1" onclick="packlisteMod.alleAbhaken()">‚úì Alle abhaken</button>'+
        '<button class="btn btn-blue" style="flex:1" onclick="packlisteMod.alleZuruecksetzen()">‚Ü∫ Zur√ºcksetzen</button>'+
        '<button class="btn btn-danger" style="flex:1" onclick="packlisteMod.allesLoeschen()">üóëÔ∏è Alles l√∂schen</button>'+
        '</div>'+
        '<div class="stats">'+
        '<div class="stat-card"><div class="stat-number">'+stats.abgehakt+'</div><div class="stat-label">Abgehakt</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+stats.offen+'</div><div class="stat-label">Offen</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+stats.gesamt+'</div><div class="stat-label">Gesamt</div></div>'+
        '</div>'+
        kategorieHtml+
        '</div>';
    },
    
    rTrachtkalender(){
        var self = this;
        var sortiert = Object.entries(TRACHT_KALENDER).sort(function(a,b){return Math.min.apply(null,a[1].monate)-Math.min.apply(null,b[1].monate);});
        var sichtbar = sortiert.filter(function(e){return trachtkalenderMod.ausgeblendete.indexOf(e[0])===-1;});
        
        var timelineHtml = '';
        sichtbar.forEach(function(entry) {
            var name = entry[0]; var data = entry[1];
            var barsHtml = '';
            for (var i=1;i<=12;i++) {
                if (data.monate.indexOf(i) !== -1) {
                    barsHtml += '<div class="timeline-bar" style="background:'+data.farbe+';grid-column:'+i+'">'+data.emoji+'</div>';
                }
            }
            timelineHtml += '<div class="timeline-row" style="cursor:pointer" onclick="trachtkalenderMod.toggleTracht(\''+name.replace(/'/g,"\\'")+'\')" title="Klicken zum Ausblenden">'+
                '<div class="timeline-row-label"><span style="font-size:1.3rem">'+data.emoji+'</span><span>'+name+'</span></div>'+
                '<div class="timeline-row-bars">'+barsHtml+'</div></div>';
        });
        
        var ausgeblendetHtml = '';
        if (trachtkalenderMod.ausgeblendete.length > 0) {
            ausgeblendetHtml = '<div style="margin-top:1.5rem"><h3 style="font-size:1rem;color:#7A6652;margin-bottom:.75rem">üëÅÔ∏è‚Äçüó®Ô∏è Ausgeblendete Trachten (klicken zum Einblenden)</h3><div style="display:flex;flex-wrap:wrap;gap:.5rem">';
            trachtkalenderMod.ausgeblendete.forEach(function(name) {
                var data = TRACHT_KALENDER[name];
                if (data) ausgeblendetHtml += '<div class="ausgeblendet-chip" onclick="trachtkalenderMod.toggleTracht(\''+name.replace(/'/g,"\\'")+'\')" style="background:'+data.farbe+';border-color:'+data.farbe+'"><span>'+data.emoji+' '+name+'</span><span class="chip-close">‚úì</span></div>';
            });
            ausgeblendetHtml += '</div></div>';
        }
        
        var meineTrachtenHtml = '';
        var sortTrachten = trachtkalenderMod.trachten.slice().sort(function(a,b){return b.created-a.created;});
        sortTrachten.forEach(function(t) {
            var info = TRACHT_KALENDER[t.typ] || {emoji:'üå∫',farbe:'#A69580'};
            var status = trachtkalenderMod.getStatus(t.beginn,t.ende);
            var badge = status==='active'?'<span class="badge badge-green">üü¢ Aktiv</span>':status==='upcoming'?'<span class="badge badge-yellow">üü° Bevorstehend</span>':'<span class="badge" style="background:#FFFBF0;color:#7A6652">‚ö™ Vorbei</span>';
            meineTrachtenHtml += '<div class="tracht-item" style="border-color:'+info.farbe+'"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem"><div><div style="font-size:1.1rem;font-weight:bold">'+info.emoji+' '+t.typ+'</div><div style="margin-top:.25rem">'+badge+'</div></div><button class="btn btn-danger btn-xs" onclick="trachtkalenderMod.deleteTracht(\''+t.id+'\')">üóëÔ∏è</button></div>'+
                '<div style="font-size:.85rem;color:#7A6652;line-height:1.6">üìç <strong>Standort:</strong> '+t.standort+'<br>üå∏ <strong>Bl√ºhzeit:</strong> '+trachtkalenderMod.formatDatum(t.beginn)+(t.ende?' ‚Üí '+trachtkalenderMod.formatDatum(t.ende):'')+(t.ertrag?'<br>üçØ <strong>Ertrag:</strong> '+t.ertrag.toFixed(1)+' kg':'')+(t.notizen?'<br>üí≠ '+t.notizen:'')+'</div></div>';
        });
        
        return '<div style="max-width:900px;margin-top:2rem">'+
        '<h2 style="margin-bottom:1rem">üå∏ Trachtkalender</h2>'+
        '<div class="info-box">‚ú® Wann bl√ºht welche Tracht? Klicke auf eine Zeile um sie auszublenden. Erfasse eigene Trachten mit Ertr√§gen!</div>'+
        (trachtkalenderMod.ausgeblendete.length>0?'<div style="margin-bottom:1rem"><button class="btn btn-blue btn-sm" onclick="trachtkalenderMod.alleEinblenden()">üëÅÔ∏è Alle einblenden</button></div>':'')+
        '<div class="timeline-container"><div class="timeline-header-row"><div class="timeline-label-col">Tracht</div><div class="timeline-months">'+
        '<div class="timeline-month">Jan</div><div class="timeline-month">Feb</div><div class="timeline-month">M√§r</div><div class="timeline-month">Apr</div><div class="timeline-month">Mai</div><div class="timeline-month">Jun</div><div class="timeline-month">Jul</div><div class="timeline-month">Aug</div><div class="timeline-month">Sep</div><div class="timeline-month">Okt</div><div class="timeline-month">Nov</div><div class="timeline-month">Dez</div>'+
        '</div></div>'+timelineHtml+'</div>'+
        ausgeblendetHtml+
        '<h2>üå∫ Meine erfassten Trachten</h2>'+
        (sortTrachten.length ? meineTrachtenHtml : '<div class="card" style="text-align:center;padding:2rem;color:#7A6652"><div style="font-size:3rem;margin-bottom:1rem">üå∏</div><h3>Noch keine Trachten erfasst</h3><p style="margin-top:.5rem">Erfasse deine ersten Trachten!</p><button class="btn btn-primary" style="margin-top:1rem" onclick="trachtkalenderMod.openModal()">Erste Tracht erfassen</button></div>')+
        '</div>';
    },
    
    rZuchtplanEnhanced(){
        var self = this;
        var plaene = zuchtplanMod.plaene.slice().sort(function(a,b){return b.created-a.created;});
        
        var html = '<div class="container" style="max-width:900px">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üëë K√∂niginnenzucht</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="zuchtplanMod.openModal()">+ Neuer Zuchtplan</button>'+
        '</div>'+
        '<div class="info-box">‚ú® <strong>Intelligente Datumsberechnung:</strong> Gib das Sammelbrut-Datum ein und passe die Tage an. Termine werden automatisch berechnet!</div>';
        
        if (!plaene.length) {
            html += '<div class="card" style="text-align:center;padding:3rem;color:#7A6652"><div style="font-size:3rem;margin-bottom:1rem">üëë</div><h3>Noch keine Zuchtpl√§ne</h3><p style="margin:.5rem 0 1.5rem">Erstelle deinen ersten Zuchtplan!</p><button class="btn btn-primary" onclick="zuchtplanMod.openModal()">Ersten Zuchtplan erstellen</button></div>';
        }
        
        var jetzt = Date.now();
        plaene.forEach(function(plan) {
            var phase = zuchtplanMod.getPhase(plan);
            var badgeClass = jetzt>=plan.zusetzen ? 'badge-completed' : (jetzt>=plan.sammelbrut ? 'badge-active' : 'badge-upcoming');
            
            var naechster = null; var naechstesDatum = null;
            if (jetzt<plan.sammelbrut) { naechster='Sammelbrut'; naechstesDatum=plan.sammelbrut; }
            else if (jetzt<plan.umlarven) { naechster='Umlarven'; naechstesDatum=plan.umlarven; }
            else if (jetzt<plan.zusetzen) { naechster='Zusetzen'; naechstesDatum=plan.zusetzen; }
            var verbleibend = naechstesDatum ? zuchtplanMod.getTageVerbleibend(naechstesDatum) : null;
            
            html += '<div class="zucht-card"><div class="zucht-header"><div><div class="zucht-title">'+plan.name+'</div>'+
                '<div class="badge '+badgeClass+'" style="margin-top:.5rem">'+phase+'</div>'+
                (verbleibend ? '<div style="margin-top:.5rem;font-size:.85rem;color:#7A6652">‚è≠Ô∏è <strong>'+naechster+':</strong> <span style="color:#F5A623;font-weight:600">'+verbleibend+'</span></div>' : '')+
                '</div><div style="display:flex;gap:.5rem"><button class="btn btn-blue btn-xs" onclick="zuchtplanMod.openModal(\''+plan.id+'\')">‚úèÔ∏è</button><button class="btn btn-danger btn-xs" onclick="zuchtplanMod.deleteZucht(\''+plan.id+'\')">üóëÔ∏è</button></div></div>'+
                '<div class="timeline" style="margin:1.5rem 0">'+
                '<div class="timeline-item"><div class="timeline-dot '+(jetzt>=plan.sammelbrut?'completed':'upcoming')+'"></div><div class="timeline-content"><div class="timeline-title">üì¶ Sammelbrutableger</div><div class="timeline-date">'+zuchtplanMod.formatDatum(plan.sammelbrut)+'</div></div></div>'+
                '<div class="timeline-item"><div class="timeline-dot '+(jetzt>=plan.umlarven?(jetzt<plan.zusetzen?'active':'completed'):'upcoming')+'"></div><div class="timeline-content"><div class="timeline-title">üî¨ Umlarven</div><div class="timeline-date">'+zuchtplanMod.formatDatum(plan.umlarven)+' <small style="color:#A69580">(+'+(plan.tageUmlarven||4)+' Tage)</small></div>'+(jetzt>=plan.umlarven&&jetzt<plan.zusetzen?'<div class="timeline-note">üêù Weiselzellen wachsen...</div>':'')+'</div></div>'+
                '<div class="timeline-item"><div class="timeline-dot '+(jetzt>=plan.zusetzen?'completed':'upcoming')+'"></div><div class="timeline-content"><div class="timeline-title">üëë K√∂nigin zusetzen</div><div class="timeline-date">'+zuchtplanMod.formatDatum(plan.zusetzen)+' <small style="color:#A69580">(+'+(plan.tageZusetzen||12)+' Tage)</small></div>'+(jetzt>=plan.zusetzen?'<div class="timeline-note">‚úÖ Zuchtplan abgeschlossen!</div>':'')+'</div></div>'+
                '</div>'+
                (plan.notizen ? '<div style="margin-top:1rem;padding:.75rem;background:#FFF8EE;border-radius:.5rem;font-size:.85rem;color:#7A6652">üí≠ '+plan.notizen+'</div>' : '')+
                '</div>';
        });
        
        return html + '</div>';
    },
    
    rBehandlungen(){
        var self = this;
        var sortiert = behandlungMod.behandlungen.slice().sort(function(a,b){return b.datum-a.datum;});
        
        var html = '<div class="container" style="max-width:900px">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üíâ Behandlungen</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="behandlungMod.openModal()">+ Neue Behandlung</button>'+
        '</div>'+
        '<div class="info-box">‚ú® <strong>Mit Wiederholungen:</strong> Erfasse Behandlungen und lege Wiederholungs-Intervalle fest. Zuk√ºnftige Termine werden automatisch angezeigt!</div>';
        
        if (!sortiert.length) {
            html += '<div class="card" style="text-align:center;padding:3rem;color:#7A6652"><div style="font-size:3rem;margin-bottom:1rem">üíâ</div><h3>Noch keine Behandlungen</h3><p style="margin-top:.5rem">Erfasse deine erste Behandlung!</p><button class="btn btn-primary" style="margin-top:1rem" onclick="behandlungMod.openModal()">Erste Behandlung erfassen</button></div>';
        }
        
        sortiert.forEach(function(beh) {
            var methode = METHODEN[beh.methode];
            var farbe = methode ? methode.farbe : '#7A6652';
            var jetzt = Date.now();
            var zukunft = beh.termine.filter(function(t){return t>=jetzt;});
            var naechster = zukunft.length>0 ? behandlungMod.getTerminStatus(zukunft[0]) : null;
            
            var termineHtml = '';
            if (beh.termine.length > 1) {
                termineHtml = '<div class="termine-liste"><strong style="font-size:.85rem;color:#7A6652">üîÑ Behandlungs-Termine ('+beh.termine.length+'x):</strong>';
                beh.termine.forEach(function(termin, idx) {
                    var status = behandlungMod.getTerminStatus(termin);
                    termineHtml += '<div class="termin-item"><span class="termin-datum">'+(idx+1)+'. '+behandlungMod.formatDatum(termin)+'</span><span class="badge badge-'+status.status+'" style="margin:0">'+status.label+'</span></div>';
                });
                termineHtml += '</div>';
            }
            
            html += '<div class="behandlung-card" style="border-color:'+farbe+'"><div class="behandlung-header"><div>'+
                '<div class="behandlung-title">'+(methode?methode.emoji:'üíâ')+' '+beh.methodeName+'</div>'+
                '<div style="margin-top:.5rem"><span class="badge badge-repeat">'+(beh.intervallLabel||'Einmalig')+'</span>'+
                (naechster ? '<span class="badge badge-'+naechster.status+'">'+naechster.label+'</span>' : '<span class="badge badge-completed">Abgeschlossen</span>')+
                '</div></div><button class="btn btn-danger btn-xs" onclick="behandlungMod.deleteBehandlung(\''+beh.id+'\')">üóëÔ∏è</button></div>'+
                '<div class="behandlung-info">üêù <strong>V√∂lker:</strong> '+beh.voelkerLabel+'<br>üìÖ <strong>Erste Behandlung:</strong> '+behandlungMod.formatDatum(beh.datum)+(beh.notizen?'<br>üí≠ '+beh.notizen:'')+'</div>'+
                termineHtml+'</div>';
        });
        
        return html + '</div>';
    },
    
    rDatenexport(){
        var self = this;
        return '<div class="container">'+
        '<h1>üìä Datenexport</h1>'+
        '<div class="card">'+
        '<h3>üìã Daten als JSON exportieren</h3>'+
        '<p style="font-size:.9rem;color:#7A6652;margin:.75rem 0">Exportiere alle deine Imkerei-Daten als JSON-Datei zur Sicherung.</p>'+
        '<button class="btn btn-primary btn-block" onclick="(function(){var d=JSON.stringify(app.data,null,2);var b=new Blob([d],{type:\'application/json\'});var a=document.createElement(\'a\');a.href=URL.createObjectURL(b);a.download=\'imkerei_backup_\'+new Date().toISOString().split(\'T\')[0]+\'.json\';a.click();app.toast(\'‚úì Export erfolgreich!\',\'success\');})()">üì• Daten exportieren (JSON)</button>'+
        '</div>'+
        '<div class="card">'+
        '<h3>üìä Statistik-√úbersicht</h3>'+
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-top:.75rem">'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+this.data.standorte.length+'</div><div style="font-size:.75rem;color:#7A6652">Standorte</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+this.data.voelker.length+'</div><div style="font-size:.75rem;color:#7A6652">V√∂lker</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+zuchtplanMod.plaene.length+'</div><div style="font-size:.75rem;color:#7A6652">Zuchtpl√§ne</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+behandlungMod.behandlungen.length+'</div><div style="font-size:.75rem;color:#7A6652">Behandlungen</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+trachtkalenderMod.trachten.length+'</div><div style="font-size:.75rem;color:#7A6652">Trachten</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+packlisteMod.items.length+'</div><div style="font-size:.75rem;color:#7A6652">Packlisten-Items</div></div>'+
        '</div></div></div>';
    },
    
    rPlaceholder(){
        return '<div class="container">'+
        '<h1>üöß In Entwicklung</h1>'+
        '<div class="card" style="text-align:center;padding:3rem">'+
        '<div style="font-size:4rem;margin-bottom:1rem">üêù</div>'+
        '<p style="color:#7A6652">Diese Funktion wird bald verf√ºgbar sein!</p>'+
        '</div>'+
        '</div>';
    },
    
    del(col, id){
        if(!confirm('Wirklich l√∂schen?')) return;
        this.data[col] = this.data[col].filter(function(x){return x.id !== id;});
        db.del(col, id);
        this.render();
    }
};


// ============================================
// MODUL: PACKLISTE
// ============================================
const PACKLISTE_ITEMS = {
    'Schutzkleidung': ['Imkeranzug / Imkerjacke','Imkerhandschuhe','Imkerhut mit Schleier','Feste Schuhe / Stiefel'],
    'Werkzeuge': ['Stockmei√üel','Smoker (Raucher)','Abkehrbesen','Wabenzange','Entdeckelungsgabel','Stockkarte & Stift','Messer / Entdeckelungsmesser'],
    'Rauchmaterial': ['Holzsp√§ne / Holzpellets','Heu / Stroh','Karton / Eierkarton','Anz√ºnder','Feuerzeug / Streichh√∂lzer'],
    'Futter': ['Futterteig (Apifonda)','Zuckerwasser','Futtertaschen','Futterzarge'],
    'Behandlung': ['Ameisens√§ure','Oxals√§ure','Puderzucker (f√ºr Diagnose)','Diagnosebrett / Windel','Schutzhandschuhe f√ºr S√§ure','Dosierer / Verdampfer'],
    'Material': ['R√§hmchen','Mittelw√§nde','Absperrgitter','Fluglochkeil','M√§usegitter','Draht zum Einl√∂ten'],
    'Ernte': ['Honigschleuder','Entdeckelungsgeschirr','Sieb (doppelt)','Honigeimer / Hobbock','Honigrefraktometer','Gl√§ser & Deckel','Etiketten'],
    'Beuten & Zargen': ['Boden / Bodenbrett','Brutraum(zarge)','Honigraum(zarge)','Absperrgitter','Innendeckel','Au√üendeckel / Blechdeckel'],
    'Sonstiges': ['Erste-Hilfe-Set','Wasser / Getr√§nk','Transportbox / Kiste','M√ºllsack','Desinfektionsmittel','Handy / Kamera']
};

// ============================================
// WETTER MODUL (Open-Meteo, 14 Tage)
// ============================================
const wetterMod = {
    daten: null,
    datenProStandort: {},
    loading: false,
    error: null,
    letzterAbruf: null,
    
    getStandortKoords(){
        // Ersten Standort mit Koordinaten nehmen
        var standorte = app.data.standorte || [];
        for (var i=0; i<standorte.length; i++) {
            if (standorte[i].lat && standorte[i].lng) return {lat:standorte[i].lat, lng:standorte[i].lng, name:standorte[i].name};
        }
        return null;
    },
    
    async ladenFuerStandort(standortId, lat, lng){
        var key = standortId;
        var cached = this.datenProStandort[key];
        if (cached && cached._ts && (Date.now() - cached._ts < 30*60*1000)) return cached;
        try {
            var url = 'https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lng+
                '&current=temperature_2m,weather_code,wind_speed_10m'+
                '&timezone=Europe%2FBerlin';
            var resp = await fetch(url);
            var data = await resp.json();
            data._ts = Date.now();
            this.datenProStandort[key] = data;
            return data;
        } catch(e) { return null; }
    },
    
    async laden(){
        var koords = this.getStandortKoords();
        if (!koords) { this.error = 'nostandort'; return; }
        
        // Nur alle 30 Min neu laden
        if (this.daten && this.letzterAbruf && (Date.now() - this.letzterAbruf < 30*60*1000)) return;
        
        this.loading = true;
        this.error = null;
        try {
            var url = 'https://api.open-meteo.com/v1/forecast?latitude='+koords.lat+'&longitude='+koords.lng+
                '&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weather_code,wind_speed_10m_max'+
                '&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m'+
                '&timezone=Europe%2FBerlin&forecast_days=14';
            var resp = await fetch(url);
            var data = await resp.json();
            this.daten = data;
            this.daten._standortName = koords.name;
            this.letzterAbruf = Date.now();
            this.error = null;
        } catch(e) {
            this.error = 'fetch';
            console.error('Wetter-Fehler:', e);
        }
        this.loading = false;
        
        // Auch f√ºr alle Standorte mit GPS laden
        var standorte = app.data.standorte || [];
        for (var i=0; i<standorte.length; i++) {
            var s = standorte[i];
            if (s.lat && s.lng) {
                this.ladenFuerStandort(s.id, s.lat, s.lng);
            }
        }
    },
    
    renderMini(standortId){
        var data = this.datenProStandort[standortId];
        if (!data || !data.current) return '';
        var c = data.current;
        var flug = this.bienenFlugWetter(c.temperature_2m, 0, c.wind_speed_10m);
        return '<div style="display:flex;align-items:center;gap:.5rem;margin-top:.5rem;padding:.5rem;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:.5rem;font-size:.8rem">'+
            '<span style="font-size:1.25rem">'+this.wetterIcon(c.weather_code)+'</span>'+
            '<span style="font-weight:600">'+Math.round(c.temperature_2m)+'¬∞C</span>'+
            '<span style="color:#7A6652">üí®'+Math.round(c.wind_speed_10m)+'km/h</span>'+
            '<span style="font-size:.75rem;font-weight:600;color:'+flug.color+';margin-left:auto">'+flug.label+'</span>'+
            '</div>';
    },
    
    wetterIcon(code){
        if (code <= 1) return '‚òÄÔ∏è';
        if (code <= 3) return '‚õÖ';
        if (code <= 48) return '‚òÅÔ∏è';
        if (code <= 57) return 'üåßÔ∏è';
        if (code <= 67) return 'üåßÔ∏è';
        if (code <= 77) return 'üå®Ô∏è';
        if (code <= 82) return 'üåßÔ∏è';
        if (code <= 86) return 'üå®Ô∏è';
        if (code <= 99) return '‚õàÔ∏è';
        return 'üå§Ô∏è';
    },
    
    wetterText(code){
        if (code === 0) return 'Klar';
        if (code <= 3) return 'Bew√∂lkt';
        if (code <= 48) return 'Nebel';
        if (code <= 57) return 'Niesel';
        if (code <= 67) return 'Regen';
        if (code <= 77) return 'Schnee';
        if (code <= 82) return 'Schauer';
        if (code <= 86) return 'Schneeschauer';
        if (code <= 99) return 'Gewitter';
        return '?';
    },
    
    bienenFlugWetter(tMax, niederschlag, wind){
        // Bienen fliegen ab ~12¬∞C, nicht bei starkem Regen/Wind
        if (tMax >= 15 && niederschlag < 1 && wind < 30) return {status:'gut', label:'üêù Gutes Flugwetter', color:'#10b981'};
        if (tMax >= 12 && niederschlag < 5 && wind < 40) return {status:'ok', label:'üêù Bedingt Flugwetter', color:'#f59e0b'};
        return {status:'schlecht', label:'‚ùå Kein Flugwetter', color:'#ef4444'};
    },
    
    render(){
        try {
        if (this.error === 'nostandort') return '<div class="card" style="border-left:4px solid #7A6652">'+
            '<h2 style="margin:0 0 .5rem">üå§Ô∏è Wetter</h2>'+
            '<div style="color:#7A6652;font-size:.85rem">Lege einen Standort mit GPS-Position an, um Wetterdaten zu sehen.</div></div>';
        if (this.loading && !this.daten) return '<div class="card"><h2 style="margin:0 0 .5rem">üå§Ô∏è Wetter</h2><div style="color:#7A6652">Laden...</div></div>';
        if (this.error === 'fetch') return '<div class="card"><h2 style="margin:0 0 .5rem">üå§Ô∏è Wetter</h2><div style="color:#ef4444;font-size:.85rem">Wetterdaten konnten nicht geladen werden.</div></div>';
        if (!this.daten) return '';
        
        var d = this.daten;
        var c = d.current;
        var daily = d.daily;
        var standortName = d._standortName || 'Standort';
        var self = this;
        
        // Aktuelles Wetter
        var jetztFlug = this.bienenFlugWetter(c.temperature_2m, 0, c.wind_speed_10m);
        
        var html = '<div class="card" style="border-left:4px solid #0ea5e9">'+
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
            '<h2 style="margin:0">üå§Ô∏è Wetter</h2>'+
            '<span style="font-size:.75rem;color:#7A6652">üìç '+standortName+'</span>'+
            '</div>'+
            
            // Aktuell
            '<div style="display:flex;align-items:center;gap:1rem;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);padding:1rem;border-radius:.75rem;margin-bottom:1rem">'+
            '<div style="font-size:2.5rem">'+this.wetterIcon(c.weather_code)+'</div>'+
            '<div style="flex:1">'+
            '<div style="font-size:1.5rem;font-weight:700">'+Math.round(c.temperature_2m)+'¬∞C</div>'+
            '<div style="font-size:.8rem;color:#7A6652">'+this.wetterText(c.weather_code)+' ¬∑ üí® '+Math.round(c.wind_speed_10m)+' km/h ¬∑ üíß '+c.relative_humidity_2m+'%</div>'+
            '</div>'+
            '<div style="text-align:right;font-size:.8rem;font-weight:600;color:'+jetztFlug.color+'">'+jetztFlug.label+'</div>'+
            '</div>'+
            
            // 14-Tage Vorschau
            '<div style="overflow-x:auto;margin:0 -.25rem">'+
            '<div style="display:flex;gap:.5rem;padding:.25rem">';
        
        for (var i=0; i<daily.time.length; i++) {
            var datum = new Date(daily.time[i]);
            var tag = datum.toLocaleDateString('de-DE',{weekday:'short'});
            var tagNum = datum.getDate()+'.'+(datum.getMonth()+1)+'.';
            var tMax = Math.round(daily.temperature_2m_max[i]);
            var tMin = Math.round(daily.temperature_2m_min[i]);
            var niederschlag = daily.precipitation_sum[i];
            var wind = daily.wind_speed_10m_max[i];
            var code = daily.weather_code[i];
            var flug = this.bienenFlugWetter(tMax, niederschlag, wind);
            var isHeute = i === 0;
            
            html += '<div style="min-width:72px;text-align:center;padding:.5rem .375rem;border-radius:.5rem;'+
                'background:'+(isHeute?'#dbeafe':'#FFF8EE')+';border:1px solid '+(isHeute?'#93c5fd':'#E8DFD4')+
                ';flex-shrink:0">'+
                '<div style="font-size:.7rem;font-weight:600;color:'+(isHeute?'#2563eb':'#7A6652')+'">'+
                (isHeute?'Heute':tag)+'</div>'+
                '<div style="font-size:.65rem;color:#A69580">'+tagNum+'</div>'+
                '<div style="font-size:1.25rem;margin:.25rem 0">'+this.wetterIcon(code)+'</div>'+
                '<div style="font-size:.8rem;font-weight:700">'+tMax+'¬∞</div>'+
                '<div style="font-size:.7rem;color:#A69580">'+tMin+'¬∞</div>'+
                (niederschlag > 0 ? '<div style="font-size:.65rem;color:#3b82f6;margin-top:.125rem">üíß'+niederschlag.toFixed(1)+'</div>' : '')+
                '<div style="width:8px;height:8px;border-radius:50%;background:'+flug.color+';margin:.25rem auto 0" title="'+flug.label+'"></div>'+
                '</div>';
        }
        
        html += '</div></div>'+
            '<div style="display:flex;align-items:center;gap:.75rem;margin-top:.75rem;font-size:.7rem;color:#A69580">'+
            '<span>üü¢ Flugwetter</span><span>üü° Bedingt</span><span>üî¥ Kein Flug</span>'+
            '</div>'+
            '</div>';
        
        return html;
        } catch(e) { console.error('Wetter render Fehler:', e); return ''; }
    }
};

const packlisteMod = {
    items: [],
    schnellCounter: {},
    
    init() {
        const gespeichert = localStorage.getItem('imkerei_packliste');
        if (gespeichert) {
            try {
                const data = JSON.parse(gespeichert);
                this.items = data.items || [];
                this.schnellCounter = data.counter || {};
            } catch (e) { this.erstelleNeueItems(); }
        } else { this.erstelleNeueItems(); }
    },
    
    erstelleNeueItems() {
        this.items = [];
        this.schnellCounter = {};
        Object.entries(PACKLISTE_ITEMS).forEach(function(entry) {
            var kategorie = entry[0]; var items = entry[1];
            items.forEach(function(name) {
                packlisteMod.items.push({
                    id: 'pack_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    kategorie: kategorie, name: name, checked: false, istSchnell: false
                });
            });
        });
        this.speichern();
    },
    
    speichern() { localStorage.setItem('imkerei_packliste', JSON.stringify({items: this.items, counter: this.schnellCounter})); },
    
    toggle(id) {
        var item = this.items.find(function(i){return i.id === id;});
        if (item) { item.checked = !item.checked; this.speichern(); app.render(); }
    },
    
    changeMenge(id, delta) {
        var item = this.items.find(function(i){return i.id === id;});
        if (item) { if (!item.menge) item.menge = 1; item.menge = Math.max(1, item.menge + delta); this.speichern(); app.render(); }
    },
    
    loescheItem(id) {
        this.items = this.items.filter(function(i){return i.id !== id;});
        this.speichern(); app.render(); app.toast('üóëÔ∏è Gel√∂scht','info');
    },
    
    alleAbhaken() { this.items.forEach(function(item){item.checked = true;}); this.speichern(); app.render(); },
    alleZuruecksetzen() { this.items.forEach(function(item){item.checked = false;}); this.speichern(); app.render(); },
    
    allesLoeschen() {
        if (!confirm('Wirklich die KOMPLETTE Packliste l√∂schen?')) return;
        this.items.forEach(function(item){ db.del('packliste', item.id); });
        this.items = [];
        this.schnellCounter = {};
        app.render();
        app.toast('üóëÔ∏è Packliste gel√∂scht','info');
    },
    
    schnellHinzufuegen(typ) {
        var existierend = this.items.filter(function(i){return i.schnellTyp === typ;});
        if (existierend.length > 0) {
            this.items = this.items.filter(function(i){return i.schnellTyp !== typ;});
            this.speichern(); app.render(); app.toast('‚ùå Entfernt','info'); return;
        }
        var self = this;
        var sets = {
            'schutz': [['Schutzkleidung','üß• Schutzausr√ºstung komplett'],['Schutzkleidung','  ‚Üí Imkeranzug/Jacke'],['Schutzkleidung','  ‚Üí Imkerhandschuhe'],['Schutzkleidung','  ‚Üí Imkerhut mit Schleier']],
            'werkzeug': [['Werkzeuge','üîß Werkzeug-Set komplett'],['Werkzeuge','  ‚Üí Stockmei√üel'],['Werkzeuge','  ‚Üí Abkehrbesen'],['Werkzeuge','  ‚Üí Wabenzange']],
            'smoker': [['Rauchmaterial','üí® Smoker-Paket komplett'],['Werkzeuge','  ‚Üí Smoker (Raucher)'],['Rauchmaterial','  ‚Üí Holzsp√§ne/Pellets'],['Rauchmaterial','  ‚Üí Anz√ºnder']],
            'ernte': [['Ernte','üçØ Ernte-Set komplett'],['Ernte','  ‚Üí Honigschleuder'],['Ernte','  ‚Üí Entdeckelungsgeschirr'],['Ernte','  ‚Üí Sieb (doppelt)'],['Ernte','  ‚Üí Honigeimer'],['Ernte','  ‚Üí Gl√§ser & Deckel']],
            'behandlung_set': [['Behandlung','üíâ Behandlungs-Set komplett'],['Behandlung','  ‚Üí Ameisens√§ure'],['Behandlung','  ‚Üí Oxals√§ure'],['Behandlung','  ‚Üí Puderzucker'],['Behandlung','  ‚Üí Schutzhandschuhe']],
            'futter': [['Futter','üçØ Futter-Set komplett'],['Futter','  ‚Üí Futterteig'],['Futter','  ‚Üí Zuckerwasser'],['Futter','  ‚Üí Futterzarge']],
            'ableger': [['Material','üì¶ Ablegerkasten komplett'],['Material','  ‚Üí Boden'],['Material','  ‚Üí Brutzarge'],['Material','  ‚Üí Deckel'],['Material','  ‚Üí 6 R√§hmchen']],
            'dadant': [['Beuten & Zargen','üè† Dadant Beute komplett'],['Beuten & Zargen','  ‚Üí Boden'],['Beuten & Zargen','  ‚Üí Brutraum'],['Beuten & Zargen','  ‚Üí Honigraum'],['Beuten & Zargen','  ‚Üí Deckel']],
            'raehmchen': [['Material','ü™µ 10x R√§hmchen']],
            'mittelwaende': [['Material','‚ñ≠ 10x Mittelw√§nde']],
            'boden': [['Beuten & Zargen','‚¨ú Boden']],
            'deckel': [['Beuten & Zargen','üî≤ Deckel']],
            'zarge': [['Beuten & Zargen','üì¶ Zarge']]
        };
        var items = sets[typ] || [];
        items.forEach(function(x) {
            self.items.push({id:'schnell_'+Date.now()+'_'+Math.random().toString(36).substr(2,9), kategorie:x[0], name:x[1], checked:false, istSchnell:true, schnellTyp:typ});
        });
        this.speichern(); app.render(); app.toast('‚úì Hinzugef√ºgt','success');
    },
    
    getStatistik() {
        var abgehakt = this.items.filter(function(i){return i.checked;}).length;
        return { abgehakt: abgehakt, offen: this.items.length - abgehakt, gesamt: this.items.length };
    }
};

// ============================================
// MODUL: TRACHTKALENDER
// ============================================
const TRACHT_KALENDER = {
    'Schneegl√∂ckchen':{monate:[1,2],farbe:'#E8F5E9',emoji:'‚ùÑÔ∏è'},
    'Haselnuss':{monate:[1,2,3],farbe:'#8B7355',emoji:'üå∞'},
    'Erle':{monate:[2,3],farbe:'#795548',emoji:'üå≥'},
    'Weide':{monate:[2,3,4],farbe:'#98FB98',emoji:'üåø'},
    'Huflattich':{monate:[2,3],farbe:'#FFD700',emoji:'üåº'},
    'Kornelkirsche':{monate:[2,3,4],farbe:'#FFF59D',emoji:'üåº'},
    'Schlehe':{monate:[3,4],farbe:'#F5F5F5',emoji:'üå∏'},
    'Krokus':{monate:[2,3],farbe:'#9C27B0',emoji:'üíú'},
    'Kirsche':{monate:[3,4,5],farbe:'#FFB7C5',emoji:'üçí'},
    'Pflaume':{monate:[3,4],farbe:'#E1BEE7',emoji:'üå∏'},
    'Birne':{monate:[4,5],farbe:'#FFF9C4',emoji:'üçê'},
    'Apfel':{monate:[4,5],farbe:'#FFCDD2',emoji:'üçé'},
    'L√∂wenzahn':{monate:[4,5,6],farbe:'#FFD700',emoji:'üåº'},
    'Raps':{monate:[4,5,6],farbe:'#FFEB3B',emoji:'üåæ'},
    'Obstbl√ºte':{monate:[4,5],farbe:'#FF69B4',emoji:'üå∏'},
    'Wei√üdorn':{monate:[5,6],farbe:'#FAFAFA',emoji:'üå∏'},
    'Flieder':{monate:[5,6],farbe:'#CE93D8',emoji:'üíú'},
    'Rosskastanie':{monate:[5,6],farbe:'#FFF59D',emoji:'üå∞'},
    'Akazie (Robinie)':{monate:[5,6],farbe:'#F5F5DC',emoji:'üå≥'},
    'Edelkastanie':{monate:[6,7],farbe:'#8BC34A',emoji:'üå∞'},
    'Himbeere':{monate:[5,6],farbe:'#E91E63',emoji:'ü´ê'},
    'Brombeere':{monate:[6,7,8],farbe:'#4A148C',emoji:'ü´ê'},
    'Klee (Wei√ü)':{monate:[5,6,7,8],farbe:'#E8F5E9',emoji:'‚òòÔ∏è'},
    'Klee (Rot)':{monate:[6,7,8],farbe:'#F48FB1',emoji:'‚òòÔ∏è'},
    'Fichte (Honigtau)':{monate:[5,6,7],farbe:'#1B5E20',emoji:'üå≤'},
    'Tanne (Honigtau)':{monate:[6,7,8],farbe:'#2E7D32',emoji:'üå≤'},
    'Eiche (Honigtau)':{monate:[6,7],farbe:'#4E342E',emoji:'üå≥'},
    'Linde (Sommer)':{monate:[6,7],farbe:'#AED581',emoji:'üçÉ'},
    'Linde (Winter)':{monate:[7],farbe:'#9CCC65',emoji:'üçÉ'},
    'Phacelia':{monate:[6,7,8,9],farbe:'#9370DB',emoji:'üíú'},
    'Sonnenblume':{monate:[7,8,9],farbe:'#FFD700',emoji:'üåª'},
    'Lavendel':{monate:[7,8],farbe:'#9575CD',emoji:'üíú'},
    'Kornblume':{monate:[6,7,8],farbe:'#2196F3',emoji:'üíô'},
    'Heide':{monate:[8,9,10],farbe:'#DDA0DD',emoji:'üå∏'},
    'Efeu':{monate:[9,10,11],farbe:'#228B22',emoji:'üåø'},
    'Springkraut (Indisches)':{monate:[7,8,9,10],farbe:'#FF6F00',emoji:'üå∫'},
    'Goldrute':{monate:[7,8,9],farbe:'#FFD700',emoji:'üåº'},
    'Herbstastern':{monate:[9,10],farbe:'#9C27B0',emoji:'üíú'}
};

const trachtkalenderMod = {
    trachten: [],
    ausgeblendete: [],
    
    init() {
        // Trachten werden aus Supabase geladen in startApp()
        // localStorage nicht mehr nutzen f√ºr Trachten
        this.trachten = [];
        var aus = localStorage.getItem('imkerei_trachten_ausgeblendet');
        if (aus) { try { this.ausgeblendete = JSON.parse(aus); } catch(e) { this.ausgeblendete = []; } }
    },
    
    speichern() { /* Trachten werden direkt in Supabase gespeichert, nicht localStorage */ },
    
    openModal() {
        this._editId = null;
        document.getElementById('trachtModalTitle').textContent = 'üå∏ Tracht erfassen';
        document.getElementById('trachtSaveBtn').textContent = 'Tracht speichern';
        document.getElementById('trachtModalEnhanced').classList.add('active');
        document.getElementById('trachtTypE').value = '';
        document.getElementById('trachtStandortE').value = '';
        document.getElementById('trachtBeginnE').value = new Date().toISOString().split('T')[0];
        document.getElementById('trachtEndeE').value = '';
        document.getElementById('trachtErtragE').value = '';
        document.getElementById('trachtNotizenE').value = '';
        document.getElementById('trachtLatE').value = '';
        document.getElementById('trachtLngE').value = '';
        document.getElementById('koordinatenStatus').innerHTML = '';
        document.getElementById('trachtShareE').checked = false;
        // Standort-Dropdown bef√ºllen
        var sel = document.getElementById('trachtStandortSelect');
        sel.innerHTML = '<option value="">-- Manuell eingeben --</option>';
        app.data.standorte.forEach(function(s){
            var label = 'üìç ' + s.name + (s.lat ? ' (‚úì)' : '');
            sel.innerHTML += '<option value="'+s.id+'">'+label+'</option>';
        });
        // Karte initialisieren
        setTimeout(function(){ app.initMapPicker('tracht'); }, 300);
    },
    closeModal() { document.getElementById('trachtModalEnhanced').classList.remove('active'); },
    
    standortChanged() {
        var sid = document.getElementById('trachtStandortSelect').value;
        if (sid) {
            var s = app.data.standorte.find(function(x){return x.id===sid;});
            if (s) {
                document.getElementById('trachtStandortE').value = s.name;
                if (s.lat && s.lng) {
                    document.getElementById('trachtLatE').value = s.lat;
                    document.getElementById('trachtLngE').value = s.lng;
                    document.getElementById('trachtShareE').checked = true;
                    document.getElementById('koordinatenStatus').innerHTML = '<span style="color:#10b981">‚úÖ Position von Standort "'+s.name+'" √ºbernommen</span>';
                    // Karte neu initialisieren mit Standort-Position
                    setTimeout(function(){ app.initMapPicker('tracht'); }, 100);
                } else {
                    document.getElementById('koordinatenStatus').innerHTML = '<span style="color:#f59e0b">‚ö†Ô∏è Standort "'+s.name+'" hat keine Position. Klicke auf die Karte.</span>';
                }
            }
        }
    },
    
    getGPS() {},
    parseKoord() {},
    parseMapsLink() {},
    
    editTracht(id) {
        var t = this.trachten.find(function(x){return x.id===id;});
        if (!t) return;
        this._editId = id;
        document.getElementById('trachtModalTitle').textContent = '‚úèÔ∏è Tracht bearbeiten';
        document.getElementById('trachtSaveBtn').textContent = '√Ñnderungen speichern';
        document.getElementById('trachtModalEnhanced').classList.add('active');
        document.getElementById('trachtTypE').value = t.typ;
        document.getElementById('trachtStandortE').value = t.standort;
        document.getElementById('trachtBeginnE').value = t.beginn ? new Date(t.beginn).toISOString().split('T')[0] : '';
        document.getElementById('trachtEndeE').value = t.ende ? new Date(t.ende).toISOString().split('T')[0] : '';
        document.getElementById('trachtErtragE').value = t.ertrag || '';
        document.getElementById('trachtNotizenE').value = t.notizen || '';
        document.getElementById('trachtLatE').value = t.lat || '';
        document.getElementById('trachtLngE').value = t.lng || '';
        document.getElementById('trachtShareE').checked = t.shared || false;
        if (t.lat && t.lng) {
            document.getElementById('koordinatenStatus').innerHTML = '<span style="color:#10b981">‚úÖ Position: '+t.lat.toFixed(4)+', '+t.lng.toFixed(4)+'</span>';
        } else {
            document.getElementById('koordinatenStatus').innerHTML = '';
        }
        // Standort-Dropdown bef√ºllen
        var sel = document.getElementById('trachtStandortSelect');
        sel.innerHTML = '<option value="">-- Manuell eingeben --</option>';
        app.data.standorte.forEach(function(s){
            var label = 'üìç ' + s.name + (s.lat ? ' (‚úì)' : '');
            sel.innerHTML += '<option value="'+s.id+'">'+label+'</option>';
        });
        setTimeout(function(){ app.initMapPicker('tracht'); }, 300);
    },
    
    async saveTracht() {
        var typ = document.getElementById('trachtTypE').value;
        var standort = document.getElementById('trachtStandortE').value.trim();
        var beginn = document.getElementById('trachtBeginnE').value;
        var ende = document.getElementById('trachtEndeE').value;
        var ertrag = parseFloat(document.getElementById('trachtErtragE').value) || 0;
        var notizen = document.getElementById('trachtNotizenE').value.trim();
        var latRaw = document.getElementById('trachtLatE').value;
        var lngRaw = document.getElementById('trachtLngE').value;
        var lat = parseFloat(latRaw) || null;
        var lng = parseFloat(lngRaw) || null;
        var share = document.getElementById('trachtShareE').checked;
        console.log('SAVE TRACHT: typ='+typ+' standort='+standort+' latRaw='+latRaw+' lngRaw='+lngRaw+' lat='+lat+' lng='+lng+' share='+share);
        if (!typ || !standort) { alert('Bitte Typ und Standort eingeben!'); return; }
        
        if (this._editId) {
            // Bestehende Tracht aktualisieren
            var t = this.trachten.find(function(x){return x.id===trachtkalenderMod._editId;});
            if (t) {
                t.typ = typ; t.standort = standort;
                t.beginn = beginn ? new Date(beginn).getTime() : null;
                t.ende = ende ? new Date(ende).getTime() : null;
                t.ertrag = ertrag; t.notizen = notizen;
                t.lat = lat; t.lng = lng; t.shared = share;
                
                db.update('trachten', {typ:t.typ, standort:t.standort, beginn:t.beginn, ende:t.ende, ertrag:t.ertrag, notizen:t.notizen, lat:lat, lng:lng, shared:share}, t.id);
                
                if (share && lat && lng) {
                    var profile = app.data.user;
                    var userName = profile ? (profile.name || profile.email || 'Anonym') : 'Anonym';
                    sb.from('trachten_shared').upsert({id:t.id, user_id:currentUser.id, user_name:userName, typ:t.typ, standort:t.standort, lat:lat, lng:lng, beginn:t.beginn, ende:t.ende, ertrag:t.ertrag, notizen:t.notizen, jahr:new Date().getFullYear()});
                } else if (!share) {
                    sb.from('trachten_shared').delete().eq('id', t.id);
                }
            }
            this._editId = null;
            this.closeModal(); app.render(); app.toast('‚úì Tracht aktualisiert!','success');
        } else {
            // Neue Tracht erstellen
            var t = {id:'tracht_'+Date.now(), typ:typ, standort:standort, beginn:beginn?new Date(beginn).getTime():null, ende:ende?new Date(ende).getTime():null, ertrag:ertrag, notizen:notizen, lat:lat, lng:lng, shared:share, created:Date.now()};
            this.trachten.push(t);
            db.insert('trachten',{id:t.id,user_id:currentUser.id,typ:t.typ,standort:t.standort,beginn:t.beginn,ende:t.ende,ertrag:t.ertrag,notizen:t.notizen,lat:lat,lng:lng,shared:share,created_at:t.created});
            
            if (share && lat && lng) {
                var profile = app.data.user;
                var userName = profile ? (profile.name || profile.email || 'Anonym') : 'Anonym';
                var shareData = {id:t.id, user_id:currentUser.id, user_name:userName, typ:t.typ, standort:t.standort, lat:lat, lng:lng, beginn:t.beginn, ende:t.ende, ertrag:t.ertrag, notizen:t.notizen, jahr:new Date().getFullYear()};
                console.log('SHARE DATA:', JSON.stringify(shareData));
                var shareResult = await sb.from('trachten_shared').upsert(shareData);
                console.log('SHARE RESULT:', JSON.stringify(shareResult));
                if (shareResult.error) { app.toast('‚ùå Teilen-Fehler: '+shareResult.error.message,'error'); }
            } else {
                console.log('SHARE SKIPPED: share='+share+' lat='+lat+' lng='+lng);
                if (share && (!lat || !lng)) {
                app.toast('‚ö†Ô∏è Zum Teilen werden GPS-Koordinaten ben√∂tigt','warning');
            }
            }
            
            this.closeModal(); app.render(); app.toast('‚úì Tracht erfasst!','success');
        }
    },
    
    deleteTracht(id) { 
        this.trachten = this.trachten.filter(function(t){return t.id !== id;}); 
        db.del('trachten', id);
        // Auch von shared l√∂schen falls geteilt
        sb.from('trachten_shared').delete().eq('id', id);
        app.render(); 
    },
    
    toggleTracht(name) {
        var idx = this.ausgeblendete.indexOf(name);
        if (idx > -1) { this.ausgeblendete.splice(idx,1); } else { this.ausgeblendete.push(name); }
        localStorage.setItem('imkerei_trachten_ausgeblendet', JSON.stringify(this.ausgeblendete));
        app.render();
    },
    
    alleEinblenden() { this.ausgeblendete = []; localStorage.setItem('imkerei_trachten_ausgeblendet','[]'); app.render(); },
    
    formatDatum(ts) { if (!ts) return '-'; return new Date(ts).toLocaleDateString('de-DE'); },
    
    getStatus(beginn, ende) {
        if (!beginn) return 'upcoming';
        var jetzt = Date.now();
        var end = ende || (beginn + 30*24*60*60*1000);
        if (jetzt < beginn) return 'upcoming';
        if (jetzt > end) return 'past';
        return 'active';
    }
};

// ============================================
// MODUL: ZUCHTPLAN (enhanced)
// ============================================
const zuchtplanMod = {
    plaene: [],
    editId: null,
    tageUmlarven: 4,
    tageZusetzen: 12,
    
    init() {
        var gespeichert = localStorage.getItem('imkerei_zuchtplaene');
        if (gespeichert) { try { this.plaene = JSON.parse(gespeichert); } catch(e) { this.plaene = []; } }
    },
    
    speichern() { localStorage.setItem('imkerei_zuchtplaene', JSON.stringify(this.plaene)); },
    
    openModal(id) {
        if (id) {
            var plan = this.plaene.find(function(p){return p.id === id;});
            if (!plan) return;
            this.editId = id;
            document.getElementById('zuchtModalEnhancedTitle').textContent = 'üëë Zuchtplan bearbeiten';
            document.getElementById('zuchtNameE').value = plan.name;
            document.getElementById('zuchtSammelE').value = new Date(plan.sammelbrut).toISOString().split('T')[0];
            document.getElementById('zuchtNotizenE').value = plan.notizen || '';
            if (plan.tageUmlarven) this.tageUmlarven = plan.tageUmlarven;
            if (plan.tageZusetzen) this.tageZusetzen = plan.tageZusetzen;
            document.getElementById('tageUmlarvenE').textContent = this.tageUmlarven;
            document.getElementById('tageZusetzenE').textContent = this.tageZusetzen;
            this.berechneAlles();
        } else {
            this.editId = null;
            document.getElementById('zuchtModalEnhancedTitle').textContent = 'üëë Neuer Zuchtplan';
            document.getElementById('zuchtNameE').value = '';
            document.getElementById('zuchtSammelE').value = new Date().toISOString().split('T')[0];
            document.getElementById('zuchtNotizenE').value = '';
            this.tageUmlarven = 4; this.tageZusetzen = 12;
            document.getElementById('tageUmlarvenE').textContent = '4';
            document.getElementById('tageZusetzenE').textContent = '12';
            this.berechneAlles();
        }
        document.getElementById('zuchtModalEnhanced').classList.add('active');
    },
    
    closeModal() { document.getElementById('zuchtModalEnhanced').classList.remove('active'); this.editId = null; },
    
    changeTage(typ, delta) {
        if (typ === 'umlarven') { this.tageUmlarven = Math.max(1, this.tageUmlarven + delta); document.getElementById('tageUmlarvenE').textContent = this.tageUmlarven; }
        else { this.tageZusetzen = Math.max(1, this.tageZusetzen + delta); document.getElementById('tageZusetzenE').textContent = this.tageZusetzen; }
        this.berechneAlles();
    },
    
    berechneAlles() {
        var sammelbrut = document.getElementById('zuchtSammelE').value;
        if (!sammelbrut) return;
        var d = new Date(sammelbrut);
        var u = new Date(d); u.setDate(u.getDate() + this.tageUmlarven);
        document.getElementById('zuchtUmlarvenE').value = u.toISOString().split('T')[0];
        var z = new Date(u); z.setDate(z.getDate() + this.tageZusetzen);
        document.getElementById('zuchtZusetzenE').value = z.toISOString().split('T')[0];
    },
    
    saveZucht() {
        var name = document.getElementById('zuchtNameE').value.trim();
        var sammelbrut = document.getElementById('zuchtSammelE').value;
        var notizen = document.getElementById('zuchtNotizenE').value.trim();
        if (!name || !sammelbrut) { alert('Bitte Namen und Datum eingeben!'); return; }
        var sTs = new Date(sammelbrut).getTime();
        var uTs = new Date(document.getElementById('zuchtUmlarvenE').value).getTime();
        var zTs = new Date(document.getElementById('zuchtZusetzenE').value).getTime();
        if (this.editId) {
            var plan = this.plaene.find(function(p){return p.id === zuchtplanMod.editId;});
            if (plan) { plan.name=name; plan.sammelbrut=sTs; plan.umlarven=uTs; plan.zusetzen=zTs; plan.notizen=notizen; plan.tageUmlarven=this.tageUmlarven; plan.tageZusetzen=this.tageZusetzen; }
        } else {
            this.plaene.push({id:'zucht_'+Date.now(), name:name, sammelbrut:sTs, umlarven:uTs, zusetzen:zTs, notizen:notizen, tageUmlarven:this.tageUmlarven, tageZusetzen:this.tageZusetzen, created:Date.now()});
        }
        this.speichern(); this.closeModal(); app.render(); app.toast('‚úì Zuchtplan gespeichert!','success');
    },
    
    deleteZucht(id) { if (!confirm('Zuchtplan l√∂schen?')) return; this.plaene = this.plaene.filter(function(p){return p.id !== id;}); this.speichern(); app.render(); },
    
    formatDatum(ts) { return new Date(ts).toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'}); },
    
    getPhase(plan) {
        var j = Date.now();
        if (j >= plan.zusetzen) return 'Abgeschlossen';
        if (j >= plan.umlarven) return 'Nach Umlarven';
        if (j >= plan.sammelbrut) return 'Sammelbrut l√§uft';
        return 'Geplant';
    },
    
    getTageVerbleibend(d) { var t = Math.ceil((d - Date.now())/(1000*60*60*24)); if (t<0) return null; if (t===0) return 'Heute!'; if (t===1) return 'Morgen'; return 'In '+t+' Tagen'; }
};

// ============================================
// MODUL: BEHANDLUNGEN
// ============================================
const METHODEN = {
    'ameisensaeure60':{name:'Ameisens√§ure 60%',emoji:'üß™',farbe:'#ef4444'},
    'ameisensaeure85':{name:'Ameisens√§ure 85%',emoji:'üß™',farbe:'#dc2626'},
    'oxalsaeure':{name:'Oxals√§ure',emoji:'üíß',farbe:'#3b82f6'},
    'oxalstreifen':{name:'Oxals√§ure-Streifen',emoji:'üìã',farbe:'#60a5fa'},
    'milchsaeure':{name:'Milchs√§ure',emoji:'ü•õ',farbe:'#f59e0b'},
    'thymol':{name:'Thymol',emoji:'üåø',farbe:'#10b981'},
    'brutentnahme':{name:'Totale Brutentnahme',emoji:'üçØ',farbe:'#8b5cf6'},
    'andere':{name:'Andere Methode',emoji:'‚úèÔ∏è',farbe:'#7A6652'}
};

const behandlungMod = {
    behandlungen: [],
    selectedMethode: null,
    anzahl: 3,
    volkAuswahlTyp: 'einzeln',
    
    init() {
        // Daten kommen aus Supabase via startApp() - kein localStorage mehr
        this.behandlungen = [];
    },
    
    speichern() { /* nicht mehr n√∂tig - wird direkt nach Supabase gespeichert */ },
    
    openModal() {
        this.renderMethodenGrid();
        this.renderVolkSelectNew();
        document.getElementById('behandlungDatumNew').value = new Date().toISOString().split('T')[0];
        document.getElementById('behandlungModalNew').classList.add('active');
    },
    
    closeModal() {
        document.getElementById('behandlungModalNew').classList.remove('active');
        this.selectedMethode = null; this.anzahl = 3; this.volkAuswahlTyp = 'einzeln';
        document.getElementById('behandlungIntervallNew').value = 'keine';
        document.getElementById('behandlungNotizenNew').value = '';
        document.getElementById('behandlungMengeNew').value = '';
        document.getElementById('behandlungVerabreichungNew').value = '';
        document.getElementById('behandlungLieferantNew').value = '';
        document.getElementById('behandlungWartezeitNew').value = '';
        document.getElementById('behandlungBehandlerNew').value = '';
        document.getElementById('bestandsbuchDetails').removeAttribute('open');
        document.getElementById('anzahlGruppeNew').style.display = 'none';
        document.querySelectorAll('#methodenGridNew .methode-btn').forEach(function(b){b.classList.remove('selected');});
    },
    
    renderMethodenGrid() {
        var grid = document.getElementById('methodenGridNew');
        var html = '';
        Object.entries(METHODEN).forEach(function(entry) {
            html += '<button class="methode-btn" onclick="behandlungMod.selectMethode(\''+entry[0]+'\')"><div class="emoji">'+entry[1].emoji+'</div>'+entry[1].name+'</button>';
        });
        grid.innerHTML = html;
    },
    
    renderVolkSelectNew() {
        var select = document.getElementById('behandlungVolkNew');
        var html = '<option value="">-- Bitte w√§hlen --</option>';
        var data = app.data;
        var nachStandort = {};
        data.voelker.forEach(function(v) { if (!nachStandort[v.standortId]) nachStandort[v.standortId] = []; nachStandort[v.standortId].push(v); });
        Object.entries(nachStandort).forEach(function(entry) {
            var standort = data.standorte.find(function(s){return s.id === entry[0];});
            html += '<optgroup label="üìç '+(standort?standort.name:'Unbekannt')+'">';
            entry[1].forEach(function(v) { html += '<option value="'+v.id+'">üêù '+v.name+'</option>'; });
            html += '</optgroup>';
        });
        select.innerHTML = html;
    },
    
    selectMethode(m) {
        this.selectedMethode = m;
        document.querySelectorAll('#methodenGridNew .methode-btn').forEach(function(b){b.classList.remove('selected');});
        event.target.closest('.methode-btn').classList.add('selected');
        document.getElementById('andereMethodeGruppeNew').style.display = m === 'andere' ? 'block' : 'none';
    },
    
    updateVolkAuswahl(typ) {
        this.volkAuswahlTyp = typ;
        document.getElementById('einzelVolkGruppeNew').style.display = typ === 'einzeln' ? 'block' : 'none';
        document.getElementById('standortGruppeNew').style.display = typ === 'standort' ? 'block' : 'none';
        if (typ === 'standort') {
            var select = document.getElementById('behandlungStandortNew');
            select.innerHTML = '<option value="">-- Bitte w√§hlen --</option>';
            app.data.standorte.forEach(function(s) {
                var anzahl = app.data.voelker.filter(function(v){return v.standortId===s.id;}).length;
                select.innerHTML += '<option value="'+s.id+'">üìç '+s.name+' ('+anzahl+' V√∂lker)</option>';
            });
        }
    },
    
    updateStandortInfo() {
        var sid = document.getElementById('behandlungStandortNew').value;
        var info = document.getElementById('standortVolkInfo');
        if (!sid) { info.innerHTML = ''; return; }
        var voelker = app.data.voelker.filter(function(v){return v.standortId===sid;});
        if (voelker.length === 0) { info.innerHTML = '‚ö†Ô∏è Keine V√∂lker an diesem Standort'; return; }
        info.innerHTML = '‚úì <strong>'+voelker.length+' V√∂lker</strong> werden behandelt: ' + voelker.map(function(v){return v.name;}).join(', ');
    },
    
    updateWiederholung() {
        var v = document.getElementById('behandlungIntervallNew').value;
        document.getElementById('anzahlGruppeNew').style.display = v !== 'keine' ? 'block' : 'none';
    },
    
    changeAnzahl(d) { this.anzahl = Math.max(1, Math.min(10, this.anzahl + d)); document.getElementById('anzahlWiederholungenNew').textContent = this.anzahl; },
    
    async saveBehandlung() {
        var datum = document.getElementById('behandlungDatumNew').value;
        var intervall = document.getElementById('behandlungIntervallNew').value;
        var notizen = document.getElementById('behandlungNotizenNew').value.trim();
        var menge = document.getElementById('behandlungMengeNew').value.trim();
        var verabreichung = document.getElementById('behandlungVerabreichungNew').value.trim();
        var lieferant = document.getElementById('behandlungLieferantNew').value.trim();
        var wartezeit = document.getElementById('behandlungWartezeitNew').value.trim();
        var behandler = document.getElementById('behandlungBehandlerNew').value.trim();
        if (!this.selectedMethode || !datum) { alert('Bitte Methode und Datum!'); return; }
        var voelkerIds = []; var voelkerLabel = ''; var standortId = null;
        if (this.volkAuswahlTyp === 'alle') { voelkerIds = app.data.voelker.map(function(v){return v.id;}); voelkerLabel = 'Alle V√∂lker ('+voelkerIds.length+')'; }
        else if (this.volkAuswahlTyp === 'standort') { var sid = document.getElementById('behandlungStandortNew').value; if(!sid){alert('Bitte Standort w√§hlen!');return;} standortId = sid; var sv=app.data.voelker.filter(function(v){return v.standortId===sid;}); if(sv.length===0){alert('Keine V√∂lker an diesem Standort!');return;} voelkerIds=sv.map(function(v){return v.id;}); var sn=app.data.standorte.find(function(s){return s.id===sid;}); voelkerLabel='üìç '+(sn?sn.name:'Standort')+' ('+sv.length+' V√∂lker)'; }
        else { var vid = document.getElementById('behandlungVolkNew').value; if(!vid){alert('Bitte Volk w√§hlen!');return;} voelkerIds=[vid]; var volk=app.data.voelker.find(function(v){return v.id===vid;}); voelkerLabel=volk?volk.name:'Unbekannt'; if(volk) standortId=volk.standortId; }
        var methodeName = METHODEN[this.selectedMethode].name;
        if (this.selectedMethode==='andere') { var am=document.getElementById('andereMethodeNew').value.trim(); if(am) methodeName=am; }
        var dTs = new Date(datum).getTime();
        var termine = [dTs];
        if (intervall !== 'keine') {
            var tage = {woechentlich:7,'2wochen':14,'3wochen':21,monatlich:30}[intervall] || 7;
            for (var i=1;i<this.anzahl;i++) { var nd=new Date(datum); nd.setDate(nd.getDate()+tage*i); termine.push(nd.getTime()); }
        }
        var labels = {keine:'Einmalig',woechentlich:'W√∂chentlich','2wochen':'Alle 2 Wochen','3wochen':'Alle 3 Wochen',monatlich:'Monatlich'};
        // Save to Supabase
        await db.insert('behandlungen', {
            user_id: currentUser.id,
            voelker_ids: voelkerIds,
            voelker_label: voelkerLabel,
            methode: this.selectedMethode,
            methode_name: methodeName,
            datum: dTs,
            intervall: intervall,
            intervall_label: labels[intervall]||intervall,
            termine: termine,
            notizen: notizen,
            standort_id: standortId,
            menge: menge,
            verabreichung: verabreichung,
            lieferant: lieferant,
            wartezeit: wartezeit,
            behandler: behandler
        });
        // Reload from Supabase to get correct IDs
        var res = await sb.from('behandlungen').select('*').eq('user_id', currentUser.id);
        this.behandlungen = (res.data || []).map(function(r) {
            return { id: r.id, voelkerIds: r.voelker_ids, voelkerLabel: r.voelker_label, methode: r.methode, methodeName: r.methode_name, datum: r.datum, intervall: r.intervall, intervallLabel: r.intervall_label, termine: r.termine, notizen: r.notizen, standortId: r.standort_id||null, menge: r.menge||'', verabreichung: r.verabreichung||'', lieferant: r.lieferant||'', wartezeit: r.wartezeit||'', behandler: r.behandler||'', created: r.created_at };
        });
        this.closeModal(); app.render(); app.toast('‚úì Behandlung erfasst!','success');
    },
    
    async deleteBehandlung(id) {
        if (!confirm('Behandlung wirklich l√∂schen?')) return;
        await db.del('behandlungen', id);
        // Reload from Supabase
        var res = await sb.from('behandlungen').select('*').eq('user_id', currentUser.id);
        this.behandlungen = (res.data || []).map(function(r) {
            return { id: r.id, voelkerIds: r.voelker_ids, voelkerLabel: r.voelker_label, methode: r.methode, methodeName: r.methode_name, datum: r.datum, intervall: r.intervall, intervallLabel: r.intervall_label, termine: r.termine, notizen: r.notizen, standortId: r.standort_id||null, menge: r.menge||'', verabreichung: r.verabreichung||'', lieferant: r.lieferant||'', wartezeit: r.wartezeit||'', behandler: r.behandler||'', created: r.created_at };
        });
        app.render();
    },
    
    formatDatum(ts) { return new Date(ts).toLocaleDateString('de-DE'); },
    
    getTerminStatus(termin) {
        var diff = termin - Date.now();
        var tage = Math.ceil(diff/(1000*60*60*24));
        if (tage < 0) return {status:'completed',label:'Erledigt'};
        if (tage === 0) return {status:'active',label:'Heute!'};
        if (tage === 1) return {status:'upcoming',label:'Morgen'};
        return {status:'upcoming',label:'In '+tage+' Tagen'};
    }
};


packlisteMod.init();
trachtkalenderMod.init();
zuchtplanMod.init();
behandlungMod.init();


// ============================================
// APP STARTUP - Check auth state
// ============================================
(async function() {
    // Check if this is a password recovery link
    var hash = window.location.hash;
    if (hash && hash.includes('type=recovery')) {
        // Supabase wird den Token automatisch verarbeiten
        // onAuthStateChange feuert PASSWORD_RECOVERY
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('authScreen').style.display = 'block';
        document.querySelector('.nav').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';
        showAuthTab('reset');
        return;
    }
    
    // Check if user is already logged in
    var session = await sb.auth.getSession();
    if (session.data.session) {
        currentUser = session.data.session.user;
        await startApp();
    } else {
        // Show auth screen
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('authScreen').style.display = 'block';
        document.querySelector('.nav').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';
    }
    
    // Listen for auth changes
    sb.auth.onAuthStateChange(function(event, session) {
        if (event === 'PASSWORD_RECOVERY') {
            // User hat auf den Reset-Link geklickt
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('authScreen').style.display = 'block';
            document.querySelector('.nav').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            showAuthTab('reset');
        }
        if (event === 'SIGNED_OUT') {
            currentUser = null;
            document.getElementById('authScreen').style.display = 'block';
            document.querySelector('.nav').style.display = 'none';
            document.getElementById('app').innerHTML = '';
        }
    });
})();

</script>
</body>
</html>
