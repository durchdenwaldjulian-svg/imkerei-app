<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imkerei Tagesplaner</title>
    <meta name="theme-color" content="#F5A623">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        /* === INDEX.HTML SPECIFIC STYLES === */
        body{padding-left:220px;padding-bottom:2rem}
        
        .container{max-width:800px;margin:0 auto;padding:1rem}
        
        /* === NAV (index-specific: sidebar layout) === */
        .nav{position:fixed;left:0;top:0;bottom:0;width:220px;background:#FFFBF0;border-right:2px solid rgba(245,166,35,0.12);display:flex;flex-direction:column;padding:0;z-index:50;overflow-y:auto}
        .nav-brand{padding:1.25rem 1rem;border-bottom:2px solid rgba(245,166,35,0.12)}
        .nav-section{font-size:.65rem;font-weight:700;color:#A69580;text-transform:uppercase;letter-spacing:.08em;padding:.75rem 1rem .25rem}
        .nav-item{display:block;padding:.625rem 1rem;text-align:left;cursor:pointer;border:none;background:none;color:#7A6652;font-size:.85rem;border-left:4px solid transparent;transition:all .15s;width:100%;text-decoration:none}
        .nav-item:hover{background:rgba(245,166,35,0.06)}
        .nav-item.active{color:#92400E;font-weight:600;border-left-color:#F5A623;background:#FFF8EE}
        .footer{position:fixed;left:220px;bottom:0;right:0;background:#FFFBF0;border-top:1px solid rgba(245,166,35,0.12);padding:.4rem;text-align:center;font-size:.7rem;color:#7A6652;z-index:40}
        
        /* Timeline f√ºr Zuchtplan */
        .timeline{position:relative;padding-left:2rem}
        .timeline-item{position:relative;padding-bottom:1.5rem;border-left:2px solid #E8DFD4}
        .timeline-item:last-child{border-left:none}
        .timeline-dot{position:absolute;left:-7px;top:0;width:12px;height:12px;border-radius:50%;background:#F5A623;border:2px solid #fff;box-shadow:0 0 0 2px #E8DFD4}
        .timeline-content{margin-left:1rem;background:#FFF8EE;padding:.75rem;border-radius:.5rem}
        
        /* Tracht Items */
        /* .tracht-item ‚Üí tracht.html */
        
        /* V√∂lker Grid */
        .volk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.75rem}
        .volk-card{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:.875rem;cursor:pointer;transition:all .2s}
        .volk-card:hover{border-color:#F5A623;transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,166,35,.2)}
        
        @media(max-width:768px){
            body{padding-left:0;padding-bottom:64px}
            .nav{display:none}
            .footer{display:none}
            .modal-content{max-width:100%;border-radius:1rem 1rem 0 0}
            .option-grid{grid-template-columns:repeat(3,1fr)}
            .volk-grid{grid-template-columns:1fr}
            .mobile-nav{display:flex}
            .mobile-menu-overlay{display:none}
            .mobile-menu-overlay.active{display:flex}
        }

        /* === MOBILE NAV BAR === */
        .mobile-nav{
            display:none;
            position:fixed;left:0;right:0;bottom:0;z-index:200;
            background:#FFFBF0;border-top:2px solid rgba(245,166,35,0.12);
            flex-direction:row;align-items:stretch;height:62px;
            box-shadow:0 -2px 8px rgba(28,20,16,0.06);
        }
        .mobile-nav-btn{
            flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
            border:none;background:none;cursor:pointer;color:#7A6652;
            font-size:.65rem;font-weight:500;gap:2px;padding:.25rem 0;
            border-top:3px solid transparent;transition:all .15s;
        }
        .mobile-nav-btn .mn-icon{font-size:1.3rem;line-height:1}
        .mobile-nav-btn.active{color:#92400E;font-weight:700;border-top-color:#F5A623;background:#FFF8EE}
        .mobile-nav-btn:active{background:rgba(245,166,35,0.1)}

        /* === MOBILE FULLSCREEN MENU === */
        .mobile-menu-overlay{
            display:none;position:fixed;inset:0;z-index:300;
            background:rgba(28,20,16,0.5);
            flex-direction:column;align-items:center;justify-content:center;
        }
        .mobile-menu-box{
            background:#FFFBF0;border-radius:1.25rem;width:92%;max-width:400px;
            max-height:85vh;overflow-y:auto;padding:1.25rem;
            box-shadow:0 12px 40px rgba(28,20,16,0.25);
            animation:menuSlideUp .25s ease;
        }
        @keyframes menuSlideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
        .mobile-menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:2px solid rgba(245,166,35,0.15)}
        .mobile-menu-header h2{font-size:1.15rem;color:#1C1410;margin:0;display:flex;align-items:center;gap:.5rem}
        .mobile-menu-close{width:36px;height:36px;border:none;background:#f5f0eb;border-radius:.5rem;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#7A6652}
        .mobile-menu-close:active{background:#E8DFD4}
        .mobile-menu-section{font-size:.7rem;font-weight:700;color:#A69580;text-transform:uppercase;letter-spacing:.08em;margin:1rem 0 .5rem;padding-left:.25rem}
        .mobile-menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
        .mobile-menu-item{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            padding:.75rem .5rem;border:2px solid #E8DFD4;border-radius:.75rem;
            background:#fff;cursor:pointer;text-decoration:none;color:#1C1410;
            font-size:.78rem;font-weight:500;gap:.3rem;transition:all .15s;min-height:70px;
        }
        .mobile-menu-item:active{border-color:#F5A623;background:#FFF8EE;transform:scale(0.96)}
        .mobile-menu-item.mm-active{border-color:#F5A623;background:#FFF8EE;font-weight:700;color:#92400E}
        .mobile-menu-item .mm-icon{font-size:1.5rem}
        .mobile-menu-item.mm-danger{color:#ef4444;border-color:#fee2e2}
        .mobile-menu-item.mm-danger:active{background:#fef2f2}

        /* === PACKLISTE MODULE STYLES === */
        .pack-kategorie{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:1rem;margin-bottom:1rem}
        .pack-item-row{display:flex;justify-content:space-between;align-items:center;padding:.625rem;border-bottom:1px solid #FFFBF0;gap:.75rem}
        .pack-item-row:hover{background:#FFF8EE}
        .pack-item-row:last-child{border-bottom:none}
        .pack-item-main{display:flex;align-items:center;flex:1;min-width:0}
        .pack-item-controls{display:flex;align-items:center;gap:.5rem;flex-shrink:0}
        .pack-checkbox{width:1.25rem;height:1.25rem;margin-right:.875rem;cursor:pointer;accent-color:#F5A623;flex-shrink:0}
        .pack-label{flex:1;font-size:.95rem;color:#1C1410;user-select:none;cursor:pointer;min-width:0;word-break:break-word}
        .pack-label.checked{text-decoration:line-through;color:#A69580}
        .pack-label strong{color:#F5A623;font-weight:700}
        .menge-counter{display:flex;align-items:center;gap:.25rem;background:#FFF8EE;border-radius:.5rem;padding:.25rem}
        .menge-btn{width:1.75rem;height:1.75rem;border:1px solid #d1d5db;border-radius:.375rem;background:#fff;cursor:pointer;font-size:1rem;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:all .15s;color:#7A6652}
        .menge-btn:hover{background:#F5A623;border-color:#F5A623;color:#1C1410;transform:scale(1.1)}
        .menge-btn:active{transform:scale(.95)}
        .menge-value{min-width:1.5rem;text-align:center;font-weight:600;font-size:.9rem;color:#1C1410}
        .btn-del{background:none;border:none;cursor:pointer;font-size:1.25rem;padding:.25rem .5rem;opacity:.4;transition:all .2s}
        .btn-del:hover{opacity:1;transform:scale(1.2)}
        .stats{display:flex;gap:1rem;margin-bottom:1.5rem}
        .stat-card{flex:1;background:#FFF8EE;padding:1rem;border-radius:.5rem;text-align:center}
        .stat-number{font-size:1.75rem;font-weight:bold;color:#F5A623}
        .stat-label{font-size:.75rem;color:#7A6652;margin-top:.25rem;text-transform:uppercase;letter-spacing:.05em}
        .schnell-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.75rem;margin-bottom:1.5rem}
        .schnell-btn{background:linear-gradient(135deg,#F5A623,#FFBE45);border:none;border-radius:.75rem;padding:1rem;cursor:pointer;transition:all .2s;box-shadow:0 2px 4px rgba(28,20,16,0.08)}
        .schnell-btn:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 6px 12px rgba(245,166,35,.3)}
        .schnell-btn:active{transform:translateY(-1px)}
        .schnell-btn.schnell-equipment{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
        .schnell-btn.schnell-equipment:hover{box-shadow:0 6px 12px rgba(59,130,246,.3)}
        .schnell-icon{font-size:2.5rem;margin-bottom:.5rem}
        .schnell-label{font-weight:600;font-size:.9rem;color:#1C1410}
        .schnell-btn.schnell-equipment .schnell-label{color:#fff}
        
        /* === TRACHTKALENDER MODULE STYLES === */
        /* Tracht-Timeline CSS ‚Üí tracht.html */
        .ausgeblendet-chip:hover{opacity:1;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .chip-close{font-size:1rem;font-weight:bold;color:#10b981}
        
        /* === ZUCHTPLAN MODULE STYLES === */
        .zucht-card{background:#fff;border:2px solid #E8DFD4;border-radius:.75rem;padding:1.25rem;margin-bottom:1rem;transition:all .2s}
        .zucht-card:hover{border-color:#F5A623;transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,166,35,.2)}
        .zucht-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:1rem}
        .zucht-title{font-size:1.25rem;font-weight:bold;color:#1C1410}
        .timeline-dot.completed{background:#10b981;box-shadow:0 0 0 2px #10b981}
        .timeline-dot.active{background:#F5A623;box-shadow:0 0 0 2px #F5A623;animation:pulse 2s infinite}
        .timeline-dot.upcoming{background:#E8DFD4}
        .timeline-title{font-weight:bold;font-size:1rem;color:#1C1410;margin-bottom:.5rem}
        .timeline-date{font-size:.9rem;color:#7A6652;margin-bottom:.25rem}
        .timeline-note{font-size:.85rem;color:#5C4A38;margin-top:.5rem;padding-top:.5rem;border-top:1px solid #E8DFD4}
        .tage-counter{display:flex;align-items:center;gap:.75rem;background:#FFF8EE;padding:.75rem;border-radius:.5rem;margin-top:.5rem}
        .counter-label{font-size:.85rem;color:#7A6652}
        .badge-active{background:#10b981;color:#fff}
        .badge-upcoming{background:#f59e0b;color:#fff}
        .badge-completed{background:#7A6652;color:#fff}
        .badge-repeat{background:#dbeafe;color:#1e40af}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        /* === BEHANDLUNG MODULE STYLES === */
        /* Behandlung-CSS ‚Üí behandlung.html */
        
        .dauer-btns{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin:.75rem 0}

    
        /* Auth Styles */
        .auth-container{max-width:400px;margin:10vh auto;padding:2rem}
        .auth-card{background:#fff;border-radius:1.25rem;padding:2rem;box-shadow:0 4px 24px rgba(28,20,16,0.1);border:1px solid rgba(245,166,35,0.12)}
        .auth-title{text-align:center;font-size:2.5rem;margin-bottom:.5rem}
        .auth-subtitle{text-align:center;color:#7A6652;margin-bottom:2rem;font-size:.9rem}
        .auth-tabs{display:flex;gap:0;margin-bottom:1.5rem;border:2px solid rgba(245,166,35,0.2);border-radius:.75rem;overflow:hidden}
        .auth-tab{flex:1;padding:.75rem;text-align:center;cursor:pointer;font-weight:600;font-size:.9rem;border:none;background:#FFF8EE;color:#7A6652;transition:all .15s}
        .auth-tab.active{background:#F5A623;color:#1C1410}
        .auth-divider{text-align:center;color:#A69580;font-size:.8rem;margin:1rem 0;position:relative}
        .auth-divider::before,.auth-divider::after{content:'';position:absolute;top:50%;width:35%;height:1px;background:#E8DFD4}
        .auth-divider::before{left:0}
        .auth-divider::after{right:0}
        .loading-overlay{position:fixed;inset:0;background:rgba(255,251,240,.95);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column}
        .spinner{width:50px;height:50px;border:4px solid rgba(245,166,35,0.2);border-top-color:#F5A623;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .save-indicator{position:fixed;top:.75rem;right:.75rem;background:#10b981;color:#fff;padding:.35rem .75rem;border-radius:.5rem;font-size:.75rem;font-weight:600;opacity:0;transition:opacity .3s;z-index:60}
        .save-indicator.show{opacity:1}
    </style>
</head>
<body>
<div id="toast" class="toast"></div>
<div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div><div style="margin-top:1rem;color:#7A6652;font-weight:600">Laden...</div></div>
<div id="saveIndicator" class="save-indicator">üíæ Gespeichert</div>
<div id="app"></div>
<div class="footer">Imkerei Durchdenwald üêù ¬∑ v6.0 Cloud</div>

<!-- Auth Screen (shown when not logged in) -->
<div id="authScreen" style="display:none">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-title">üêù</div>
            <div style="text-align:center;font-size:1.25rem;font-weight:bold;color:#1C1410;margin-bottom:.25rem">Imkerei Tagesplaner</div>
            <div class="auth-subtitle">Melde dich an oder erstelle einen Account</div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Anmelden</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Registrieren</button>
            </div>
            
            <!-- Login -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" id="loginEmail" class="input" placeholder="deine@email.de">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" id="loginPassword" class="input" placeholder="Dein Passwort">
                </div>
                <button class="btn btn-primary btn-block" onclick="doLogin()">Anmelden</button>
                <div style="text-align:center;margin-top:1rem">
                    <a href="#" onclick="showAuthTab('forgot');return false" style="font-size:.85rem;color:#3b82f6">Passwort vergessen?</a>
                </div>
            </div>
            
            <!-- Register -->
            <div id="registerForm" style="display:none">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="regName" class="input" placeholder="Max Mustermann">
                </div>
                <div class="form-group">
                    <label class="form-label">Imkerei (optional)</label>
                    <input type="text" id="regImkerei" class="input" placeholder="Imkerei Durchdenwald">
                </div>
                <div class="form-group">
                    <label class="form-label">E-Mail *</label>
                    <input type="email" id="regEmail" class="input" placeholder="deine@email.de">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort * (min. 6 Zeichen)</label>
                    <input type="password" id="regPassword" class="input" placeholder="Sicheres Passwort">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort wiederholen *</label>
                    <input type="password" id="regPassword2" class="input" placeholder="Passwort best√§tigen">
                </div>
                <button class="btn btn-primary btn-block" onclick="doRegister()">Account erstellen</button>
            </div>
            
            <!-- Passwort vergessen -->
            <div id="forgotForm" style="display:none">
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" id="forgotEmail" class="input" placeholder="deine@email.de">
                </div>
                <button class="btn btn-primary btn-block" onclick="doForgotPassword()">Passwort-Reset senden</button>
                <div style="text-align:center;margin-top:1rem">
                    <a href="#" onclick="showAuthTab('login');return false" style="font-size:.85rem;color:#3b82f6">‚Üê Zur√ºck zum Login</a>
                </div>
            </div>
            
            <!-- Neues Passwort setzen (nach Reset-Link) -->
            <div id="resetForm" style="display:none">
                <div style="text-align:center;margin-bottom:1rem">
                    <div style="font-size:2rem;margin-bottom:.5rem">üîë</div>
                    <h3>Neues Passwort setzen</h3>
                </div>
                <div class="form-group">
                    <label class="form-label">Neues Passwort (min. 6 Zeichen)</label>
                    <input type="password" id="resetNewPassword" class="input" placeholder="Neues Passwort">
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort wiederholen</label>
                    <input type="password" id="resetNewPassword2" class="input" placeholder="Passwort best√§tigen">
                </div>
                <button class="btn btn-primary btn-block" onclick="doSetNewPassword()">Passwort speichern</button>
            </div>
            
            <div id="authError" style="display:none;margin-top:1rem;padding:.75rem;background:#fee2e2;border:1px solid #fca5a5;border-radius:.5rem;color:#991b1b;font-size:.85rem;text-align:center"></div>
        </div>
    </div>
</div>

<!-- Standort Modal -->
<div id="standortModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="standortModalTitle">üìç Neuer Standort</h2>
            <button class="close-btn" onclick="app.closeModal('standortModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Name des Standorts *</label>
                <input type="text" id="standortName" class="input" placeholder="z.B. Heimstand Garten">
            </div>
            <div class="form-group">
                <label class="form-label">Anzahl V√∂lker</label>
                <div class="counter">
                    <button class="counter-btn" onclick="app.changeVoelkerCount(-1)">‚àí</button>
                    <div class="counter-value" id="standortVoelkerCount">2</div>
                    <button class="counter-btn" onclick="app.changeVoelkerCount(1)">+</button>
                </div>
                <div class="info-box">Die V√∂lker werden automatisch erstellt</div>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen (optional)</label>
                <textarea id="standortNotizen" class="input" placeholder="z.B. S√ºdseite, gesch√ºtzter Bereich"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">üìç Position auf Karte w√§hlen</label>
                <div id="standortMapPicker" style="height:250px;border-radius:.75rem;border:2px solid #E8DFD4;margin-bottom:.5rem;position:relative;z-index:1"></div>
                <input type="hidden" id="standortLat" value="">
                <input type="hidden" id="standortLng" value="">
                <div id="standortKoordStatus" style="font-size:.8rem;color:#7A6652"></div>
                <div class="info-box">üí° Klicke auf die Karte um den Standort zu setzen. Du kannst zoomen und die Karte verschieben.</div>
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveStandort()">Standort speichern</button>
        </div>
    </div>
</div>

<!-- Volk Modal -->
<div id="volkModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="volkModalTitle">üêù Volk Details</h2>
            <button class="close-btn" onclick="app.closeModal('volkModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Name des Volkes *</label>
                <input type="text" id="volkName" class="input" placeholder="z.B. Volk 1">
            </div>
            <div class="form-group">
                <label class="form-label">Beutensystem</label>
                <select id="volkBeute" class="input">
                    <option value="Dadant">Dadant</option>
                    <option value="Zander">Zander</option>
                    <option value="Deutsch Normal">Deutsch Normal</option>
                    <option value="Langstroth">Langstroth</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <div class="option-grid" style="grid-template-columns:repeat(2,1fr)">
                    <button class="option-btn selected" onclick="app.setVolkStatus('ok')">‚úÖ Gut</button>
                    <button class="option-btn" onclick="app.setVolkStatus('schwach')">‚ö†Ô∏è Schwach</button>
                    <button class="option-btn" onclick="app.setVolkStatus('weisellos')">üëë Weisellos</button>
                    <button class="option-btn" onclick="app.setVolkStatus('problem')">‚ùå Problem</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notizen</label>
                <textarea id="volkNotizen" class="input" placeholder="Besonderheiten..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">üçØ Honigernte</label>
                <div id="volkHonigInfo" style="padding:.5rem .75rem;background:#FFF8EE;border-radius:.5rem;font-size:.9rem;color:#7A6652">Lade...</div>
                <div style="font-size:.75rem;color:#94a3b8;margin-top:.25rem">Ertr√§ge werden √ºber <a href="ernte.html" style="color:#F5A623">üçØ Honigernte</a> erfasst</div>
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveVolk()">Volk speichern</button>
            <button class="btn btn-danger btn-block" style="margin-top:.5rem" onclick="app.deleteVolk()">üóëÔ∏è Volk l√∂schen</button>
        </div>
    </div>
</div>

<!-- Aufgabe Modal -->
<div id="aufgabeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="aufgabeModalTitle">‚úì Neue Aufgabe</h2>
            <button class="close-btn" onclick="app.closeModal('aufgabeModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Aufgaben-Typ w√§hlen</label>
                <div class="option-grid" id="aufgabeTypGrid"></div>
            </div>
            <div class="form-group" id="aufgabeStandortWrap" style="display:none">
                <label class="form-label">üìç Standort</label>
                <select id="aufgabeStandort" class="input">
                    <option value="">-- Alle Standorte --</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">F√§lligkeit</label>
                <input type="date" id="aufgabeDatum" class="input">
            </div>
            <div class="form-group" id="aufgabeIntervallWrap" style="display:none">
                <label class="form-label">üîÅ Wiederholung</label>
                <div style="display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.5rem">
                    <button type="button" class="option-btn" onclick="app.setIntervall(0)">Einmalig</button>
                    <button type="button" class="option-btn" onclick="app.setIntervall(7)">W√∂chentlich</button>
                    <button type="button" class="option-btn" onclick="app.setIntervall(14)">Alle 2 Wochen</button>
                    <button type="button" class="option-btn" onclick="app.setIntervall(-1)">Eigene</button>
                </div>
                <div id="aufgabeIntervallCustom" style="display:none">
                    <div style="display:flex;align-items:center;gap:.5rem">
                        <span style="font-size:.85rem">Alle</span>
                        <input type="number" id="aufgabeIntervallTage" class="input" style="width:80px" min="1" value="7">
                        <span style="font-size:.85rem">Tage</span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Dauer (Minuten)</label>
                <div class="dauer-btns">
                    <button class="option-btn" onclick="app.setDauer(15)">15 Min</button>
                    <button class="option-btn" onclick="app.setDauer(30)">30 Min</button>
                    <button class="option-btn" onclick="app.setDauer(60)">1 Std</button>
                    <button class="option-btn selected" onclick="app.setDauer(120)">2 Std</button>
                </div>
                <input type="number" id="aufgabeDauer" class="input" value="120" min="5" step="5">
            </div>
            <div class="form-group">
                <label class="form-label">Priorit√§t</label>
                <div class="priority-btns">
                    <button class="priority-btn" onclick="app.setPrio('low')">üü¢ Niedrig</button>
                    <button class="priority-btn selected medium" onclick="app.setPrio('medium')">üü° Mittel</button>
                    <button class="priority-btn" onclick="app.setPrio('high')">üî¥ Hoch</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notiz (optional)</label>
                <input type="text" id="aufgabeNotiz" class="input" placeholder="Zus√§tzliche Hinweise...">
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveAufgabe()">Aufgabe speichern</button>
        </div>
    </div>
</div>

<!-- Kosten Modal -->
<div id="kostenModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üí∞ Neue Ausgabe</h2>
            <button class="close-btn" onclick="app.closeModal('kostenModal')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Kategorie w√§hlen</label>
                <div class="option-grid" id="kostenKatGrid"></div>
            </div>
            <div class="form-group">
                <label class="form-label">H√§ufige Ausgaben</label>
                <div class="option-grid" id="kostenVorlagenGrid"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Beschreibung</label>
                <input type="text" id="kostenBeschreibung" class="input" placeholder="z.B. Benzin f√ºr Standortfahrt">
            </div>
            <div class="form-group">
                <label class="form-label">Betrag (‚Ç¨)</label>
                <input type="number" id="kostenBetrag" class="input" placeholder="0.00" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="date" id="kostenDatum" class="input">
            </div>
            <button class="btn btn-primary btn-block" onclick="app.saveKosten()">Ausgabe speichern</button>
        </div>
    </div>
</div>


<!-- Tracht Modal -->
<!-- Tracht-Modal ‚Üí tracht.html -->

<!-- Behandlung Modal -->
<!-- Behandlung-Modal ‚Üí behandlung.html -->

<nav class="nav">
    <div class="nav-brand">
        <div style="font-size:1.5rem;font-weight:bold;color:#F5A623">üêù</div>
        <div style="font-size:.85rem;font-weight:600;color:#1C1410;margin-top:.25rem">Imkerei</div>
        <div style="font-size:.7rem;color:#7A6652">Cloud v6.0</div>
    </div>
    <div class="nav-section">√úbersicht</div>
    <a href="index.html#heute" class="nav-item active">üìÖ Heute</a>
    <a href="index.html#standorte" class="nav-item">üìç Standorte</a>
    <a href="index.html#aufgaben" class="nav-item">üìù Aufgaben</a>
    <div class="nav-section">V√∂lker</div>
    <a href="zuchtplan.html" class="nav-item">üëë K√∂niginnenzucht</a>
    <a href="index.html#behandlung" class="nav-item">üíâ Behandlungen</a>
    <a href="bewertung.html" class="nav-item">‚≠ê V√∂lker-Bewertung</a>
    <a href="assistent.html" class="nav-item">ü§ñ Assistent</a>
    <a href="bestandsbuch.html" class="nav-item">üìã Bestandsbuch</a>
    <div class="nav-section">Ernte & Planung</div>
    <a href="ernte.html" class="nav-item">üçØ Honigernte</a>
    <a href="index.html#tracht" class="nav-item">üå∏ Tracht</a>
    <a href="index.html#packliste" class="nav-item">üì¶ Packliste</a>
    <div class="nav-section">Community</div>
    <a href="forum.html" class="nav-item">üí¨ Forum</a>
    <div class="nav-section">Verwaltung</div>
    <a href="index.html#kosten" class="nav-item">üí∞ Kosten</a>
    <div style="flex:1"></div>
    <div class="nav-section">Rechtliches</div>
    <a href="impressum.html" class="nav-item" style="text-decoration:none;font-size:.75rem;padding:.4rem 1rem;color:#A69580">Impressum</a>
    <a href="datenschutz.html" class="nav-item" style="text-decoration:none;font-size:.75rem;padding:.4rem 1rem;color:#A69580">Datenschutz</a>
    <a href="agb.html" class="nav-item" style="text-decoration:none;font-size:.75rem;padding:.4rem 1rem;color:#A69580">AGB</a>
    <a href="index.html#einstellungen" class="nav-item">‚öôÔ∏è Einstellungen</a>
    <button class="nav-item" style="color:#ef4444" onclick="doLogout()">üö™ Abmelden</button>
</nav>

<!-- MOBILE NAV BAR -->
<div class="mobile-nav" id="mobileNav">
    <button class="mobile-nav-btn" onclick="mobileMenuOpen()"><span class="mn-icon">‚ò∞</span>Men√º</button>
    <button class="mobile-nav-btn active" data-mpage="heute"><span class="mn-icon">üìÖ</span>Heute</button>
    <button class="mobile-nav-btn" data-mpage="standorte"><span class="mn-icon">üìç</span>Standorte</button>
    <button class="mobile-nav-btn" data-mpage="aufgaben"><span class="mn-icon">üìù</span>Aufgaben</button>
    <button class="mobile-nav-btn" data-mpage="tracht"><span class="mn-icon">üå∏</span>Tracht</button>
    <button class="mobile-nav-btn" data-mpage="einstellungen"><span class="mn-icon">‚öôÔ∏è</span>Mehr</button>
</div>

<!-- MOBILE FULLSCREEN MENU -->
<div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="if(event.target===this)mobileMenuClose()">
    <div class="mobile-menu-box">
        <div class="mobile-menu-header">
            <h2>üêù Navigation</h2>
            <button class="mobile-menu-close" onclick="mobileMenuClose()">‚úï</button>
        </div>
        <div class="mobile-menu-section">√úbersicht</div>
        <div class="mobile-menu-grid">
            <button class="mobile-menu-item" data-mmpage="heute"><span class="mm-icon">üìÖ</span>Heute</button>
            <button class="mobile-menu-item" data-mmpage="standorte"><span class="mm-icon">üìç</span>Standorte</button>
            <button class="mobile-menu-item" data-mmpage="aufgaben"><span class="mm-icon">üìù</span>Aufgaben</button>
        </div>
        <div class="mobile-menu-section">V√∂lker</div>
        <div class="mobile-menu-grid">
            <a href="zuchtplan.html" class="mobile-menu-item"><span class="mm-icon">üëë</span>Zucht</a>
            <button class="mobile-menu-item" data-mmpage="behandlung"><span class="mm-icon">üíâ</span>Behandlung</button>
            <a href="bewertung.html" class="mobile-menu-item"><span class="mm-icon">‚≠ê</span>Bewertung</a>
        </div>
        <div class="mobile-menu-section">Tools</div>
        <div class="mobile-menu-grid">
            <a href="assistent.html" class="mobile-menu-item"><span class="mm-icon">ü§ñ</span>Assistent</a>
            <a href="bestandsbuch.html" class="mobile-menu-item"><span class="mm-icon">üìã</span>Bestandsbuch</a>
            <a href="ernte.html" class="mobile-menu-item"><span class="mm-icon">üçØ</span>Ernte</a>
        </div>
        <div class="mobile-menu-section">Ernte & Planung</div>
        <div class="mobile-menu-grid">
            <button class="mobile-menu-item" data-mmpage="tracht"><span class="mm-icon">üå∏</span>Tracht</button>
            <button class="mobile-menu-item" data-mmpage="packliste"><span class="mm-icon">üì¶</span>Packliste</button>
            <button class="mobile-menu-item" data-mmpage="kosten"><span class="mm-icon">üí∞</span>Kosten</button>
        </div>
        <div class="mobile-menu-section">Community</div>
        <div class="mobile-menu-grid">
            <a href="forum.html" class="mobile-menu-item"><span class="mm-icon">üí¨</span>Forum</a>
        </div>
        <div class="mobile-menu-section">Verwaltung</div>
        <div class="mobile-menu-grid">
            <button class="mobile-menu-item" data-mmpage="einstellungen"><span class="mm-icon">‚öôÔ∏è</span>Einstellungen</button>
            <button class="mobile-menu-item mm-danger" onclick="mobileMenuClose();doLogout()"><span class="mm-icon">üö™</span>Abmelden</button>
        </div>
        <div class="mobile-menu-section">Rechtliches</div>
        <div class="mobile-menu-grid">
            <a href="impressum.html" class="mobile-menu-item" style="font-size:.7rem"><span class="mm-icon">üìÑ</span>Impressum</a>
            <a href="datenschutz.html" class="mobile-menu-item" style="font-size:.7rem"><span class="mm-icon">üîí</span>Datenschutz</a>
            <a href="agb.html" class="mobile-menu-item" style="font-size:.7rem"><span class="mm-icon">üìã</span>AGB</a>
        </div>
    </div>
</div>

<script src="config.js"></script>
<script>
// Hash fr√ºh speichern bevor Supabase Auth ihn entfernt
var _startPageHash = window.location.hash ? window.location.hash.replace('#','') : null;

// ============================================
// AUTH FUNCTIONS (index.html specific)
// ============================================
function showAuthTab(tab) {
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
    document.getElementById('forgotForm').style.display = tab === 'forgot' ? 'block' : 'none';
    document.getElementById('resetForm').style.display = tab === 'reset' ? 'block' : 'none';
    document.getElementById('authError').style.display = 'none';
    document.querySelectorAll('.auth-tab').forEach(function(t,i) {
        t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='register'&&i===1));
    });
}

function showAuthError(msg) {
    var el = document.getElementById('authError');
    el.textContent = msg; el.style.display = 'block';
}

async function doSetNewPassword() {
    var pw1 = document.getElementById('resetNewPassword').value;
    var pw2 = document.getElementById('resetNewPassword2').value;
    if (!pw1 || pw1.length < 6) { showAuthError('Passwort muss mindestens 6 Zeichen haben'); return; }
    if (pw1 !== pw2) { showAuthError('Passw√∂rter stimmen nicht √ºberein'); return; }
    var result = await sb.auth.updateUser({password: pw1});
    if (result.error) { showAuthError(result.error.message); return; }
    showAuthError('');
    document.getElementById('authError').style.display = 'block';
    document.getElementById('authError').style.background = '#d1fae5';
    document.getElementById('authError').style.borderColor = '#6ee7b7';
    document.getElementById('authError').style.color = '#065f46';
    document.getElementById('authError').textContent = '‚úÖ Passwort erfolgreich ge√§ndert! Du wirst eingeloggt...';
    setTimeout(async function(){
        currentUser = result.data.user;
        await startApp();
    }, 1500);
}

async function doLogin() {
    var email = document.getElementById('loginEmail').value.trim();
    var pw = document.getElementById('loginPassword').value;
    if (!email || !pw) { showAuthError('Bitte E-Mail und Passwort eingeben'); return; }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    var result = await sb.auth.signInWithPassword({ email: email, password: pw });
    if (result.error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        showAuthError(result.error.message === 'Invalid login credentials' ? 'Falsche E-Mail oder Passwort' : result.error.message);
        return;
    }
    currentUser = result.data.user;
    // Last login speichern
    sb.from('profiles').update({last_login: new Date().toISOString()}).eq('user_id', currentUser.id);
    // Alte localStorage Trachten aufr√§umen
    localStorage.removeItem('imkerei_trachten');
    await startApp();
}

async function doRegister() {
    var name = document.getElementById('regName').value.trim();
    var imkerei = document.getElementById('regImkerei').value.trim();
    var email = document.getElementById('regEmail').value.trim();
    var pw = document.getElementById('regPassword').value;
    var pw2 = document.getElementById('regPassword2').value;
    
    if (!name) { showAuthError('Bitte Namen eingeben'); return; }
    if (!email) { showAuthError('Bitte E-Mail eingeben'); return; }
    if (pw.length < 6) { showAuthError('Passwort muss min. 6 Zeichen haben'); return; }
    if (pw !== pw2) { showAuthError('Passw√∂rter stimmen nicht √ºberein'); return; }
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    var result = await sb.auth.signUp({ email: email, password: pw });
    if (result.error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        showAuthError(result.error.message); return;
    }
    currentUser = result.data.user;
    
    // Profil anlegen
    await sb.from('profiles').insert({ id: currentUser.id, name: name, imkerei: imkerei, email: email });
    
    // Standard-Packliste erstellen
    await packlisteMod.erstelleNeueItems();
    
    await startApp();
}

async function doForgotPassword() {
    var email = document.getElementById('forgotEmail').value.trim();
    if (!email) { showAuthError('Bitte E-Mail eingeben'); return; }
    var result = await sb.auth.resetPasswordForEmail(email);
    if (result.error) { showAuthError(result.error.message); return; }
    showAuthError(''); 
    document.getElementById('authError').style.display = 'block';
    document.getElementById('authError').style.background = '#d1fae5';
    document.getElementById('authError').style.borderColor = '#6ee7b7';
    document.getElementById('authError').style.color = '#065f46';
    document.getElementById('authError').textContent = 'üìß Reset-Link wurde gesendet! Pr√ºfe dein Postfach.';
}

async function doLogout() {
    await sb.auth.signOut();
    currentUser = null;
    document.getElementById('authScreen').style.display = 'block';
    document.querySelector('.nav').style.display = 'none';
    document.getElementById('app').innerHTML = '';
    document.querySelector('.footer').style.display = 'none';
}

// ============================================
// APP START - Load all data from Supabase
// ============================================
async function startApp() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('authScreen').style.display = 'none';
    document.querySelector('.nav').style.display = '';
    document.querySelector('.footer').style.display = '';
    
    // Presence starten
    if (typeof initPresence === 'function') initPresence(currentUser);
    
    // Load profile
    var profileRes = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    app.data.user = profileRes.data || { name: currentUser.email, email: currentUser.email };
    
    // Kalender-Zustand aus Profil laden
    if (profileRes.data && profileRes.data.kalender_offen !== undefined) {
        trachtkalenderMod.kalenderOffen = profileRes.data.kalender_offen;
    }
    
    // Wetter-Ort aus Profil laden
    if (profileRes.data) {
        if (profileRes.data.wetter_ort) wetterMod.customOrt = profileRes.data.wetter_ort;
        if (profileRes.data.wetter_lat) wetterMod.customLat = profileRes.data.wetter_lat;
        if (profileRes.data.wetter_lng) wetterMod.customLng = profileRes.data.wetter_lng;
    }
    
    // UI-State aus Profil laden (Aufgaben ein-/zugeklappt)
    var uiLoaded = false;
    if (profileRes.data && profileRes.data.ui_state) {
        var saved = profileRes.data.ui_state;
        if (saved.ueberfaellig !== undefined) { app.uiState.ueberfaellig = saved.ueberfaellig; uiLoaded = true; }
        if (saved.heute !== undefined) app.uiState.heute = saved.heute;
        if (saved.naechste7 !== undefined) app.uiState.naechste7 = saved.naechste7;
        if (saved.spaeter !== undefined) app.uiState.spaeter = saved.spaeter;
        if (saved.packliste !== undefined) app.uiState.packliste = saved.packliste;
    }
    // Fallback: localStorage
    if (!uiLoaded) {
        try {
            var local = JSON.parse(localStorage.getItem('imkerei_uiState'));
            if (local) {
                if (local.ueberfaellig !== undefined) app.uiState.ueberfaellig = local.ueberfaellig;
                if (local.heute !== undefined) app.uiState.heute = local.heute;
                if (local.naechste7 !== undefined) app.uiState.naechste7 = local.naechste7;
                if (local.spaeter !== undefined) app.uiState.spaeter = local.spaeter;
                if (local.packliste !== undefined) app.uiState.packliste = local.packliste;
            }
        } catch(e){}
    }
    
    // Load all data in parallel
    var results = await Promise.all([
        sb.from('standorte').select('*').eq('user_id', currentUser.id),
        sb.from('voelker').select('*').eq('user_id', currentUser.id),
        sb.from('aufgaben').select('*').eq('user_id', currentUser.id),
        sb.from('kosten').select('*').eq('user_id', currentUser.id),
        sb.from('zuchtplaene').select('*').eq('user_id', currentUser.id),
        sb.from('trachten').select('*').eq('user_id', currentUser.id),
        sb.from('behandlungen').select('*').eq('user_id', currentUser.id),
        sb.from('packliste').select('*').eq('user_id', currentUser.id),
        sb.from('trachten_ausgeblendet').select('*').eq('user_id', currentUser.id)
    ]);
    
    // Map DB rows to app format
    app.data.standorte = (results[0].data || []).map(function(r) {
        return { id: r.id, name: r.name, notizen: r.notizen, mapsLink: r.maps_link, lat: r.lat, lng: r.lng, created: r.created_at };
    });
    app.data.voelker = (results[1].data || []).map(function(r) {
        return { id: r.id, standortId: r.standort_id, name: r.name, beutensystem: r.beutensystem, status: r.status, notizen: r.notizen, honigertrag: parseFloat(r.honigertrag)||0, created: r.created_at };
    });
    app.data.aufgaben = (results[2].data || []).map(function(r) {
        return { id: r.id, typ: r.typ, notiz: r.notiz, faelligkeit: r.faelligkeit, dauer: r.dauer, prio: r.prio, erledigt: r.erledigt, standortId: r.standort_id||null, intervallTage: r.intervall_tage||0, created: r.created_at };
    });
    app.data.kosten = (results[3].data || []).map(function(r) {
        return { id: r.id, beschreibung: r.beschreibung, betrag: parseFloat(r.betrag)||0, kat: r.kat, datum: r.datum };
    });
    zuchtplanMod.plaene = (results[4].data || []).map(function(r) {
        return { id: r.id, name: r.name, sammelbrut: r.sammelbrut, umlarven: r.umlarven, zusetzen: r.zusetzen, notizen: r.notizen, tageUmlarven: r.tage_umlarven, tageZusetzen: r.tage_zusetzen, created: r.created_at };
    });
    trachtkalenderMod.trachten = (results[5].data || []).map(function(r) {
        return { id: r.id, typ: r.typ, standort: r.standort, beginn: r.beginn, ende: r.ende, ertrag: parseFloat(r.ertrag)||0, notizen: r.notizen, lat: r.lat||null, lng: r.lng||null, shared: r.shared||false, created: r.created_at };
    });
    console.log('üå∏ Trachten geladen:', trachtkalenderMod.trachten.length, trachtkalenderMod.trachten.map(function(t){return t.id+' ('+t.typ+')';}).join(', '));
    if (results[5].error) console.error('‚ùå Trachten Lade-Fehler:', results[5].error);
    behandlungMod.behandlungen = (results[6].data || []).map(function(r) {
        return { id: r.id, voelkerIds: r.voelker_ids, voelkerLabel: r.voelker_label, methode: r.methode, methodeName: r.methode_name, datum: r.datum, intervall: r.intervall, intervallLabel: r.intervall_label, termine: r.termine, notizen: r.notizen, standortId: r.standort_id||null, menge: r.menge||'', verabreichung: r.verabreichung||'', lieferant: r.lieferant||'', wartezeit: r.wartezeit||'', behandler: r.behandler||'', created: r.created_at };
    });
    packlisteMod.items = (results[7].data || []).map(function(r) {
        return { id: r.id, kategorie: r.kategorie, name: r.name, checked: r.checked, menge: r.menge, istSchnell: r.ist_schnell, schnellTyp: r.schnell_typ };
    });
    trachtkalenderMod.ausgeblendete = (results[8].data || []).map(function(r) { return r.tracht_name; });
    console.log('üìã Geladene ausgeblendete Trachten:', trachtkalenderMod.ausgeblendete.length);
    console.log('üìã Geladene ausgeblendete Trachten:', trachtkalenderMod.ausgeblendete.length);
    
    // If packliste is empty for new user, create defaults
    if (packlisteMod.items.length === 0) {
        await packlisteMod.erstelleNeueItems();
    }
    
    document.getElementById('loadingOverlay').style.display = 'none';
    app.initUI();
    
    // Hash-Navigation: z.B. index.html#tracht ‚Üí direkt zur Tracht-Seite
    if (_startPageHash && ['heute','standorte','aufgaben','behandlung','tracht','packliste','kosten','einstellungen'].indexOf(_startPageHash) > -1) {
        app.page = _startPageHash;
        // Aktiven Nav-Link setzen
        document.querySelectorAll('.nav .nav-item').forEach(function(b){ b.classList.remove('active'); });
        var navLink = document.querySelector('.nav .nav-item[href="index.html#'+_startPageHash+'"]');
        if (navLink) navLink.classList.add('active');
        history.replaceState(null, '', window.location.pathname); // Hash sauber entfernen
    }
    
    app.render();
    
    // Wetter im Hintergrund laden
    wetterMod.laden().then(function(){ app.render(); });
    
    // Verwaiste trachten_shared aufr√§umen (im Hintergrund)
    (async function(){
        try {
            var sharedRes = await sb.from('trachten_shared').select('id').eq('user_id', currentUser.id);
            var sharedIds = (sharedRes.data || []).map(function(r){ return r.id; });
            var meineIds = trachtkalenderMod.trachten.map(function(t){ return t.id; });
            var verwaiste = sharedIds.filter(function(sid){ return meineIds.indexOf(sid) === -1; });
            if (verwaiste.length > 0) {
                console.log('üßπ R√§ume '+verwaiste.length+' verwaiste geteilte Trachten auf:', verwaiste);
                for (var i=0; i<verwaiste.length; i++) {
                    await sb.from('trachten_shared').delete().eq('id', verwaiste[i]);
                }
            }
        } catch(e){ console.warn('Aufr√§umen fehlgeschlagen:', e); }
    })();
}

// Save indicator
function showSaved() {
    var el = document.getElementById('saveIndicator');
    el.classList.add('show');
    setTimeout(function(){ el.classList.remove('show'); }, 1500);
}

// ============================================
// AUTO-BACKUP VOR L√ñSCHAKTIONEN
// ============================================
const autoBackup = {
    // Erstellt ein Backup aller Daten in localStorage
    create(grund) {
        try {
            var backup = {
                datum: new Date().toISOString(),
                grund: grund,
                version: 1,
                daten: {
                    standorte: JSON.parse(JSON.stringify(app.data.standorte)),
                    voelker: JSON.parse(JSON.stringify(app.data.voelker)),
                    aufgaben: JSON.parse(JSON.stringify(app.data.aufgaben)),
                    kosten: JSON.parse(JSON.stringify(app.data.kosten)),
                    behandlungen: JSON.parse(JSON.stringify(behandlungMod.behandlungen)),
                    zuchtplaene: JSON.parse(JSON.stringify(zuchtplanMod.plaene)),
                    trachten: JSON.parse(JSON.stringify(trachtkalenderMod.trachten)),
                    packliste: JSON.parse(JSON.stringify(packlisteMod.items))
                }
            };
            
            // Letzte 10 Backups behalten
            var backups = JSON.parse(localStorage.getItem('imkerei_backups') || '[]');
            backups.unshift(backup);
            if (backups.length > 10) backups = backups.slice(0, 10);
            localStorage.setItem('imkerei_backups', JSON.stringify(backups));
            console.log('‚úÖ Auto-Backup erstellt:', grund);
            return true;
        } catch(e) {
            console.error('Backup Fehler:', e);
            return false;
        }
    },
    
    // Zeigt alle verf√ºgbaren Backups
    getAll() {
        return JSON.parse(localStorage.getItem('imkerei_backups') || '[]');
    },
    
    // Stellt ein bestimmtes Backup wieder her
    // Intelligent: Nur Tabellen √ºberschreiben, die im Backup enthalten sind
    async restore(index) {
        var backups = this.getAll();
        if (!backups[index]) { alert('Backup nicht gefunden!'); return; }
        
        var backup = backups[index];
        var d = backup.daten;
        
        // Pr√ºfe welche Daten im Backup enthalten sind
        var tabellen = [];
        if (d.standorte && d.standorte.length) tabellen.push('Standorte ('+d.standorte.length+')');
        if (d.voelker && d.voelker.length) tabellen.push('V√∂lker ('+d.voelker.length+')');
        if (d.aufgaben && d.aufgaben.length) tabellen.push('Aufgaben ('+d.aufgaben.length+')');
        if (d.kosten && d.kosten.length) tabellen.push('Kosten ('+d.kosten.length+')');
        if (d.behandlungen && d.behandlungen.length) tabellen.push('Behandlungen ('+d.behandlungen.length+')');
        if (d.zuchtplaene && d.zuchtplaene.length) tabellen.push('Zuchtpl√§ne ('+d.zuchtplaene.length+')');
        if (d.trachten && d.trachten.length) tabellen.push('Trachten ('+d.trachten.length+')');
        if (d.packliste && d.packliste.length) tabellen.push('Packliste ('+d.packliste.length+')');
        
        if (tabellen.length === 0) { alert('Backup enth√§lt keine Daten!'); return; }
        
        if (!confirm('Backup vom ' + new Date(backup.datum).toLocaleString('de-DE') + ' wiederherstellen?\n\nGrund: ' + backup.grund + '\n\nEnthaltene Daten:\n‚Ä¢ ' + tabellen.join('\n‚Ä¢ ') + '\n\n‚ö†Ô∏è Nur diese Bereiche werden √ºberschrieben.\nAlle anderen Daten bleiben erhalten!')) return;
        
        // Nur Tabellen l√∂schen und neu bef√ºllen, die im Backup enthalten sind
        if (d.standorte && d.standorte.length) {
            await sb.from('standorte').delete().eq('user_id', currentUser.id);
            await sb.from('standorte').insert(d.standorte.map(function(s){
                return {id:s.id, user_id:currentUser.id, name:s.name, notizen:s.notizen, maps_link:s.mapsLink, lat:s.lat, lng:s.lng, created_at:s.created};
            }));
        }
        if (d.voelker && d.voelker.length) {
            await sb.from('voelker').delete().eq('user_id', currentUser.id);
            await sb.from('voelker').insert(d.voelker.map(function(v){
                return {id:v.id, user_id:currentUser.id, standort_id:v.standortId, name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen||'', honigertrag:v.honigertrag||0, created_at:v.created};
            }));
        }
        if (d.aufgaben && d.aufgaben.length) {
            await sb.from('aufgaben').delete().eq('user_id', currentUser.id);
            await sb.from('aufgaben').insert(d.aufgaben.map(function(a){
                return {id:a.id, user_id:currentUser.id, typ:a.typ, notiz:a.notiz, faelligkeit:a.faelligkeit, dauer:a.dauer, prio:a.prio, erledigt:a.erledigt||null, standort_id:a.standortId||null, intervall_tage:a.intervallTage||0, created_at:a.created};
            }));
        }
        if (d.kosten && d.kosten.length) {
            await sb.from('kosten').delete().eq('user_id', currentUser.id);
            await sb.from('kosten').insert(d.kosten.map(function(k){
                return {id:k.id, user_id:currentUser.id, beschreibung:k.beschreibung, betrag:k.betrag, kat:k.kat, datum:k.datum};
            }));
        }
        if (d.behandlungen && d.behandlungen.length) {
            await sb.from('behandlungen').delete().eq('user_id', currentUser.id);
            await sb.from('behandlungen').insert(d.behandlungen.map(function(b){
                return {id:b.id, user_id:currentUser.id, voelker_ids:b.voelkerIds, voelker_label:b.voelkerLabel, methode:b.methode, methode_name:b.methodeName, datum:b.datum, intervall:b.intervall, intervall_label:b.intervallLabel, termine:b.termine, notizen:b.notizen, standort_id:b.standortId||null, menge:b.menge||'', verabreichung:b.verabreichung||'', lieferant:b.lieferant||'', wartezeit:b.wartezeit||'', behandler:b.behandler||'', created_at:b.created};
            }));
        }
        if (d.zuchtplaene && d.zuchtplaene.length) {
            await sb.from('zuchtplaene').delete().eq('user_id', currentUser.id);
            await sb.from('zuchtplaene').insert(d.zuchtplaene.map(function(z){
                return {id:z.id, user_id:currentUser.id, name:z.name, sammelbrut:z.sammelbrut, umlarven:z.umlarven, zusetzen:z.zusetzen, notizen:z.notizen, tage_umlarven:z.tageUmlarven, tage_zusetzen:z.tageZusetzen, created_at:z.created};
            }));
        }
        if (d.trachten && d.trachten.length) {
            await sb.from('trachten').delete().eq('user_id', currentUser.id);
            await sb.from('trachten').insert(d.trachten.map(function(t){
                return {id:t.id, user_id:currentUser.id, typ:t.typ, standort:t.standort, beginn:t.beginn, ende:t.ende, ertrag:t.ertrag, notizen:t.notizen, lat:t.lat||null, lng:t.lng||null, shared:t.shared||false, created_at:t.created};
            }));
            // Geteilte Trachten auch in trachten_shared wiederherstellen
            var geteilte = d.trachten.filter(function(t){ return t.shared && t.lat && t.lng; });
            if (geteilte.length > 0) {
                await sb.from('trachten_shared').delete().eq('user_id', currentUser.id);
                var userName = app.data.user ? (app.data.user.name || app.data.user.email || 'Anonym') : 'Anonym';
                await sb.from('trachten_shared').insert(geteilte.map(function(t){
                    return {id:t.id, user_id:currentUser.id, user_name:userName, typ:t.typ, standort:t.standort, lat:t.lat, lng:t.lng, beginn:t.beginn, ende:t.ende, ertrag:t.ertrag, notizen:t.notizen, jahr:new Date().getFullYear()};
                }));
            }
        }
        if (d.packliste && d.packliste.length) {
            await sb.from('packliste').delete().eq('user_id', currentUser.id);
            await sb.from('packliste').insert(d.packliste.map(function(p){
                return {id:p.id, user_id:currentUser.id, kategorie:p.kategorie, name:p.name, checked:p.checked, menge:p.menge, ist_schnell:p.istSchnell, schnell_typ:p.schnellTyp};
            }));
        }
        
        // Seite neu laden um alles frisch von Supabase zu holen
        alert('‚úÖ Backup wiederhergestellt! Seite wird neu geladen.');
        location.reload();
    },
    
    // Einzelnes Backup l√∂schen
    remove(index) {
        var backups = this.getAll();
        if (!backups[index]) return;
        var d = new Date(backups[index].datum);
        if (!confirm('Backup vom ' + d.toLocaleString('de-DE') + ' l√∂schen?')) return;
        backups.splice(index, 1);
        localStorage.setItem('imkerei_backups', JSON.stringify(backups));
        app.render();
    },
    
    // Manuelles Backup als JSON-Datei herunterladen
    download() {
        var backup = {
            datum: new Date().toISOString(),
            grund: 'Manueller Export',
            version: 1,
            daten: {
                standorte: app.data.standorte,
                voelker: app.data.voelker,
                aufgaben: app.data.aufgaben,
                kosten: app.data.kosten,
                behandlungen: behandlungMod.behandlungen,
                zuchtplaene: zuchtplanMod.plaene,
                trachten: trachtkalenderMod.trachten,
                packliste: packlisteMod.items
            }
        };
        var blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'imkerei_backup_' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
    },
    
    // JSON-Datei hochladen und wiederherstellen
    upload() {
        var input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var text = await file.text();
            try {
                var backup = JSON.parse(text);
                if (!backup.daten) { alert('Ung√ºltige Backup-Datei!'); return; }
                // In Backup-Liste aufnehmen
                var backups = JSON.parse(localStorage.getItem('imkerei_backups') || '[]');
                backups.unshift(backup);
                if (backups.length > 10) backups = backups.slice(0, 10);
                localStorage.setItem('imkerei_backups', JSON.stringify(backups));
                // Direkt wiederherstellen
                autoBackup.restore(0);
            } catch(err) {
                alert('Fehler beim Lesen der Datei: ' + err.message);
            }
        };
        input.click();
    }
};

// ============================================
// CONSTANTS
// ============================================
const TT={
    futter:'üçØ Futter',durchsicht:'üîç Durchsicht',varroabehandlung:'üíâ Varroa',honigraum:'üì¶ Honigraum',absperrgitter:'‚äû Gitter',schwarmkontrolle:'üëÄ Schwarm',ableger:'üêù Ableger',koenigin:'üëë K√∂nigin',mittelwaende:'‚ñ≠ Mittelwand',waben:'‚ó´ Waben',raehmchen:'ü™µ R√§hmchen',standort:'üöó Standort',honigschleudern:'üçØ Schleudern',wachs:'üïØÔ∏è Wachs',equipmentwartung:'üîß Wartung',beuten:'üè† Beuten',varroa:'üî¨ Varroa',gem√ºlldiagnose:'üîç Gem√ºll',winterfutter:'‚ùÑÔ∏è Winter',fluglochkeil:'üö™ Flugloch',maeusegitter:'üê≠ M√§use',custom:'‚úèÔ∏è Eigene'
};
const KK=['Futter','Behandlung','Material','Werkzeug','Fahrtkosten','Verpackung','Energie','Versicherung','Fortbildung','Sonstiges'];
const KOSTEN_VORLAGEN={
    'Benzin':{kat:'Fahrtkosten',betrag:15.00},'Diesel':{kat:'Fahrtkosten',betrag:20.00},'Zucker 25kg':{kat:'Futter',betrag:25.00},'Apifonda':{kat:'Futter',betrag:35.00},'Ameisens√§ure':{kat:'Behandlung',betrag:15.00},'Oxals√§ure':{kat:'Behandlung',betrag:12.00},'Mittelw√§nde':{kat:'Material',betrag:30.00},'Gl√§ser':{kat:'Verpackung',betrag:45.00},'Etiketten':{kat:'Verpackung',betrag:20.00},'Strom':{kat:'Energie',betrag:50.00}
};
const app={
    data:{user:null,standorte:[],voelker:[],aufgaben:[],kosten:[]},
    page:'heute',
    pending:null,
    editStandortId:null,
    editVolkId:null,
    editAufgabeId:null,
    selectedIntervall:0,
    editZuchtId:null,
    selectedStandortId:null,
    selectedVolkStatus:'ok',
    selectedAufgabeTyp:null,
    selectedPrio:'medium',
    selectedDauer:120,
    selectedKostenKat:null,
    voelkerCount:2,
    _toastTimer:null,
    // UI-State: merkt sich ob Sektionen auf/zugeklappt sind
    uiState:{
        ueberfaellig: true,   // standardm√§√üig offen
        heute: true,           // standardm√§√üig offen
        naechste7: true,       // standardm√§√üig offen
        spaeter: false,        // standardm√§√üig zu
        packliste: false       // standardm√§√üig zu
    },
    
    toggleUI(key){
        this.uiState[key] = !this.uiState[key];
        // Immer in localStorage speichern (sicherer Fallback)
        try { localStorage.setItem('imkerei_uiState', JSON.stringify(this.uiState)); } catch(e){}
        // Auch in Supabase versuchen
        if (currentUser) {
            var uid = currentUser.id;
            var state = JSON.parse(JSON.stringify(this.uiState));
            console.log('[toggleUI] ‚û°Ô∏è Update profiles SET ui_state =', state, 'WHERE id =', uid);
            sb.from('profiles').update({ui_state: state}).eq('id', uid).select()
                .then(function(res){ 
                    console.log('[toggleUI] ‚¨ÖÔ∏è Response data:', res.data, 'error:', res.error, 'count:', res.count, 'status:', res.status);
                    if(res.error) console.error('[toggleUI] ‚ùå Fehler:', res.error.message);
                    else if(!res.data || res.data.length === 0) console.warn('[toggleUI] ‚ö†Ô∏è Kein Datensatz aktualisiert! Falsche ID oder RLS blockiert.');
                    else console.log('[toggleUI] ‚úÖ Gespeichert:', res.data[0].ui_state);
                });
        } else {
            console.warn('[toggleUI] ‚ö†Ô∏è currentUser ist null!');
        }
        this.render();
    },
    
    init(){
        // Auth check handled externally
    },
    
    initUI(){
        const self=this;
        
        // Desktop-Sidebar: <a href="index.html#page"> Links abfangen
        document.querySelectorAll('.nav .nav-item[href^="index.html#"]').forEach(function(link){
            link.addEventListener('click',function(e){
                e.preventDefault();
                var page = link.getAttribute('href').replace('index.html#','');
                document.querySelectorAll('.nav .nav-item').forEach(function(b){b.classList.remove('active');});
                link.classList.add('active');
                self.page = page;
                window.location.hash = page;
                self.render();
                window.scrollTo(0,0);
            });
        });
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('aufgabeDatum').value = today;
        document.getElementById('kostenDatum').value = today;
        
        this.renderAufgabeTypes();
        this.renderKostenKategorien();
        this.renderKostenVorlagen();
    },
    
    toast(msg, type='success', duration=2500){
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.className = 'toast ' + type;
        requestAnimationFrame(function(){
            el.classList.add('show');
        });
        clearTimeout(this._toastTimer);
        const self = this;
        this._toastTimer = setTimeout(function(){
            el.classList.remove('show');
        }, duration);
    },
    
    // === REGISTRATION ===
    startReg(){
        const n = document.getElementById('regName').value.trim();
        const e = document.getElementById('regEmail').value.trim();
        const ok = document.getElementById('regDatenschutz').checked;
        
        if(!n){alert('Bitte Namen eingeben!');return;}
        if(!e || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){alert('Bitte g√ºltige E-Mail eingeben!');return;}
        if(!ok){alert('Bitte Datenschutz akzeptieren!');return;}
        
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        this.pending = {
            name: n,
            imkerei: document.getElementById('regImkerei').value.trim(),
            email: e,
            code: code,
            ts: Date.now()
        };
        
        emailjs.send('service_rowhptg', 'template_oqn3t06', {
            from_name: n,
            imkerei: this.pending.imkerei || '-',
            email: e,
            datum: 'Dein Best√§tigungscode: ' + code
        }).then(() => {
            this.toast('üìß Code gesendet!', 'success');
        }).catch(() => {
            this.toast('E-Mail Fehler', 'error');
        });
        
        // registration handled by auth screen
        document.getElementById('codeEmail').textContent = e;
        document.getElementById('codeModal').classList.add('active');
    },
    
    verifyCode(){
        const c = document.getElementById('codeInput').value.trim();
        if(!this.pending) return;
        
        if(c !== this.pending.code){
            alert('Falscher Code!');
            return;
        }
        
        this.data.user = {
            name: this.pending.name,
            imkerei: this.pending.imkerei,
            email: this.pending.email,
            emailConfirmed: true,
            registeredAt: this.pending.ts
        };
        
        if(!this.data.registrations) this.data.registrations = [];
        this.data.registrations.push({
            id: 'r' + this.uid(),
            name: this.pending.name,
            imkerei: this.pending.imkerei,
            email: this.pending.email,
            emailConfirmed: true,
            registeredAt: this.pending.ts
        });
        
        emailjs.send('service_rowhptg', 'template_oqn3t06', {
            from_name: this.pending.name,
            imkerei: this.pending.imkerei || '-',
            email: this.pending.email,
            datum: 'Neue Registrierung: ' + this.fdt(Date.now())
        }).catch(() => {});
        
        this.save();
        document.getElementById('codeModal').classList.remove('active');
        this.pending = null;
        this.toast('Willkommen! üêù', 'success', 3000);
        this.render();
    },
    
    resendCode(){
        if(!this.pending) return;
        
        emailjs.send('service_rowhptg', 'template_oqn3t06', {
            from_name: this.pending.name,
            imkerei: this.pending.imkerei || '-',
            email: this.pending.email,
            datum: 'Dein Best√§tigungscode: ' + this.pending.code
        }).then(() => {
            this.toast('üìß Erneut gesendet!', 'info');
        }).catch(() => {
            this.toast('Fehler', 'error');
        });
    },
    
    // === GRIDS F√úLLEN ===
    renderAufgabeTypes(){
        const grid = document.getElementById('aufgabeTypGrid');
        grid.innerHTML = Object.entries(TT).map(function(entry){
            const key = entry[0];
            const label = entry[1];
            const parts = label.split(' ');
            const emoji = parts[0];
            const text = parts.slice(1).join(' ');
            return '<button class="option-btn" onclick="app.selectAufgabeTyp(\''+key+'\')"><span class="emoji">'+emoji+'</span>'+text+'</button>';
        }).join('');
    },
    
    renderKostenKategorien(){
        const grid = document.getElementById('kostenKatGrid');
        grid.innerHTML = KK.map(function(kat){
            return '<button class="option-btn" onclick="app.selectKostenKat(\''+kat+'\')">'+kat+'</button>';
        }).join('');
    },
    
    renderKostenVorlagen(){
        const grid = document.getElementById('kostenVorlagenGrid');
        grid.innerHTML = Object.entries(KOSTEN_VORLAGEN).map(function(entry){
            const name = entry[0];
            const data = entry[1];
            return '<button class="option-btn" onclick="app.useKostenVorlage(\''+name+'\')">'+name+'<br><small style="color:#7A6652">'+data.betrag.toFixed(2)+'‚Ç¨</small></button>';
        }).join('');
    },
    
    // === MODAL FUNKTIONEN ===
    openModal(id){
        document.getElementById(id).classList.add('active');
    },
    
    closeModal(id){
        document.getElementById(id).classList.remove('active');
        
        if(id === 'aufgabeModal'){
            this.editAufgabeId = null;
            this.selectedAufgabeTyp = null;
            this.selectedPrio = 'medium';
            document.getElementById('aufgabeNotiz').value = '';
            document.querySelectorAll('#aufgabeTypGrid .option-btn').forEach(function(btn){
                btn.classList.remove('selected');
            });
        }else if(id === 'kostenModal'){
            this.selectedKostenKat = null;
            document.getElementById('kostenBeschreibung').value = '';
            document.getElementById('kostenBetrag').value = '';
            document.querySelectorAll('#kostenKatGrid .option-btn').forEach(function(btn){
                btn.classList.remove('selected');
            });
        }else if(id === 'standortModal'){
            this.editStandortId = null;
            this.voelkerCount = 2;
            document.getElementById('standortName').value = '';
            document.getElementById('standortVoelkerCount').textContent = '2';
            document.getElementById('standortNotizen').value = '';
        }else if(id === 'volkModal'){
            this.editVolkId = null;
            this.selectedVolkStatus = 'ok';
            document.getElementById('volkName').value = '';
            document.getElementById('volkNotizen').value = '';
            document.getElementById('volkHonig').value = '';
        }else if(id === 'trachtModal'){
            document.getElementById('trachtStandort').value = '';
            document.getElementById('trachtErtrag').value = '';
            document.getElementById('trachtNotizen').value = '';
        }
    },
    
    // === COUNTER ===
    changeVoelkerCount(delta){
        this.voelkerCount = Math.max(0, this.voelkerCount + delta);
        document.getElementById('standortVoelkerCount').textContent = this.voelkerCount;
    },
    
    // === STANDORTE ===
    openStandortModal(id){
        if(id){
            const s = this.data.standorte.find(function(x){return x.id === id;});
            if(s){
                this.editStandortId = id;
                document.getElementById('standortModalTitle').textContent = 'üìç Standort bearbeiten';
                document.getElementById('standortName').value = s.name;
                const voelkerAnzahl = this.data.voelker.filter(function(v){return v.standortId === id;}).length;
                this.voelkerCount = voelkerAnzahl;
                document.getElementById('standortVoelkerCount').textContent = voelkerAnzahl;
                document.getElementById('standortNotizen').value = s.notizen || '';
                document.getElementById('standortLat').value = s.lat || '';
                document.getElementById('standortLng').value = s.lng || '';
                this._standortEditLat = s.lat || null;
                this._standortEditLng = s.lng || null;
            }
        }else{
            this.editStandortId = null;
            this.voelkerCount = 2;
            document.getElementById('standortModalTitle').textContent = 'üìç Neuer Standort';
            document.getElementById('standortVoelkerCount').textContent = '2';
            document.getElementById('standortLat').value = '';
            document.getElementById('standortLng').value = '';
            document.getElementById('standortKoordStatus').innerHTML = '';
            this._standortEditLat = null;
            this._standortEditLng = null;
        }
        this.openModal('standortModal');
        // Karte initialisieren nach kurzer Verz√∂gerung (Modal muss sichtbar sein)
        setTimeout(function(){ app.initMapPicker('standort'); }, 300);
    },
    
    initMapPicker(type){
        var containerId = type === 'standort' ? 'standortMapPicker' : 'trachtMapPicker';
        var latId = type === 'standort' ? 'standortLat' : 'trachtLatE';
        var lngId = type === 'standort' ? 'standortLng' : 'trachtLngE';
        var statusId = type === 'standort' ? 'standortKoordStatus' : 'koordinatenStatus';
        
        var container = document.getElementById(containerId);
        if (!container) return;
        
        // Alte Map-Instanz entfernen
        if (container._mapInstance) {
            container._mapInstance.remove();
            container._mapInstance = null;
        }
        container.innerHTML = '';
        
        // Startposition: gespeicherte Koordinaten oder Deutschland-Mitte
        var startLat = parseFloat(document.getElementById(latId).value) || 49.0;
        var startLng = parseFloat(document.getElementById(lngId).value) || 10.0;
        var startZoom = document.getElementById(latId).value ? 14 : 6;
        
        var map = L.map(container, {zoomControl: true}).setView([startLat, startLng], startZoom);
        container._mapInstance = map;
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OSM',
            maxZoom: 19
        }).addTo(map);
        
        var marker = null;
        
        // Wenn schon Koordinaten da sind, Marker setzen
        if (document.getElementById(latId).value) {
            marker = L.marker([startLat, startLng]).addTo(map);
            document.getElementById(statusId).innerHTML = '<span style="color:#10b981">‚úÖ Position gesetzt: '+startLat.toFixed(4)+', '+startLng.toFixed(4)+'</span>';
        }
        
        // Klick auf Karte setzt Marker
        map.on('click', function(e){
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            document.getElementById(latId).value = lat;
            document.getElementById(lngId).value = lng;
            document.getElementById(statusId).innerHTML = '<span style="color:#10b981">‚úÖ Position gesetzt: '+lat.toFixed(4)+', '+lng.toFixed(4)+'</span>';
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lng]).addTo(map);
        });
        
        // Karte mehrfach invalidieren damit sie korrekt rendert
        setTimeout(function(){ map.invalidateSize(); }, 100);
        setTimeout(function(){ map.invalidateSize(); }, 500);
        setTimeout(function(){ map.invalidateSize(); }, 1000);
    },
    
    parseStandortKoord(){
        // Not needed anymore - map picker handles it
    },
    
    saveStandort(){
        const name = document.getElementById('standortName').value.trim();
        const voelkerAnzahl = this.voelkerCount;
        const notizen = document.getElementById('standortNotizen').value.trim();
        const mapsLink = '';
        const lat = parseFloat(document.getElementById('standortLat').value) || null;
        const lng = parseFloat(document.getElementById('standortLng').value) || null;
        
        console.log('=== saveStandort ===');
        console.log('editStandortId:', this.editStandortId);
        console.log('Name:', name, '| Lat:', lat, '| Lng:', lng);
        
        if(!name){
            alert('Bitte Namen eingeben!');
            return;
        }
        
        if(this.editStandortId){
            const s = this.data.standorte.find(function(x){return x.id === app.editStandortId;});
            if(s){
                s.name = name;
                s.notizen = notizen;
                s.mapsLink = mapsLink;
                s.lat = lat;
                s.lng = lng;
                
                const aktuelleVoelker = this.data.voelker.filter(function(v){return v.standortId === app.editStandortId;});
                const diff = voelkerAnzahl - aktuelleVoelker.length;
                
                if(diff > 0){
                    for(let i = 0; i < diff; i++){
                        this.data.voelker.push({
                            id: 'v' + this.uid(),
                            standortId: this.editStandortId,
                            name: 'Volk ' + (aktuelleVoelker.length + i + 1),
                            beutensystem: 'Dadant',
                            status: 'ok',
                            notizen: '',
                            honigertrag: 0,
                            created: Date.now()
                        });
                    }
                }else if(diff < 0){
                    const zuLoeschen = aktuelleVoelker.slice(diff);
                    zuLoeschen.forEach(function(v){
                        app.data.voelker = app.data.voelker.filter(function(x){return x.id !== v.id;});
                    });
                }
            }
        }else{
            const standortId = 's' + this.uid();
            this.data.standorte.push({
                id: standortId,
                name: name,
                notizen: notizen,
                mapsLink: mapsLink,
                lat: lat,
                lng: lng,
                created: Date.now()
            });
            
            for(let i = 1; i <= voelkerAnzahl; i++){
                this.data.voelker.push({
                    id: 'v' + this.uid(),
                    standortId: standortId,
                    name: 'Volk ' + i,
                    beutensystem: 'Dadant',
                    status: 'ok',
                    notizen: '',
                    honigertrag: 0,
                    created: Date.now()
                });
            }
        }
        
        // Save to Supabase BEFORE closeModal (closeModal resets editStandortId!)
        if(this.editStandortId){
            var s = this.data.standorte.find(function(x){return x.id === app.editStandortId;});
            if(s) {
                var updateData = {name:s.name, notizen:s.notizen, maps_link:s.mapsLink, lat:s.lat, lng:s.lng};
                console.log('Standort Update:', s.id, JSON.stringify(updateData));
                db.update('standorte', updateData, s.id).then(function(r){
                    if(r && r.error) {
                        alert('‚ùå FEHLER: ' + JSON.stringify(r.error));
                    } else {
                        console.log('‚úÖ Standort Update OK');
                    }
                });
            }
            // Save all voelker for this standort
            this.data.voelker.filter(function(v){return v.standortId===app.editStandortId;}).forEach(function(v){
                db.upsert('voelker', {id:v.id, user_id:currentUser.id, standort_id:v.standortId, name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen, honigertrag:v.honigertrag, created_at:v.created});
            });
        } else {
            var newS = this.data.standorte[this.data.standorte.length-1];
            db.upsert('standorte', {id:newS.id, user_id:currentUser.id, name:newS.name, notizen:newS.notizen, maps_link:newS.mapsLink, lat:newS.lat, lng:newS.lng, created_at:newS.created});
            this.data.voelker.filter(function(v){return v.standortId===newS.id;}).forEach(function(v){
                db.upsert('voelker', {id:v.id, user_id:currentUser.id, standort_id:v.standortId, name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen||'', honigertrag:v.honigertrag||0, created_at:v.created});
            });
        }
        
        this.closeModal('standortModal');
        this.render();
    },
    
    delStandort(id){
        if(!confirm('Standort und alle V√∂lker wirklich l√∂schen?')) return;
        autoBackup.create('Standort gel√∂scht: ' + (this.data.standorte.find(function(s){return s.id===id;})||{}).name);
        
        this.data.standorte = this.data.standorte.filter(function(s){return s.id !== id;});
        this.data.voelker = this.data.voelker.filter(function(v){return v.standortId !== id;});
        db.del('standorte', id);
        db.delWhere('voelker', 'standort_id', id);
        this.render();
    },
    
    // === V√ñLKER ===
    openVolkModal(id){
        const v = this.data.voelker.find(function(x){return x.id === id;});
        if(!v) return;
        
        this.editVolkId = id;
        this.selectedVolkStatus = v.status || 'ok';
        document.getElementById('volkModalTitle').textContent = 'üêù ' + v.name;
        document.getElementById('volkName').value = v.name;
        document.getElementById('volkBeute').value = v.beutensystem || 'Dadant';
        document.getElementById('volkNotizen').value = v.notizen || '';
        
        // Honig-Info aus ernten-Tabelle laden
        document.getElementById('volkHonigInfo').textContent = 'Lade...';
        sb.from('ernten').select('menge').eq('user_id', currentUser.id).eq('volk_id', id).then(function(res){
            var total = (res.data||[]).reduce(function(s,r){return s+parseFloat(r.menge||0);},0);
            document.getElementById('volkHonigInfo').innerHTML = '<strong style="color:#F5A623;font-size:1.1rem">'+total.toFixed(1)+' kg</strong> <span style="font-size:.8rem">('+((res.data||[]).length)+' Ernten)</span>';
        });
        
        // Status buttons markieren
        document.querySelectorAll('#volkModal .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        
        this.openModal('volkModal');
        
        // Status button nach kurzer Verz√∂gerung markieren
        setTimeout(function(){
            const statusMap = {
                'ok': 0,
                'schwach': 1,
                'weisellos': 2,
                'problem': 3
            };
            const btns = document.querySelectorAll('#volkModal .option-btn');
            const idx = statusMap[v.status] || 0;
            if(btns[idx]) btns[idx].classList.add('selected');
        }, 50);
    },
    
    setVolkStatus(status){
        this.selectedVolkStatus = status;
        document.querySelectorAll('#volkModal .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
    },
    
    saveVolk(){
        if(!this.editVolkId) return;
        
        const v = this.data.voelker.find(function(x){return x.id === app.editVolkId;});
        if(!v) return;
        
        v.name = document.getElementById('volkName').value.trim();
        v.beutensystem = document.getElementById('volkBeute').value;
        v.status = this.selectedVolkStatus;
        v.notizen = document.getElementById('volkNotizen').value.trim();
        
        db.update('voelker', {name:v.name, beutensystem:v.beutensystem, status:v.status, notizen:v.notizen}, v.id);
        this.closeModal('volkModal');
        this.render();
    },
    
    deleteVolk(){
        if(!this.editVolkId) return;
        if(!confirm('Volk wirklich l√∂schen?')) return;
        autoBackup.create('Volk gel√∂scht: ' + (this.data.voelker.find(function(v){return v.id===app.editVolkId;})||{}).name);
        
        var delId = app.editVolkId;
        this.data.voelker = this.data.voelker.filter(function(v){return v.id !== delId;});
        db.del('voelker', delId);
        this.closeModal('volkModal');
        this.render();
    },
    
    showStandortDetails(id){
        this.selectedStandortId = id;
        this.render();
    },
    
    // === AUFGABEN ===
    selectAufgabeTyp(typ){
        this.selectedAufgabeTyp = typ;
        document.querySelectorAll('#aufgabeTypGrid .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.closest('.option-btn').classList.add('selected');
        
        // Standort + Intervall anzeigen bei bestimmten Typen
        var brauchtStandort = ['durchsicht','schwarmkontrolle','varroabehandlung','futter','honigraum','absperrgitter','varroa','gem√ºlldiagnose','winterfutter','fluglochkeil','maeusegitter'].indexOf(typ) > -1;
        document.getElementById('aufgabeStandortWrap').style.display = brauchtStandort ? 'block' : 'none';
        document.getElementById('aufgabeIntervallWrap').style.display = brauchtStandort ? 'block' : 'none';
        
        // Standort-Dropdown f√ºllen
        if (brauchtStandort) {
            var sel = document.getElementById('aufgabeStandort');
            sel.innerHTML = '<option value="">-- Alle Standorte --</option>';
            app.data.standorte.forEach(function(s){
                sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>';
            });
        }
        
        if(typ === 'custom'){
            const name = prompt('Name der Aufgabe:');
            if(name) document.getElementById('aufgabeNotiz').value = name;
        }
    },
    
    setIntervall(tage){
        this.selectedIntervall = tage;
        document.querySelectorAll('#aufgabeIntervallWrap .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
        document.getElementById('aufgabeIntervallCustom').style.display = tage === -1 ? 'block' : 'none';
        if (tage > 0) document.getElementById('aufgabeIntervallTage').value = tage;
    },
    
    setPrio(prio){
        this.selectedPrio = prio;
        document.querySelectorAll('.priority-btn').forEach(function(btn){
            btn.classList.remove('selected', 'low', 'medium', 'high');
        });
        event.target.classList.add('selected', prio);
    },
    
    setDauer(minuten){
        this.selectedDauer = minuten;
        document.getElementById('aufgabeDauer').value = minuten;
        document.querySelectorAll('.dauer-btns .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
    },
    
    openAufgabeModal(id){
        // Reset Standort/Intervall
        document.getElementById('aufgabeStandortWrap').style.display = 'none';
        document.getElementById('aufgabeIntervallWrap').style.display = 'none';
        document.getElementById('aufgabeIntervallCustom').style.display = 'none';
        this.selectedIntervall = 0;
        document.querySelectorAll('#aufgabeIntervallWrap .option-btn').forEach(function(btn){ btn.classList.remove('selected'); });
        
        if(id){
            const a = this.data.aufgaben.find(function(x){return x.id === id;});
            if(a){
                this.editAufgabeId = id;
                this.selectedAufgabeTyp = a.typ;
                this.selectedPrio = a.prio;
                this.selectedDauer = a.dauer;
                this.selectedIntervall = a.intervallTage || 0;
                
                document.getElementById('aufgabeModalTitle').textContent = '‚úì Aufgabe bearbeiten';
                document.getElementById('aufgabeDatum').value = new Date(a.faelligkeit).toISOString().split('T')[0];
                document.getElementById('aufgabeDauer').value = a.dauer;
                
                const notizParts = a.notiz.split(' - ');
                var notizText = notizParts.length > 1 ? notizParts[1] : '';
                // Intervall-Hinweis aus Notiz entfernen
                notizText = notizText.replace(/\s*\[üîÅ.*?\]\s*$/, '');
                document.getElementById('aufgabeNotiz').value = notizText;
                
                // Standort setzen
                if (a.standortId) {
                    document.getElementById('aufgabeStandortWrap').style.display = 'block';
                    document.getElementById('aufgabeIntervallWrap').style.display = 'block';
                    var sel = document.getElementById('aufgabeStandort');
                    sel.innerHTML = '<option value="">-- Alle Standorte --</option>';
                    app.data.standorte.forEach(function(s){
                        sel.innerHTML += '<option value="'+s.id+'">'+s.name+'</option>';
                    });
                    sel.value = a.standortId;
                }
                
                // Intervall markieren
                if (a.intervallTage > 0) {
                    document.getElementById('aufgabeIntervallWrap').style.display = 'block';
                    if (a.intervallTage === 7 || a.intervallTage === 14) {
                        // Standard-Buttons markieren (nach timeout weil DOM noch nicht sichtbar)
                    } else {
                        document.getElementById('aufgabeIntervallCustom').style.display = 'block';
                        document.getElementById('aufgabeIntervallTage').value = a.intervallTage;
                    }
                }
                
                // Typ button markieren
                setTimeout(function(){
                    document.querySelectorAll('#aufgabeTypGrid .option-btn').forEach(function(btn, idx){
                        btn.classList.remove('selected');
                        if(Object.keys(TT)[idx] === a.typ){
                            btn.classList.add('selected');
                        }
                    });
                }, 50);
            }
        }else{
            this.editAufgabeId = null;
            this.selectedIntervall = 0;
            document.getElementById('aufgabeModalTitle').textContent = '‚úì Neue Aufgabe';
            document.getElementById('aufgabeStandort').value = '';
        }
        this.openModal('aufgabeModal');
    },
    
    saveAufgabe(){
        if(!this.selectedAufgabeTyp){
            alert('Bitte w√§hle einen Aufgaben-Typ!');
            return;
        }
        
        const datum = document.getElementById('aufgabeDatum').value;
        const dauer = parseInt(document.getElementById('aufgabeDauer').value);
        const notiz = document.getElementById('aufgabeNotiz').value;
        const standortId = document.getElementById('aufgabeStandort').value || null;
        var intervallTage = this.selectedIntervall;
        if (intervallTage === -1) intervallTage = parseInt(document.getElementById('aufgabeIntervallTage').value) || 0;
        
        // Standortname in Notiz aufnehmen
        var standortName = '';
        if (standortId) {
            var s = this.data.standorte.find(function(x){return x.id===standortId;});
            if (s) standortName = ' (üìç '+s.name+')';
        }
        var intervallHinweis = intervallTage > 0 ? ' [üîÅ alle '+intervallTage+'d]' : '';
        
        if(this.editAufgabeId){
            const a = this.data.aufgaben.find(function(x){return x.id === app.editAufgabeId;});
            if(a){
                a.typ = this.selectedAufgabeTyp;
                a.notiz = TT[this.selectedAufgabeTyp] + standortName + (notiz ? ' - ' + notiz : '') + intervallHinweis;
                a.faelligkeit = new Date(datum).getTime();
                a.dauer = dauer;
                a.prio = this.selectedPrio;
                a.standortId = standortId;
                a.intervallTage = intervallTage;
                db.update('aufgaben', {typ:a.typ, notiz:a.notiz, faelligkeit:a.faelligkeit, dauer:a.dauer, prio:a.prio, standort_id:standortId, intervall_tage:intervallTage}, a.id);
            }
        }else{
            const aufgabe = {
                id: 'a' + this.uid(),
                typ: this.selectedAufgabeTyp,
                notiz: TT[this.selectedAufgabeTyp] + standortName + (notiz ? ' - ' + notiz : '') + intervallHinweis,
                faelligkeit: new Date(datum).getTime(),
                dauer: dauer,
                prio: this.selectedPrio,
                erledigt: false,
                standortId: standortId,
                intervallTage: intervallTage,
                created: Date.now()
            };
            this.data.aufgaben.push(aufgabe);
            db.insert('aufgaben', {id:aufgabe.id, user_id:currentUser.id, typ:aufgabe.typ, notiz:aufgabe.notiz, faelligkeit:aufgabe.faelligkeit, dauer:aufgabe.dauer, prio:aufgabe.prio, erledigt:null, standort_id:standortId, intervall_tage:intervallTage, created_at:aufgabe.created});
        }
        
        this.closeModal('aufgabeModal');
        this.render();
    },
    
    doneA(id){
        const a = this.data.aufgaben.find(function(x){return x.id === id;});
        if(a){
            a.erledigt = Date.now();
            db.update('aufgaben', {erledigt: a.erledigt}, a.id);
            
            // Bei Intervall-Aufgabe: automatisch n√§chste erstellen
            if (a.intervallTage && a.intervallTage > 0) {
                var naechstesDatum = new Date(a.faelligkeit + a.intervallTage * 24*60*60*1000);
                var neueAufgabe = {
                    id: 'a' + app.uid(),
                    typ: a.typ,
                    notiz: a.notiz,
                    faelligkeit: naechstesDatum.getTime(),
                    dauer: a.dauer,
                    prio: a.prio,
                    erledigt: false,
                    standortId: a.standortId,
                    intervallTage: a.intervallTage,
                    created: Date.now()
                };
                this.data.aufgaben.push(neueAufgabe);
                db.insert('aufgaben', {id:neueAufgabe.id, user_id:currentUser.id, typ:neueAufgabe.typ, notiz:neueAufgabe.notiz, faelligkeit:neueAufgabe.faelligkeit, dauer:neueAufgabe.dauer, prio:neueAufgabe.prio, erledigt:null, standort_id:neueAufgabe.standortId, intervall_tage:neueAufgabe.intervallTage, created_at:neueAufgabe.created});
                this.toast('‚úÖ Erledigt! N√§chste in '+a.intervallTage+' Tagen erstellt', 'success');
            }
            
            this.render();
        }
    },
    
    undoneA(id){
        const a = this.data.aufgaben.find(function(x){return x.id === id;});
        if(a){
            a.erledigt = null;
            db.update('aufgaben', {erledigt: null}, a.id);
            this.render();
        }
    },
    
    // === ZUCHTPLAN === (jetzt in zuchtplan.html)
    openZuchtModal(id){
        window.location.href = 'zuchtplan.html';
    },
    
    saveZucht(){
        // Nicht mehr verwendet ‚Äì Zuchtplan-Verwaltung ist in zuchtplan.html
    },
    
    // === TRACHT === (wird √ºber trachtkalenderMod.saveTracht() gesteuert)
    
    // === KOSTEN ===
    selectKostenKat(kat){
        this.selectedKostenKat = kat;
        document.querySelectorAll('#kostenKatGrid .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
        });
        event.target.closest('.option-btn').classList.add('selected');
    },
    
    useKostenVorlage(name){
        const vorlage = KOSTEN_VORLAGEN[name];
        document.getElementById('kostenBeschreibung').value = name;
        document.getElementById('kostenBetrag').value = vorlage.betrag.toFixed(2);
        this.selectedKostenKat = vorlage.kat;
        
        document.querySelectorAll('#kostenKatGrid .option-btn').forEach(function(btn){
            btn.classList.remove('selected');
            if(btn.textContent === vorlage.kat){
                btn.classList.add('selected');
            }
        });
    },
    
    saveKosten(){
        if(!this.selectedKostenKat){
            alert('Bitte w√§hle eine Kategorie!');
            return;
        }
        
        const beschreibung = document.getElementById('kostenBeschreibung').value;
        const betrag = parseFloat(document.getElementById('kostenBetrag').value);
        const datum = document.getElementById('kostenDatum').value;
        
        if(!beschreibung || isNaN(betrag)){
            alert('Bitte f√ºlle alle Felder aus!');
            return;
        }
        
        const kosten = {
            id: 'k' + this.uid(),
            beschreibung: beschreibung,
            betrag: betrag,
            kat: this.selectedKostenKat,
            datum: new Date(datum).getTime()
        };
        
        this.data.kosten.push(kosten);
        db.insert('kosten', {id:kosten.id, user_id:currentUser.id, beschreibung:kosten.beschreibung, betrag:kosten.betrag, kat:kosten.kat, datum:kosten.datum});
        this.closeModal('kostenModal');
        this.render();
    },
    
    // === HILFSFUNKTIONEN ===
    save(){
        // Data is saved directly to Supabase in each operation
    },
    
    uid(){
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    },
    
    fd(ts){
        if(!ts) return '-';
        const d = new Date(ts);
        return d.toLocaleDateString('de-DE');
    },
    
    fdt(ts){
        if(!ts) return '-';
        const d = new Date(ts);
        return d.toLocaleString('de-DE');
    },
    
    // === RENDER ===
    render(){
        const pages = {
            heute: this.rHeute.bind(this),
            standorte: this.selectedStandortId ? this.rStandortDetails.bind(this) : this.rStandorte.bind(this),
            aufgaben: this.rAufgaben.bind(this),
            kosten: this.rKosten.bind(this),
            koeniginnen: this.rZuchtplanEnhanced.bind(this),
            tracht: this.rTracht.bind(this),
            ernte: this.rErnte.bind(this),
            tagebuch: this.rPlaceholder.bind(this),
            behandlung: this.rBehandlungen.bind(this),
            packliste: this.rPackliste.bind(this),
            datenexport: this.rDatenexport.bind(this),
            einstellungen: this.rEinst.bind(this)
        };
        document.getElementById('app').innerHTML = pages[this.page] ? pages[this.page]() : '<div class="container"><h1>Seite nicht gefunden</h1></div>';
        
        // Mini-Maps initialisieren nach DOM-Update
        if (this.page === 'standorte' && !this.selectedStandortId) {
            this.initMiniMaps();
        }
    },
    
    initMiniMaps(){
        var self = this;
        setTimeout(function(){
            self.data.standorte.forEach(function(s){
                if (s.lat && s.lng) {
                    var el = document.getElementById('minimap_'+s.id);
                    if (!el || el._mapDone) return;
                    el._mapDone = true;
                    try {
                        var map = L.map(el, {
                            zoomControl: false,
                            dragging: false,
                            scrollWheelZoom: false,
                            doubleClickZoom: false,
                            touchZoom: false,
                            attributionControl: false
                        }).setView([s.lat, s.lng], 14);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:17}).addTo(map);
                        L.marker([s.lat, s.lng]).addTo(map);
                        setTimeout(function(){ map.invalidateSize(); }, 300);
                    } catch(e) { console.log('Minimap Error:', e); }
                }
            });
        }, 150);
    },
    
    // Fortsetzung folgt in Teil 2...
    
    rHeute(){
        const self = this;
        const heute = new Date();
        const heuteStr = heute.toDateString();
        const heuteTs = heute.getTime();
        
        // === ALLE EVENTS SAMMELN ===
        var timeline = [];
        
        // 1. Aufgaben
        this.data.aufgaben.forEach(function(a){
            if (a.erledigt) return;
            var ts = a.faelligkeit;
            var tage = Math.ceil((ts - heuteTs)/(1000*60*60*24));
            if (new Date(ts).toDateString() === heuteStr) tage = 0;
            var status = tage < 0 ? 'overdue' : (tage === 0 ? 'today' : 'upcoming');
            timeline.push({
                typ: 'aufgabe',
                ts: ts,
                tage: tage,
                status: status,
                data: a
            });
        });
        
        // 2. Behandlungen (alle zuk√ºnftigen Termine)
        behandlungMod.behandlungen.forEach(function(b){
            (b.termine||[]).forEach(function(termin){
                var tage = Math.ceil((termin - heuteTs)/(1000*60*60*24));
                if (new Date(termin).toDateString() === heuteStr) tage = 0;
                if (tage < -7) return; // Mehr als 7 Tage √ºberf√§llig nicht zeigen
                timeline.push({
                    typ: 'behandlung',
                    ts: termin,
                    tage: tage,
                    status: tage < 0 ? 'overdue' : (tage === 0 ? 'today' : 'upcoming'),
                    data: b
                });
            });
        });
        
        // 3. Zuchtplan-Termine
        zuchtplanMod.plaene.forEach(function(p){
            [{name:'Umlarven',ts:p.umlarven,emoji:'üî¨'},{name:'Zusetzen',ts:p.zusetzen,emoji:'üëë'}].forEach(function(step){
                if (step.ts) {
                    var tage = Math.ceil((step.ts - heuteTs)/(1000*60*60*24));
                    if (tage >= -1 && tage <= 90) {
                        timeline.push({
                            typ: 'zucht',
                            ts: step.ts,
                            tage: tage,
                            status: tage < 0 ? 'overdue' : (tage === 0 ? 'today' : 'upcoming'),
                            data: {plan:p, step:step.name, emoji:step.emoji}
                        });
                    }
                }
            });
        });
        
        // Sortieren: √ºberf√§llig zuerst (√§ltester zuerst), dann heute, dann upcoming
        timeline.sort(function(a,b){
            // √úberf√§llig ganz oben
            if (a.status === 'overdue' && b.status !== 'overdue') return -1;
            if (a.status !== 'overdue' && b.status === 'overdue') return 1;
            // Dann heute
            if (a.status === 'today' && b.status === 'upcoming') return -1;
            if (a.status === 'upcoming' && b.status === 'today') return 1;
            // Innerhalb gleicher Gruppe nach Datum
            return a.ts - b.ts;
        });
        
        // === GRUPPIEREN ===
        var ueberfaellig = timeline.filter(function(e){return e.status === 'overdue';});
        var heuteEvents = timeline.filter(function(e){return e.status === 'today';});
        var naechste7 = timeline.filter(function(e){return e.status === 'upcoming' && e.tage <= 7;});
        var spaeter = timeline.filter(function(e){return e.status === 'upcoming' && e.tage > 7;});
        
        // === RENDER HELPER ===
        function renderEvent(e) {
            var emoji, titel, sub, farbe, aktionen = '';
            
            if (e.typ === 'aufgabe') {
                var a = e.data;
                emoji = '‚úì';
                titel = a.notiz;
                var pc = a.prio === 'high' ? 'badge-red' : (a.prio === 'medium' ? 'badge-yellow' : 'badge-green');
                sub = '‚è±Ô∏è '+a.dauer+' Min ¬∑ <span class="badge '+pc+'" style="font-size:.65rem">'+a.prio.toUpperCase()+'</span>';
                aktionen = '<button class="btn btn-blue btn-xs" onclick="app.openAufgabeModal(\''+a.id+'\')">‚úèÔ∏è</button>'+
                    '<button class="btn btn-success btn-xs" onclick="app.doneA(\''+a.id+'\')">‚úì</button>';
            } else if (e.typ === 'behandlung') {
                var b = e.data;
                var m = METHODEN[b.methode] || {name:b.methodeName,emoji:'üíä'};
                emoji = m.emoji;
                titel = b.methodeName;
                sub = b.voelkerLabel;
                if (b.menge) sub += ' ¬∑ '+b.menge;
            } else if (e.typ === 'zucht') {
                emoji = e.data.emoji;
                titel = e.data.step + ': ' + e.data.plan.name;
                sub = 'üëë Zuchtplan';
            }
            
            // Zeitlabel
            var zeitLabel = '';
            if (e.tage < -1) zeitLabel = Math.abs(e.tage)+' Tage √ºberf√§llig';
            else if (e.tage === -1) zeitLabel = 'Gestern';
            else if (e.tage === 0) zeitLabel = 'Heute';
            else if (e.tage === 1) zeitLabel = 'Morgen';
            else if (e.tage <= 7) zeitLabel = new Date(e.ts).toLocaleDateString('de-DE',{weekday:'short',day:'numeric',month:'short'});
            else {
                var wochen = Math.ceil(e.tage / 7);
                zeitLabel = new Date(e.ts).toLocaleDateString('de-DE',{day:'numeric',month:'short'}) + ' ('+e.tage+'d)';
            }
            
            var zeitFarbe = e.status === 'overdue' ? '#ef4444' : (e.status === 'today' ? '#10b981' : '#7A6652');
            var borderColor = e.status === 'overdue' ? '#fca5a5' : (e.status === 'today' ? '#86efac' : '#E8DFD4');
            
            return '<div style="background:#fff;padding:.75rem;border-radius:.5rem;margin-bottom:.5rem;border:1px solid '+borderColor+'">'+
            '<div style="display:flex;justify-content:space-between;align-items:center">'+
            '<div style="display:flex;align-items:center;gap:.5rem;flex:1;min-width:0">'+
            '<span style="font-size:1.25rem;flex-shrink:0">'+emoji+'</span>'+
            '<div style="min-width:0"><div style="font-weight:600;font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+titel+'</div>'+
            '<div style="font-size:.75rem;color:#7A6652">'+sub+'</div></div></div>'+
            '<div style="display:flex;align-items:center;gap:.5rem;flex-shrink:0">'+
            '<div style="font-size:.75rem;font-weight:600;color:'+zeitFarbe+';white-space:nowrap">'+zeitLabel+'</div>'+
            aktionen+
            '</div></div></div>';
        }
        
        return '<div class="container">'+
        '<h1>üìÖ Heute</h1>'+
        '<div class="card">'+
        '<h3>'+heute.toLocaleDateString('de-DE', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'})+'</h3>'+
        '</div>'+
        
        // Wetter
        wetterMod.render()+
        
        // ‚ö†Ô∏è √úBERF√ÑLLIG
        (ueberfaellig.length ?
            '<div class="card" style="background:linear-gradient(135deg,#fef2f2,#fff);border-left:4px solid #ef4444">'+
            '<div data-toggle-ui="ueberfaellig" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none">'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<span style="font-size:.7rem;color:#ef4444">'+(app.uiState.ueberfaellig?'‚ñº':'‚ñ∂')+'</span>'+
            '<h2 style="margin:0;color:#ef4444;font-size:1.1rem">‚ö†Ô∏è √úberf√§llig ('+ueberfaellig.length+')</h2>'+
            '</div></div>'+
            '<div style="'+(app.uiState.ueberfaellig?'':'display:none;')+'margin-top:.75rem">'+
            ueberfaellig.map(renderEvent).join('')+
            '</div></div>'
            : ''
        )+
        
        // üî• HEUTE
        '<div class="card" style="background:linear-gradient(135deg,#f0fdf4,#fff);border-left:4px solid #10b981">'+
        '<div style="display:flex;justify-content:space-between;align-items:center">'+
        '<div data-toggle-ui="heute" style="display:flex;align-items:center;gap:.5rem;cursor:pointer;user-select:none;flex:1">'+
        '<span style="font-size:.7rem;color:#10b981">'+(app.uiState.heute?'‚ñº':'‚ñ∂')+'</span>'+
        '<h2 style="margin:0;font-size:1.1rem">üî• Heute ('+heuteEvents.length+')</h2>'+
        '</div>'+
        '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation();app.openAufgabeModal()">+ Aufgabe</button>'+
        '</div>'+
        '<div style="'+(app.uiState.heute?'':'display:none;')+'margin-top:.75rem">'+
        (heuteEvents.length ?
            heuteEvents.map(renderEvent).join('')
            : '<div style="text-align:center;padding:1rem;color:#7A6652;font-size:.9rem">Nichts f√ºr heute geplant üéâ</div>'
        )+
        '</div></div>'+
        
        // üìÖ N√ÑCHSTE 7 TAGE
        (naechste7.length ?
            '<div class="card" style="background:linear-gradient(135deg,#FFF8EE,#fff);border-left:4px solid #F5A623">'+
            '<div data-toggle-ui="naechste7" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none">'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<span style="font-size:.7rem;color:#F5A623">'+(app.uiState.naechste7?'‚ñº':'‚ñ∂')+'</span>'+
            '<h2 style="margin:0;font-size:1.1rem">üìÖ N√§chste 7 Tage ('+naechste7.length+')</h2>'+
            '</div></div>'+
            '<div style="'+(app.uiState.naechste7?'':'display:none;')+'margin-top:.75rem">'+
            naechste7.map(renderEvent).join('')+
            '</div></div>'
            : ''
        )+
        
        // üîÆ SP√ÑTER
        (spaeter.length ?
            '<div class="card" style="border-left:4px solid #94a3b8">'+
            '<div data-toggle-ui="spaeter" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<span style="font-size:.7rem;color:#7A6652">'+(app.uiState.spaeter?'‚ñº':'‚ñ∂')+'</span>'+
            '<h2 style="margin:0;font-size:1.1rem;color:#64748b">üîÆ Sp√§ter geplant ('+spaeter.length+')</h2>'+
            '</div></div>'+
            '<div style="'+(app.uiState.spaeter?'':'display:none;')+'margin-top:.75rem">'+
            spaeter.map(renderEvent).join('')+
            '</div></div>'
            : ''
        )+
        
        // Packliste
        (function(){
            var packItems = packlisteMod.items || [];
            var unchecked = packItems.filter(function(i){return !i.checked;});
            var total = packItems.length;
            if (total === 0) return '';
            var checked = total - unchecked.length;
            var prozent = total > 0 ? Math.round(checked/total*100) : 0;
            
            var kategorien = {};
            unchecked.forEach(function(item){
                var kat = item.kategorie || 'Sonstiges';
                if (!kategorien[kat]) kategorien[kat] = [];
                kategorien[kat].push(item);
            });
            
            var detailHtml = unchecked.length === 0 ?
                '<div style="text-align:center;padding:.75rem;color:#10b981;font-weight:600">Alles eingepackt! ‚úÖ</div>'
                :
                Object.keys(kategorien).map(function(kat){
                    return '<div style="margin-bottom:.5rem">'+
                    '<div style="font-size:.7rem;font-weight:600;color:#7A6652;text-transform:uppercase;margin-bottom:.25rem">'+kat+'</div>'+
                    kategorien[kat].map(function(item){
                        var menge = item.menge || 1;
                        return '<div style="display:flex;align-items:center;gap:.5rem;padding:.25rem 0;border-bottom:1px solid #FFFBF0">'+
                        '<input type="checkbox" style="width:1rem;height:1rem;cursor:pointer" onchange="packlisteMod.toggle(\''+item.id+'\');app.render()">'+
                        '<span style="font-size:.85rem">'+(menge>1?'<strong>'+menge+'x</strong> ':'')+item.name+'</span>'+
                        '</div>';
                    }).join('')+
                    '</div>';
                }).join('');
            
            return '<div class="card" style="background:linear-gradient(135deg,#f0f9ff,#fff);border-left:4px solid #3b82f6;padding:.75rem 1rem">'+
            '<div data-toggle-ui="packliste" style="display:flex;justify-content:space-between;align-items:center;cursor:pointer">'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<span style="font-size:.7rem;color:#7A6652">'+(app.uiState.packliste?'‚ñº':'‚ñ∂')+'</span>'+
            '<h2 style="margin:0;font-size:1rem">üì¶ Packliste</h2>'+
            '</div>'+
            '<div style="display:flex;align-items:center;gap:.5rem">'+
            '<div style="width:60px;background:#E8DFD4;border-radius:999px;height:5px">'+
            '<div style="background:#3b82f6;border-radius:999px;height:100%;width:'+prozent+'%"></div></div>'+
            '<span class="badge '+(unchecked.length===0?'badge-green':'badge-yellow')+'" style="font-size:.7rem">'+checked+'/'+total+'</span>'+
            '</div>'+
            '</div>'+
            '<div style="'+(app.uiState.packliste?'':'display:none;')+'margin-top:.75rem">'+
            detailHtml+
            '<div style="margin-top:.5rem;text-align:center">'+
            '<button class="btn btn-blue btn-sm" style="font-size:.8rem;padding:.375rem .75rem" onclick="app.navigate(\'packliste\')">üìã Volle Packliste</button>'+
            '</div>'+
            '</div>'+
            '</div>';
        })()+
        
        // Schnell√ºbersicht
        '<div class="card">'+
        '<h3>üìä Schnell√ºbersicht</h3>'+
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-top:.75rem">'+
        [
            ['üìç Standorte', this.data.standorte.length],
            ['üêù V√∂lker', this.data.voelker.length],
            ['‚úì Offene Aufgaben', this.data.aufgaben.filter(function(a){return !a.erledigt;}).length],
            ['üíâ Behandlungen', behandlungMod.behandlungen.length],
            ['üëë Zuchtpl√§ne', zuchtplanMod.plaene.length],
            ['üçØ Honig (Gesamt)', this.data.voelker.reduce(function(s,v){return s+(v.honigertrag||0);}, 0).toFixed(1) + ' kg']
        ].map(function(x){
            return '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem">'+
            '<div style="font-size:1.5rem;font-weight:bold;color:#1C1410">'+x[1]+'</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.25rem">'+x[0]+'</div>'+
            '</div>';
        }).join('')+
        '</div>'+
        '</div>'+
        '</div>';
    },
    
    rStandorte(){
        const self = this;
        this.selectedStandortId = null;
        
        var html = '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üìç Standorte</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openStandortModal()">+ Neuer Standort</button>'+
        '</div>'+
        this.data.standorte.map(function(s){
            const voelker = self.data.voelker.filter(function(v){return v.standortId === s.id;});
            return '<div class="card" style="cursor:pointer;transition:all .2s" onclick="app.showStandortDetails(\''+s.id+'\')">'+
            '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.75rem">'+
            '<div style="flex:1">'+
            '<h3>'+s.name+'</h3>'+
            (s.notizen ? '<div style="font-size:.85rem;color:#7A6652;margin-top:.25rem">'+s.notizen+'</div>' : '')+
            '</div>'+
            '<div style="display:flex;gap:.5rem">'+
            '<button class="btn btn-primary btn-xs" onclick="event.stopPropagation();app.openStandortModal(\''+s.id+'\')">‚úèÔ∏è</button>'+
            '<button class="btn btn-danger btn-xs" onclick="event.stopPropagation();app.delStandort(\''+s.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            (s.lat && s.lng ? '<div id="minimap_'+s.id+'" style="height:150px;border-radius:.75rem;border:2px solid #E8DFD4;margin-bottom:.5rem;overflow:hidden" onclick="event.stopPropagation()"></div>' : '')+
            (s.lat && s.lng ? wetterMod.renderMini(s.id) : '')+
            '<div style="background:#FFF8EE;padding:.75rem;border-radius:.5rem;margin-top:.5rem">'+
            '<div style="font-weight:600;margin-bottom:.5rem">üêù '+voelker.length+' V√∂lker - Klicken f√ºr Details</div>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!this.data.standorte.length ? 
            '<div class="card" style="text-align:center;padding:3rem;color:#7A6652">'+
            '<div style="font-size:3rem;margin-bottom:1rem">üìç</div>'+
            '<h3>Noch keine Standorte</h3>'+
            '<p style="margin:.5rem 0 1.5rem">Erstelle deinen ersten Standort und f√ºge V√∂lker hinzu!</p>'+
            '<button class="btn btn-primary" onclick="app.openStandortModal()">Ersten Standort erstellen</button>'+
            '</div>' 
            : ''
        )+
        '</div>';
        
        // Mini-Maps nach dem Rendern initialisieren
        setTimeout(function(){
            self.data.standorte.forEach(function(s){
                if (s.lat && s.lng) {
                    var el = document.getElementById('minimap_'+s.id);
                    if (!el) return;
                    try {
                        var map = L.map(el, {
                            zoomControl: false,
                            dragging: false,
                            scrollWheelZoom: false,
                            doubleClickZoom: false,
                            touchZoom: false,
                            attributionControl: false
                        }).setView([s.lat, s.lng], 14);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:17}).addTo(map);
                        L.marker([s.lat, s.lng]).addTo(map);
                        setTimeout(function(){ map.invalidateSize(); }, 200);
                    } catch(e) { console.log('Minimap Error:', e); }
                }
            });
        }, 100);
        
        return html;
    },
    
    rStandortDetails(){
        const self = this;
        const s = this.data.standorte.find(function(x){return x.id === self.selectedStandortId;});
        if(!s){
            this.selectedStandortId = null;
            return this.rStandorte();
        }
        
        const voelker = this.data.voelker.filter(function(v){return v.standortId === s.id;});
        
        const statusColors = {
            'ok': '#10b981',
            'schwach': '#f59e0b',
            'weisellos': '#8b5cf6',
            'problem': '#ef4444'
        };
        
        const statusLabels = {
            'ok': '‚úÖ Gut',
            'schwach': '‚ö†Ô∏è Schwach',
            'weisellos': 'üëë Weisellos',
            'problem': '‚ùå Problem'
        };
        
        return '<div class="container">'+
        '<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">'+
        '<button class="btn btn-sm" onclick="app.selectedStandortId=null;app.render()">‚Üê Zur√ºck</button>'+
        '<h1 style="margin:0">'+s.name+'</h1>'+
        '</div>'+
        
        '<div class="card">'+
        '<div style="display:flex;justify-content:space-between;align-items:start">'+
        '<div>'+
        (s.notizen ? '<p style="color:#7A6652;margin-bottom:.5rem">'+s.notizen+'</p>' : '')+
        (s.mapsLink ? '<a href="'+s.mapsLink+'" target="_blank" style="font-size:.85rem;color:#3b82f6">üìç In Maps √∂ffnen</a>' : '')+
        '</div>'+
        '<div style="display:flex;gap:.5rem">'+
        '<button class="btn btn-primary btn-xs" onclick="app.openStandortModal(\''+s.id+'\')">‚úèÔ∏è Bearbeiten</button>'+
        '</div>'+
        '</div>'+
        '</div>'+
        
        '<div style="display:flex;justify-content:space-between;align-items:center;margin:1.5rem 0 1rem">'+
        '<h2 style="margin:0">üêù V√∂lker ('+voelker.length+')</h2>'+
        '<div style="display:flex;gap:.5rem">'+
        '<button class="btn btn-danger btn-xs" onclick="if(app.voelkerCount>0){app.voelkerCount='+voelker.length+'-1;app.openStandortModal(\''+s.id+'\');app.saveStandort();}">‚àí Volk</button>'+
        '<button class="btn btn-success btn-xs" onclick="app.voelkerCount='+(voelker.length+1)+';app.openStandortModal(\''+s.id+'\');app.saveStandort();">+ Volk</button>'+
        '</div>'+
        '</div>'+
        
        '<div class="volk-grid">'+
        voelker.map(function(v){
            const statusColor = statusColors[v.status] || statusColors.ok;
            const statusLabel = statusLabels[v.status] || statusLabels.ok;
            
            return '<div class="volk-card" onclick="app.openVolkModal(\''+v.id+'\')">'+
            '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem">'+
            '<h3 style="margin:0;font-size:.95rem">'+v.name+'</h3>'+
            '<div style="width:12px;height:12px;border-radius:50%;background:'+statusColor+'"></div>'+
            '</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-bottom:.25rem">'+v.beutensystem+'</div>'+
            '<div style="font-size:.75rem;margin-bottom:.5rem">'+statusLabel+'</div>'+
            '<div style="background:#FFF8EE;padding:.5rem;border-radius:.5rem;font-size:.75rem">'+
            'üçØ '+(v.honigertrag||0).toFixed(1)+' kg'+
            '</div>'+
            '</div>';
        }).join('')+
        '</div>'+
        
        (!voelker.length ? '<div class="card" style="text-align:center;color:#7A6652">Noch keine V√∂lker an diesem Standort</div>' : '')+
        '</div>';
    },
    
    rAufgaben(){
        const self = this;
        const offen = this.data.aufgaben.filter(function(a){return !a.erledigt;}).sort(function(a,b){return a.faelligkeit - b.faelligkeit;});
        const erledigt = this.data.aufgaben.filter(function(a){return a.erledigt;}).sort(function(a,b){return b.erledigt - a.erledigt;}).slice(0, 10);
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>‚úì Aufgaben</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openAufgabeModal()">+ Neue Aufgabe</button>'+
        '</div>'+
        '<h2>Offen ('+offen.length+')</h2>'+
        offen.map(function(a){
            const pc = a.prio === 'high' ? 'badge-red' : (a.prio === 'medium' ? 'badge-yellow' : 'badge-green');
            const ueberfaellig = Date.now() > a.faelligkeit;
            return '<div class="card" '+(ueberfaellig ? 'style="border-left:4px solid #ef4444"' : '')+'>'+
            '<div style="display:flex;justify-content:space-between;align-items:start">'+
            '<div style="flex:1">'+
            '<div style="font-weight:600;margin-bottom:.25rem">'+a.notiz+'</div>'+
            '<div style="font-size:.8rem;color:#7A6652">'+
            'üìÖ '+self.fd(a.faelligkeit)+' ¬∑ ‚è±Ô∏è '+a.dauer+' Min ¬∑ '+
            '<span class="badge '+pc+'">'+a.prio.toUpperCase()+'</span>'+
            (ueberfaellig ? ' ¬∑ <span class="badge badge-red">√úBERF√ÑLLIG</span>' : '')+
            '</div>'+
            '</div>'+
            '<div style="display:flex;gap:.5rem">'+
            '<button class="btn btn-blue btn-xs" onclick="app.openAufgabeModal(\''+a.id+'\')">‚úèÔ∏è</button>'+
            '<button class="btn btn-success btn-xs" onclick="app.doneA(\''+a.id+'\')">‚úì</button>'+
            '<button class="btn btn-danger btn-xs" onclick="app.del(\'aufgaben\',\''+a.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!offen.length ? '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">Keine offenen Aufgaben üéâ</div>' : '')+
        '<h2 style="margin-top:1.5rem">Erledigt</h2>'+
        erledigt.map(function(a){
            return '<div class="card" style="opacity:.6">'+
            '<div style="display:flex;justify-content:space-between;align-items:start">'+
            '<div style="flex:1">'+
            '<div style="text-decoration:line-through">'+a.notiz+'</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.25rem">‚úì '+self.fd(a.erledigt)+'</div>'+
            '</div>'+
            '<div style="display:flex;gap:.5rem">'+
            '<button class="btn btn-blue btn-xs" onclick="app.undoneA(\''+a.id+'\')" title="Wieder √∂ffnen">‚Ü©Ô∏è</button>'+
            '<button class="btn btn-danger btn-xs" onclick="app.del(\'aufgaben\',\''+a.id+'\')" title="L√∂schen">üóëÔ∏è</button>'+
            '</div>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!erledigt.length ? '<div class="card" style="text-align:center;color:#7A6652">Noch keine erledigten Aufgaben</div>' : '')+
        '</div>';
    },
    
    rZuchtplan(){
        // Zuchtplan ist jetzt eine eigenst√§ndige Seite
        window.location.href = 'zuchtplan.html';
        return '<div class="container" style="text-align:center;padding:3rem"><p>Weiterleitung...</p></div>';
    },
    
    rTracht(){
        window.location.href = 'tracht.html';
        return '<div class="container" style="text-align:center;padding:3rem"><p>Weiterleitung...</p></div>';
    },
    
    
    rErnte(){
        const self = this;
        const gesamtErtrag = this.data.voelker.reduce(function(s,v){return s + (v.honigertrag || 0);}, 0);
        const trachtErtrag = this.data.trachten ? this.data.trachten.reduce(function(s,t){return s + (t.ertrag || 0);}, 0) : 0;
        
        // Group voelker by standort
        var standortMap = {};
        this.data.standorte.forEach(function(s){ standortMap[s.id] = {name:s.name, id:s.id, voelker:[], ertrag:0}; });
        this.data.voelker.forEach(function(v){
            var sid = v.standortId;
            if (!standortMap[sid]) standortMap[sid] = {name:'Ohne Standort', id:sid, voelker:[], ertrag:0};
            standortMap[sid].voelker.push(v);
            standortMap[sid].ertrag += (v.honigertrag||0);
        });
        
        if (!this._ernteOpen) this._ernteOpen = {};
        
        return '<div class="container">'+
        '<h1>üçØ Honigernte</h1>'+
        
        '<div class="card">'+
        '<h3 style="text-align:center;margin-bottom:1rem">Gesamtertrag '+new Date().getFullYear()+'</h3>'+
        '<div style="text-align:center">'+
        '<div style="font-size:3rem;font-weight:bold;color:#F5A623">'+gesamtErtrag.toFixed(1)+' kg</div>'+
        '<div style="font-size:.85rem;color:#7A6652;margin-top:.5rem">Aus '+self.data.voelker.length+' V√∂lkern an '+self.data.standorte.length+' Standorten</div>'+
        '</div>'+
        '</div>'+
        
        (trachtErtrag > 0 ? 
            '<div class="card">'+
            '<h3>Nach Trachten</h3>'+
            '<div style="background:#FFF8EE;padding:.75rem;border-radius:.5rem;margin-top:.5rem">'+
            '<div style="font-size:1.25rem;font-weight:bold">'+trachtErtrag.toFixed(1)+' kg</div>'+
            '<div style="font-size:.75rem;color:#7A6652">Erfasst √ºber Trachten</div>'+
            '</div>'+
            '</div>'
            : ''
        )+
        
        Object.entries(standortMap).map(function(entry){
            var sid = entry[0]; var data = entry[1];
            if (data.voelker.length === 0) return '';
            var isOpen = self._ernteOpen[sid] || false;
            var sortiert = data.voelker.sort(function(a,b){return (b.honigertrag||0) - (a.honigertrag||0);});
            return '<div class="card" style="padding:0;overflow:hidden">'+
            
            // Standort Header - klickbar zum Aufklappen
            '<div onclick="app.toggleErnte(\''+sid+'\')" style="display:flex;justify-content:space-between;align-items:center;padding:1.25rem;cursor:pointer;transition:background .15s;user-select:none" onmouseover="this.style.background=\'#FFF8EE\'" onmouseout="this.style.background=\'\'">'+
            '<div style="display:flex;align-items:center;gap:.75rem">'+
            '<span style="font-size:1.25rem;transition:transform .2s;transform:rotate('+(isOpen?'90':'0')+'deg)">‚ñ∂</span>'+
            '<div>'+
            '<h2 style="margin:0">üìç '+data.name+'</h2>'+
            '<div style="font-size:.8rem;color:#7A6652;margin-top:.25rem">'+data.voelker.length+' V√∂lker ¬∑ Klicken f√ºr Details</div>'+
            '</div>'+
            '</div>'+
            '<div style="text-align:right">'+
            '<div style="font-size:1.75rem;font-weight:bold;color:#F5A623">'+data.ertrag.toFixed(1)+' kg</div>'+
            '</div>'+
            '</div>'+
            
            // Aufklappbarer Bereich
            '<div style="display:'+(isOpen?'block':'none')+';border-top:2px solid #FFFBF0">'+
            
            // Standort-Ertrag schnell eingeben
            '<div style="padding:1rem;background:#FFF8EE">'+
            '<div style="font-weight:600;margin-bottom:.75rem">üçØ Ertrag f√ºr ganzen Standort eintragen</div>'+
            '<div style="display:flex;gap:.5rem;align-items:center">'+
            '<input type="number" id="ernteStandort_'+sid+'" class="input" placeholder="kg gesamt" step="0.1" min="0" style="flex:1;margin:0" value="">'+
            '<button class="btn btn-primary btn-sm" onclick="app.verteilErnteStandort(\''+sid+'\')">Gleichm√§√üig verteilen</button>'+
            '</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.5rem">Wird gleichm√§√üig auf alle '+data.voelker.length+' V√∂lker aufgeteilt</div>'+
            '</div>'+
            
            // Einzelne V√∂lker
            '<div style="padding:.5rem 1rem">'+
            sortiert.map(function(v){
                var pct = gesamtErtrag > 0 ? ((v.honigertrag||0)/gesamtErtrag*100) : 0;
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.75rem 0;border-bottom:1px solid #FFFBF0">'+
                '<div style="flex:1">'+
                '<div style="font-weight:600">'+v.name+'</div>'+
                '<div style="background:#E8DFD4;height:.375rem;border-radius:.25rem;margin-top:.375rem;max-width:200px">'+
                '<div style="background:#F5A623;height:100%;border-radius:.25rem;width:'+Math.min(100,pct)+'%"></div>'+
                '</div>'+
                '</div>'+
                '<div style="display:flex;align-items:center;gap:.5rem">'+
                '<input type="number" style="width:70px;padding:.375rem;border:1px solid #d1d5db;border-radius:.375rem;text-align:right;font-weight:600" value="'+(v.honigertrag||0).toFixed(1)+'" step="0.1" min="0" onchange="app.updateVolkErtrag(\''+v.id+'\',this.value)">'+
                '<span style="font-size:.85rem;color:#7A6652">kg</span>'+
                '</div>'+
                '</div>';
            }).join('')+
            '</div>'+
            '</div>'+
            
            '</div>';
        }).join('')+
        
        (!this.data.standorte.length ? 
            '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">'+
            '<div style="font-size:3rem;margin-bottom:1rem">üçØ</div>'+
            '<p>Erstelle zuerst Standorte und V√∂lker, um Ertr√§ge zu erfassen.</p>'+
            '</div>'
            : ''
        )+
        
        '<div class="info-box" style="margin-top:1rem">'+
        'üí° Du kannst den Ertrag pro Volk direkt bearbeiten oder f√ºr den ganzen Standort auf einmal eingeben.'+
        '</div>'+
        '</div>';
    },
    
    toggleErnte(sid){
        if (!this._ernteOpen) this._ernteOpen = {};
        this._ernteOpen[sid] = !this._ernteOpen[sid];
        this.render();
    },
    
    updateVolkErtrag(vid, val){
        var v = this.data.voelker.find(function(x){return x.id===vid;});
        if (v) {
            v.honigertrag = parseFloat(val) || 0;
            db.update('voelker', {honigertrag: v.honigertrag}, v.id);
        }
    },
    
    verteilErnteStandort(sid){
        var input = document.getElementById('ernteStandort_'+sid);
        var gesamt = parseFloat(input.value);
        if (!gesamt || gesamt <= 0) { alert('Bitte eine g√ºltige kg-Zahl eingeben'); return; }
        var voelker = this.data.voelker.filter(function(v){return v.standortId===sid;});
        if (voelker.length === 0) return;
        var pro = Math.round((gesamt / voelker.length) * 10) / 10;
        voelker.forEach(function(v){
            v.honigertrag = (v.honigertrag||0) + pro;
            db.update('voelker', {honigertrag: v.honigertrag}, v.id);
        });
        input.value = '';
        this.render();
        app.toast('‚úì '+gesamt+' kg auf '+voelker.length+' V√∂lker verteilt (je +'+pro+' kg)','success');
    },
    
    

    /* shareTracht/unshareTracht ‚Üí tracht.html */

    
    rKosten(){
        const self = this;
        const k = this.data.kosten.sort(function(a,b){return b.datum - a.datum;});
        const total = k.reduce(function(s,x){return s + x.betrag;}, 0);
        const byKat = {};
        k.forEach(function(x){
            byKat[x.kat] = (byKat[x.kat] || 0) + x.betrag;
        });
        
        return '<div class="container">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
        '<h1>üí∞ Kosten</h1>'+
        '<button class="btn btn-primary btn-sm" onclick="app.openModal(\'kostenModal\')">+ Neue Ausgabe</button>'+
        '</div>'+
        '<div class="card">'+
        '<div style="text-align:center">'+
        '<div style="font-size:2.5rem;font-weight:bold;color:#1C1410">'+total.toFixed(2)+' ‚Ç¨</div>'+
        '<div style="font-size:.85rem;color:#7A6652">Gesamtausgaben</div>'+
        '</div>'+
        '<div style="margin-top:1rem;padding-top:1rem;border-top:2px solid #FFFBF0">'+
        Object.entries(byKat).sort(function(a,b){return b[1] - a[1];}).map(function(x){
            return '<div style="display:flex;justify-content:space-between;padding:.4rem 0;font-size:.9rem">'+
            '<span>'+x[0]+'</span>'+
            '<strong>'+x[1].toFixed(2)+' ‚Ç¨</strong>'+
            '</div>';
        }).join('')+
        '</div>'+
        '</div>'+
        k.map(function(x){
            return '<div class="card">'+
            '<div style="display:flex;justify-content:space-between;align-items:center">'+
            '<div style="flex:1">'+
            '<div style="font-weight:600">'+x.beschreibung+' ‚Äì '+x.betrag.toFixed(2)+' ‚Ç¨</div>'+
            '<div style="font-size:.75rem;color:#7A6652;margin-top:.25rem">'+x.kat+' ¬∑ '+self.fd(x.datum)+'</div>'+
            '</div>'+
            '<button class="btn btn-danger btn-xs" onclick="app.del(\'kosten\',\''+x.id+'\')">üóëÔ∏è</button>'+
            '</div>'+
            '</div>';
        }).join('')+
        (!k.length ? '<div class="card" style="text-align:center;padding:2rem;color:#7A6652">Noch keine Ausgaben erfasst</div>' : '')+
        '</div>';
    },
    
    rEinst(){
        return '<div class="container">'+
        '<h1>‚öôÔ∏è Einstellungen</h1>'+
        (this.data.user ? 
            '<div class="card">'+
            '<h3>üë§ Profil</h3>'+
            '<div style="font-size:.9rem;color:#7A6652;margin-top:.75rem">'+
            '<div style="margin-bottom:.5rem"><strong>Name:</strong> '+this.data.user.name+'</div>'+
            (this.data.user.imkerei ? '<div style="margin-bottom:.5rem"><strong>Imkerei:</strong> '+this.data.user.imkerei+'</div>' : '')+
            '<div style="margin-bottom:.5rem"><strong>E-Mail:</strong> '+this.data.user.email+' '+
            (this.data.user.emailConfirmed ? '<span class="badge badge-green">‚úì Best√§tigt</span>' : '<span class="badge badge-yellow">Nicht best√§tigt</span>')+
            '</div>'+
            '<div><strong>Registriert:</strong> '+this.fd(this.data.user.registeredAt)+'</div>'+
            '</div>'+
            '</div>' 
            : ''
        )+
        '<div class="card">'+
        '<h3>üìä Statistik</h3>'+
        '<div style="font-size:.9rem;color:#7A6652;margin-top:.75rem">'+
        '<div style="margin-bottom:.4rem">Standorte: <strong>'+this.data.standorte.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">V√∂lker: <strong>'+this.data.voelker.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Aufgaben: <strong>'+this.data.aufgaben.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Zuchtpl√§ne: <strong>'+zuchtplanMod.plaene.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Trachten: <strong>'+trachtkalenderMod.trachten.length+'</strong></div>'+
        '<div style="margin-bottom:.4rem">Kosten: <strong>'+this.data.kosten.length+'</strong></div>'+
        '</div>'+
        '</div>'+
        '<div class="card">'+
        '<h3>üíæ Backup & Wiederherstellung</h3>'+
        '<p style="font-size:.85rem;color:#7A6652;margin:.5rem 0">Vor jeder L√∂schaktion wird automatisch ein Backup erstellt. Du kannst auch manuell Backups erstellen und herunterladen.</p>'+
        '<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem">'+
        '<button class="btn btn-primary btn-sm" onclick="autoBackup.create(\'Manuelles Backup\');app.render()">üíæ Backup jetzt erstellen</button>'+
        '<button class="btn btn-blue btn-sm" onclick="autoBackup.download()">üì• Als Datei speichern</button>'+
        '<button class="btn btn-success btn-sm" onclick="autoBackup.upload()">üì§ Datei hochladen</button>'+
        '</div>'+
        (function(){
            var backups = autoBackup.getAll();
            if (!backups.length) return '<div style="text-align:center;padding:1rem;color:#7A6652;font-size:.85rem">Noch keine Backups vorhanden</div>';
            return '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">'+
            '<div style="font-weight:600;font-size:.9rem">Letzte Backups ('+backups.length+'):</div>'+
            '<button class="btn btn-danger btn-xs" onclick="if(confirm(\'Alle Backups l√∂schen?\')){localStorage.removeItem(\'imkerei_backups\');app.render();}">üóëÔ∏è Alle l√∂schen</button>'+
            '</div>'+
            backups.map(function(b, i){
                var d = new Date(b.datum);
                var datum = d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
                var counts = b.daten ? (b.daten.standorte||[]).length + ' Standorte, ' + (b.daten.voelker||[]).length + ' V√∂lker' : '?';
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:.5rem;background:#FFF8EE;border-radius:.5rem;margin-bottom:.35rem;font-size:.85rem">'+
                '<div><div style="font-weight:500">'+datum+'</div>'+
                '<div style="font-size:.75rem;color:#7A6652">'+b.grund+' ¬∑ '+counts+'</div></div>'+
                '<div style="display:flex;gap:.35rem">'+
                '<button class="btn btn-success btn-xs" onclick="autoBackup.restore('+i+')">‚Ü©Ô∏è</button>'+
                '<button class="btn btn-danger btn-xs" onclick="autoBackup.remove('+i+')">üóëÔ∏è</button>'+
                '</div></div>';
            }).join('');
        })()+
        '</div>'+
        '<div class="card">'+
        '<h3>‚ÑπÔ∏è App-Version</h3>'+
        '<p style="font-size:.9rem;color:#7A6652;margin-top:.5rem">Imkerei Tagesplaner v5.0</p>'+
        '<p style="font-size:.85rem;color:#F5A623;font-weight:600;margin-top:.25rem">Imkerei Durchdenwald üêù</p>'+
        '<p style="font-size:.8rem;color:#10b981;margin-top:.5rem">‚òÅÔ∏è Cloud-Version ‚Äì Daten sicher gespeichert</p>'+
        '</div>'+
        '<div class="card">'+
        '<button class="btn btn-danger btn-block" onclick="doLogout()">üö™ Abmelden</button>'+
        '</div>'+
        '</div>';
    },
    

    rPackliste(){
        var stats = packlisteMod.getStatistik();
        var grouped = {};
        packlisteMod.items.forEach(function(item) {
            if (!grouped[item.kategorie]) grouped[item.kategorie] = [];
            grouped[item.kategorie].push(item);
        });
        
        var kategorieHtml = '';
        Object.entries(grouped).forEach(function(entry) {
            var kategorie = entry[0]; var items = entry[1];
            var abgehakt = items.filter(function(i){return i.checked;}).length;
            kategorieHtml += '<div class="pack-kategorie"><h3>'+kategorie+' <small style="color:#7A6652;font-weight:normal">('+abgehakt+'/'+items.length+')</small></h3>';
            items.forEach(function(item) {
                var menge = item.menge || 1;
                kategorieHtml += '<div class="pack-item-row"><div class="pack-item-main">'+
                    '<input type="checkbox" class="pack-checkbox" '+(item.checked?'checked':'')+' onchange="packlisteMod.toggle(\''+item.id+'\')">'+
                    '<span class="pack-label '+(item.checked?'checked':'')+'" onclick="packlisteMod.toggle(\''+item.id+'\')">'+(menge>1?'<strong>'+menge+'x</strong> ':'')+item.name+'</span>'+
                    '</div><div class="pack-item-controls">'+
                    '<div class="menge-counter"><button class="menge-btn" onclick="packlisteMod.changeMenge(\''+item.id+'\',-1)">‚àí</button><span class="menge-value">'+menge+'</span><button class="menge-btn" onclick="packlisteMod.changeMenge(\''+item.id+'\',1)">+</button></div>'+
                    '<button class="btn-del" onclick="packlisteMod.loescheItem(\''+item.id+'\')">üóëÔ∏è</button>'+
                    '</div></div>';
            });
            kategorieHtml += '</div>';
        });
        
        return '<div class="container">'+
        '<h1>üìã Imkerei Packliste</h1>'+
        '<div class="info-box">‚ú® <strong>Vollst√§ndige Packliste</strong> - einfach abhaken! Schnell-Buttons f√ºgen ganze Sets hinzu.</div>'+
        '<h2 style="margin-top:0">‚ö° Schnell hinzuf√ºgen</h2>'+
        '<h3 style="font-size:.9rem;color:#7A6652;margin-bottom:.75rem">üè† Beuten & Material</h3>'+
        '<div class="schnell-grid">'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'ableger\')"><div class="schnell-icon">üì¶</div><div class="schnell-label">Ablegerkasten</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'dadant\')"><div class="schnell-icon">üè†</div><div class="schnell-label">Dadant Beute</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'raehmchen\')"><div class="schnell-icon">ü™µ</div><div class="schnell-label">10 R√§hmchen</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'mittelwaende\')"><div class="schnell-icon">‚ñ≠</div><div class="schnell-label">10 Mittelw√§nde</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'boden\')"><div class="schnell-icon">‚¨ú</div><div class="schnell-label">Boden</div></button>'+
        '<button class="schnell-btn" onclick="packlisteMod.schnellHinzufuegen(\'zarge\')"><div class="schnell-icon">üì¶</div><div class="schnell-label">Zarge</div></button>'+
        '</div>'+
        '<h3 style="font-size:.9rem;color:#7A6652;margin:.75rem 0">üîß Arbeits-Equipment</h3>'+
        '<div class="schnell-grid">'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'schutz\')"><div class="schnell-icon">üß•</div><div class="schnell-label">Schutzausr√ºstung</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'werkzeug\')"><div class="schnell-icon">üîß</div><div class="schnell-label">Werkzeug-Set</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'smoker\')"><div class="schnell-icon">üí®</div><div class="schnell-label">Smoker-Paket</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'ernte\')"><div class="schnell-icon">üçØ</div><div class="schnell-label">Ernte-Set</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'behandlung_set\')"><div class="schnell-icon">üíâ</div><div class="schnell-label">Behandlungs-Set</div></button>'+
        '<button class="schnell-btn schnell-equipment" onclick="packlisteMod.schnellHinzufuegen(\'futter\')"><div class="schnell-icon">üçØ</div><div class="schnell-label">Futter-Set</div></button>'+
        '</div>'+
        '<div style="display:flex;gap:.75rem;margin-bottom:1.5rem">'+
        '<button class="btn btn-success" style="flex:1" onclick="packlisteMod.alleAbhaken()">‚úì Alle abhaken</button>'+
        '<button class="btn btn-blue" style="flex:1" onclick="packlisteMod.alleZuruecksetzen()">‚Ü∫ Zur√ºcksetzen</button>'+
        '<button class="btn btn-danger" style="flex:1" onclick="packlisteMod.allesLoeschen()">üóëÔ∏è Alles l√∂schen</button>'+
        '</div>'+
        '<div style="margin-bottom:1.5rem">'+
        '<button class="btn btn-primary" style="width:100%" onclick="packlisteMod.drucken()">üñ®Ô∏è Packliste drucken</button>'+
        '</div>'+
        '<div class="stats">'+
        '<div class="stat-card"><div class="stat-number">'+stats.abgehakt+'</div><div class="stat-label">Abgehakt</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+stats.offen+'</div><div class="stat-label">Offen</div></div>'+
        '<div class="stat-card"><div class="stat-number">'+stats.gesamt+'</div><div class="stat-label">Gesamt</div></div>'+
        '</div>'+
        kategorieHtml+
        '</div>';
    },
    
    /* rTrachtkalender ‚Üí tracht.html */

    
    rZuchtplanEnhanced(){
        // Zuchtplan ist jetzt eine eigenst√§ndige Seite
        window.location.href = 'zuchtplan.html';
        return '<div class="container" style="max-width:900px;text-align:center;padding:3rem"><div style="font-size:3rem;margin-bottom:1rem">üëë</div><p>Weiterleitung zur K√∂niginnenzucht...</p></div>';
    },
    
    rBehandlungen(){
        window.location.href = 'behandlung.html';
        return '<div class="container" style="text-align:center;padding:3rem"><p>Weiterleitung...</p></div>';
    },
    
    
    rDatenexport(){
        var self = this;
        return '<div class="container">'+
        '<h1>üìä Datenexport</h1>'+
        '<div class="card">'+
        '<h3>üìã Daten als JSON exportieren</h3>'+
        '<p style="font-size:.9rem;color:#7A6652;margin:.75rem 0">Exportiere alle deine Imkerei-Daten als JSON-Datei zur Sicherung.</p>'+
        '<button class="btn btn-primary btn-block" onclick="(function(){var d=JSON.stringify(app.data,null,2);var b=new Blob([d],{type:\'application/json\'});var a=document.createElement(\'a\');a.href=URL.createObjectURL(b);a.download=\'imkerei_backup_\'+new Date().toISOString().split(\'T\')[0]+\'.json\';a.click();app.toast(\'‚úì Export erfolgreich!\',\'success\');})()">üì• Daten exportieren (JSON)</button>'+
        '</div>'+
        '<div class="card">'+
        '<h3>üìä Statistik-√úbersicht</h3>'+
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-top:.75rem">'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+this.data.standorte.length+'</div><div style="font-size:.75rem;color:#7A6652">Standorte</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+this.data.voelker.length+'</div><div style="font-size:.75rem;color:#7A6652">V√∂lker</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+zuchtplanMod.plaene.length+'</div><div style="font-size:.75rem;color:#7A6652">Zuchtpl√§ne</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+behandlungMod.behandlungen.length+'</div><div style="font-size:.75rem;color:#7A6652">Behandlungen</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+trachtkalenderMod.trachten.length+'</div><div style="font-size:.75rem;color:#7A6652">Trachten</div></div>'+
        '<div style="text-align:center;padding:1rem;background:#FFF8EE;border-radius:.75rem"><div style="font-size:1.5rem;font-weight:bold">'+packlisteMod.items.length+'</div><div style="font-size:.75rem;color:#7A6652">Packlisten-Items</div></div>'+
        '</div></div></div>';
    },
    
    rPlaceholder(){
        return '<div class="container">'+
        '<h1>üöß In Entwicklung</h1>'+
        '<div class="card" style="text-align:center;padding:3rem">'+
        '<div style="font-size:4rem;margin-bottom:1rem">üêù</div>'+
        '<p style="color:#7A6652">Diese Funktion wird bald verf√ºgbar sein!</p>'+
        '</div>'+
        '</div>';
    },
    
    del(col, id){
        if(!confirm('Wirklich l√∂schen?')) return;
        var item = this.data[col] ? this.data[col].find(function(x){return x.id === id;}) : null;
        autoBackup.create(col + ' gel√∂scht: ' + (item ? (item.notiz || item.beschreibung || item.name || id) : id));
        this.data[col] = this.data[col].filter(function(x){return x.id !== id;});
        db.del(col, id);
        this.render();
    }
};


// ============================================
// MODUL: PACKLISTE
// ============================================
const PACKLISTE_ITEMS = {
    'Schutzkleidung': ['Imkeranzug / Imkerjacke','Imkerhandschuhe','Imkerhut mit Schleier','Feste Schuhe / Stiefel'],
    'Werkzeuge': ['Stockmei√üel','Smoker (Raucher)','Abkehrbesen','Wabenzange','Entdeckelungsgabel','Stockkarte & Stift','Messer / Entdeckelungsmesser'],
    'Rauchmaterial': ['Holzsp√§ne / Holzpellets','Heu / Stroh','Karton / Eierkarton','Anz√ºnder','Feuerzeug / Streichh√∂lzer'],
    'Futter': ['Futterteig (Apifonda)','Zuckerwasser','Futtertaschen','Futterzarge'],
    'Behandlung': ['Ameisens√§ure','Oxals√§ure','Puderzucker (f√ºr Diagnose)','Diagnosebrett / Windel','Schutzhandschuhe f√ºr S√§ure','Dosierer / Verdampfer'],
    'Material': ['R√§hmchen','Mittelw√§nde','Absperrgitter','Fluglochkeil','M√§usegitter','Draht zum Einl√∂ten'],
    'Ernte': ['Honigschleuder','Entdeckelungsgeschirr','Sieb (doppelt)','Honigeimer / Hobbock','Honigrefraktometer','Gl√§ser & Deckel','Etiketten'],
    'Beuten & Zargen': ['Boden / Bodenbrett','Brutraum(zarge)','Honigraum(zarge)','Absperrgitter','Innendeckel','Au√üendeckel / Blechdeckel'],
    'Sonstiges': ['Erste-Hilfe-Set','Wasser / Getr√§nk','Transportbox / Kiste','M√ºllsack','Desinfektionsmittel','Handy / Kamera']
};

// ============================================
// WETTER MODUL (Open-Meteo, 14 Tage)
// ============================================
const wetterMod = {
    daten: null,
    datenProStandort: {},
    loading: false,
    error: null,
    letzterAbruf: null,
    customOrt: null,
    customLat: null,
    customLng: null,
    _karte: null,
    _marker: null,
    
    getStandortKoords(){
        // Zuerst custom Ort aus Profil
        if (this.customLat && this.customLng) {
            return {lat: this.customLat, lng: this.customLng, name: this.customOrt || 'Mein Standort'};
        }
        // Fallback: Ersten Standort mit Koordinaten nehmen
        var standorte = app.data.standorte || [];
        for (var i=0; i<standorte.length; i++) {
            if (standorte[i].lat && standorte[i].lng) return {lat:standorte[i].lat, lng:standorte[i].lng, name:standorte[i].name};
        }
        return null;
    },
    
    async ortAendern(){
        document.getElementById('wetterOrtModal').classList.add('active');
        var liste = document.getElementById('wetterStandortListe');
        var standorte = app.data.standorte || [];
        var gpsStandorte = standorte.filter(function(s){ return s.lat && s.lng; });
        if (gpsStandorte.length > 0) {
            var html = '';
            gpsStandorte.forEach(function(s){
                var istAktiv = wetterMod.customOrt === s.name;
                html += '<button class="btn '+(istAktiv?'btn-primary':'btn-outline')+' btn-sm" style="margin:.25rem" onclick="wetterMod.ortWaehlen(\''+s.name+'\','+s.lat+','+s.lng+')">üìç '+s.name+'</button>';
            });
            liste.innerHTML = html;
        } else {
            liste.innerHTML = '<div style="font-size:.8rem;color:#94a3b8">Keine Standorte mit GPS vorhanden</div>';
        }
        document.getElementById('wetterSuchErgebnis').innerHTML = '';
        document.getElementById('wetterOrtSuche').value = '';
        document.getElementById('wetterKarteInfo').innerHTML = 'Klicke auf die Karte um einen Standort zu w√§hlen';
        setTimeout(function(){
            var container = document.getElementById('wetterKarte');
            if (wetterMod._karte) { wetterMod._karte.remove(); wetterMod._karte = null; }
            var startLat = wetterMod.customLat || 49.0;
            var startLng = wetterMod.customLng || 8.4;
            var karte = L.map('wetterKarte').setView([startLat, startLng], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'¬© OSM', maxZoom:18}).addTo(karte);
            wetterMod._karte = karte;
            wetterMod._marker = null;
            if (wetterMod.customLat && wetterMod.customLng) {
                wetterMod._marker = L.marker([wetterMod.customLat, wetterMod.customLng]).addTo(karte);
            }
            gpsStandorte.forEach(function(s){
                L.circleMarker([s.lat, s.lng], {radius:6, color:'#F5A623', fillColor:'#F5A623', fillOpacity:0.8}).bindTooltip(s.name).addTo(karte);
            });
            karte.on('click', async function(e){
                var lat = e.latlng.lat;
                var lng = e.latlng.lng;
                if (wetterMod._marker) karte.removeLayer(wetterMod._marker);
                wetterMod._marker = L.marker([lat, lng]).addTo(karte);
                var ortName = 'Standort ('+lat.toFixed(4)+', '+lng.toFixed(4)+')';
                document.getElementById('wetterKarteInfo').innerHTML = 'üìç '+ortName+' <button class="btn btn-primary btn-sm" style="margin-left:.5rem" onclick="wetterMod.ortWaehlen(\''+ortName+'\','+lat+','+lng+')">‚úì √úbernehmen</button>';
            });
        }, 300);
    },
    
    async ortSuchen(){
        var ort = document.getElementById('wetterOrtSuche').value.trim();
        if (!ort) return;
        var ergebnis = document.getElementById('wetterSuchErgebnis');
        ergebnis.innerHTML = '‚è≥ Suche...';
        try {
            var resp = await fetch('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(ort)+'&count=5&language=de');
            var data = await resp.json();
            if (!data.results || data.results.length === 0) {
                ergebnis.innerHTML = '<div style="color:#ef4444;font-size:.85rem">Kein Ergebnis f√ºr "'+ort+'"</div>';
                return;
            }
            var html = '';
            data.results.forEach(function(r){
                var label = r.name + (r.admin1 ? ', '+r.admin1 : '') + (r.country ? ' ('+r.country+')' : '');
                html += '<button class="btn btn-outline btn-sm" style="margin:.25rem;display:block;width:100%;text-align:left" onclick="wetterMod.ortWaehlen(\''+r.name.replace(/'/g,"\\'")+'\','+r.latitude+','+r.longitude+')">üìç '+label+'</button>';
            });
            ergebnis.innerHTML = html;
        } catch(e) {
            ergebnis.innerHTML = '<div style="color:#ef4444;font-size:.85rem">Fehler bei der Suche</div>';
        }
    },
    
    async ortWaehlen(name, lat, lng){
        this.customOrt = name;
        this.customLat = lat;
        this.customLng = lng;
        await sb.from('profiles').update({wetter_ort: name, wetter_lat: lat, wetter_lng: lng}).eq('id', currentUser.id);
        document.getElementById('wetterOrtModal').classList.remove('active');
        if (this._karte) { this._karte.remove(); this._karte = null; }
        this.daten = null;
        this.letzterAbruf = null;
        await this.laden();
        app.render();
        app.toast('‚úÖ Wetter-Standort: '+name, 'success');
    },
    
    async ladenFuerStandort(standortId, lat, lng){
        var key = standortId;
        var cached = this.datenProStandort[key];
        if (cached && cached._ts && (Date.now() - cached._ts < 30*60*1000)) return cached;
        try {
            var url = 'https://api.open-meteo.com/v1/forecast?latitude='+lat+'&longitude='+lng+
                '&current=temperature_2m,weather_code,wind_speed_10m'+
                '&timezone=Europe%2FBerlin';
            var resp = await fetch(url);
            var data = await resp.json();
            data._ts = Date.now();
            this.datenProStandort[key] = data;
            return data;
        } catch(e) { return null; }
    },
    
    async laden(){
        var koords = this.getStandortKoords();
        if (!koords) { this.error = 'nostandort'; return; }
        
        // Nur alle 30 Min neu laden
        if (this.daten && this.letzterAbruf && (Date.now() - this.letzterAbruf < 30*60*1000)) return;
        
        this.loading = true;
        this.error = null;
        try {
            var url = 'https://api.open-meteo.com/v1/forecast?latitude='+koords.lat+'&longitude='+koords.lng+
                '&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weather_code,wind_speed_10m_max'+
                '&current=temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m'+
                '&timezone=Europe%2FBerlin&forecast_days=14';
            var resp = await fetch(url);
            var data = await resp.json();
            this.daten = data;
            this.daten._standortName = koords.name;
            this.letzterAbruf = Date.now();
            this.error = null;
        } catch(e) {
            this.error = 'fetch';
            console.error('Wetter-Fehler:', e);
        }
        this.loading = false;
        
        // Auch f√ºr alle Standorte mit GPS laden
        var standorte = app.data.standorte || [];
        for (var i=0; i<standorte.length; i++) {
            var s = standorte[i];
            if (s.lat && s.lng) {
                this.ladenFuerStandort(s.id, s.lat, s.lng);
            }
        }
    },
    
    renderMini(standortId){
        var data = this.datenProStandort[standortId];
        if (!data || !data.current) return '';
        var c = data.current;
        var flug = this.bienenFlugWetter(c.temperature_2m, 0, c.wind_speed_10m);
        return '<div style="display:flex;align-items:center;gap:.5rem;margin-top:.5rem;padding:.5rem;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:.5rem;font-size:.8rem">'+
            '<span style="font-size:1.25rem">'+this.wetterIcon(c.weather_code)+'</span>'+
            '<span style="font-weight:600">'+Math.round(c.temperature_2m)+'¬∞C</span>'+
            '<span style="color:#7A6652">üí®'+Math.round(c.wind_speed_10m)+'km/h</span>'+
            '<span style="font-size:.75rem;font-weight:600;color:'+flug.color+';margin-left:auto">'+flug.label+'</span>'+
            '</div>';
    },
    
    wetterIcon(code){
        if (code <= 1) return '‚òÄÔ∏è';
        if (code <= 3) return '‚õÖ';
        if (code <= 48) return '‚òÅÔ∏è';
        if (code <= 57) return 'üåßÔ∏è';
        if (code <= 67) return 'üåßÔ∏è';
        if (code <= 77) return 'üå®Ô∏è';
        if (code <= 82) return 'üåßÔ∏è';
        if (code <= 86) return 'üå®Ô∏è';
        if (code <= 99) return '‚õàÔ∏è';
        return 'üå§Ô∏è';
    },
    
    wetterText(code){
        if (code === 0) return 'Klar';
        if (code <= 3) return 'Bew√∂lkt';
        if (code <= 48) return 'Nebel';
        if (code <= 57) return 'Niesel';
        if (code <= 67) return 'Regen';
        if (code <= 77) return 'Schnee';
        if (code <= 82) return 'Schauer';
        if (code <= 86) return 'Schneeschauer';
        if (code <= 99) return 'Gewitter';
        return '?';
    },
    
    bienenFlugWetter(tMax, niederschlag, wind){
        // Bienen fliegen ab ~12¬∞C, nicht bei starkem Regen/Wind
        if (tMax >= 15 && niederschlag < 1 && wind < 30) return {status:'gut', label:'üêù Gutes Flugwetter', color:'#10b981'};
        if (tMax >= 12 && niederschlag < 5 && wind < 40) return {status:'ok', label:'üêù Bedingt Flugwetter', color:'#f59e0b'};
        return {status:'schlecht', label:'‚ùå Kein Flugwetter', color:'#ef4444'};
    },
    
    render(){
        try {
        if (this.error === 'nostandort') return '<div class="card" style="border-left:4px solid #7A6652">'+
            '<h2 style="margin:0 0 .5rem">üå§Ô∏è Wetter</h2>'+
            '<div style="color:#7A6652;font-size:.85rem">Lege einen Standort mit GPS-Position an, um Wetterdaten zu sehen.</div></div>';
        if (this.loading && !this.daten) return '<div class="card"><h2 style="margin:0 0 .5rem">üå§Ô∏è Wetter</h2><div style="color:#7A6652">Laden...</div></div>';
        if (this.error === 'fetch') return '<div class="card"><h2 style="margin:0 0 .5rem">üå§Ô∏è Wetter</h2><div style="color:#ef4444;font-size:.85rem">Wetterdaten konnten nicht geladen werden.</div></div>';
        if (!this.daten) return '';
        
        var d = this.daten;
        var c = d.current;
        var daily = d.daily;
        var standortName = d._standortName || 'Standort';
        var self = this;
        
        // Aktuelles Wetter
        var jetztFlug = this.bienenFlugWetter(c.temperature_2m, 0, c.wind_speed_10m);
        
        var html = '<div class="card" style="border-left:4px solid #0ea5e9">'+
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">'+
            '<h2 style="margin:0">üå§Ô∏è Wetter</h2>'+
            '<span style="font-size:.75rem;color:#7A6652;cursor:pointer" onclick="wetterMod.ortAendern()" title="Ort √§ndern">üìç '+standortName+' ‚úèÔ∏è</span>'+
            '</div>'+
            
            // Aktuell
            '<div style="display:flex;align-items:center;gap:1rem;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);padding:1rem;border-radius:.75rem;margin-bottom:1rem">'+
            '<div style="font-size:2.5rem">'+this.wetterIcon(c.weather_code)+'</div>'+
            '<div style="flex:1">'+
            '<div style="font-size:1.5rem;font-weight:700">'+Math.round(c.temperature_2m)+'¬∞C</div>'+
            '<div style="font-size:.8rem;color:#7A6652">'+this.wetterText(c.weather_code)+' ¬∑ üí® '+Math.round(c.wind_speed_10m)+' km/h ¬∑ üíß '+c.relative_humidity_2m+'%</div>'+
            '</div>'+
            '<div style="text-align:right;font-size:.8rem;font-weight:600;color:'+jetztFlug.color+'">'+jetztFlug.label+'</div>'+
            '</div>'+
            
            // 14-Tage Vorschau
            '<div style="overflow-x:auto;margin:0 -.25rem">'+
            '<div style="display:flex;gap:.5rem;padding:.25rem">';
        
        for (var i=0; i<daily.time.length; i++) {
            var datum = new Date(daily.time[i]);
            var tag = datum.toLocaleDateString('de-DE',{weekday:'short'});
            var tagNum = datum.getDate()+'.'+(datum.getMonth()+1)+'.';
            var tMax = Math.round(daily.temperature_2m_max[i]);
            var tMin = Math.round(daily.temperature_2m_min[i]);
            var niederschlag = daily.precipitation_sum[i];
            var wind = daily.wind_speed_10m_max[i];
            var code = daily.weather_code[i];
            var flug = this.bienenFlugWetter(tMax, niederschlag, wind);
            var isHeute = i === 0;
            
            html += '<div style="min-width:72px;text-align:center;padding:.5rem .375rem;border-radius:.5rem;'+
                'background:'+(isHeute?'#dbeafe':'#FFF8EE')+';border:1px solid '+(isHeute?'#93c5fd':'#E8DFD4')+
                ';flex-shrink:0">'+
                '<div style="font-size:.7rem;font-weight:600;color:'+(isHeute?'#2563eb':'#7A6652')+'">'+
                (isHeute?'Heute':tag)+'</div>'+
                '<div style="font-size:.65rem;color:#A69580">'+tagNum+'</div>'+
                '<div style="font-size:1.25rem;margin:.25rem 0">'+this.wetterIcon(code)+'</div>'+
                '<div style="font-size:.8rem;font-weight:700">'+tMax+'¬∞</div>'+
                '<div style="font-size:.7rem;color:#A69580">'+tMin+'¬∞</div>'+
                (niederschlag > 0 ? '<div style="font-size:.65rem;color:#3b82f6;margin-top:.125rem">üíß'+niederschlag.toFixed(1)+'</div>' : '')+
                '<div style="width:8px;height:8px;border-radius:50%;background:'+flug.color+';margin:.25rem auto 0" title="'+flug.label+'"></div>'+
                '</div>';
        }
        
        html += '</div></div>'+
            '<div style="display:flex;align-items:center;gap:.75rem;margin-top:.75rem;font-size:.7rem;color:#A69580">'+
            '<span>üü¢ Flugwetter</span><span>üü° Bedingt</span><span>üî¥ Kein Flug</span>'+
            '</div>'+
            '</div>';
        
        return html;
        } catch(e) { console.error('Wetter render Fehler:', e); return ''; }
    }
};

const packlisteMod = {
    items: [],
    schnellCounter: {},
    
    init() {
        // Daten werden in startApp() aus Supabase geladen
        // localStorage wird nicht mehr verwendet
    },
    
    erstelleNeueItems() {
        this.items = [];
        this.schnellCounter = {};
        Object.entries(PACKLISTE_ITEMS).forEach(function(entry) {
            var kategorie = entry[0]; var items = entry[1];
            items.forEach(function(name) {
                packlisteMod.items.push({
                    id: 'pack_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    kategorie: kategorie, name: name, checked: false, istSchnell: false
                });
            });
        });
        this.speichern();
    },
    
    speichern() {
        if (!currentUser) { console.warn('[Packliste] speichern: kein User'); return; }
        var rows = this.items.map(function(item){
            return {
                id: item.id,
                user_id: currentUser.id,
                kategorie: item.kategorie,
                name: item.name,
                checked: item.checked || false,
                menge: item.menge || 1,
                ist_schnell: item.istSchnell || false,
                schnell_typ: item.schnellTyp || null
            };
        });
        console.log('[Packliste] speichern() aufgerufen, ' + rows.length + ' Items');
        if (rows.length > 0) {
            sb.from('packliste').upsert(rows).then(function(res){
                if (res.error) console.error('[Packliste] ‚ùå Speichern Fehler:', res.error);
                else console.log('[Packliste] ‚úÖ ' + rows.length + ' Items in Supabase gespeichert');
            });
        }
    },
    
    toggle(id) {
        var item = this.items.find(function(i){return i.id === id;});
        if (item) { 
            item.checked = !item.checked; 
            console.log('[Packliste] Toggle:', id, '‚Üí checked:', item.checked);
            // Upsert statt update - damit wird der Datensatz angelegt falls er fehlt
            var row = {
                id: item.id,
                user_id: currentUser.id,
                kategorie: item.kategorie,
                name: item.name,
                checked: item.checked,
                menge: item.menge || 1,
                ist_schnell: item.istSchnell || false,
                schnell_typ: item.schnellTyp || null
            };
            sb.from('packliste').upsert(row).select()
                .then(function(res){
                    if(res.error) console.error('[Packliste] ‚ùå', res.error.message);
                    else if(!res.data || res.data.length === 0) console.warn('[Packliste] ‚ö†Ô∏è Kein Datensatz!');
                    else console.log('[Packliste] ‚úÖ Gespeichert');
                });
            app.render(); 
        }
    },
    
    changeMenge(id, delta) {
        var item = this.items.find(function(i){return i.id === id;});
        if (item) { 
            if (!item.menge) item.menge = 1; 
            item.menge = Math.max(1, item.menge + delta); 
            this.speichern(); 
            db.update('packliste', {menge: item.menge}, id);
            app.render(); 
        }
    },
    
    loescheItem(id) {
        console.log('[Packliste] L√∂sche Item:', id);
        this.items = this.items.filter(function(i){return i.id !== id;});
        sb.from('packliste').delete().eq('id', id)
            .then(function(res){
                console.log('[Packliste] Delete Response:', res.data, 'error:', res.error);
                if(res.error) console.error('[Packliste] ‚ùå L√∂sch-Fehler:', res.error.message);
                else console.log('[Packliste] ‚úÖ Gel√∂scht aus Supabase');
            });
        app.render(); 
        app.toast('üóëÔ∏è Gel√∂scht','info');
    },
    
    alleAbhaken() { this.items.forEach(function(item){item.checked = true; db.update('packliste', {checked: true}, item.id);}); app.render(); },
    alleZuruecksetzen() { this.items.forEach(function(item){item.checked = false; db.update('packliste', {checked: false}, item.id);}); app.render(); },
    
    allesLoeschen() {
        if (!confirm('Wirklich die KOMPLETTE Packliste l√∂schen?')) return;
        this.items.forEach(function(item){ db.del('packliste', item.id); });
        this.items = [];
        this.schnellCounter = {};
        app.render();
        app.toast('üóëÔ∏è Packliste gel√∂scht','info');
    },
    
    schnellHinzufuegen(typ) {
        var existierend = this.items.filter(function(i){return i.schnellTyp === typ;});
        if (existierend.length > 0) {
            this.items = this.items.filter(function(i){return i.schnellTyp !== typ;});
            this.speichern(); app.render(); app.toast('‚ùå Entfernt','info'); return;
        }
        var self = this;
        var sets = {
            'schutz': [['Schutzkleidung','üß• Schutzausr√ºstung komplett'],['Schutzkleidung','  ‚Üí Imkeranzug/Jacke'],['Schutzkleidung','  ‚Üí Imkerhandschuhe'],['Schutzkleidung','  ‚Üí Imkerhut mit Schleier']],
            'werkzeug': [['Werkzeuge','üîß Werkzeug-Set komplett'],['Werkzeuge','  ‚Üí Stockmei√üel'],['Werkzeuge','  ‚Üí Abkehrbesen'],['Werkzeuge','  ‚Üí Wabenzange']],
            'smoker': [['Rauchmaterial','üí® Smoker-Paket komplett'],['Werkzeuge','  ‚Üí Smoker (Raucher)'],['Rauchmaterial','  ‚Üí Holzsp√§ne/Pellets'],['Rauchmaterial','  ‚Üí Anz√ºnder']],
            'ernte': [['Ernte','üçØ Ernte-Set komplett'],['Ernte','  ‚Üí Honigschleuder'],['Ernte','  ‚Üí Entdeckelungsgeschirr'],['Ernte','  ‚Üí Sieb (doppelt)'],['Ernte','  ‚Üí Honigeimer'],['Ernte','  ‚Üí Gl√§ser & Deckel']],
            'behandlung_set': [['Behandlung','üíâ Behandlungs-Set komplett'],['Behandlung','  ‚Üí Ameisens√§ure'],['Behandlung','  ‚Üí Oxals√§ure'],['Behandlung','  ‚Üí Puderzucker'],['Behandlung','  ‚Üí Schutzhandschuhe']],
            'futter': [['Futter','üçØ Futter-Set komplett'],['Futter','  ‚Üí Futterteig'],['Futter','  ‚Üí Zuckerwasser'],['Futter','  ‚Üí Futterzarge']],
            'ableger': [['Material','üì¶ Ablegerkasten komplett'],['Material','  ‚Üí Boden'],['Material','  ‚Üí Brutzarge'],['Material','  ‚Üí Deckel'],['Material','  ‚Üí 6 R√§hmchen']],
            'dadant': [['Beuten & Zargen','üè† Dadant Beute komplett'],['Beuten & Zargen','  ‚Üí Boden'],['Beuten & Zargen','  ‚Üí Brutraum'],['Beuten & Zargen','  ‚Üí Honigraum'],['Beuten & Zargen','  ‚Üí Deckel']],
            'raehmchen': [['Material','ü™µ 10x R√§hmchen']],
            'mittelwaende': [['Material','‚ñ≠ 10x Mittelw√§nde']],
            'boden': [['Beuten & Zargen','‚¨ú Boden']],
            'deckel': [['Beuten & Zargen','üî≤ Deckel']],
            'zarge': [['Beuten & Zargen','üì¶ Zarge']]
        };
        var items = sets[typ] || [];
        items.forEach(function(x) {
            self.items.push({id:'schnell_'+Date.now()+'_'+Math.random().toString(36).substr(2,9), kategorie:x[0], name:x[1], checked:false, istSchnell:true, schnellTyp:typ});
        });
        this.speichern(); app.render(); app.toast('‚úì Hinzugef√ºgt','success');
    },
    
    getStatistik() {
        var abgehakt = this.items.filter(function(i){return i.checked;}).length;
        return { abgehakt: abgehakt, offen: this.items.length - abgehakt, gesamt: this.items.length };
    },
    
    drucken() {
        var grouped = {};
        this.items.forEach(function(item) {
            if (!grouped[item.kategorie]) grouped[item.kategorie] = [];
            grouped[item.kategorie].push(item);
        });
        
        var datum = new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'long',year:'numeric'});
        var stats = this.getStatistik();
        
        var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Packliste - Imkerei</title>';
        html += '<style>';
        html += 'body{font-family:Arial,sans-serif;max-width:700px;margin:0 auto;padding:1.5rem;color:#333}';
        html += 'h1{font-size:1.5rem;border-bottom:2px solid #F5A623;padding-bottom:.5rem;margin-bottom:.25rem}';
        html += '.datum{font-size:.85rem;color:#666;margin-bottom:1.5rem}';
        html += '.stats{font-size:.9rem;color:#666;margin-bottom:1rem}';
        html += 'h2{font-size:1.1rem;margin:1.25rem 0 .5rem;color:#1C1410;border-bottom:1px solid #eee;padding-bottom:.25rem}';
        html += '.item{display:flex;align-items:center;gap:.5rem;padding:.3rem 0;border-bottom:1px dotted #ddd}';
        html += '.checkbox{width:14px;height:14px;border:2px solid #999;border-radius:2px;flex-shrink:0}';
        html += '.checkbox.checked{background:#10b981;border-color:#10b981}';
        html += '.name{flex:1;font-size:.9rem}';
        html += '.checked-text{text-decoration:line-through;color:#999}';
        html += '.menge{font-size:.8rem;color:#666;min-width:40px;text-align:right}';
        html += '@media print{body{padding:.5rem}}';
        html += '</style></head><body>';
        html += '<h1>üêù Imkerei Packliste</h1>';
        html += '<div class="datum">'+datum+'</div>';
        html += '<div class="stats">'+stats.abgehakt+' von '+stats.gesamt+' abgehakt ¬∑ '+stats.offen+' offen</div>';
        
        Object.entries(grouped).forEach(function(entry){
            var kat = entry[0]; var items = entry[1];
            var abgehakt = items.filter(function(i){return i.checked;}).length;
            html += '<h2>'+kat+' ('+abgehakt+'/'+items.length+')</h2>';
            items.forEach(function(item){
                var menge = item.menge || 1;
                html += '<div class="item">';
                html += '<div class="checkbox'+(item.checked?' checked':'')+'"></div>';
                html += '<div class="name'+(item.checked?' checked-text':'')+'">'+(menge>1?menge+'x ':'')+item.name+'</div>';
                html += '</div>';
            });
        });
        
        html += '</body></html>';
        
        var win = window.open('','_blank');
        win.document.write(html);
        win.document.close();
        setTimeout(function(){ win.print(); }, 300);
    }
};

// ============================================
// MODUL: TRACHTKALENDER (Mini-Helfer f√ºr Heute-Seite + Export)
// Vollst√§ndige Verwaltung ‚Üí tracht.html
// ============================================
const trachtkalenderMod = {
    trachten: [],
    ausgeblendete: [],
    kalenderOffen: false,
    init() { this.trachten = []; this.ausgeblendete = []; },
    formatDatum(ts) { if (!ts) return '-'; return new Date(ts).toLocaleDateString('de-DE'); }
};


// ============================================
// MODUL: ZUCHTPLAN (nur Daten-Helfer f√ºr Heute-Seite)
// Volle Zuchtplan-Verwaltung ist in zuchtplan.html
// ============================================
const zuchtplanMod = {
    plaene: [],
    
    formatDatum(ts) { return new Date(ts).toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'}); },
    
    getPhase(plan) {
        var j = Date.now();
        if (j >= plan.zusetzen) return 'Abgeschlossen';
        if (j >= plan.umlarven) return 'Nach Umlarven';
        if (j >= plan.sammelbrut) return 'Sammelbrut l√§uft';
        return 'Geplant';
    },
    
    getTageVerbleibend(d) { var t = Math.ceil((d - Date.now())/(1000*60*60*24)); if (t<0) return null; if (t===0) return 'Heute!'; if (t===1) return 'Morgen'; return 'In '+t+' Tagen'; }
};

// ============================================
// MODUL: BEHANDLUNGEN
// ============================================
// ============================================
// MODUL: BEHANDLUNGEN (Mini-Helfer f√ºr Heute-Seite)
// Vollst√§ndige Verwaltung ‚Üí behandlung.html
// ============================================
const METHODEN = {
    'ameisensaeure60':{name:'Ameisens√§ure 60%',emoji:'üß™',farbe:'#ef4444'},
    'ameisensaeure85':{name:'Ameisens√§ure 85%',emoji:'üß™',farbe:'#dc2626'},
    'oxalsaeure':{name:'Oxals√§ure',emoji:'üíß',farbe:'#3b82f6'},
    'oxalstreifen':{name:'Oxals√§ure-Streifen',emoji:'üìã',farbe:'#60a5fa'},
    'milchsaeure':{name:'Milchs√§ure',emoji:'ü•õ',farbe:'#f59e0b'},
    'thymol':{name:'Thymol',emoji:'üåø',farbe:'#10b981'},
    'brutentnahme':{name:'Totale Brutentnahme',emoji:'üçØ',farbe:'#8b5cf6'},
    'andere':{name:'Andere Methode',emoji:'‚úèÔ∏è',farbe:'#7A6652'}
};
const behandlungMod = {
    behandlungen: [],
    init() { this.behandlungen = []; },
    formatDatum(ts) { return new Date(ts).toLocaleDateString('de-DE'); },
    getTerminStatus(termin) {
        var diff = termin - Date.now();
        var tage = Math.ceil(diff/(1000*60*60*24));
        if (tage < 0) return {status:'completed',label:'Erledigt'};
        if (tage === 0) return {status:'active',label:'Heute!'};
        if (tage === 1) return {status:'upcoming',label:'Morgen'};
        return {status:'upcoming',label:'In '+tage+' Tagen'};
    }
};


packlisteMod.init();
trachtkalenderMod.init();
// zuchtplanMod: Daten werden via Supabase in loadData geladen (Zeile ~1037)
behandlungMod.init();


// ============================================
// APP STARTUP - Check auth state
// ============================================
(async function() {
    // Check if this is a password recovery link
    var hash = window.location.hash;
    if (hash && hash.includes('type=recovery')) {
        // Supabase wird den Token automatisch verarbeiten
        // onAuthStateChange feuert PASSWORD_RECOVERY
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('authScreen').style.display = 'block';
        document.querySelector('.nav').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';
        showAuthTab('reset');
        return;
    }
    
    // Check if user is already logged in
    var session = await sb.auth.getSession();
    if (session.data.session) {
        currentUser = session.data.session.user;
        await startApp();
    } else {
        // Show auth screen
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('authScreen').style.display = 'block';
        document.querySelector('.nav').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';
    }
    
    // Listen for auth changes
    sb.auth.onAuthStateChange(function(event, session) {
        if (event === 'PASSWORD_RECOVERY') {
            // User hat auf den Reset-Link geklickt
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('authScreen').style.display = 'block';
            document.querySelector('.nav').style.display = 'none';
            document.querySelector('.footer').style.display = 'none';
            showAuthTab('reset');
        }
        if (event === 'SIGNED_OUT') {
            currentUser = null;
            document.getElementById('authScreen').style.display = 'block';
            document.querySelector('.nav').style.display = 'none';
            document.getElementById('app').innerHTML = '';
        }
    });
})();

</script>

<!-- Wetter-Standort Modal -->
<div id="wetterOrtModal" class="modal modal-center">
    <div class="modal-content" style="max-width:600px;height:auto;max-height:90vh;border-radius:1rem;margin:auto;overflow-y:auto">
        <div class="modal-header">
            <h2>üå§Ô∏è Wetter-Standort w√§hlen</h2>
            <button class="close-btn" onclick="document.getElementById('wetterOrtModal').classList.remove('active')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">üìç Aus deinen Standorten w√§hlen</label>
                <div id="wetterStandortListe"></div>
            </div>
            <div class="form-group">
                <label class="form-label">üîç Oder Ort suchen</label>
                <div style="display:flex;gap:.5rem">
                    <input type="text" id="wetterOrtSuche" class="input" placeholder="z.B. Karlsruhe, M√ºnchen..." style="flex:1">
                    <button class="btn btn-primary" onclick="wetterMod.ortSuchen()">Suchen</button>
                </div>
                <div id="wetterSuchErgebnis" style="margin-top:.5rem"></div>
            </div>
            <div class="form-group">
                <label class="form-label">üó∫Ô∏è Oder auf der Karte klicken</label>
                <div id="wetterKarte" style="height:250px;border-radius:.75rem;border:2px solid #E8DFD4"></div>
                <div id="wetterKarteInfo" style="font-size:.8rem;color:#7A6652;margin-top:.5rem"></div>
            </div>
        </div>
    </div>
</div>

<script>
// === TOGGLE UI: Event Delegation (f√§ngt ALLE Klicks auf data-toggle-ui ab) ===
document.addEventListener('click', function(e){
    var el = e.target.closest('[data-toggle-ui]');
    if (el) {
        var key = el.getAttribute('data-toggle-ui');
        console.log('[EVENT] Klick auf data-toggle-ui:', key);
        app.toggleUI(key);
    }
});

// === MOBILE MENU ===
function mobileMenuOpen(){
    var overlay = document.getElementById('mobileMenuOverlay');
    overlay.classList.add('active');
    // Aktive Seite markieren
    document.querySelectorAll('.mobile-menu-item[data-mmpage]').forEach(function(btn){
        btn.classList.toggle('mm-active', btn.dataset.mmpage === app.page);
    });
}
function mobileMenuClose(){
    document.getElementById('mobileMenuOverlay').classList.remove('active');
}
// Mobile Menu: interne Seiten navigieren
document.querySelectorAll('.mobile-menu-item[data-mmpage]').forEach(function(btn){
    btn.addEventListener('click', function(){
        var page = btn.dataset.mmpage;
        // Desktop nav sync
        document.querySelectorAll('.nav .nav-item').forEach(function(b){b.classList.remove('active');});
        var deskLink = document.querySelector('.nav .nav-item[href="index.html#'+page+'"]');
        if(deskLink) deskLink.classList.add('active');
        app.page = page;
        app.render();
        mobileMenuClose();
        updateMobileNav(page);
    });
});
// Mobile bottom bar: direkte Navigation
document.querySelectorAll('.mobile-nav-btn[data-mpage]').forEach(function(btn){
    btn.addEventListener('click', function(){
        var page = btn.dataset.mpage;
        document.querySelectorAll('.nav .nav-item').forEach(function(b){b.classList.remove('active');});
        var deskLink = document.querySelector('.nav .nav-item[href="index.html#'+page+'"]');
        if(deskLink) deskLink.classList.add('active');
        app.page = page;
        app.render();
        updateMobileNav(page);
    });
});
function updateMobileNav(page){
    var quickPages = ['heute','standorte','aufgaben','tracht','einstellungen'];
    document.querySelectorAll('.mobile-nav-btn[data-mpage]').forEach(function(btn){
        btn.classList.toggle('active', btn.dataset.mpage === page);
    });
}

// === SWIPE NAVIGATION (Mobile) ===
(function(){
    var swipePages = ['heute','standorte','aufgaben','behandlung','tracht','packliste','kosten','einstellungen'];
    var touchStartX = 0;
    var touchStartY = 0;
    var touchEndX = 0;
    var touchEndY = 0;
    var minSwipe = 80;

    document.addEventListener('touchstart', function(e){
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, {passive:true});

    document.addEventListener('touchend', function(e){
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        var diffX = touchEndX - touchStartX;
        var diffY = Math.abs(touchEndY - touchStartY);
        if (Math.abs(diffX) < minSwipe || diffY > Math.abs(diffX)) return;
        if (document.querySelector('.modal.active')) return;
        if (document.getElementById('mobileMenuOverlay').classList.contains('active')) return;
        
        var current = app.page;
        var idx = swipePages.indexOf(current);
        if (idx === -1) return;
        
        var newIdx;
        if (diffX < 0) { newIdx = idx + 1; } else { newIdx = idx - 1; }
        if (newIdx < 0 || newIdx >= swipePages.length) return;
        
        document.querySelectorAll('.nav .nav-item').forEach(function(b){b.classList.remove('active');});
        var btn = document.querySelector('.nav .nav-item[href="index.html#'+swipePages[newIdx]+'"]');
        if (btn) btn.classList.add('active');
        app.page = swipePages[newIdx];
        app.render();
        updateMobileNav(swipePages[newIdx]);
    }, {passive:true});
})();
</script>

</body>
</html>
